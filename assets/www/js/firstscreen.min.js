/*! Sugarizer 2018-06-12 */
enyo.kind({name:"Sugar.FirstScreen",kind:enyo.Control,components:[{name:"namebox",classes:"first-namebox",onresize:"resize",showing:!1,components:[{name:"nameline",classes:"first-nameline",components:[{name:"nametext",content:"xxx",classes:"first-nametext"},{classes:"first-input",components:[{name:"name",kind:"Input",classes:"first-namevalue",onkeydown:"enterclick"}]}]}]},{name:"serverbox",classes:"first-serverbox",onresize:"resize",showing:!1,components:[{name:"serverline",classes:"first-serverline",components:[{name:"servertext",content:"xxx",classes:"first-servertext"},{classes:"first-input",components:[{name:"server",kind:"Input",classes:"first-servervalue",onkeydown:"enterclick"}]}]}]},{name:"passbox",classes:"first-passbox",onresize:"resize",showing:!1,components:[{name:"password",kind:"Sugar.Password",onEnter:"enterPassword"}]},{name:"historybox",classes:"first-historybox",kind:"Repeater",onSetupItem:"setupHistory",onresize:"resize",showing:!1,components:[{name:"history",kind:"Sugar.IconButton",icon:{directory:"icons",icon:"owner-icon.svg"},classes:"first-historybutton",ontap:"historyClicked"}]},{name:"previous",kind:"Sugar.IconButton",icon:{directory:"icons",icon:"go-left.svg"},classes:"first-leftbutton",ontap:"previous",showing:!1},{name:"next",kind:"Sugar.IconButton",icon:{directory:"icons",icon:"go-right.svg"},classes:"first-rightbutton",ontap:"next",showing:!1},{name:"colortext",content:"xxx",classes:"first-colortext",showing:!1},{name:"owner",kind:"Sugar.Icon",size:constant.sizeOwner,colorized:!0,classes:"first-owner-icon",showing:!1,onresize:"resize",ontap:"nextcolor"},{name:"newuser",kind:"Sugar.Icon",size:constant.sizeNewUser,colorized:!1,classes:"first-owner-icon",showing:!0,onresize:"resize",ontap:"newUser"},{name:"newusertext",content:"xxx",classes:"newuser-text"},{name:"login",kind:"Sugar.Icon",size:constant.sizeNewUser,colorized:!1,classes:"first-owner-icon",showing:!0,onresize:"resize",ontap:"login"},{name:"logintext",content:"xxx",classes:"newuser-text"},{name:"spinner",kind:"Image",src:"images/spinner-light.gif",classes:"spinner",showing:!1},{name:"warningmessage",content:"xxx",classes:"first-warningmessage",showing:!0}],create:function(){if(this.inherited(arguments),this.$.nametext.setContent(l10n.get("Name")),this.$.servertext.setContent(l10n.get("ServerUrl")),this.$.password.setLabel(l10n.get("Password")),this.$.previous.setText(l10n.get("Back")),this.$.next.setText(l10n.get("Next")),this.$.newusertext.setContent(l10n.get("NewUser")),this.$.logintext.setContent(l10n.get("Login")),this.$.owner.setIcon({directory:"icons",icon:"owner-icon.svg"}),this.$.colortext.setContent(l10n.get("ClickToColor")),this.history=preferences.getHistory(),this.history&&this.history.length||(this.history=[]),this.$.historybox.set("count",this.history.length,!0),this.resize(),this.ownerColor=Math.floor(Math.random()*xoPalette.colors.length),this.$.owner.setColorizedColor(xoPalette.colors[this.ownerColor]),this.$.newuser.setIcon({directory:"icons",icon:"newuser-icon.svg"}),this.$.login.setIcon({directory:"icons",icon:"login.svg"}),"rtl"==l10n.language.direction&&this.$.name.addClass("rtl-10"),this.createnew=!0,this.step=0,this.displayStep(),this.$.server.setValue(util.getClientType()==constant.appType?constant.defaultServer:util.getCurrentServerUrl()),util.getClientType()==constant.webAppType){var a=this;myserver.getServerInformation(myserver.getServerUrl(),function(b,c){c.url=util.getCurrentServerUrl(),preferences.setServer(c),a.$.server.setValue(c.url)})}var b=document.getElementById("toolbar");this.backgroundColor=b.style.backgroundColor,b.style.backgroundColor="white",document.getElementById("canvas").style.overflowY="hidden",util.hideNativeToolbar()},getView:function(){return constant.radialView},setupHistory:function(a,b){var c=this.history[this.history.length-b.index-1];b.item.$.history.setColorizedColor(xoPalette.colors[c.color]),b.item.$.history.setColorized(!0),b.item.$.history.setText(c.name)},displayStep:function(){var a=!1,b=!1,c=!1,d=!1,e=!1,f=!1,g=!1,h=!1,i=!1,j=!1,k=!1,l=!1,m=!1;switch(this.$.password.stopInputListening(),this.step){case 0:this.scrollToTop(),a=b=c=d=!0,m=!0;break;case 1:this.scrollToField(this.$.serverbox),e=j=k=!0,this.$.next.setText(l10n.get("Next"));break;case 2:this.scrollToField(this.$.namebox),f=j=k=!0,this.$.nametext.setContent(l10n.get(this.createnew?"ChooseName":"Name")),this.$.next.setText(l10n.get("Next"));break;case 3:this.scrollToTop(),g=k=j=!0,this.$.password.setLabel(l10n.get(this.createnew?"ChoosePassword":"Password",{min:util.getMinPasswordSize()})),this.$.next.setText(l10n.get(this.createnew?"Next":"Done")),this.$.password.startInputListening();break;case 4:this.scrollToTop(),h=k=j=i=!0,this.$.next.setText(l10n.get("Done"));break;case 5:return void this.createOrLogin()}this.$.login.setShowing(a),this.$.logintext.setShowing(b),this.$.newuser.setShowing(c),this.$.newusertext.setShowing(d),this.$.namebox.setShowing(f),f&&(this.$.name.focus(),this.$.name.hasNode().select()),this.$.serverbox.setShowing(e),e&&(this.$.server.focus(),this.$.server.hasNode().select()),this.$.passbox.setShowing(g),this.$.colortext.setShowing(h),this.$.owner.setShowing(i),this.$.previous.setShowing(k),this.$.next.setShowing(j),this.$.historybox.setShowing(m&&this.history.length),this.$.warningmessage.setShowing(l)},newUser:function(){this.createnew=!0,this.step++,this.step++,this.displayStep()},login:function(){this.createnew=!1,this.step++,util.getClientType()==constant.webAppType&&this.step++,this.displayStep()},next:function(){if(!this.$.spinner.getShowing())if(1==this.step&&this.$.server.getValue()){this.$.spinner.setShowing(!0);var a=this;myserver.getServerInformation(this.$.server.getValue(),function(b,c){var d=c;d.url=a.$.server.getValue(),preferences.setServer(d),a.step++,a.displayStep(),a.$.spinner.setShowing(!1),a.$.warningmessage.setShowing(!1)},function(){a.$.warningmessage.setContent(l10n.get("ErrorLoadingRemote")),a.$.warningmessage.setShowing(!0),a.$.spinner.setShowing(!1)})}else if(2==this.step){var b=this.$.name.getValue().trim();if(0==b.length)return;this.step++,util.getClientType()!=constant.appType||!this.createnew&&this.$.server.getValue()||this.step++,this.displayStep()}else if(3==this.step){var c=this.$.password.getPassword();if(0==c.length||c.length<util.getMinPasswordSize())return;this.step++,this.createnew||this.step++,this.displayStep()}else this.step++,this.displayStep()},previous:function(){if(!this.$.spinner.getShowing()){this.step--;var a=util.getClientType();(3==this.step&&a==constant.appType&&this.createnew||4==this.step&&!this.createnew||1==this.step&&(a==constant.webAppType||this.createnew))&&this.step--,this.displayStep()}},enterclick:function(a,b){if(13===b.keyCode)return this.next(),!0},enterPassword:function(){this.next()},scrollToField:function(a){var b=a.hasNode();b&&(enyo.platform.android||enyo.platform.androidChrome)&&setTimeout(function(){b.scrollIntoView()},100)},scrollToTop:function(){var a=document.getElementById("firstScreen");a&&(enyo.platform.android||enyo.platform.androidChrome)&&setTimeout(function(){a.scrollIntoView(!0)},100)},nextcolor:function(){this.$.spinner.getShowing()||(this.ownerColor=this.ownerColor+1,this.ownerColor>=xoPalette.colors.length&&(this.ownerColor=0),this.$.owner.setColorizedColor(xoPalette.colors[this.ownerColor]),this.$.owner.render())},resize:function(){var a=util.getCanvasCenter();this.$.owner.applyStyle("margin-left",a.x-constant.sizeOwner/2+"px");var b=a.y-constant.sizeOwner/2;this.$.nameline.applyStyle("margin-top",b-15+"px"),this.$.serverline.applyStyle("margin-top",b-15+"px"),this.$.passbox.applyStyle("margin-top",b/2+"px"),this.$.owner.applyStyle("margin-top",b+"px"),this.$.warningmessage.applyStyle("left",a.x-100+"px"),this.$.colortext.applyStyle("margin-top",b-15+"px");var c=b-constant.sizeNewUser/2;if(this.$.newuser.applyStyle("margin-top",c+"px"),this.$.login.applyStyle("margin-top",c+"px"),this.$.historybox.applyStyle("margin-top",c+20+"px"),this.$.newusertext.applyStyle("margin-top",c+constant.sizeNewUser+20+"px"),this.$.newusertext.applyStyle("width",constant.sizeNewUser+"px"),this.$.logintext.applyStyle("margin-top",c+constant.sizeNewUser+20+"px"),this.$.logintext.applyStyle("width",constant.sizeNewUser+"px"),this.history.length){var d=a.x-1.5*constant.sizeNewUser-30;this.$.newuser.applyStyle("margin-left",d+"px"),this.$.newusertext.applyStyle("margin-left",d+"px"),d+=constant.sizeNewUser+30,this.$.login.applyStyle("margin-left",d+"px"),this.$.logintext.applyStyle("margin-left",d+"px"),d+=constant.sizeNewUser+30,this.$.historybox.applyStyle("margin-left",d+"px")}else this.$.newuser.applyStyle("margin-left",a.x-constant.sizeNewUser-25+"px"),this.$.newusertext.applyStyle("margin-left",a.x-constant.sizeNewUser-25+"px"),this.$.login.applyStyle("margin-left",a.x+25+"px"),this.$.logintext.applyStyle("margin-left",a.x+25+"px")},historyClicked:function(a,b){var c=this.history[this.history.length-b.index-1];if(this.$.name.setValue(c.name),this.$.server.setValue(c.server?c.server.url:""),c.server&&c.server.url){var d=this;myserver.getServerInformation(this.$.server.getValue(),function(a,b){b.url=d.$.server.getValue(),preferences.setServer(b)}),this.createnew=!1,this.step=3,this.displayStep()}else preferences.setName(c.name),preferences.setColor(c.color),this.launchDesktop()},createOrLogin:function(){return preferences.setColor(this.ownerColor),preferences.setName(this.$.name.getValue().trim()),util.getClientType()==constant.webAppType||!this.createnew&&this.$.server.getValue()?(this.$.spinner.setShowing(!0),void(this.createnew?this.createUser():this.loginUser())):void this.launchDesktop()},createUser:function(){var a=this;myserver.postUser({name:preferences.getName(),color:preferences.getColor(),language:preferences.getLanguage(),role:"student",password:this.$.password.getPassword()},function(b,c){a.loginUser()},function(b,c){a.$.spinner.setShowing(!1),22==c?a.$.warningmessage.setContent(l10n.get("UserAlreadyExist")):a.$.warningmessage.setContent(l10n.get("ServerError",{code:c})),a.$.warningmessage.setShowing(!0),a.step--})},loginUser:function(){var a=this,b={name:preferences.getName(),password:this.$.password.getPassword()};myserver.loginUser(b,function(b,c){preferences.setToken({x_key:c.user._id,access_token:c.token}),myserver.getUser(c.user._id,function(b,c){preferences.setNetworkId(c._id),preferences.setPrivateJournal(c.private_journal),preferences.setSharedJournal(c.shared_journal),preferences.setConnected(!0),l10n.language.code=c.language;var d=preferences.merge(c);d&&preferences.save(),a.$.spinner.setShowing(!1),a.launchDesktop()},function(b,c){a.$.warningmessage.setContent(l10n.get("ServerError",{code:c})),a.$.warningmessage.setShowing(!0),a.$.spinner.setShowing(!1),a.step--})},function(b,c){1==c?a.$.warningmessage.setContent(l10n.get("UserLoginInvalid")):a.$.warningmessage.setContent(l10n.get("ServerError",{code:c})),a.$.warningmessage.setShowing(!0),a.$.spinner.setShowing(!1),a.step--,4==a.step&&(util.getClientType()==constant.webAppType||util.getClientType()==constant.appType&&this.createnew)&&a.$.password.startInputListening()})},launchDesktop:function(){document.getElementById("toolbar").style.backgroundColor=this.backgroundColor,document.getElementById("canvas").style.overflowY="auto",app=new Sugar.Desktop,app.renderInto(document.getElementById("canvas")),preferences.save()}}),enyo.kind({name:"Sugar.EE",kind:enyo.Control,published:{mode:1},components:[{name:"endscreen",kind:"Image",src:"images/uiwarning.png",classes:"shutdownimage",showing:!1,ontap:"reload"},{name:"audio",kind:"Sugar.Audio"},{name:"owner",kind:"Sugar.Icon",size:constant.sizeOwner,icon:{directory:"icons",icon:"owner-icon.svg"},colorized:!0,colorizedColor:{stroke:"#666666",fill:"#FFFFFF"},classes:"owner-icon",showing:!1},{name:"dots"},{name:"lab",kind:"Image",src:"images/eelab.svg",classes:"eelab",showing:!1},{name:"fed",kind:"Image",src:"images/eefed.jpg",classes:"eefed",showing:!1}],create:function(){this.inherited(arguments),this.timer=null,this.step=0,app.noresize=!0},rendered:function(){this.inherited(arguments),this.draw()},modeChanged:function(){this.draw()},reload:function(){location.reload()},draw:function(){if(this.addRemoveClass("eedownscreen",!1),this.addRemoveClass("shutdownscreen",!1),1==this.mode){if(this.step)return;this.addRemoveClass("eescreen",!0),this.$.audio.play("audio/eeboot"),this.step=1,this.timer=window.setInterval(enyo.bind(this,"processStep"),1e3)}else 2==this.mode&&(this.addRemoveClass("shutdownscreen",!0),this.$.endscreen.setShowing(!0))},processStep:function(){var a={stroke:"#000000",fill:"#999999"},b={stroke:"#000000",fill:"#666666"};switch(this.step++){case 1:var c=util.getCanvasCenter();this.$.owner.setX(c.x-constant.sizeOwner/2),this.$.owner.setY(c.y-constant.sizeOwner/2),this.$.owner.setShowing(!0);break;case 11:this.dots=[];for(var d=24,e=this.$.owner.getSize(),f=this.$.owner.getX()+e/2-d/2,g=this.$.owner.getY()+e/2-d/2,h=2*Math.PI,i=1.5*e,j=Math.PI/2,k=h/parseFloat(24),l=0;l<24;l++){x=f+Math.cos(j)*i,y=g+Math.sin(j)*i;var m=this.$.dots.createComponent({kind:"Sugar.Icon",icon:{directory:"icons",icon:"dot.svg"},size:d,x:x,y:y,colorizedColor:a,colorized:!0,showing:0==l},{owner:this});m.render(),this.dots.push(m),j+=k}break;case 20:for(var l=0;l<24;l++)this.dots[l].setShowing(!0);this.$.fed.setShowing(!0),this.$.lab.setShowing(!0);break;case 21:for(var l=0;l<24;l+=4)this.dots[l].setColorizedColor(b);break;case 22:case 23:case 24:case 25:case 26:for(var n=[],l=0;l<24;l++)n.push(this.dots[l].getColorizedColor());for(var l=0;l<24;l++)this.dots[l].setColorizedColor(n[0==l?23:l-1]);break;case 27:for(var l=0;l<24;l++)this.dots[l].setColorizedColor(b);break;case 39:window.clearInterval(this.timer),this.reload()}}});