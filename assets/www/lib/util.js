/*! Sugarizer 2018-07-01 */
define(["webL10n","sugar-web/datastore"],function(a,b){function c(a){var b=a+1;return b==xoPalette.colors.length&&(b=0),b}function d(a){var b=a-1;return b<0&&(b=xoPalette.colors.length-1),b}function e(a){return a>64&&a<91?a-65:a>96&&a<123?a-71:a>47&&a<58?a+4:43===a?62:47===a?63:0}function f(a,b){for(var c,d,f=a.replace(/[^A-Za-z0-9\+\/]/g,""),g=f.length,h=b?Math.ceil((3*g+1>>2)/b)*b:3*g+1>>2,i=new Uint8Array(h),j=0,k=0,l=0;l<g;l++)if(d=3&l,j|=e(f.charCodeAt(l))<<6*(3-d),3===d||g-l===1){for(c=0;c<3&&k<h;c++,k++)i[k]=j>>>(16>>>c&24)&255;j=0}return i}var g={},h=[{name:"Years",factor:30758400},{name:"Months",factor:2592e3},{name:"Weeks",factor:604800},{name:"Days",factor:86400},{name:"Hours",factor:3600},{name:"Minutes",factor:60}];return g.timestampToElapsedString=function(b,c,d){for(var e=d?"_short":"",f=0,g="",i=((new Date).getTime()-b)/1e3,j=0;j<h.length;j++){var k=h[j].factor,l=Math.floor(i/k);if(l>0&&(f>0&&(g+=","),g+=" "+l+" "+(1==l?a.get(h[j].name+"_one"+e):a.get(h[j].name+"_other"+e)),i-=l*k),""!=g&&(f+=1),f==c)break}return 0==f?a.get("SecondsAgo"+e):a.get("Ago"+e,{time:g})},g.getDateRange=function(a){if(void 0===a)return null;var b=new Date,c=new Date(b.getFullYear(),b.getMonth(),b.getDate()).getTime();b=b.getTime();var d=null;switch(a){case 1:d={min:c,max:b};break;case 2:d={min:c-864e5,max:b};break;case 3:d={min:c-6048e5,max:b};break;case 4:d={min:c-2592e6,max:b};break;case 5:d={min:c-307584e5,max:b}}return d},g.getNextStrokeColor=function(a){var b=g.getColorIndex(a);if(b==-1)return a;for(var d=c(b);xoPalette.colors[d].stroke!=xoPalette.colors[b].stroke;)d=c(d);return xoPalette.colors[d]},g.getPreviousStrokeColor=function(a){var b=g.getColorIndex(a);if(b==-1)return a;for(var c=d(b);xoPalette.colors[c].stroke!=xoPalette.colors[b].stroke;)c=d(c);return xoPalette.colors[c]},g.getNextFillColor=function(a){var b=g.getColorIndex(a);if(b==-1)return a;for(var d=c(b);xoPalette.colors[d].fill!=xoPalette.colors[b].fill;)d=c(d);return xoPalette.colors[d]},g.getPreviousFillColor=function(a){var b=g.getColorIndex(a);if(b==-1)return a;for(var c=d(b);xoPalette.colors[c].fill!=xoPalette.colors[b].fill;)c=d(c);return xoPalette.colors[c]},g.getColorIndex=function(a){for(var b=0;b<xoPalette.colors.length;b++)if(a.stroke==xoPalette.colors[b].stroke&&a.fill==xoPalette.colors[b].fill)return b;return-1},g.getCanvasCenter=function(){var a=document.getElementById("canvas")||document.getElementById("body"),b=a.offsetHeight,c=a.offsetWidth,d=parseFloat(b)/2,e=parseFloat(c)/2;return{x:e,y:d,dx:c,dy:b}},g.computeMargin=function(a,b){var c=document.getElementById("canvas"),d=c.offsetHeight,e=c.offsetWidth,f=a.width<=e?a.width:b.width*e,g=a.height<=d?a.height:b.height*d;return{left:parseFloat(e-f)/2,top:parseFloat(d-g)/2,width:f,height:g}},g.cursorIsInside=function(a){var b=document.getElementById(a.getAttribute("id"));if(null==b)return!1;var c={};for(c.x=b.offsetLeft,c.y=b.offsetTop,c.dx=b.clientWidth,c.dy=b.clientHeight;b.offsetParent&&(c.x=c.x+b.offsetParent.offsetLeft,c.y=c.y+b.offsetParent.offsetTop-b.scrollTop,b!=document.getElementsByTagName("body")[0]);)b=b.offsetParent;var d=mouse.position.x>=c.x&&mouse.position.x<=c.x+c.dx&&mouse.position.y>=c.y&&mouse.position.y<=c.y+c.dy;return d},g.setToolbar=function(a){toolbar!=a&&(toolbar=a,a.renderInto(document.getElementById("toolbar")))},g.getBrowserName=function(){return enyo.platform.android?"Android":enyo.platform.androidChrome?"Chrome Android":enyo.platform.androidFirefox?"Firefox Android":enyo.platform.ie?"IE":enyo.platform.ios?"iOS":enyo.platform.webos?"webOS":enyo.platform.blackberry?"BlackBerry":enyo.platform.safari?"Safari":enyo.platform.chrome?"Chrome":enyo.platform.firefox?"Firefox":"Unknown"},g.getBrowserVersion=function(){return enyo.platform.android?enyo.platform.android:enyo.platform.androidChrome?enyo.platform.androidChrome:enyo.platform.androidFirefox?enyo.platform.androidFirefox:enyo.platform.ie?enyo.platform.ie:enyo.platform.ios?enyo.platform.ios:enyo.platform.webos?enyo.platform.webos:enyo.platform.blackberry?enyo.platform.blackberry:enyo.platform.safari?enyo.platform.safari:enyo.platform.chrome?enyo.platform.chrome:enyo.platform.firefox?enyo.platform.firefox:"?"},g.getClientType=function(){return"http"==document.location.protocol.substr(0,4)?constant.webAppType:constant.appType},g.getClientName=function(){return this.getClientType()==constant.webAppType?"Web App":"App"},g.getCurrentServerUrl=function(){var a=window.location.href;return a.substring(0,a.lastIndexOf("/"))},g.getMinPasswordSize=function(){var a=constant.minPasswordSize,b=preferences.getServer();return b&&b.options&&b.options["min-password-size"]&&(a=b.options["min-password-size"]),a},g.restartApp=function(){location.reload()},g.vibrate=function(){(enyo.platform.android||enyo.platform.androidChrome||enyo.platform.ios)&&g.getClientType()==constant.appType&&navigator.vibrate&&navigator.vibrate(30)},g.hideNativeToolbar=function(){(enyo.platform.android||enyo.platform.androidChrome)&&g.getClientType()==constant.appType&&AndroidFullScreen.immersiveMode(function(){},function(){})},g.handleVolumeButtons=function(){if((enyo.platform.android||enyo.platform.androidChrome)&&g.getClientType()==constant.appType){var a=function(){};document.addEventListener("volumeupbutton",function(){cordova.plugins.VolumeControl.getVolume(function(b){var c=parseInt(b);c<100&&cordova.plugins.VolumeControl.setVolume(c+10,a,a)},a)},!1),document.addEventListener("volumedownbutton",function(){cordova.plugins.VolumeControl.getVolume(function(b){var c=parseInt(b);c>0&&cordova.plugins.VolumeControl.setVolume(c-1,a,a)},a)},!1)}},g.writeFile=function(a,b,c){var d=null,e=null,g="json",h=a.title,i="application/json";a&&a.mimetype?(i=a.mimetype,g="image/jpeg"==i?"jpg":"image/png"==i?"png":"audio/wav"==i?"wav":"video/webm"==i?"webm":"bin",d=f(b.substr(b.indexOf("base64,")+7)).buffer):e=JSON.stringify({metadata:a,text:b});var j=cordova.file.externalRootDirectory;enyo.platform.ios&&(j=cordova.file.documentsDirectory),window.resolveLocalFileSystemURL(j,function(a){a.getFile(h+"."+g,{create:!0},function(a){a&&a.createWriter(function(b){if(b.seek(b.length),e){var f=new Blob([e],{type:i});b.write(f)}else b.write(d);c(null,a.fullPath)},function(a){c(error.code,null)})})})},g.cleanDatastore=function(a){for(var c=b.find(),d=0;d<c.length;d++)b.remove(c[d].objectId);preferences.reset(a)},g.computeDatastoreSize=function(a){if("undefined"!=typeof chrome&&chrome.app&&chrome.app.runtime)return void chrome.storage.local.getBytesInUse(function(b){var c=268435456;a&&a({total:c,used:b,remain:c-b})});var b=enyo.platform.safari||enyo.platform.ios?5224448:10446848,c=0;for(var d in localStorage){var e=2*localStorage[d].length;isNaN(e)||(c+=e)}a&&a({total:b,used:c,remain:b-c})},g.formatSize=function(b){return b>1048576?formated=(b/1024/1024).toFixed()+a.get("ShortForMegabytes"):b>1024?formated=(b/1024).toFixed()+a.get("ShortForKilobytes"):formated=b+a.get("ShortForBytes"),formated},g.quitApp=function(){new Sugar.EE({mode:2}).renderInto(document.getElementById("body")),window.setTimeout(function(){"undefined"!=typeof chrome&&chrome.app&&chrome.app.runtime&&window.top.postMessage("","*"),window.close(),/Edge/.test(navigator.userAgent)||(window.open("","_self",""),window.close()),navigator&&(navigator.app?navigator.app.exitApp():navigator.device&&navigator.device.exitApp())},constant.timerBeforeClose)},g});