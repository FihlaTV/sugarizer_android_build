/*! Sugarizer 2019-01-12 */
define(["webL10n","sugar-web/datastore","FileSaver"],function(a,b,c){function d(a){var b=a+1;return b==xoPalette.colors.length&&(b=0),b}function e(a){var b=a-1;return b<0&&(b=xoPalette.colors.length-1),b}function f(a){return a>64&&a<91?a-65:a>96&&a<123?a-71:a>47&&a<58?a+4:43===a?62:47===a?63:0}function g(a,b){for(var c,d,e=a.replace(/[^A-Za-z0-9\+\/]/g,""),g=e.length,h=b?Math.ceil((3*g+1>>2)/b)*b:3*g+1>>2,i=new Uint8Array(h),j=0,k=0,l=0;l<g;l++)if(d=3&l,j|=f(e.charCodeAt(l))<<6*(3-d),3===d||g-l==1){for(c=0;c<3&&k<h;c++,k++)i[k]=j>>>(16>>>c&24)&255;j=0}return i}function h(a,b,c){if("application/json"==a.type){var d=null;try{if(d=JSON.parse(b),!d.metadata)return void c(a.name,-1)}catch(b){return void c(a.name,-1)}c(a.name,0,d.metadata,d.text)}else{var e={title:a.name,mimetype:a.type,activity:"org.olpcfrance.MediaViewerActivity"};c(a.name,0,e,b)}}var i={},j=[{name:"Years",factor:30758400},{name:"Months",factor:2592e3},{name:"Weeks",factor:604800},{name:"Days",factor:86400},{name:"Hours",factor:3600},{name:"Minutes",factor:60}];return i.timestampToElapsedString=function(b,c,d){for(var e=d?"_short":"",f=0,g="",h=((new Date).getTime()-b)/1e3,i=0;i<j.length;i++){var k=j[i].factor,l=Math.floor(h/k);if(l>0&&(f>0&&(g+=","),g+=" "+l+" "+(1==l?a.get(j[i].name+"_one"+e):a.get(j[i].name+"_other"+e)),h-=l*k),""!=g&&(f+=1),f==c)break}return 0==f?a.get("SecondsAgo"+e):a.get("Ago"+e,{time:g})},i.getDateRange=function(a){if(void 0===a)return null;var b=new Date,c=new Date(b.getFullYear(),b.getMonth(),b.getDate()).getTime();b=b.getTime();var d=null;switch(a){case 1:d={min:c,max:b};break;case 2:d={min:c-864e5,max:b};break;case 3:d={min:c-6048e5,max:b};break;case 4:d={min:c-2592e6,max:b};break;case 5:d={min:c-307584e5,max:b}}return d},i.getNextStrokeColor=function(a){var b=i.getColorIndex(a);if(-1==b)return a;for(var c=d(b);xoPalette.colors[c].stroke!=xoPalette.colors[b].stroke;)c=d(c);return xoPalette.colors[c]},i.getPreviousStrokeColor=function(a){var b=i.getColorIndex(a);if(-1==b)return a;for(var c=e(b);xoPalette.colors[c].stroke!=xoPalette.colors[b].stroke;)c=e(c);return xoPalette.colors[c]},i.getNextFillColor=function(a){var b=i.getColorIndex(a);if(-1==b)return a;for(var c=d(b);xoPalette.colors[c].fill!=xoPalette.colors[b].fill;)c=d(c);return xoPalette.colors[c]},i.getPreviousFillColor=function(a){var b=i.getColorIndex(a);if(-1==b)return a;for(var c=e(b);xoPalette.colors[c].fill!=xoPalette.colors[b].fill;)c=e(c);return xoPalette.colors[c]},i.getColorIndex=function(a){for(var b=0;b<xoPalette.colors.length;b++)if(a.stroke==xoPalette.colors[b].stroke&&a.fill==xoPalette.colors[b].fill)return b;return-1},i.getCanvasCenter=function(){var a=document.getElementById("canvas")||document.getElementById("body"),b=a.offsetHeight,c=a.offsetWidth,d=parseFloat(b)/2;return{x:parseFloat(c)/2,y:d,dx:c,dy:b}},i.computeMargin=function(a,b){var c=document.getElementById("canvas"),d=c.offsetHeight,e=c.offsetWidth,f=a.width<=e?a.width:b.width*e,g=a.height<=d?a.height:b.height*d;return{left:parseFloat(e-f)/2,top:parseFloat(d-g)/2,width:f,height:g}},i.cursorIsInside=function(a){var b=document.getElementById(a.getAttribute("id"));if(null==b)return!1;var c={};for(c.x=b.offsetLeft,c.y=b.offsetTop,c.dx=b.clientWidth,c.dy=b.clientHeight;b.offsetParent&&(c.x=c.x+b.offsetParent.offsetLeft,c.y=c.y+b.offsetParent.offsetTop-b.scrollTop,b!=document.getElementsByTagName("body")[0]);)b=b.offsetParent;return mouse.position.x>=c.x&&mouse.position.x<=c.x+c.dx&&mouse.position.y>=c.y&&mouse.position.y<=c.y+c.dy},i.setToolbar=function(a){toolbar!=a&&(toolbar=a,a.renderInto(document.getElementById("toolbar")))},i.getBrowserName=function(){return enyo.platform.android?"Android":enyo.platform.androidChrome?"Chrome Android":enyo.platform.androidFirefox?"Firefox Android":enyo.platform.ie?"IE":enyo.platform.ios?"iOS":enyo.platform.webos?"webOS":enyo.platform.blackberry?"BlackBerry":enyo.platform.safari?"Safari":enyo.platform.chrome?"Chrome":enyo.platform.firefox?"Firefox":"Unknown"},i.getBrowserVersion=function(){return enyo.platform.android?enyo.platform.android:enyo.platform.androidChrome?enyo.platform.androidChrome:enyo.platform.androidFirefox?enyo.platform.androidFirefox:enyo.platform.ie?enyo.platform.ie:enyo.platform.ios?enyo.platform.ios:enyo.platform.webos?enyo.platform.webos:enyo.platform.blackberry?enyo.platform.blackberry:enyo.platform.safari?enyo.platform.safari:enyo.platform.chrome?enyo.platform.chrome:enyo.platform.firefox?enyo.platform.firefox:"?"},i.getClientType=function(){return"http"==document.location.protocol.substr(0,4)?constant.webAppType:constant.appType},i.getClientName=function(){return this.getClientType()==constant.webAppType?"Web App":"App"},i.getCurrentServerUrl=function(){var a=window.location.href;return a.substring(0,a.lastIndexOf("/"))},i.getMinPasswordSize=function(){var a=constant.minPasswordSize,b=preferences.getServer();return b&&b.options&&b.options["min-password-size"]&&(a=b.options["min-password-size"]),a},i.restartApp=function(){location.reload()},i.vibrate=function(){(enyo.platform.android||enyo.platform.androidChrome||enyo.platform.ios)&&i.getClientType()==constant.appType&&navigator.vibrate&&navigator.vibrate(30)},i.hideNativeToolbar=function(){(enyo.platform.android||enyo.platform.androidChrome)&&i.getClientType()==constant.appType&&AndroidFullScreen.immersiveMode(function(){},function(){})},i.handleVolumeButtons=function(){if((enyo.platform.android||enyo.platform.androidChrome)&&i.getClientType()==constant.appType){var a=function(){};document.addEventListener("volumeupbutton",function(){cordova.plugins.VolumeControl.getVolume(function(b){var c=parseInt(b);c<100&&cordova.plugins.VolumeControl.setVolume(c+10,a,a)},a)},!1),document.addEventListener("volumedownbutton",function(){cordova.plugins.VolumeControl.getVolume(function(b){var c=parseInt(b);c>0&&cordova.plugins.VolumeControl.setVolume(c-1,a,a)},a)},!1)}},i.writeFile=function(a,b,d,e){var f=null,h=null,j="json",k=b.title,l="application/json";b&&b.mimetype?(l=b.mimetype,j="image/jpeg"==l?"jpg":"image/png"==l?"png":"audio/wav"==l?"wav":"video/webm"==l?"webm":"bin",f=g(d.substr(d.indexOf("base64,")+7)).buffer):h=JSON.stringify({metadata:b,text:d});var m=k+"."+j;if(i.getClientType()==constant.appType)if(enyo.platform.android||enyo.platform.androidChrome||enyo.platform.ios){var n=cordova.file.externalRootDirectory;enyo.platform.ios&&(n=cordova.file.documentsDirectory),window.resolveLocalFileSystemURL(n,function(a){a.getFile(m,{create:!0},function(a){a&&a.createWriter(function(b){if(b.seek(b.length),h){var c=new Blob([h],{type:l});b.write(c)}else b.write(f);e(null,a.fullPath)},function(a){e(error.code,null)})})})}else{var o=require("electron"),p=o.ipcRenderer;p.removeAllListeners("save-file-reply"),p.send("save-file-dialog",{directory:a,filename:m,mimetype:l,extension:j,text:h,binary:d}),p.on("save-file-reply",function(a,b){e(b.err,b.filename)})}else{var q=new Blob(h?[h]:[f],{type:l});c.saveAs(q,m),e(null,m)}},i.loadFile=function(a,b){if(i.getClientType()==constant.webAppType){if(-1==["application/json","image/jpeg","image/png","audio/wav","video/webm"].indexOf(a.type))return void b(a.name,-1);var c=new FileReader;c.onload=function(){h(a,c.result,b)},"application/json"==a.type?c.readAsText(a):c.readAsDataURL(a)}},i.askDirectory=function(a){if(!(i.getClientType()!=constant.appType||enyo.platform.android||enyo.platform.androidChrome||enyo.platform.ios)){var b=require("electron"),c=b.ipcRenderer;c.removeAllListeners("choose-directory-reply"),c.send("choose-directory-dialog"),c.on("choose-directory-reply",function(b,c){a(c)})}},i.askFiles=function(b){if(i.getClientType()==constant.appType)if(enyo.platform.android||enyo.platform.androidChrome||enyo.platform.ios){if(!window.cordova&&!window.PhoneGap)return;var c={type:"image/jpeg",name:a.get("ImageFromDevice")},d=function(a){h(c,"data:image/jpeg;base64,"+a,b)},e=function(a){};navigator.camera.getPicture(d,e,{quality:50,targetWidth:640,targetHeight:480,destinationType:Camera.DestinationType.DATA_URL,sourceType:Camera.PictureSourceType.PHOTOLIBRARY})}else{var f=require("electron"),g=f.ipcRenderer;g.removeAllListeners("choose-files-reply"),g.send("choose-files-dialog"),g.on("choose-files-reply",function(a,c,d,e){d?b(c.name,-1):h(c,e,b)})}},i.cleanDatastore=function(a){for(var c=b.find(),d=0;d<c.length;d++)b.remove(c[d].objectId);preferences.reset(a)},i.computeDatastoreSize=function(a){if("undefined"!=typeof chrome&&chrome.app&&chrome.app.runtime)return void chrome.storage.local.getBytesInUse(function(b){var c=268435456;a&&a({total:c,used:b,remain:c-b})});var b=enyo.platform.safari||enyo.platform.ios?5224448:10446848,c=0;for(var d in localStorage){var e=2*localStorage[d].length;isNaN(e)||(c+=e)}a&&a({total:b,used:c,remain:b-c})},i.formatSize=function(b){return formated=b>1048576?(b/1024/1024).toFixed()+" "+a.get("ShortForMegabytes"):b>1024?(b/1024).toFixed()+" "+a.get("ShortForKilobytes"):0==b?"-":b+" "+a.get("ShortForBytes"),formated},i.quitApp=function(){new Sugar.EE({mode:2}).renderInto(document.getElementById("body")),window.setTimeout(function(){"undefined"!=typeof chrome&&chrome.app&&chrome.app.runtime&&window.top.postMessage("","*"),window.close(),/Edge/.test(navigator.userAgent)||(window.open("","_self",""),window.close()),navigator&&(navigator.app?navigator.app.exitApp():navigator.device&&navigator.device.exitApp())},constant.timerBeforeClose)},i});