/*! Sugarizer 2017-08-25 */
define(["sugar-web/datastore"],function(a){var b={};return b.init=function(){this.name="<No name>",this.color=22,this.colorvalue=null,this.activities=[],this.view=0,this.language="en";var a=navigator.language;a&&(a.indexOf("fr")!=-1?this.language="fr":a.indexOf("es")!=-1?this.language="es":a.indexOf("de")!=-1?this.language="de":a.indexOf("ar")!=-1?this.language="ar":a.indexOf("ja")!=-1?this.language="ja":a.indexOf("pl")!=-1?this.language="pl":a.indexOf("pt")!=-1&&(this.language="pt")),this.connected=!1,this.server=null,this.networkId=null,this.privateJournal=null,this.sharedJournal=null,this.genericActivity={directory:"icons",icon:"application-x-generic.svg"}},b.init(),b.load=function(b){var c=this;a.localStorage.load(function(){var d=a.localStorage.getValue("sugar_settings");return null==d||void 0===d.name?void(b&&b(!1)):(c.name=d.name,c.color=d.color,c.colorvalue=d.colorvalue,c.view=d.view,void 0!==d.language&&(c.language=d.language),void 0!==d.connected&&(c.connected=d.connected),void 0!==d.server&&(c.server=d.server),void 0!==d.networkId&&(c.networkId=d.networkId),l10n.language.code=c.language,c.activities=d.activities,c.updateEntries(),void(b&&b(!0)))})},b.updateEntries=function(){for(var b=0;b<this.activities.length;b++){var c=this.activities[b];c.instances=a.find(c.id),c.instances.sort(function(a,b){return parseInt(b.metadata.timestamp)-parseInt(a.metadata.timestamp)})}},b.save=function(){a.localStorage.setValue("sugar_settings",{name:this.name,color:this.color,colorvalue:xoPalette.colors[this.color],activities:this.activities,view:app.getView(),language:this.language,connected:this.connected,server:this.server,networkId:this.networkId})},b.saveToServer=function(a,b){if(null!=this.networkId){var c=this;a.putUser(this.networkId,{name:c.name,color:xoPalette.colors[c.color],language:c.language,favorites:c.getFavoritesActivitiesName()},function(a,c){b&&b()},function(){console.log("WARNING: Error updating network user"),b&&b()})}else b&&b()},b.merge=function(a){var b=!1;if(void 0!==a.name&&a.name!=this.name&&(this.name=a.name,b=!0),void 0===a.color||a.color.fill==this.colorvalue.fill&&a.color.stroke==this.colorvalue.stroke||(this.colorvalue=a.color,this.color=util.getColorIndex(this.colorvalue),b=!0),void 0!==a.language&&a.language!=this.language&&(this.language=a.language,b=!0),void 0!==a.favorites)for(var c=0;c<this.activities.length;c++){var d=this.activities[c].favorite;this.activities[c].favorite=!1;for(var e=0;e<a.favorites.length;e++)a.favorites[e]==this.activities[c].id&&(this.activities[c].favorite=!0);b=b||d!=this.activities[c].favorite}return void 0!==a.server&&a.server!=this.server&&(this.server=a.server,b=!0),void 0!==a.networkId&&a.networkId!=this.networkId&&(this.networkId=a.networkId,b=!0),void 0!==a.private_journal&&a.private_journal!=this.privateJournal&&(this.privateJournal=a.private_journal),void 0!==a.shared_journal&&a.shared_journal!=this.sharedJournal&&(this.sharedJournal=a.shared_journal),b},b.reset=function(){a.localStorage.removeValue("sugar_settings")},b.getName=function(){return this.name},b.getColor=function(){return xoPalette.colors[this.color]},b.getView=function(){return this.view},b.getLanguage=function(){return this.language},b.getActivities=function(){return this.activities},b.getActivitiesByName=function(a){if(void 0===a||null==a||0==a.length)return this.activities;for(var b=this.activities,c=[],d=0;d<b.length;d++)b[d].name.toLowerCase().indexOf(a)!=-1&&c.push(b[d]);return c},b.getActivity=function(a){for(var b=0;b<this.activities.length;b++)if(this.activities[b].id==a)return this.activities[b];return this.genericActivity},b.getFavoritesActivities=function(){for(var a=[],b=0;b<this.activities.length;b++)this.activities[b].favorite&&a.push(this.activities[b]);return a},b.getFavoritesActivitiesName=function(){for(var a=this.getFavoritesActivities(),b=[],c=0;c<a.length;c++)b.push(a[c].id);return b},b.isConnected=function(){return this.connected||util.getClientType()==constant.webAppType},b.getServer=function(){return this.server},b.getNetworkId=function(){return this.networkId},b.getPrivateJournal=function(){return this.privateJournal},b.getSharedJournal=function(){return this.sharedJournal},b.setName=function(a){this.name=a},b.setColor=function(a){a>=0&&a<xoPalette.colors.length&&(this.color=a)},b.setLanguage=function(a){this.language=a},b.setActivities=function(a){this.activities=a},b.setConnected=function(a){this.connected=a},b.setServer=function(a){this.server=a},b.setNetworkId=function(a){this.networkId=a},b.setPrivateJournal=function(a){this.privateJournal=a},b.setSharedJournal=function(a){this.sharedJournal=a},b.updateActivities=function(a){for(var b=!1,c=0,d=0;d<a.length;d++){for(var e=!1,f=0;!e&&f<this.activities.length;f++)a[d].id==this.activities[f].id&&(e=!0,c++,this.activities[f].version!=a[d].version&&(this.activities[f].name=a[d].name,this.activities[f].version=a[d].version,this.activities[f].directory=a[d].directory,this.activities[f].icon=a[d].icon,b=!0));e||(this.activities.push(a[d]),b=!0)}if(c!=this.activities.length){b=!0;for(var g=[],d=0;d<this.activities.length;d++)for(var e=!1,f=0;!e&&f<a.length;f++)this.activities[d].id!=a[f].id&&"native"!=this.activities[d].type||(e=!0,g.push(this.activities[d]));this.activities=g}return b},b.nextColor=function(){this.color=(this.color+1)%xoPalette.colors.length},b.runActivity=function(b,c,d,e,f){if(null!=b.type&&"native"==b.type){if(sugarizerOS)return sugarizerOS.runActivity(b.id),void sugarizerOS.addApplicationToJournal(sugarizerOS.log,b,a);console.log("No sugarizerOS instance found")}null==b.activityId&&(b.activityId=a.createUUID()),this.save();var g=b.directory+"/index.html?aid="+b.activityId+"&a="+b.id;g=void 0===c?null!=b.instances&&b.instances.length>0?g+"&o="+b.instances[0].objectId+"&n="+b.instances[0].metadata.title:g+"&n="+b.name:null!=c?g+"&o="+c+"&n="+d:g+"&n="+b.name,e&&(g=g+"&s="+e),f&&(g+="&h=1"),window.location=g},b.switchFavoriteActivity=function(a){return a.favorite=!a.favorite,a.favorite},b});