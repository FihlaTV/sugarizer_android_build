/*! Sugarizer 2019-09-21 */
define(["sugar-web/activity/activity","sugar-web/datastore","sugar-web/env","webL10n"],function(a,b,c,d){requirejs(["domReady!","humane"],function(e,f){function g(a){k.includes(a)||(k.push(a),h())}function h(){for(var a="",b=k.length;b--;)a+='<option value="'+k[b]+'">'+k[b]+"</option>";document.getElementById("qrtextdropdown").innerHTML=a}a.setup();var i=(/Android/i.test(navigator.userAgent)||/iPad/i.test(navigator.userAgent)||/iPhone/i.test(navigator.userAgent))&&"http"!=document.location.protocol.substr(0,4),j=0,k=[];c.getEnvironment(function(a,b){var c="undefined"!=typeof chrome&&chrome.app&&chrome.app.runtime?chrome.i18n.getUILanguage():navigator.language,e=b.user?b.user.language:c;d.language.code=e});var l=95,m=20,n=document.getElementById("canvas").parentNode.offsetHeight-l;n-=m*n/100;var o=new QRCode("qr-code",{width:n,height:n,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.H}),p=(document.getElementById("canvas").parentNode.offsetWidth-n)/2;document.getElementById("qr-code").style.marginLeft=p+"px",document.getElementById("qr-code").style.marginTop="20px";var q=function(a){o.clear(),o.makeCode(a),g(a);var a=r.value.toLowerCase();a.length>0?document.getElementById("erasetext-button").style.visibility="visible":document.getElementById("erasetext-button").style.visibility="hidden",0==a.indexOf("http://")||0==a.indexOf("https://")?document.getElementById("user-text").classList.add("text-url"):document.getElementById("user-text").classList.remove("text-url")};window.addEventListener("resize",function(){var a=document.body.clientHeight-l,b=a/(n*(100+m)/100);document.getElementById("qr-code").style.zoom=b;var c=navigator.userAgent.toLowerCase();-1==c.indexOf("chrome")&&(document.getElementById("qr-code").style.MozTransform="scale("+b+")",document.getElementById("qr-code").style.MozTransformOrigin="0 0"),u&&(document.getElementById("outdiv").style.zoom=b,-1==c.indexOf("chrome")&&(document.getElementById("outdiv").style.MozTransform="scale("+b+")",document.getElementById("outdiv").style.MozTransformOrigin="0 0"))});var r=document.getElementById("user-text");r.addEventListener("keyup",function(){var a=r.value.toLowerCase();a.length>0?document.getElementById("erasetext-button").style.visibility="visible":document.getElementById("erasetext-button").style.visibility="hidden",0==a.indexOf("http://")||0==a.indexOf("https://")?document.getElementById("user-text").classList.add("text-url"):document.getElementById("user-text").classList.remove("text-url")}),r.addEventListener("click",function(){var a=r.value.toLowerCase();0!=a.indexOf("http://")&&0!=a.indexOf("https://")||(i?cordova.InAppBrowser.open(r.value,"_system"):window.open(r.value))}),document.getElementById("erasetext-button").addEventListener("click",function(){r.value="",r.focus(),document.getElementById("erasetext-button").style.visibility="hidden",document.getElementById("user-text").classList.remove("text-url")}),document.getElementById("generate-button").addEventListener("click",function(){q(r.value)});var s=function(a){document.getElementById("outdiv").style.visibility="hidden",document.getElementById("video-stream").style.visibility="hidden",document.getElementById("qr-code").style.visibility="visible",document.getElementById("loading-spinner").style.visibility="hidden",document.getElementById("photo-button").classList.remove("active"),r.value=a,q(a)};document.getElementById("png-button").addEventListener("click",function(){var a="image/png",c=document.getElementById("qr-code").childNodes[1].src,e={mimetype:a,title:"Image QR Code",activity:"org.olpcfrance.MediaViewerActivity",timestamp:(new Date).getTime(),creation_time:(new Date).getTime(),file_size:0};b.create(e,function(){f.log(d.get("QRCodeSaved")),console.log("export done.")},c)}),document.getElementById("fullscreen-button").addEventListener("click",function(){document.getElementById("photo-button").classList.contains("active")||(document.getElementById("main-toolbar").style.opacity=0,document.getElementById("input-box").style.opacity=0,document.getElementById("canvas").style.top="0px",document.getElementById("unfullscreen-button").style.visibility="visible")}),document.getElementById("unfullscreen-button").addEventListener("click",function(){document.getElementById("main-toolbar").style.opacity=1,document.getElementById("input-box").style.opacity=1,document.getElementById("canvas").style.top="55px",document.getElementById("unfullscreen-button").style.visibility="hidden"});var t=document.getElementById("photo-button"),u=!1,v="";t.addEventListener("click",function(){if(i)return document.getElementById("main-toolbar").style.opacity=0,document.getElementById("canvas").style.opacity=0,document.getElementById("close-button").style.visibility="visible",document.getElementById("switchcamera-button").style.visibility="visible",void QRScanner.prepare(function(a,b){a?console.log("Error "+a):(console.log(b),QRScanner.scan(function(a,b){a?console.log("Error "+a):(r.value=b,q(b)),QRScanner.cancelScan(function(a){}),document.getElementById("main-toolbar").style.opacity=1,document.getElementById("canvas").style.opacity=1,document.getElementById("close-button").style.visibility="hidden",document.getElementById("switchcamera-button").style.visibility="hidden"}),QRScanner.show(function(a){}))});var a=document.getElementById("outdiv"),b=document.getElementById("video-stream");t.classList.contains("active")?(a.style.visibility="hidden",b.style.visibility="hidden",document.getElementById("loading-spinner").style.visibility="hidden",document.getElementById("qr-code").style.visibility="visible",r.value=v,q(r.value)):(document.getElementById("qr-code").style.visibility="hidden",document.getElementById("loading-spinner").style.visibility="visible",v=r.value,r.value="",u?(a.style.visibility="visible",b.style.visibility="visible"):(a.innerHTML='<video id="video-window" autoplay></video>',load(n,p,s),u=!0)),t.classList.toggle("active")}),document.getElementById("close-button").addEventListener("click",function(a){i&&QRScanner.cancelScan(function(a){})}),document.getElementById("switchcamera-button").addEventListener("click",function(a){i&&(j=(j+1)%2,QRScanner.useCamera(j,function(a,b){}))}),document.getElementById("qrtextdropdown").addEventListener("change",function(){document.getElementById("user-text").value=document.getElementById("qrtextdropdown").value,q(document.getElementById("qrtextdropdown").value)}),document.getElementById("stop-button").addEventListener("click",function(b){console.log("writing...");var c={userText:t.classList.contains("active")?v:r.value,uHistory:k},d=JSON.stringify(c);a.getDatastoreObject().setDataAsText(d),a.getDatastoreObject().save(function(a){null===a?console.log("write done."):console.log("write failed.")})}),c.getEnvironment(function(b,c){c.objectId?a.getDatastoreObject().loadAsText(function(a,b,c){null==a&&null!=c&&(c=JSON.parse(c),r.value=c.userText,k=c.uHistory,q(c.userText))}):(console.log("New instance"),r.value=c.user.name,q(c.user.name))})})});