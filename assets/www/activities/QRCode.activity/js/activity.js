/*! Sugarizer 2017-08-25 */
define(["sugar-web/activity/activity","sugar-web/datastore"],function(a,b){require(["domReady!"],function(c){a.setup();var d=(/Android/i.test(navigator.userAgent)||/iPad/i.test(navigator.userAgent)||/iPhone/i.test(navigator.userAgent))&&"http"!=document.location.protocol.substr(0,4),e=0,f=95,g=20,h=document.getElementById("canvas").parentNode.offsetHeight-f;h-=g*h/100;var i=new QRCode("qr-code",{width:h,height:h,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.H}),j=(document.getElementById("canvas").parentNode.offsetWidth-h)/2;document.getElementById("qr-code").style.marginLeft=j+"px",document.getElementById("qr-code").style.marginTop="20px";var k=function(a){i.clear(),i.makeCode(a);var a=m.value.toLowerCase();0==a.indexOf("http://")||0==a.indexOf("https://")?document.getElementById("user-text").classList.add("text-url"):document.getElementById("user-text").classList.remove("text-url")};window.addEventListener("resize",function(){var a=document.body.clientHeight-f,b=a/(h*(100+g)/100);document.getElementById("qr-code").style.zoom=b;var c=navigator.userAgent.toLowerCase();c.indexOf("chrome")==-1&&(document.getElementById("qr-code").style.MozTransform="scale("+b+")",document.getElementById("qr-code").style.MozTransformOrigin="0 0"),p&&(document.getElementById("outdiv").style.zoom=b,c.indexOf("chrome")==-1&&(document.getElementById("outdiv").style.MozTransform="scale("+b+")",document.getElementById("outdiv").style.MozTransformOrigin="0 0"))});var l=b.localStorage.getValue("sugar_settings"),m=document.getElementById("user-text");m.value=l.name,m.addEventListener("keyup",function(){var a=m.value.toLowerCase();0==a.indexOf("http://")||0==a.indexOf("https://")?document.getElementById("user-text").classList.add("text-url"):document.getElementById("user-text").classList.remove("text-url")}),m.addEventListener("click",function(){var a=m.value.toLowerCase();0!=a.indexOf("http://")&&0!=a.indexOf("https://")||window.open(m.value)}),document.getElementById("generate-button").addEventListener("click",function(){k(m.value)});var n=function(a){document.getElementById("outdiv").style.visibility="hidden",document.getElementById("video-stream").style.visibility="hidden",document.getElementById("qr-code").style.visibility="visible",document.getElementById("loading-spinner").style.visibility="hidden",document.getElementById("photo-button").classList.remove("active"),m.value=a,k(a)};document.getElementById("png-button").addEventListener("click",function(){var a="image/png",c=document.getElementById("qr-code").childNodes[1].src,d={mimetype:a,title:"Image QR Code",activity:"org.olpcfrance.MediaViewerActivity",timestamp:(new Date).getTime(),creation_time:(new Date).getTime(),file_size:0};b.create(d,function(){console.log("export done.")},c)}),document.getElementById("fullscreen-button").addEventListener("click",function(){document.getElementById("photo-button").classList.contains("active")||(document.getElementById("main-toolbar").style.opacity=0,document.getElementById("input-box").style.opacity=0,document.getElementById("canvas").style.top="0px",document.getElementById("unfullscreen-button").style.visibility="visible")}),document.getElementById("unfullscreen-button").addEventListener("click",function(){document.getElementById("main-toolbar").style.opacity=1,document.getElementById("input-box").style.opacity=1,document.getElementById("canvas").style.top="55px",document.getElementById("unfullscreen-button").style.visibility="hidden"});var o=document.getElementById("photo-button"),p=!1,q="";o.addEventListener("click",function(){if(d)return document.getElementById("main-toolbar").style.opacity=0,document.getElementById("canvas").style.opacity=0,document.getElementById("close-button").style.visibility="visible",document.getElementById("switchcamera-button").style.visibility="visible",void QRScanner.prepare(function(a,b){a?console.log("Error "+a):(console.log(b),QRScanner.scan(function(a,b){a?console.log("Error "+a):(m.value=b,k(b)),document.getElementById("main-toolbar").style.opacity=1,document.getElementById("canvas").style.opacity=1,document.getElementById("close-button").style.visibility="hidden",document.getElementById("switchcamera-button").style.visibility="hidden"}),QRScanner.show(function(a){}))});var a=document.getElementById("outdiv"),b=document.getElementById("video-stream");o.classList.contains("active")?(a.style.visibility="hidden",b.style.visibility="hidden",document.getElementById("loading-spinner").style.visibility="hidden",document.getElementById("qr-code").style.visibility="visible",m.value=q,k(m.value)):(document.getElementById("qr-code").style.visibility="hidden",document.getElementById("loading-spinner").style.visibility="visible",q=m.value,m.value="",p?(a.style.visibility="visible",b.style.visibility="visible"):(a.innerHTML='<video id="video-window" autoplay></video>',load(h,j,n),p=!0)),o.classList.toggle("active")}),document.getElementById("close-button").addEventListener("click",function(a){d&&QRScanner.cancelScan(function(a){})}),document.getElementById("switchcamera-button").addEventListener("click",function(a){d&&(e=(e+1)%2,QRScanner.useCamera(e,function(a,b){}))});var r=document.getElementById("stop-button");r.addEventListener("click",function(b){console.log("writing...");var c={userText:o.classList.contains("active")?q:m.value},d=JSON.stringify(c);a.getDatastoreObject().setDataAsText(d),a.getDatastoreObject().save(function(a){null===a?console.log("write done."):console.log("write failed.")})}),k(l.name),a.getDatastoreObject().getMetadata(function(b,c){console.log("datastore check");var d=(new Date).getTime();Math.abs(d-c.creation_time)<2e3?console.log("Time too short"):a.getDatastoreObject().loadAsText(function(a,b,c){null==a&&null!=c&&(c=JSON.parse(c),m.value=c.userText,k(c.userText))})})})});