/*! Sugarizer 2018-06-12 */
define(["sugar-web/activity/activity","sugar-web/datastore","sugar-web/env","webL10n"],function(a,b,c,d){require(["domReady!","humane"],function(e,f){a.setup();var g=(/Android/i.test(navigator.userAgent)||/iPad/i.test(navigator.userAgent)||/iPhone/i.test(navigator.userAgent))&&"http"!=document.location.protocol.substr(0,4),h=0;c.getEnvironment(function(a,b){var c="undefined"!=typeof chrome&&chrome.app&&chrome.app.runtime?chrome.i18n.getUILanguage():navigator.language,e=b.user?b.user.language:c;d.language.code=e});var i=95,j=20,k=document.getElementById("canvas").parentNode.offsetHeight-i;k-=j*k/100;var l=new QRCode("qr-code",{width:k,height:k,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.H}),m=(document.getElementById("canvas").parentNode.offsetWidth-k)/2;document.getElementById("qr-code").style.marginLeft=m+"px",document.getElementById("qr-code").style.marginTop="20px";var n=function(a){l.clear(),l.makeCode(a);var a=o.value.toLowerCase();0==a.indexOf("http://")||0==a.indexOf("https://")?document.getElementById("user-text").classList.add("text-url"):document.getElementById("user-text").classList.remove("text-url")};window.addEventListener("resize",function(){var a=document.body.clientHeight-i,b=a/(k*(100+j)/100);document.getElementById("qr-code").style.zoom=b;var c=navigator.userAgent.toLowerCase();c.indexOf("chrome")==-1&&(document.getElementById("qr-code").style.MozTransform="scale("+b+")",document.getElementById("qr-code").style.MozTransformOrigin="0 0"),r&&(document.getElementById("outdiv").style.zoom=b,c.indexOf("chrome")==-1&&(document.getElementById("outdiv").style.MozTransform="scale("+b+")",document.getElementById("outdiv").style.MozTransformOrigin="0 0"))});var o=document.getElementById("user-text");o.addEventListener("keyup",function(){var a=o.value.toLowerCase();0==a.indexOf("http://")||0==a.indexOf("https://")?document.getElementById("user-text").classList.add("text-url"):document.getElementById("user-text").classList.remove("text-url")}),o.addEventListener("click",function(){var a=o.value.toLowerCase();0!=a.indexOf("http://")&&0!=a.indexOf("https://")||window.open(o.value)}),document.getElementById("generate-button").addEventListener("click",function(){n(o.value)});var p=function(a){document.getElementById("outdiv").style.visibility="hidden",document.getElementById("video-stream").style.visibility="hidden",document.getElementById("qr-code").style.visibility="visible",document.getElementById("loading-spinner").style.visibility="hidden",document.getElementById("photo-button").classList.remove("active"),o.value=a,n(a)};document.getElementById("png-button").addEventListener("click",function(){var a="image/png",c=document.getElementById("qr-code").childNodes[1].src,e={mimetype:a,title:"Image QR Code",activity:"org.olpcfrance.MediaViewerActivity",timestamp:(new Date).getTime(),creation_time:(new Date).getTime(),file_size:0};b.create(e,function(){f.log(d.get("QRCodeSaved")),console.log("export done.")},c)}),document.getElementById("fullscreen-button").addEventListener("click",function(){document.getElementById("photo-button").classList.contains("active")||(document.getElementById("main-toolbar").style.opacity=0,document.getElementById("input-box").style.opacity=0,document.getElementById("canvas").style.top="0px",document.getElementById("unfullscreen-button").style.visibility="visible")}),document.getElementById("unfullscreen-button").addEventListener("click",function(){document.getElementById("main-toolbar").style.opacity=1,document.getElementById("input-box").style.opacity=1,document.getElementById("canvas").style.top="55px",document.getElementById("unfullscreen-button").style.visibility="hidden"});var q=document.getElementById("photo-button"),r=!1,s="";q.addEventListener("click",function(){if(g)return document.getElementById("main-toolbar").style.opacity=0,document.getElementById("canvas").style.opacity=0,document.getElementById("close-button").style.visibility="visible",document.getElementById("switchcamera-button").style.visibility="visible",void QRScanner.prepare(function(a,b){a?console.log("Error "+a):(console.log(b),QRScanner.scan(function(a,b){a?console.log("Error "+a):(o.value=b,n(b)),document.getElementById("main-toolbar").style.opacity=1,document.getElementById("canvas").style.opacity=1,document.getElementById("close-button").style.visibility="hidden",document.getElementById("switchcamera-button").style.visibility="hidden"}),QRScanner.show(function(a){}))});var a=document.getElementById("outdiv"),b=document.getElementById("video-stream");q.classList.contains("active")?(a.style.visibility="hidden",b.style.visibility="hidden",document.getElementById("loading-spinner").style.visibility="hidden",document.getElementById("qr-code").style.visibility="visible",o.value=s,n(o.value)):(document.getElementById("qr-code").style.visibility="hidden",document.getElementById("loading-spinner").style.visibility="visible",s=o.value,o.value="",r?(a.style.visibility="visible",b.style.visibility="visible"):(a.innerHTML='<video id="video-window" autoplay></video>',load(k,m,p),r=!0)),q.classList.toggle("active")}),document.getElementById("close-button").addEventListener("click",function(a){g&&QRScanner.cancelScan(function(a){})}),document.getElementById("switchcamera-button").addEventListener("click",function(a){g&&(h=(h+1)%2,QRScanner.useCamera(h,function(a,b){}))});var t=document.getElementById("stop-button");t.addEventListener("click",function(b){console.log("writing...");var c={userText:q.classList.contains("active")?s:o.value},d=JSON.stringify(c);a.getDatastoreObject().setDataAsText(d),a.getDatastoreObject().save(function(a){null===a?console.log("write done."):console.log("write failed.")})}),c.getEnvironment(function(b,c){c.objectId?a.getDatastoreObject().loadAsText(function(a,b,c){null==a&&null!=c&&(c=JSON.parse(c),o.value=c.userText,n(c.userText))}):(console.log("New instance"),o.value=c.user.name,n(c.user.name))})})});