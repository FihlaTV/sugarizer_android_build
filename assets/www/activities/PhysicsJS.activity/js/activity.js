/*! Sugarizer 2019-09-21 */
define(["sugar-web/activity/activity"],function(a){requirejs(["domReady!"],function(b){a.setup();var c=navigator.userAgent.toLowerCase(),d=document.getElementById("sensor-button"),e=document.getElementById("gravity-button"),f=document.getElementById("apple-button"),g=document.getElementById("run-button"),h=!1,i=!0,j=!1,k=null;-1!=c.indexOf("android")||-1!=c.indexOf("iphone")||-1!=c.indexOf("ipad")||-1!=c.indexOf("ipod")||-1!=c.indexOf("mozilla/5.0 (mobile")?(document.addEventListener("deviceready",function(){h=!0},!1),d.disabled=!1,d.classList.add("active")):d.disabled=!0;var l=document.getElementById("body"),m=l.offsetWidth,n=l.offsetHeight,o=55,p=0,q=!1,r=0,s=0,t=!0;Physics({timestep:6},function(b){function c(a){i&&(a.x<-4.5?F(a.y>4.75?3:a.y<-4.75?5:4):a.x<=4.5&&a.x>=-4.5?a.y>4.75?F(2):a.y<-4.75&&F(6):a.x>4.5&&F(a.y>4.75?1:a.y<-4.75?7:0))}function u(){if(1!=window.devicePixelRatio){var a=document.getElementById("viewport").children[0],c=1/window.devicePixelRatio;a.style.zoom=c;-1==navigator.userAgent.toLowerCase().indexOf("chrome")&&(a.style.MozTransform="scale("+c+")",a.style.MozTransformOrigin="0 0"),b.wakeUpAll()}}function v(a,b){return Math.random()*(b-a)+a|0}function w(a){document.getElementById("box-button").classList.remove("active"),document.getElementById("circle-button").classList.remove("active"),document.getElementById("polygon-button").classList.remove("active"),document.getElementById("triangle-button").classList.remove("active"),document.getElementById("clear-button").classList.remove("active"),0==a?document.getElementById("circle-button").classList.add("active"):1==a?document.getElementById("box-button").classList.add("active"):2==a?document.getElementById("triangle-button").classList.add("active"):3==a?document.getElementById("polygon-button").classList.add("active"):-1==a&&document.getElementById("clear-button").classList.add("active")}function x(a,c){var d,e;switch(a){case 0:e=K[v(0,K.length-1)],d=Physics.body("circle",{x:c.x,y:c.y,vx:v(-5,5)/100,radius:40,restitution:.9,styles:{fillStyle:e[0],strokeStyle:e[1],lineWidth:1,angleIndicator:e[1]}});break;case 1:e=K[v(0,K.length-1)];var f=v(0,70);d=Physics.body("rectangle",{width:50+f,height:50+f,x:c.x,y:c.y,vx:v(-5,5)/100,restitution:.9,styles:{fillStyle:e[0],strokeStyle:e[1],lineWidth:1,angleIndicator:e[1]}});break;case 2:case 3:var g=2==a?3:v(5,10);e=K[v(0,K.length-1)],d=Physics.body("convex-polygon",{vertices:Physics.geometry.regularPolygonVertices(g,30),x:c.x,y:c.y,vx:v(-5,5)/100,angle:v(0,2*Math.PI),restitution:.9,styles:{fillStyle:e[0],strokeStyle:e[1],lineWidth:1,angleIndicator:e[1]}})}return d.treatment="static",b.add(d),d}function y(c){for(var d=b.getBodies(),e=[],f=0;f<d.length;f++){var g=z(d[f]);e.push(g)}var h=a.getDatastoreObject(),i=JSON.stringify({world:e});h.setDataAsText(i),h.save(c)}function z(a){var b={};return b.type=a.geometry.name,"circle"==b.type?b.radius=a.radius:"rectangle"==a.geometry.name?(b.width=a.view.width,b.height=a.view.height):"convex-polygon"==a.geometry.name&&(b.vertices=a.vertices),b.restitution=a.restitution,b.styles=a.styles,b.x=a.view.x,b.y=a.view.y,b}function A(c){a.getDatastoreObject().loadAsText(function(a,c,d){var d=JSON.parse(d);if(null!=d)for(var e=d.world,f=0;f<e.length;f++){var g=B(e[f]);b.add(g)}})}function B(a){var b={x:a.x,y:a.y,restitution:a.restitution,styles:a.styles};return a.angle&&(b.angle=a.angle),"circle"==a.type?b.radius=a.radius:"rectangle"==a.type?(b.width=a.width,b.height=a.height):(a.type="convex-polygon")&&(b.vertices=a.vertices),Physics.body(a.type,b)}function C(){b.getBodies().forEach(function(a,b,c){a.treatment="static"})}function D(){b.getBodies().forEach(function(a,b,c){a.treatment="dynamic"})}function E(){t?(document.getElementById("run-button").classList.remove("running"),document.getElementById("run-button").setAttribute("title","Play"),C()):(document.getElementById("run-button").classList.add("running"),document.getElementById("run-button").setAttribute("title","Pause"),Physics.util.ticker.start(),D()),t=!t}function F(a){if(r!=a){var c={};switch(a){case 0:c={x:0,y:4e-4};break;case 1:c={x:4e-4,y:4e-4};break;case 2:c={x:4e-4,y:0};break;case 3:c={x:4e-4,y:-4e-4};break;case 4:c={x:0,y:-4e-4};break;case 5:c={x:-4e-4,y:-4e-4};break;case 6:c={x:-4e-4,y:0};break;case 7:c={x:-4e-4,y:4e-4}}var d=-90==window.orientation?-1:1;c={x:c.x*d,y:c.y*d},document.getElementById("gravity-button").style.backgroundImage="url(icons/gravity"+(-1==d?(a+4)%8:a)+".svg)",N.setAcceleration(c),b.wakeUpAll(),r=a}}var G,H,I=Physics.aabb(0-p,o,m+p,n);requirejs(["pixi"],function(a){window.PIXI=a,H=Physics.renderer("pixi",{el:"viewport"}),b.add(H),b.on("step",function(){b.render(),q||(q=!0,u()),h&&(watchId=navigator.accelerometer.watchAcceleration(c,null,{frequency:500}),h=!1)}),b.add(Physics.behavior("interactive",{el:H.container}))}),G=Physics.behavior("edge-collision-detection",{aabb:I,restitution:.2,cof:.8}),window.addEventListener("resize",function(){k&&clearTimeout(k),resizerTimer=setTimeout(function(){H.resize(l.offsetWidth,l.offsetHeight),I=Physics.aabb(0-p,o,H.width+p,H.height),G.setAABB(I),m=l.offsetWidth,n=l.offsetHeight,u()},500)},!0),document.getElementById("box-button").addEventListener("click",function(a){s=1,w(s)},!0),document.getElementById("circle-button").addEventListener("click",function(a){s=0,w(s)},!0),document.getElementById("triangle-button").addEventListener("click",function(a){s=2,w(s)},!0),document.getElementById("polygon-button").addEventListener("click",function(a){s=3,w(s)},!0),e.addEventListener("click",function(){F((r+1)%8)},!0),g.addEventListener("click",function(){E()},!0),document.getElementById("clear-button").addEventListener("click",function(){s=-1,w(s)},!0),d.addEventListener("click",function(){i=!i,i?d.classList.add("active"):d.classList.remove("active")},!0),f.addEventListener("click",function(){j=!j,j?(b.remove(N),b.add(O),f.classList.add("active"),e.disabled=!0):(b.remove(O),b.add(N),f.classList.remove("active"),e.disabled=!1)},!0),A(),document.getElementById("stop-button").addEventListener("click",function(a){console.log("writing..."),y(function(a){null===a?console.log("write done."):console.log("write failed.")})});var J=function(){H?H.resize(l.offsetWidth,l.offsetHeight):setTimeout(J,300)};setTimeout(J,300);var K=[["0x268bd2","0x0d394f"],["0xc93b3b","0x561414"],["0xe25e36","0x79231b"],["0x6c71c4","0x393f6a"],["0x58c73c","0x30641c"],["0xcac34c","0x736a2c"]],L=null,M=null;b.on({"interact:poke":function(a){-1!=s&&a.y>o&&(L=x(s,a),M=a)},"interact:move":function(a){if(null!=L){var c=M.x-a.x,d=M.y-a.y,e=Math.min(Math.sqrt(Math.abs(c*c-d*d)),M.y-o);if(null!=L.view){var f=z(L);"circle"==f.type?f.radius=Math.max(40,e):"rectangle"==f.type?f.width=f.height=Math.max(50,e):(f.type="convex-polygon")&&(f.vertices=Physics.geometry.regularPolygonVertices(f.vertices.length,Math.max(30,e))),b.removeBody(L);var g=new Physics.vector(M.x,0),h=new Physics.vector(a.x-M.x,a.y-M.y);f.angle=-g.angle(h),L=B(f),L.treatment="static",b.add(L)}}},"interact:release":function(a){t&&(null!=L&&(L.treatment="dynamic"),b.wakeUpAll()),L=null},"interact:grab":function(a){-1==s&&b.remove(a.body)}});var N=Physics.behavior("constant-acceleration"),O=Physics.behavior("newtonian",{strength:.5});b.add([N,Physics.behavior("body-impulse-response"),Physics.behavior("body-collision-detection"),Physics.behavior("sweep-prune"),G]),Physics.util.ticker.on(function(a){b.step(a);var c=b.getBodies(),d=p/2;if(d>0)for(var e=0;e<c.length;e++){var f=c[e];(f.state.pos.x<0-d||f.state.pos.x>m+d)&&b.remove(f)}})})})});