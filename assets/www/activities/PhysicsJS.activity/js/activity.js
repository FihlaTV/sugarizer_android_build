/*! Sugarizer 2017-09-04 */
define(["sugar-web/activity/activity"],function(a){require(["domReady!"],function(b){a.setup();var c=navigator.userAgent.toLowerCase(),d=document.getElementById("sensor-button"),e=document.getElementById("gravity-button"),f=document.getElementById("apple-button"),g=!1,h=!0,i=!1;c.indexOf("android")!=-1||c.indexOf("iphone")!=-1||c.indexOf("ipad")!=-1||c.indexOf("ipod")!=-1||c.indexOf("mozilla/5.0 (mobile")!=-1?(document.addEventListener("deviceready",function(){g=!0},!1),d.disabled=!1,d.classList.add("active")):d.disabled=!0;var j=document.getElementById("body"),k=j.offsetWidth,l=j.offsetHeight,m=55,n=0,o=!1,p=0,q=0;Physics({timestep:6},function(b){function c(a){h&&(a.x<-4.5?z(a.y>4.75?3:a.y<-4.75?5:4):a.x<=4.5&&a.x>=-4.5?a.y>4.75?z(2):a.y<-4.75&&z(6):a.x>4.5&&z(a.y>4.75?1:a.y<-4.75?7:0))}function r(){if(1!=window.devicePixelRatio){var a=document.getElementById("viewport").children[0],b=1/window.devicePixelRatio;a.style.zoom=b;var c=navigator.userAgent.toLowerCase();c.indexOf("chrome")==-1&&(a.style.MozTransform="scale("+b+")",a.style.MozTransformOrigin="0 0")}}function s(a,b){return Math.random()*(b-a)+a|0}function t(a){document.getElementById("box-button").classList.remove("active"),document.getElementById("circle-button").classList.remove("active"),document.getElementById("polygon-button").classList.remove("active"),document.getElementById("triangle-button").classList.remove("active"),document.getElementById("clear-button").classList.remove("active"),0==a?document.getElementById("circle-button").classList.add("active"):1==a?document.getElementById("box-button").classList.add("active"):2==a?document.getElementById("triangle-button").classList.add("active"):3==a?document.getElementById("polygon-button").classList.add("active"):a==-1&&document.getElementById("clear-button").classList.add("active")}function u(a,c){var d,e;switch(a){case 0:e=E[s(0,E.length-1)],d=Physics.body("circle",{x:c.x,y:c.y,vx:s(-5,5)/100,radius:40,restitution:.9,styles:{fillStyle:e[0],strokeStyle:e[1],lineWidth:1,angleIndicator:e[1]}});break;case 1:e=E[s(0,E.length-1)];var f=s(0,70);d=Physics.body("rectangle",{width:50+f,height:50+f,x:c.x,y:c.y,vx:s(-5,5)/100,restitution:.9,styles:{fillStyle:e[0],strokeStyle:e[1],lineWidth:1,angleIndicator:e[1]}});break;case 2:case 3:var g=2==a?3:s(5,10);e=E[s(0,E.length-1)],d=Physics.body("convex-polygon",{vertices:Physics.geometry.regularPolygonVertices(g,30),x:c.x,y:c.y,vx:s(-5,5)/100,angle:s(0,2*Math.PI),restitution:.9,styles:{fillStyle:e[0],strokeStyle:e[1],lineWidth:1,angleIndicator:e[1]}})}return d.treatment="static",b.add(d),d}function v(c){for(var d=b.getBodies(),e=[],f=0;f<d.length;f++){var g=w(d[f]);e.push(g)}var h=a.getDatastoreObject(),i=JSON.stringify({world:e});h.setDataAsText(i),h.save(c)}function w(a){var b={};return b.type=a.geometry.name,"circle"==b.type?b.radius=a.radius:"rectangle"==a.geometry.name?(b.width=a.view.width,b.height=a.view.height):"convex-polygon"==a.geometry.name&&(b.vertices=a.vertices),b.restitution=a.restitution,b.styles=a.styles,b.x=a.view.x,b.y=a.view.y,b}function x(c){var d=a.getDatastoreObject();d.loadAsText(function(a,c,d){var d=JSON.parse(d);if(null!=d)for(var e=d.world,f=0;f<e.length;f++){var g=y(e[f]);b.add(g)}})}function y(a){var b={x:a.x,y:a.y,restitution:a.restitution,styles:a.styles};return a.angle&&(b.angle=a.angle),"circle"==a.type?b.radius=a.radius:"rectangle"==a.type?(b.width=a.width,b.height=a.height):(a.type="convex-polygon")&&(b.vertices=a.vertices),Physics.body(a.type,b)}function z(a){if(p!=a){document.getElementById("gravity-button").style.backgroundImage="url(icons/gravity"+a+".svg)";var c={};switch(a){case 0:c={x:0,y:4e-4};break;case 1:c={x:4e-4,y:4e-4};break;case 2:c={x:4e-4,y:0};break;case 3:c={x:4e-4,y:-4e-4};break;case 4:c={x:0,y:-4e-4};break;case 5:c={x:-4e-4,y:-4e-4};break;case 6:c={x:-4e-4,y:0};break;case 7:c={x:-4e-4,y:4e-4}}H.setAcceleration(c),b.wakeUpAll(),p=a}}var A,B,C=Physics.aabb(0-n,m,k+n,l);require(["pixi"],function(a){window.PIXI=a,B=Physics.renderer("pixi",{el:"viewport"}),b.add(B),b.on("step",function(){b.render(),o||(o=!0,r()),g&&(watchId=navigator.accelerometer.watchAcceleration(c,null,{frequency:500}),g=!1)}),b.add(Physics.behavior("interactive",{el:B.container}))}),A=Physics.behavior("edge-collision-detection",{aabb:C,restitution:.2,cof:.8}),window.addEventListener("resize",function(){C=Physics.aabb(0-n,m,B.width+n,B.height),A.setAABB(C),k=j.offsetWidth,l=j.offsetHeight,r()},!0),document.getElementById("box-button").addEventListener("click",function(a){q=1,t(q)},!0),document.getElementById("circle-button").addEventListener("click",function(a){q=0,t(q)},!0),document.getElementById("triangle-button").addEventListener("click",function(a){q=2,t(q)},!0),document.getElementById("polygon-button").addEventListener("click",function(a){q=3,t(q)},!0),e.addEventListener("click",function(){z((p+1)%8)},!0),document.getElementById("clear-button").addEventListener("click",function(){q=-1,t(q)},!0),d.addEventListener("click",function(){h=!h,h?d.classList.add("active"):d.classList.remove("active")},!0),f.addEventListener("click",function(){i=!i,i?(b.remove(H),b.add(I),f.classList.add("active"),e.disabled=!0):(b.remove(I),b.add(H),f.classList.remove("active"),e.disabled=!1)},!0),x();var D=document.getElementById("stop-button");D.addEventListener("click",function(a){console.log("writing..."),v(function(a){null===a?console.log("write done."):console.log("write failed.")})});var E=[["0x268bd2","0x0d394f"],["0xc93b3b","0x561414"],["0xe25e36","0x79231b"],["0x6c71c4","0x393f6a"],["0x58c73c","0x30641c"],["0xcac34c","0x736a2c"]],F=null,G=null;b.on({"interact:poke":function(a){q!=-1&&a.y>m&&(F=u(q,a),G=a)},"interact:move":function(a){if(null!=F){var c=G.x-a.x,d=G.y-a.y,e=Math.min(Math.sqrt(Math.abs(c*c-d*d)),G.y-m);if(null!=F.view){var f=w(F);"circle"==f.type?f.radius=Math.max(40,e):"rectangle"==f.type?f.width=f.height=Math.max(50,e):(f.type="convex-polygon")&&(f.vertices=Physics.geometry.regularPolygonVertices(f.vertices.length,Math.max(30,e))),b.removeBody(F);var g=new Physics.vector(G.x,0),h=new Physics.vector(a.x-G.x,a.y-G.y);f.angle=-g.angle(h),F=y(f),F.treatment="static",b.add(F)}}},"interact:release":function(a){null!=F&&(F.treatment="dynamic",F=null),b.wakeUpAll()},"interact:grab":function(a){q==-1&&b.remove(a.body)}});var H=Physics.behavior("constant-acceleration"),I=Physics.behavior("newtonian",{strength:.5});b.add([H,Physics.behavior("body-impulse-response"),Physics.behavior("body-collision-detection"),Physics.behavior("sweep-prune"),A]),Physics.util.ticker.on(function(a){b.step(a);var c=b.getBodies(),d=n/2;if(d>0)for(var e=0;e<c.length;e++){var f=c[e];(f.state.pos.x<0-d||f.state.pos.x>k+d)&&b.remove(f)}})})})});