/*! Sugarizer 2019-09-21 */
define(["sugar-web/activity/activity","activity/palettes/format-text-palette","activity/palettes/list-palette","activity/palettes/paragraph-palette","activity/palettes/font-palette","sugar-web/graphics/colorpalette","sugar-web/datastore","sugar-web/graphics/journalchooser","sugar-web/env","sugar-web/graphics/presencepalette","activity/palettes/export-palette","webL10n"],function(a,b,c,d,e,f,g,h,i,j,k,l){requirejs(["domReady!","humane"],function(m,n){function o(a){var b=T;return b=b.replace("#010101",a.stroke),b=b.replace("#FFFFFF",a.fill),"data:image/svg+xml;base64,"+btoa(b)}function p(){var a=document.getElementById("presence-users"),b="<hr><ul style='list-style: none; padding:0;'>";for(var c in U)b+="<li><img style='height:30px;' src='"+o(U[c].colorvalue)+"'>"+U[c].name+"</li>";b+="</ul>",a.innerHTML=b}function q(a){var b=document.getElementById("presence-users");a&&b&&(U={},N.listSharedActivityUsers(N.getSharedInfo().id,function(a){U={};for(var b=0;b<a.length;b++){var c=a[b];U[b]=c}p()}))}a.setup();var r={modules:{toolbar:"#main-toolbar",history:{maxStack:500},imageResize:{},cursors:{transformOnTextChange:!0},clipboard:!0}};Quill.register("modules/cursors",QuillCursors);var s=document.getElementById("editor"),t=new Quill(s,r);t.focus(),t.format("size","24px");const u=t.getModule("cursors"),v=Quill.import("delta");i.getEnvironment(function(b,c){currentenv=c;var d="undefined"!=typeof chrome&&chrome.app&&chrome.app.runtime?chrome.i18n.getUILanguage():navigator.language,e=c.user?c.user.language:d;l.language.code=e,window.addEventListener("localized",function(){document.getElementById("network-button").title=l.get("Network"),document.getElementById("color-button-1").title=l.get("ForegroundColor"),document.getElementById("color-button-2").title=l.get("BackgroundColor"),document.getElementById("format-text").title=l.get("Formattext"),document.getElementById("paragraph").title=l.get("Paragraph"),document.getElementById("list").title=l.get("List"),document.getElementById("resize-inc").title=l.get("Increasefontsize"),document.getElementById("font-button").title=l.get("ChooseFont"),document.getElementById("resize-dec").title=l.get("Decreasefontsize"),document.getElementById("insert-picture").title=l.get("Image"),document.getElementById("edit-undo").title=l.get("Undo"),document.getElementById("edit-redo").title=l.get("Redo"),document.getElementById("edit-copy").title=l.get("Copy"),document.getElementById("edit-paste").title=l.get("Paste"),document.getElementById("export").title=l.get("Export"),document.getElementById(5).title=l.get("Bold"),document.getElementById(6).title=l.get("Italic"),document.getElementById(7).title=l.get("Underline"),document.getElementById(8).title=l.get("Strike"),document.getElementById(9).title=l.get("OrderedList"),document.getElementById(10).title=l.get("UnorderedList"),document.getElementById(11).title=l.get("JustifyLeft"),document.getElementById(12).title=l.get("JustifyRight"),document.getElementById(13).title=l.get("JustifyCenter"),document.getElementById(19).title=l.get("ExportToTxt"),document.getElementById(20).title=l.get("ExportToPdf"),document.getElementById(21).title=l.get("ExportToDoc"),document.getElementById(22).title=l.get("ExportToOdt")}),c.objectId||c.sharedId?a.getDatastoreObject().loadAsText(function(a,b,c){if(null==a&&null!=c){var d=JSON.parse(c);console.log(d),t.setContents(d)}}):setTimeout(function(){t.setContents([{insert:l.get("Welcome",{username:c.user.name})+"\n",attributes:{size:"40px",color:c.user.colorvalue.stroke,bold:!0}}]);var a=t.getLength();t.clipboard.dangerouslyPasteHTML(a,l.get("Write")),a=t.getLength(),t.clipboard.dangerouslyPasteHTML(a,l.get("Writefeatures")),a=t.getLength(),t.clipboard.dangerouslyPasteHTML(a,l.get("Enjoy")),a=t.getLength(),t.clipboard.dangerouslyPasteHTML(a,"<br></br>"),a=t.getLength(),t.updateContents((new v).retain(t.getSelection().index+1).insert({image:window.initialImageDataUrl}))},200),c.sharedId&&(console.log("Shared instance"),document.getElementById("edit-undo").style.display="none",document.getElementById("edit-redo").style.display="none",document.getElementById("shared-button").click(),N=a.getPresenceObject(function(a,b){b.onDataReceived(R),b.onSharedActivityUserChanged(S)}))}),document.getElementById("stop-button").addEventListener("click",function(b){var c=t.getContents(),d=JSON.stringify(c);a.getDatastoreObject().setDataAsText(d),a.getDatastoreObject().save(function(a){null===a?console.log("write done."):console.log("write failed.")})});var w=!1,x=null;document.getElementById("edit-copy").addEventListener("click",function(){var a=t.getSelection();x=t.getContents(a.index,a.length),document.execCommand("copy")}),document.getElementById("edit-paste").addEventListener("click",function(){document.execCommand("paste")||null!=x&&(w=!0,t.updateContents((new v).retain(t.getSelection().index).concat(x)))}),t.keyboard.addBinding({key:"C",shortKey:!0},function(){document.getElementById("edit-copy").click()}),document.getElementById("edit-undo").addEventListener("click",function(){t.history.undo()}),document.getElementById("edit-redo").addEventListener("click",function(){t.history.redo()});var y=document.getElementById("format-text"),z=[{id:5,title:"bold",cmd:"bold"},{id:6,title:"italic",cmd:"italic"},{id:7,title:"underline",cmd:"underline"},{id:8,title:"strike",cmd:"strikeThrough"}];b=new b.Formatpalette(y,void 0),b.setCategories(z),b.addEventListener("format",function(){b.popDown(),t.focus()}),document.getElementById(5).addEventListener("click",function(){document.getElementById("bold").click()}),document.getElementById(6).addEventListener("click",function(){document.getElementById("italic").click()}),document.getElementById(7).addEventListener("click",function(){document.getElementById("underline").click()}),document.getElementById(8).addEventListener("click",function(){document.getElementById("strike").click()});var A=document.getElementById("list"),B=[{id:10,title:"unordered list",cmd:"insertUnorderedList"},{id:9,title:"ordered list",cmd:"insertorderedList"}];c=new c.Listpalette(A,void 0),c.setCategories(B),c.addEventListener("list",function(){c.popDown()}),document.getElementById("9").addEventListener("click",function(){document.getElementById("list-ordered").click()}),document.getElementById("10").addEventListener("click",function(){document.getElementById("list-unordered").click()});var C=document.getElementById("paragraph"),D=[{id:11,title:"justify Left",cmd:"justifyLeft"},{id:13,title:"justify Center",cmd:"justifyCenter"},{id:12,title:"justify Right",cmd:"justifyRight"}];d=new d.Parapalette(C,void 0),d.setCategories(D),d.addEventListener("para",function(){d.popDown(),t.focus()}),document.getElementById(11).addEventListener("click",function(){w=!0,t.format("align","justify")}),document.getElementById(12).addEventListener("click",function(){w=!0,t.format("align","right")}),document.getElementById(13).addEventListener("click",function(){w=!0,t.format("align","center")});var E=document.getElementById("font-button");e=new e.Fontpalette(E),e.addEventListener("fontChange",function(a){var b=a.detail.family;"Arial"==b&&(b="arial"),"Comic Sans MS"==b&&(b="comic"),w=!0,t.format("font",b)});var F=document.getElementById("color-button-1"),G=new f.ColorPalette(F);G.setColor("rgb(0, 0, 0)"),G.addEventListener("colorChange",function(a){w=!0,t.format("color",a.detail.color)});var H=document.getElementById("color-button-2"),I=new f.ColorPalette(H);I.setColor("rgb(255,255,255)"),I.addEventListener("colorChange",function(a){w=!0,t.format("background-color",a.detail.color)});var J=["16px","24px","32px","40px","48px","56px","64px","72px","80px","100px"];document.getElementById("resize-inc").addEventListener("click",function(){var a=t.getFormat();if(null==a.size){var b=J.indexOf("24px");t.format("size",J[b+1])}else{var b=J.indexOf(a.size);++b<J.length&&t.format("size",J[b])}}),document.getElementById("resize-dec").addEventListener("click",function(){var a=t.getFormat();if(null==a.size){var b=J.indexOf("24px");b>0&&t.format("size",J[b-1])}else{var b=J.indexOf(a.size);--b>=0&&t.format("size",J[b])}}),document.getElementById("insert-picture").addEventListener("click",function(a){h.show(function(a){a&&new g.DatastoreObject(a.objectId).loadAsText(function(a,b,c){t.focus(),w=!0,t.updateContents((new v).retain(t.getSelection().index).insert({image:c}))})},{mimetype:"image/png"},{mimetype:"image/jpeg"})});var K=document.getElementById("export"),r=[{id:19,title:"export to txt",cmd:"save-as-txt"},{id:20,title:"export to pdf",cmd:"save-as-pdf"},{id:21,title:"export to doc",cmd:"doc"},{id:22,title:"export to odt",cmd:"odt"}];k=new k.Exportpalette(K,void 0),k.setCategories(r),k.addEventListener("export",function(){k.popDown()}),document.getElementById("19").addEventListener("click",function(){var a=document.getElementById("title").value,b="text/plain",c=document.getElementById("editor").textContent;c=JSON.stringify(c);var d={mimetype:b,title:a+".txt",activity:"",timestamp:(new Date).getTime(),creation_time:(new Date).getTime(),file_size:0};g.create(d,function(){console.log("export done."),n.log(l.get("Txt"))},c)}),document.getElementById("20").addEventListener("click",function(){var a=document.getElementById("title").value;t.scrollingContainer.style.overflowY="visible",console.log(t.scrollingContainer.style.height);var b=t.scrollingContainer.offsetHeight;t.scrollingContainer.style.height="auto",t.scrollingContainer.scrollTop=0,html2canvas(t.scrollingContainer).then(function(c){t.scrollingContainer.style.height=b,t.scrollingContainer.style.overflowY="auto";var d=c.toDataURL("image/png"),d=c.toDataURL("image/png"),e=210,f=295,h=c.height*e/c.width,i=h,j=new jsPDF("p","mm","",!0),k=0;for(j.addImage(d,"PNG",0,k,e,h,"","FAST"),i-=f;i>=0;)k=i-h,j.addPage(),j.addImage(d,"PNG",0,k,e,h,"","FAST"),i-=f;var m=j.output("dataurlstring"),o="application/pdf",p={mimetype:o,title:a+".pdf",activity:"",timestamp:(new Date).getTime(),creation_time:(new Date).getTime(),file_size:0};g.create(p,function(){console.log("export done."),n.log(l.get("Pdf"))},m)})}),document.getElementById(21).addEventListener("click",function(){var a=document.getElementById("title").value,b=document.getElementById("editor").innerHTML,c="<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'></head><body>",d="</body></html>",e=c+b+d,f="data:application/vnd.ms-word;charset=utf-8;base64,"+btoa(unescape(encodeURIComponent(e))),h="application/msword",i={mimetype:h,title:a+".doc",activity:"",timestamp:(new Date).getTime(),creation_time:(new Date).getTime(),file_size:0};g.create(i,function(){console.log("export done."),n.log(l.get("Doc"))},f)}),document.getElementById("22").addEventListener("click",function(){var a=document.getElementsByClassName("ql-editor"),b=traverse(a[0]),c="application/vnd.oasis.opendocument.text",d=document.getElementById("title").value,e="data:application/vnd.oasis.opendocument.text;charset=utf-8;base64,"+btoa(unescape(encodeURIComponent(b))),f={mimetype:c,title:d+".odt",activity:"",timestamp:(new Date).getTime(),creation_time:(new Date).getTime(),file_size:0};g.create(f,function(){console.log("export done."),n.log(l.get("Odt")),resetXML()},e)}),t.on("text-change",function(a,b,c){if(("user"==c||1==w)&&null!=N){var d=t.getSelection();N.sendMessage(N.getSharedInfo().id,{user:N.getUserInfo(),content:{action:"typing",data:a,range:d}}),w=!1}}),t.on("selection-change",function(a,b,c){a&&null!=N&&N.sendMessage(N.getSharedInfo().id,{user:N.getUserInfo(),content:{action:"selection",range:a}})});var L,M,N=null,O=!1,P=!1,Q=new j.PresencePalette(document.getElementById("network-button"),void 0);Q.addEventListener("shared",function(){Q.popDown(),console.log("Want to share"),N=a.getPresenceObject(function(a,b){if(a)return void console.log("Sharing error");b.createSharedActivity("org.sugarlabs.Write",function(a){console.log("Activity shared"),O=!0}),b.onDataReceived(R),b.onSharedActivityUserChanged(S)})});var R=function(a){if(N.getUserInfo().networkId!==a.user.networkId){if("init"==a.content.action&&0==P){t.updateContents(a.content.data);for(var b=a.content.allcursors,c=0;c<b.length;c++)console.log(b[c]),b[c].id!=L&&(u.createCursor(b[c].id,b[c].name,b[c].color),u.moveCursor(b[c].id,b[c].range));u.update(),document.getElementById("list-ordered").click(),document.getElementById("list-ordered").click(),P=!0}"typing"==a.content.action&&t.updateContents(a.content.data),"selection"==a.content.action&&setTimeout(function(){u.moveCursor(a.user.networkId,a.content.range)},5)}},S=function(a){if(O){var b=t.getContents(),c=t.getSelection();M.range=c;var d=u.cursors();N.sendMessage(N.getSharedInfo().id,{user:N.getUserInfo(),content:{action:"init",data:b,allcursors:d}}),M.range=null}L||(L=a.user.networkId);var e=a.user.name.replace("<","&lt;").replace(">","&gt;"),f="<img style='height:30px;' src='"+o(a.user.colorvalue)+"'>";N.listSharedActivities(function(a){for(var b=0;b<a.length;b++)a[b].id===N.getSharedInfo().id&&q(a[b].users)});for(var g in U)console.log(U[g].name,g,U[g].networkId);if(1==a.move){n.log(f+l.get("PlayerJoin",{user:e}));var h=u.createCursor(a.user.networkId,e,a.user.colorvalue.stroke);L==a.user.networkId&&(M=h)}-1===a.move&&(u.removeCursor(a.user.networkId),n.log(f+l.get("PlayerLeave",{user:e})),a.user.networkId==U[0].networkId&&U[1].networkId==L&&(document.getElementById(3).style.display="inline",document.getElementById(4).style.display="inline",O=!0))},T='<?xml version="1.0" ?><!DOCTYPE svg  PUBLIC \'-//W3C//DTD SVG 1.1//EN\'  \'http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd\' [<!ENTITY stroke_color "#010101"><!ENTITY fill_color "#FFFFFF">]><svg enable-background="new 0 0 55 55" height="55px" version="1.1" viewBox="0 0 55 55" width="55px" x="0px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" y="0px"><g display="block" id="stock-xo_1_"><path d="M33.233,35.1l10.102,10.1c0.752,0.75,1.217,1.783,1.217,2.932   c0,2.287-1.855,4.143-4.146,4.143c-1.145,0-2.178-0.463-2.932-1.211L27.372,40.961l-10.1,10.1c-0.75,0.75-1.787,1.211-2.934,1.211   c-2.284,0-4.143-1.854-4.143-4.141c0-1.146,0.465-2.184,1.212-2.934l10.104-10.102L11.409,24.995   c-0.747-0.748-1.212-1.785-1.212-2.93c0-2.289,1.854-4.146,4.146-4.146c1.143,0,2.18,0.465,2.93,1.214l10.099,10.102l10.102-10.103   c0.754-0.749,1.787-1.214,2.934-1.214c2.289,0,4.146,1.856,4.146,4.145c0,1.146-0.467,2.18-1.217,2.932L33.233,35.1z" fill="&fill_color;" stroke="&stroke_color;" stroke-width="3.5"/><circle cx="27.371" cy="10.849" fill="&fill_color;" r="8.122" stroke="&stroke_color;" stroke-width="3.5"/></g></svg>',U={}})});