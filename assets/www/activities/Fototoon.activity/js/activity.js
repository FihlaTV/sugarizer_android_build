/*! Sugarizer 2019-09-21 */
define(["sugar-web/activity/activity","sugar-web/datastore","sugar-web/env","textpalette","sugar-web/graphics/menupalette","sugar-web/graphics/journalchooser","lzstring","webL10n","toon"],function(a,b,c,d,e,f,g,h,i){function j(a){return translation=h.get(a),""==translation&&(translation=a),translation}var k=75;c.getEnvironment(function(a,b){var c="undefined"!=typeof chrome&&chrome.app&&chrome.app.runtime?chrome.i18n.getUILanguage():navigator.language,d=b.user?b.user.language:c;h.language.code=d,console.log("LANG "+d)}),requirejs(["domReady!"],function(h){a.setup();var l={version:"1",boxs:[{globes:[]}]},m=document.getElementById("mainCanvas"),n=document.getElementById("sortCanvas");m.height=window.innerHeight-k-5,m.width=4*m.height/3,m.style.left=(window.innerWidth-m.width)/2+"px";var o=document.getElementById("previous-button");o.title=j("Previous"),o.addEventListener("click",function(a){t.showPreviousBox()});var p=document.getElementById("next-button");p.title=j("Next"),p.addEventListener("click",function(a){t.showNextBox()});var q=document.getElementById("text-button");q.title=j("EditText");var r=new d.TextPalette(q,t,j("SetGlobeText")),s=document.getElementById("page-counter"),t=new i.Model(l,m,r);t.init(),t.attachPageCounterViewer(s),t.attachPrevNextButtons(o,p);var u=!0,v=document.getElementById("add-globe");v.title=j("AddAglobe");for(var w=[{icon:!0,id:i.TYPE_GLOBE,label:j("Globe")},{icon:!0,id:i.TYPE_EXCLAMATION,label:j("Exclamation")},{icon:!0,id:i.TYPE_WHISPER,label:j("Whisper")},{icon:!0,id:i.TYPE_CLOUD,label:j("Think")},{icon:!0,id:i.TYPE_RECTANGLE,label:j("Box")}],x=new e.MenuPalette(v,j("AddAglobe"),w),y=0;y<x.buttons.length;y++)x.buttons[y].addEventListener("click",function(a){t.addGlobe(this.id)});var z=document.getElementById("add-button");z.title=j("Add"),z.addEventListener("click",function(a){f.show(function(a){if(a){new b.DatastoreObject(a.objectId).loadAsText(function(b,c,d){var e=document.createElement("img");"org.olpcfrance.PaintActivity"==a.metadata.activity?e.src=g.decompressFromUTF16(JSON.parse(d).src):e.src=d,e.onload=function(){t.addImage(e.src)}})}},{mimetype:"image/png"},{mimetype:"image/jpeg"},{activity:"org.olpcfrance.PaintActivity"})}),c.getEnvironment(function(b,c){c.objectId&&a.getDatastoreObject().loadAsText(function(a,b,c){if(null==a&&null!=c){var d=JSON.parse(c),e=d.dataWithoutImages,f=d.dataImages;e.images={};for(var g in f){var h=g;e.images[h]=LZString.decompressFromUTF16(f[h])}t.setData(e),u||(t.changeToEditMode(),u=!0)}})}),document.getElementById("stop-button").addEventListener("click",function(b){console.log("writing..."),t.showWait(),u||(t.finishSort(),t.init(),u=!0);var c={};c.version=t.getData().version,c.boxs=t.getData().boxs,dataImages={};for(var d in t.getData().images){var e=d;console.log("saving image "+e),dataImages[e]=LZString.compressToUTF16(t.getData().images[e])}var f={dataWithoutImages:c,dataImages:dataImages};t.hideWait();var g=JSON.stringify(f);a.getDatastoreObject().setDataAsText(g),a.getDatastoreObject().save(function(a){null===a?console.log("write done."):console.log("write failed.")})});var A=document.getElementById("image-save");A.title=j("SaveAsImage");for(var B=[{id:"0",label:j("OneRow")},{id:"1",label:j("OneColumn")},{id:"2",label:j("TwoColumns")}],C=new e.MenuPalette(A,j("SaveAsImage"),B),y=0;y<C.buttons.length;y++)C.buttons[y].addEventListener("click",function(a){t.saveAsImage(this.id)});var D=document.getElementById("sort-button");D.title=j("Sort"),t.attachSortButton(D),D.addEventListener("click",function(a){if(!(t.getData().boxs.length<3)){if(t.showWait(),u){t.initPreviews(),n.width=window.innerWidth-2*k;var b=n.width/t.getData().boxs.length;n.height=3*b/4,n.style.left=(window.innerWidth-n.width)/2+"px",n.style.top=(window.innerHeight-n.height)/2+"px",t.initSort(n)}else t.finishSort(),t.init();t.hideWait(),u=!u}});var E=document.getElementById("clean-all-button");E.title=j("Clean"),E.addEventListener("click",function(a){t.setData(l),u||(t.changeToEditMode(),u=!0)})})});