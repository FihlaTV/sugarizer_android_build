/*! Sugarizer 2016-12-28 */
define(["sugar-web/graphics/palette","sugar-web/env","webL10n"],function(a,b,c){function d(){L=Speech(),e(function(a){M=a,L.init(M),G||document.captureEvents(Event.MOUSEMOVE);var b=30;setInterval(function(){s()},1e3/b),window.addEventListener("localized",function(){if(N)return c.language.code=M.language,void(N=!1);u();var a=window.setTimeout(function(){window.clearTimeout(a);var b=document.getElementById("speaklang").innerHTML,d=c.get("TypeSomething",{name:M.name});L.playVoice(b,d),q(d)},100)})})}function e(a){var c={name:"",language:navigator.language};if(!b.isSugarizer())return void a(c);if("undefined"!=typeof chrome&&chrome.app&&chrome.app.runtime){var d=JSON.parse(values.sugar_settings);chrome.storage.local.get("sugar_settings",function(b){a(d)})}else{var d=JSON.parse(localStorage.sugar_settings);a(d)}}function f(){for(var a=document.getElementsByClassName("palette"),b=0;b<a.length;b++)a[b].style.visibility="hidden"}function g(a){var b,c=v.getBoundingClientRect(),d=c.width-c.width/4.5,e=c.height,f=c.width/2,g=d*a/5/(a-1);if(a%2==0){for(b=0;b<Math.floor(a/2);b++)B[b+1].x=f-g/2-(Math.floor(a/2)-b-1)*g,B[b+1].y=e/3;for(b=0;b<Math.floor(a/2);b++)B[b+Math.floor(a/2)+1].x=f+g/2+b*g,B[b+Math.floor(a/2)+1].y=e/3}if(a%2==1){for(B[1].x=f,B[1].y=e/3,b=0;b<Math.floor(a/2);b++)B[b+2].x=f-(Math.floor(a/2)-b)*g,B[b+2].y=e/3;for(b=0;b<Math.floor(a/2);b++)B[b+Math.floor(a/2)+2].x=f+(b+1)*g,B[b+Math.floor(a/2)+2].y=e/3}}function h(a,b){var c=a.getBoundingClientRect();H=(b.clientX-c.left)*a.width/c.width,I=(b.clientY-c.top)*a.height/c.height}function i(){var a,b=document.getElementById("eyetype").innerHTML;for(a=1;a<=E;a++){if(w.beginPath(),w.fillStyle="#000000",1==b)w.arc(B[a].x,B[a].y,1.1*z,0,2*Math.PI),w.fill();else{var c=1.1*z;w.fillRect(B[a].x-c,B[a].y-c,2*c,2*c)}w.closePath()}for(a=1;a<=E;a++){if(w.beginPath(),w.fillStyle="#FFFFFF",1==b)w.arc(B[a].x,B[a].y,z,0,2*Math.PI),w.fill();else{var c=z;w.fillRect(B[a].x-c,B[a].y-c,2*c,2*c)}w.closePath()}}function j(a){var b,c;H==-1&&I==-1?(b=0,c=0):(b=H-B[a].x,c=I-B[a].y);var d=1,e=1;b<0&&(d=-1),c<0&&(e=-1);var f=Math.atan(Math.abs(c/b));return isNaN(f)&&(f=0),{x:d*Math.min((z-A)*Math.cos(f),Math.abs(b)),y:e*Math.min((z-A)*Math.sin(f),Math.abs(c))}}function k(){var a;for(a=1;a<=E;a++)w.beginPath(),w.fillStyle="#000000",w.arc(B[a].x+j(a).x,B[a].y+j(a).y,A,0,2*Math.PI),w.fill(),w.closePath()}function l(){document.getElementById("chat").style.display="block"}function m(){document.getElementById("chat").style.display="none"}function n(){var a=document.getElementById("userText").value,b=document.getElementById("chatbox"),c=document.createElement("li");c.style.borderRadius="10px",c.style.backgroundColor="#999999",c.style.listStyleType="none",c.style.padding="15px",c.style.margin="-15px",c.appendChild(document.createTextNode(a)),b.appendChild(c)}function o(a){"0"==document.getElementById("speaking").innerHTML&&(clearInterval(F),J=0);var b=a/70+1;b=Math.min(4,b),b=Math.max(1,b),1==K?(J-=b,J<-40&&(K=2)):2==K&&(J+=b,J>40&&(K=1))}function p(){var a=document.getElementById("rate").innerHTML,b=.01;document.getElementById("speaking").innerHTML=1,F=setInterval(function(){o(a)},1e3*b)}function q(a){""!=a&&("2"==document.getElementById("mode").innerHTML?setTimeout(function(){p()},4e3):p())}function r(){w.beginPath(),w.moveTo(C.x,C.y),w.bezierCurveTo(C.x+100,C.y+J,D.x-100,D.y+J,D.x,D.y),w.lineWidth=10,w.stroke(),w.closePath(),w.beginPath(),w.moveTo(C.x,C.y),w.bezierCurveTo(C.x+100,C.y-J,D.x-100,D.y-J,D.x,D.y),w.lineWidth=10,w.stroke(),w.closePath()}function s(){t(),E=parseInt(document.getElementById("numeyes").innerHTML),g(E),i(),k(),r()}function t(){w.clearRect(0,0,v.width,v.height),w.beginPath(),w.rect(0,0,v.width,v.height),w.fillStyle="#999999",w.fill()}function u(){document.getElementById("gamemode1-button").title=c.get("TypeSomethingToHear"),document.getElementById("gamemode2-button").title=c.get("AskRobot"),document.getElementById("gamemode3-button").title=c.get("VoiceChat"),document.getElementById("language-button").title=c.get("Language"),document.getElementById("speech-button").title=c.get("Speech"),document.getElementById("face-button").title=c.get("Face"),document.getElementById("ratelabel").innerHTML=c.get("ratelabel"),document.getElementById("pitchlabel").innerHTML=c.get("pitchlabel"),document.getElementById("eyesnumber").innerHTML=c.get("eyesnumber"),document.getElementById("eyes").title=c.get("eyes"),document.getElementById("glasses").title=c.get("glasses"),document.getElementById("speakText").title=c.get("speak"),document.getElementById("lang-en").innerHTML=c.get("langen"),document.getElementById("lang-ca").innerHTML=c.get("langca"),document.getElementById("lang-cs").innerHTML=c.get("langcs"),document.getElementById("lang-de").innerHTML=c.get("langde"),document.getElementById("lang-el").innerHTML=c.get("langel"),document.getElementById("lang-eo").innerHTML=c.get("langeo"),document.getElementById("lang-es").innerHTML=c.get("langes"),document.getElementById("lang-fi").innerHTML=c.get("langfi"),document.getElementById("lang-fr").innerHTML=c.get("langfr"),document.getElementById("lang-hu").innerHTML=c.get("langhu"),document.getElementById("lang-it").innerHTML=c.get("langit"),document.getElementById("lang-kn").innerHTML=c.get("langkn"),document.getElementById("lang-la").innerHTML=c.get("langla"),document.getElementById("lang-lv").innerHTML=c.get("langlv"),document.getElementById("lang-nl").innerHTML=c.get("langnl"),document.getElementById("lang-pl").innerHTML=c.get("langpl"),document.getElementById("lang-pt").innerHTML=c.get("langpt"),document.getElementById("lang-ro").innerHTML=c.get("langro"),document.getElementById("lang-sk").innerHTML=c.get("langsk"),document.getElementById("lang-sv").innerHTML=c.get("langsv"),document.getElementById("lang-tr").innerHTML=c.get("langtr"),document.getElementById("lang-zh").innerHTML=c.get("langzh")}var v=document.getElementById("canvas"),w=v.getContext("2d");v.width=window.innerWidth,v.height=window.innerHeight-55;var x=v.getBoundingClientRect().width,y=v.getBoundingClientRect().height,z=Math.min(x,y)/6.5,A=Math.min(x,y)/28,B=[{x:0,y:0},{x:0,y:0},{x:0,y:0},{x:0,y:0},{x:0,y:0},{x:0,y:0}],C={x:1.35*x/4,y:2*y/3},D={x:2.65*x/4,y:2*y/3},E=2;$(window).resize(function(){v.width=window.innerWidth,v.height=window.innerHeight-55,x=v.getBoundingClientRect().width,y=v.getBoundingClientRect().height,C={x:1.35*x/4,y:2*y/3},D={x:2.65*x/4,y:2*y/3},z=Math.min(x,y)/6.5,A=Math.min(x,y)/28,g()}),v.addEventListener("mousemove",function(a){h(v,a)},!1);var F,G=!!document.all,H=-1,I=-1,J=0,K=1,L=null,M={},N=!0;document.getElementById("userArea").onmouseup=function(a){f()},document.getElementById("speakText").onmousedown=function(a){var b=document.getElementById("speaklang").innerHTML,c=document.getElementById("userText").value;L.playVoice(b,c)},document.getElementById("speakText").onmouseup=function(a){var b=document.getElementById("userText").value;q(b),"3"==document.getElementById("mode").innerHTML&&n()},document.getElementById("userText").onkeypress=function(a){var b=a.keyCode||a.which;if(13==b){var c=document.getElementById("speaklang").innerHTML,d=document.getElementById("userText").value;L.playVoice(c,d),q(d),"3"==document.getElementById("mode").innerHTML&&n()}},document.getElementById("userText").oninput=function(a){var b=this.getBoundingClientRect(),c={clientX:b.left+20*document.getElementById("userText").selectionStart,clientY:b.top};h(v,c),s()},document.getElementById("userText").addEventListener("mousemove",function(a){h(v,a),s()},!1),document.getElementById("gamemode1-button").onmouseup=function(a){document.getElementById("mode").innerHTML="1",document.getElementById("canvas").style.display="block",m()},document.getElementById("gamemode2-button").onmouseup=function(a){document.getElementById("mode").innerHTML="2",document.getElementById("canvas").style.display="block",m()},document.getElementById("gamemode3-button").onmouseup=function(a){document.getElementById("mode").innerHTML="3",document.getElementById("canvas").style.display="none",l()},d()});