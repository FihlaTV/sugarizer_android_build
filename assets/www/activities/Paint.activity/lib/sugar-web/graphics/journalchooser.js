/*! Sugarizer 2017-09-04 */
define(["picoModal","sugar-web/datastore","sugar-web/graphics/icon","mustache"],function(a,b,c,d){function e(a){var b=a;for(var c in q)b=b.replace("$"+c,q[c]);return b}function f(a,c,e,f){var h=[];a&&h.push(a),c&&h.push(c),e&&h.push(e),f&&h.push(f);for(var j=b.find(),k=[],m=0;m<j.length;m++){var n=j[m],q=!0;r&&(q=q&&n.metadata.keep);var s=document.getElementById("search-text").value;s&&s.length>0&&(q=q&&n.metadata.title&&n.metadata.title.indexOf(s)!=-1),q&&k.push(n)}var t=h.length,u=k;if(t>0){u=[];for(var m=0;m<k.length;m++){for(var n=k[m],q=!1,v=0;v<t;v++)q=q||i(n,h[v]);q&&u.push(n)}}for(var j={entries:u.sort(function(a,b){return parseInt(b.metadata.timestamp)-parseInt(a.metadata.timestamp)})},m=0;m<j.entries.length;m++){var n=j.entries[m],w=l[n.metadata.activity];n.imageUrl="../../"+w.directory+"/"+w.icon,n.index=m,n.ago=g(n.metadata.creation_time)}var x="\t\t\t{{#entries}}\t\t\t<div id='entry_{{index}}' style='height:60px'>\t\t\t\t<div id='eicon_{{index}}' class='toolbutton' style='background-image:url({{imageUrl}});background-size:40px 40px;width:40px;height:40px;display:inline-block;margin-left:20px;margin-top:5px;'></div>\t\t\t\t<div id='etext_{{index}}' style='color:black;display:inline-block;vertical-align:middle;margin-left:30px;height:60px;margin-top:10px;font-weight:bold;font-size:14px;'>{{metadata.title}}</div>\t\t\t\t<div id='edate_{{index}}' style='color:black;vertical-align:baseline;text-align:right;float:right;height:45px;padding-top:15px;margin-right:10px;clear:right;font-weight:normal;font-size:14px;'>{{ago}}</div>\t\t\t</div>\t\t\t{{/entries}}\t\t",y=d.render(x,j);document.getElementById("journal-container").innerHTML=y;for(var m=0;m<j.entries.length;m++){var n=document.getElementById("entry_"+m);n.addEventListener("click",function(a){var b=a.target.id;b=b.substr(b.indexOf("_")+1);var c=document.getElementById("entry_"+b);c.style.backgroundColor="#808080",p=j.entries[b],delete p.ago,delete p.index,delete p.imageUrl,window.setTimeout(function(){o.close(p)},200)})}document.getElementById("journal-empty").style.visibility=0!=j.entries.length?"hidden":"visible"}function g(a){for(var b={SecondsAgo:"Seconds ago",Ago:" ago",Minutes_one:"minute",Minutes_other:"minutes",Hours_one:"hour",Hours_other:"hours",Days_one:"day",Days_other:"days",Weeks_one:"week",Weeks_other:"weeks",Months_one:"month",Months_other:"months",Years_one:"year",Years_other:"years"},c=[{name:"Years",factor:30758400},{name:"Months",factor:2592e3},{name:"Weeks",factor:604800},{name:"Days",factor:86400},{name:"Hours",factor:3600},{name:"Minutes",factor:60}],d=1,e=0,f="",g=new Date(a).getTime(),h=((new Date).getTime()-g)/1e3,i=0;i<c.length;i++){var j=c[i].factor,k=Math.floor(h/j);if(k>0&&(e>0&&(f+=","),f+=" "+k+" "+(1==k?b[c[i].name+"_one"]:b[c[i].name+"_other"]),h-=k*j),""!=f&&(e+=1),e==d)break}return 0==e?b.SecondsAgo:f+b.Ago}function h(a,b,c){var d=a[b];if(!d)return!1;var e=c[0];return"%"==e?d.indexOf(c.substr(1))!=-1:">"==e?parseInt(d)>parseInt(c.substr(1)):"<"==e?parseInt(d)<parseInt(c.substr(1)):d==c}function i(a,b){for(var c=a.metadata,d=Object.keys(b),e=!0,f=0;f<d.length;f++){var g=d[f],i=b[g];if(i instanceof Array){for(var j=!1,k=0;k<i.length;k++)j=j||h(c,g,i[k]);e=e&&j}else e=e&&h(c,g,i)}return e}for(var j={},k=b.localStorage.getValue("sugar_settings"),l=[],m=0;m<k.activities.length;m++){var n=k.activities[m];l[n.id]=n}var o,p,q={titleJournal:"Local journal",titleClose:"Cancel",titleChoose:"Choose an object",holderSearch:"Search in Journal",noMatchingEntries:"No matching entries",SecondsAgo:"Seconds ago",Ago:" ago",Minutes_one:"minute",Minutes_other:"minutes",Hours_one:"hour",Hours_other:"hours",Days_one:"day",Days_other:"days",Weeks_one:"week",Weeks_other:"weeks",Months_one:"month",Months_other:"months",Years_one:"year",Years_other:"years"},r=!1;return j.show=function(b,d,g,h,i){p=null,o=a({content:e("\t\t\t\t<div id='pictotoolbar' class='toolbar' style='padding: 0'>\t\t\t\t\t<button class='toolbutton active' id='journal-button' title='$titleJournal' style='background-image: url(lib/sugar-web/graphics/icons/actions/activity-journal.svg)'></button>\t\t\t\t\t<button class='toolbutton pull-right' id='close-button' title='$titleClose' style='background-image: url(lib/sugar-web/graphics/icons/actions/dialog-cancel.svg)'></button>\t\t\t\t\t<div style='position: absolute; top: 20px; left: 60px;'>$titleChoose</div>\t\t\t\t</div>\t\t\t\t<div class='toolbar' style='border-top-style: solid; border-color: #c0c0c0; border-width: 1px'>\t\t\t\t\t<span class='icon-input' style='vertical-align:top;'>\t\t\t\t\t<input id='search-text' type='text' placeholder='$holderSearch' style='width: 200px; font-size: 10pt'/>\t\t\t\t\t<button id='cancel-search' class='cancel right'></button>\t\t\t\t\t</span>\t\t\t\t\t<button class='toolbutton' id='favorite-button' title='$titleFavorite' style='background-image: url(lib/sugar-web/graphics/icons/emblems/favorite.svg)'></button>\t\t\t\t</div>\t\t\t\t<div id='journal-empty' style='position:absolute;width:100%;top:50%;left:50%'>\t\t\t\t\t<div style='width:60px;height:60px;background-repeat: no-repeat;background-image: url(lib/sugar-web/graphics/icons/actions/activity-journal.svg)'></div>\t\t\t\t\t<div style='text-align:left!important;margin-left:-30px;color:#808080;text-align:center;font-size:14px;'>$noMatchingEntries</div>\t\t\t\t</div>\t\t\t\t<div id='journal-container' style='width: 100%; overflow:auto'></div>"),closeButton:!1,modalStyles:{backgroundColor:"white",height:"400px",width:"600px",maxWidth:"90%"}}).afterShow(function(a){var b=k.colorvalue;c.colorize(document.getElementById("journal-button"),b,function(){});var e=document.getElementById("pictotoolbar").parentNode.offsetHeight-110;document.getElementById("journal-container").style.height=e+"px";var j=document.getElementById("favorite-button");j.addEventListener("click",function(){r?j.style.backgroundImage="url(lib/sugar-web/graphics/icons/emblems/favorite.svg)":c.colorize(j,b,function(){}),r=!r,f(d,g,h,i)}),document.getElementById("search-text").addEventListener("keyup",function(){f(d,g,h,i)}),document.getElementById("cancel-search").addEventListener("click",function(){document.getElementById("search-text").value="",f(d,g,h,i)}),document.getElementById("close-button").addEventListener("click",function(){p=null,a.close()}),f(d,g,h,i)}).afterClose(function(a){a.destroy(),b&&b(p)}).show()},j});