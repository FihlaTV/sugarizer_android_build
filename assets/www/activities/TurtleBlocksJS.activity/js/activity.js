/*! Sugarizer 2018-05-08 */
function facebookInit(){window.fbAsyncInit=function(){FB.init({appId:"1496189893985945",xfbml:!0,version:"v2.1"})}}const _THIS_IS_MUSIC_BLOCKS_=!1,_THIS_IS_TURTLE_BLOCKS_=!0;try{!function(a,b,c){var d,e=a.getElementsByTagName(b)[0];a.getElementById(c)||(d=a.createElement(b),d.id=c,d.src="https://connect.facebook.net/en_US/sdk.js",e.parentNode.insertBefore(d,e))}(document,"script","facebook-jssdk")}catch(a){}var lang=document.webL10n.getLanguage();lang.indexOf("-")!==-1&&(lang=lang.slice(0,lang.indexOf("-")),document.webL10n.setLanguage(lang)),MYDEFINES=["activity/sugarizer-compatibility","activity/platformstyle","easeljs-0.8.2.min","tweenjs-0.6.2.min","preloadjs-0.6.2.min","howler","p5.min","p5.sound.min","p5.dom.min","mespeak","Chart","activity/utils","activity/artwork","activity/status","activity/munsell","activity/trash","activity/boundary","activity/turtle","activity/palette","activity/protoblocks","activity/blocks","activity/block","activity/turtledefs","activity/logo","activity/clearbox","activity/savebox","activity/utilitybox","activity/samplesviewer","activity/basicblocks","activity/blockfactory","activity/analytics","activity/macros","activity/musicutils","activity/lilypond","prefixfree.min"],define(MYDEFINES,function(a){function b(a){function b(){Ga.showBlocks(),blocksContainer.x=0,blocksContainer.y=0,Ea.initial_x=55,Ea.initial_y=55,Ea.updatePalettes();var a=100*Pa,b=100*Pa;for(var c in Fa.blockList)if(!Fa.blockList[c].trash){var d=Fa.blockList[c];if(null==d.connections[0]){var e=a-d.container.x,f=b-d.container.y;if(Fa.moveBlockRelative(c,e,f),Fa.findDragGroup(c),Fa.dragGroup.length>0)for(var g=0;g<Fa.dragGroup.length;g++){var h=Fa.dragGroup[g];0!==g&&Fa.moveBlockRelative(h,e,f)}a+=200*Pa,a>(Ba.width-100)/Pa&&(a=100*Pa,b+=100*Pa)}}db[0].visible=!1,db[1].visible=!0,boundary.hide()}function c(){null!=Za&&(Ca.removeChild(Za),Za=null),Ga.boxes={},Ga.time=0,da(),Ga.setBackgroundColor(-1),Ga.lilypondOutput=LILYPONDHEADER;for(var a=0;a<Da.turtleList.length;a++)Ga.turtleHeaps[a]=[],Ga.lilypondStaging[a]=[],Da.turtleList[a].doClear(!0,!0);blocksContainer.x=0,blocksContainer.y=0,Element.prototype.remove=function(){this.parentElement.removeChild(this)},NodeList.prototype.remove=HTMLCollection.prototype.remove=function(){for(var a=0,b=this.length;a<b;a++)this[a]&&this[a].parentElement&&this[a].parentElement.removeChild(this[a])};var b=document.getElementById("myTable");null!=b&&b.remove()}function d(a){var b=Ga.turtleDelay;Ga.setTurtleDelay(0),Da.running()?0!==b?(console.log("running from step"),Ga.step()):(console.log("stopping..."),Ga.doStopTurtle(),setTimeout(function(){console.log("and running"),Ga.runLogoCommands(null,a)},500)):(console.log("running"),Ga.runLogoCommands(null,a))}function e(){Ga.setTurtleDelay(gb),Da.running()?Ga.step():Ga.runLogoCommands()}function f(){var a=0;for(var b in Ga.stepQueue)a+=1;0===a||Ga.turtleDelay!==hb?(Ga.setTurtleDelay(hb),Da.running()||Ga.runLogoCommands(),Ga.step()):(Ga.setTurtleDelay(hb),Ga.step())}function g(){Ga.doStopTurtle()}function h(){wb?(ga(),wb=!1):(ha(),wb=!0)}function i(){xb?(ia(),xb=!1):(ja(),xb=!0)}function j(){Ua=!Ua}function k(a,b){var c=this;c.x=Ba.width/(2*Pa)+300/Math.sqrt(2),c.y=300-300/Math.sqrt(2),this.closeButton=ya("cancel-button",_("Close"),c.x,c.y,55,0),this.closeButton.on("click",function(d){console.log("Deleting Chart"),c.closeButton.visible=!1,Ca.removeChild(a),Ga.showBlocks(),yb=!0,b.clearRect(0,0,600,600)})}function l(a){var b=document.createElement("canvas");return b.width=a.width,b.height=a.height,a.toDataURL()==b.toDataURL()}function m(){var a=docById("myChart");if(0!=l(a)){var b=a.getContext("2d");document.body.style.cursor="wait";var c=null,d=analyzeProject(Fa);console.log(d);var e=scoreToChartData(d),f=this;f.close=k;var g=function(){var a=c.toBase64Image(),d=new Image;d.onload=function(){var a=new createjs.Bitmap(d);Ca.addChild(a),a.x=Ba.width/(2*Pa)-300,a.y=0,a.scaleX=a.scaleY=a.scale=600/a.image.width,Ga.hideBlocks(),yb=!0,document.body.style.cursor="default",f.close(a,b)},d.src=a},h=getChartOptions(g);console.log("creating new chart"),c=new Chart(b).Radar(e,h)}}function o(){jb<ib.length-1&&(jb+=1,Fa.setBlockScale(ib[jb]))}function p(){jb>0&&(jb-=1,Fa.setBlockScale(ib[jb]))}function q(){if(docById("loader").className="loader",Ca=new createjs.Stage(Ba),createjs.Touch.enable(Ca),createjs.Ticker.timingMode=createjs.Ticker.RAF_SYNCHED,createjs.Ticker.setFPS(30),createjs.Ticker.addEventListener("tick",Ca),createjs.Ticker.addEventListener("tick",O),y("#ffffff","#7a7a7a",function(a){Bb=a},55),y("#ffcbc4","#ff0031",function(a){Cb=a},110),z(),palettesContainer=new createjs.Container,blocksContainer=new createjs.Container,trashContainer=new createjs.Container,turtleContainer=new createjs.Container,Ca.addChild(turtleContainer,trashContainer,blocksContainer,palettesContainer),r(),trashcan=new Trashcan,trashcan.setCanvas(Ba).setStage(trashContainer).setSize(ob).setRefreshCanvas(N).init(),Da=new Turtles,Da.setCanvas(Ba).setStage(turtleContainer).setRefreshCanvas(N),boundary=new Boundary,boundary.setStage(blocksContainer).init(),Fa=new Blocks,Fa.setCanvas(Ba).setStage(blocksContainer).setRefreshCanvas(N).setTrashcan(trashcan).setUpdateStage(Ca.update).setGetStageScale(t).setTurtles(Da).setErrorMsg(fa),Fa.makeCopyPasteButtons(ya,qa),Da.setBlocks(Fa),Ea=new Palettes,Ea.setCanvas(Ba).setStage(palettesContainer).setRefreshCanvas(N).setSize(ob).setTrashcan(trashcan).setBlocks(Fa).init(),initPalettes(Ea),Ga=new Logo,Ga.setCanvas(Ba).setBlocks(Fa).setTurtles(Da).setStage(turtleContainer).setRefreshCanvas(N).setTextMsg(ea).setErrorMsg(fa).setHideMsgs(da).setOnStopTurtle(L).setOnRunTurtle(M).setGetStageX(u).setGetStageY(v).setGetStageMouseDown(w).setGetCurrentKeyCode(C).setClearCurrentKeyCode(D).setMeSpeak(meSpeak).setSaveLocally(X),Fa.setLogo(Ga),Ga.setBackgroundColor(-1),Ha=new ClearBox,Ha.setCanvas(Ba).setStage(Ca).setRefreshCanvas(N).setClear(I),Ka=new SaveBox,Ka.setCanvas(Ba).setStage(Ca).setRefreshCanvas(N).setSaveTB(R).setSaveSVG(S).setSavePNG(T).setSavePlanet(U).setSaveFB(V),Ia=new UtilityBox,Ia.setStage(Ca).setRefreshCanvas(N).setBigger(o).setSmaller(p).setPlugins(ma).setStats(m).setScroller(j),Ja=new SamplesViewer,Ja.setStage(Ca).setRefreshCanvas(N).setClear(I).setLoad(Z).setLoadRaw($).init(),initBasicProtoBlocks(Ea,Fa),macroData=storage.macros,null!=macroData&&processMacroData(macroData,Ea,Fa,_a),Fa.setMacroDictionary(_a),Ea.setMacroDictionary(_a),pluginData=storage.plugins,null!=pluginData){var a=processPluginData(pluginData,Ea,Fa,Ga.evalFlowDict,Ga.evalArgDict,Ga.evalParameterDict,Ga.evalSetterDict,Ga.evalOnStartList,Ga.evalOnStopList);updatePluginObj(a)}var b=storage.custommode;void 0!=b&&(customMode=JSON.parse(b),console.log("restoring custom mode: "+customMode)),La.addEventListener("click",function(a){this.value=null}),La.addEventListener("change",function(a){var b=new FileReader;b.onload=function(a){document.body.style.cursor="wait",setTimeout(function(){var a=b.result,c=a.replace("\n"," "),d=JSON.parse(c);for(var e in Fa.palettes.dict)Fa.palettes.dict[e].hideMenu(!0);N(),Fa.loadNewBlocks(d),document.body.style.cursor="default"},200)},b.readAsText(La.files[0])},!1),Na.addEventListener("click",function(a){this.value=null}),Ma.addEventListener("click",function(a){window.scroll(0,0),this.value=null}),Ma.addEventListener("change",function(b){window.scroll(0,0);var c=new FileReader;c.onload=function(b){document.body.style.cursor="wait",setTimeout(function(){if(a=processRawPluginData(c.result,Ea,Fa,fa,Ga.evalFlowDict,Ga.evalArgDict,Ga.evalParameterDict,Ga.evalSetterDict,Ga.evalOnStartList,Ga.evalOnStopList),null!=a){var b=preparePluginExports(a);console.log(b),storage.plugins=b}setTimeout(function(){Ea.visible&&Ea.hide(),Ea.show(),Ea.bringToTop()},1e3),document.body.style.cursor="default"},200)},c.readAsText(Ma.files[0])},!1),Ca.mouseMoveOutside=!0,Ca.enableMouseOver(10),zb=x("images/Cartesian.svg"),Ab=x("images/polar.svg");var c=window.location.href,d=null,e=!1;ra(),E();var f,g=[];if(!sugarizerCompatibility.isInsideSugarizer()&&c.indexOf("?")>0){var f=c.split("?");if(f[1].indexOf("&")>0){for(var h=f[1].split("&"),i=0;i<h.length;i++)if(h[i].indexOf("=")>0){var k=h[i].split("=");switch(k[0].toLowerCase()){case"file":d=k[1];break;case"run":"true"===k[1].toLowerCase()&&(e=!0);break;case"inurl":var l=k[1],q=function(a){return new Promise(function(b,c){var d=new XMLHttpRequest;d.open("get",a,!0),d.responseType="json",d.onload=function(){var a=d.status;200===a?b(d.response):c(a)},d.send()})};q(l).then(function(a){console.log("Your Json result is:  "+a.arg),n=a.arg,g.push(parseInt(n))},function(a){alert("Something went wrong.")});break;case"outurl":var l=k[1];break;default:fa("Invalid parameters")}}}else{if(f[1].indexOf("=")>0)var k=f[1].split("=");"file"===k[0].toLowerCase()&&(d=k[1])}}null!=d?setTimeout(function(){console.log("loading "+d),aa(Z,d,e,g)},2e3):setTimeout(function(){aa(ca)},2e3),document.addEventListener("mousewheel",s,!1),document.addEventListener("DOMMouseScroll",s,!1),this.document.onkeydown=B,na()}function r(){var a=!1;Ca.on("stagemousemove",function(a){lb=a.stageX,mb=a.stageY}),Ca.on("stagemousedown",function(b){return kb=!0,null!=Ca.getObjectUnderPoint()|Da.running()?void Ca.on("stagemouseup",function(a){kb=!1}):(a=!0,lastCords={x:b.stageX,y:b.stageY},Ca.on("stagemousemove",function(b){a&&(Fa.inLongPress&&(Fa.saveStackButton.visible=!1,Fa.dismissButton.visible=!1,Fa.inLongPress=!1),Ua&&(blocksContainer.x+=b.stageX-lastCords.x,blocksContainer.y+=b.stageY-lastCords.y,lastCords={x:b.stageX,y:b.stageY},N()))}),void Ca.on("stagemouseup",function(b){kb=!1,a=!1},null,!0))})}function s(a){var b=a.wheelDelta||-a.detail,c=Math.max(-1,Math.min(1,b)),d=30;a.clientX<ob?(Ea.menuScrollEvent(c,d),Ea.hidePaletteIconCircles()):(palette=Ea.findPalette(a.clientX/Pa,a.clientY/Pa),palette&&palette.scrollEvent(c,d))}function t(){return Pa}function u(){return Da.screenX2turtleX(lb/Pa)}function v(){return Da.screenY2turtleY(mb/Pa)}function w(){return kb}function x(a){var b=new Image;b.src=a;var c=new createjs.Container;Ca.addChild(c);var d=new createjs.Bitmap(b);return c.addChild(d),d.cache(0,0,1200,900),d.x=(Ba.width-1200)/2,d.y=(Ba.height-900)/2,d.scaleX=d.scaleY=d.scale=1,d.visible=!1,d.updateCache(),d}function y(a,b,c,d){var e=new createjs.Container;Ca.addChild(e),e.x=(Ba.width-1e3)/2,e.y=d,e.visible=!1;var f=new Image,g=MSGBLOCK.replace("fill_color",a).replace("stroke_color",b);f.onload=function(){var a=new createjs.Bitmap(f);e.addChild(a);var b=new createjs.Text("your message here","20px Arial","#000000");e.addChild(b),b.textAlign="center",b.textBaseline="alphabetic",b.x=500,b.y=30;var d=e.getBounds();e.cache(d.x,d.y,d.width,d.height);var g=new createjs.Shape;g.graphics.beginFill("#FFF").drawRect(0,0,1e3,42),g.x=0,g.y=0,e.hitArea=g,e.on("click",function(a){e.visible=!1,null!=Db&&Db.removeAllChildren(),yb=!0}),c(b),Fa.setMsgText(b)},f.src="data:image/svg+xml;base64,"+window.btoa(unescape(encodeURIComponent(g)))}function z(){for(var a=0;a<Fb.length;a++){var b=Fb[a];A(b)}}function A(a){var b=new createjs.Container;Ca.addChild(b),b.x=(Ba.width-1e3)/2,b.y=110,Eb[a]=b,Eb[a].name=a,Eb[a].visible=!1;var c=new Image;c.onload=function(){var a=new createjs.Bitmap(c);b.addChild(a);var d=new createjs.Text("","20px Sans","#000000");b.addChild(d),d.x=70,d.y=10;var e=b.getBounds();b.cache(e.x,e.y,e.width,e.height);var f=new createjs.Shape;f.graphics.beginFill("#FFF").drawRect(0,0,e.width,e.height),f.x=0,f.y=0,b.hitArea=f,b.on("click",function(a){b.visible=!1,null!=Db&&Db.removeAllChildren(),yb=!0})},c.src="images/"+a+".svg"}function B(a){if(!docById("labelDiv").classList.contains("hasKeyboard")){const e=8,f=9;a.keyCode!==f&&a.keyCode!==e||a.preventDefault();const g=27,h=13,i=36,j=37,k=39,l=38,m=40;if(a.altKey)switch(a.keyCode){case 69:c();break;case 82:d();break;case 83:Ga.doStopTurtle()}else if(a.ctrlKey);else{switch(a.keyCode){case l:null!=Fa.activeBlock?(Fa.moveStackRelative(Fa.activeBlock,0,-STANDARDBLOCKHEIGHT/2),Fa.blockMoved(Fa.activeBlock),Fa.adjustDocks(Fa.activeBlock,!0)):Ea.mouseOver?(Ea.menuScrollEvent(1,10),Ea.hidePaletteIconCircles()):null!=Ea.activePalette?Ea.activePalette.scrollEvent(STANDARDBLOCKHEIGHT,1):Ua&&(blocksContainer.y-=21);break;case m:null!=Fa.activeBlock?(Fa.moveStackRelative(Fa.activeBlock,0,STANDARDBLOCKHEIGHT/2),Fa.blockMoved(Fa.activeBlock),Fa.adjustDocks(Fa.activeBlock,!0)):Ea.mouseOver?(Ea.menuScrollEvent(-1,10),Ea.hidePaletteIconCircles()):null!=Ea.activePalette?Ea.activePalette.scrollEvent(-STANDARDBLOCKHEIGHT,1):Ua&&(blocksContainer.y+=21);break;case j:null!=Fa.activeBlock?(Fa.moveStackRelative(Fa.activeBlock,-STANDARDBLOCKHEIGHT/2,0),Fa.blockMoved(Fa.activeBlock),Fa.adjustDocks(Fa.activeBlock,!0)):Ua&&(blocksContainer.x-=21);break;case k:null!=Fa.activeBlock?(Fa.moveStackRelative(Fa.activeBlock,STANDARDBLOCKHEIGHT/2,0),Fa.blockMoved(Fa.activeBlock),Fa.adjustDocks(Fa.activeBlock,!0)):Ua&&(blocksContainer.x+=21);break;case i:if(Ea.mouseOver){var n=Math.max(55-Ea.buttons.rhythm.y,0);Ea.menuScrollEvent(1,n),Ea.hidePaletteIconCircles()}else null!=Ea.activePalette?Ea.activePalette.scrollEvent(-Ea.activePalette.scrollDiff,1):b();break;case f:break;case g:xa();break;case h:Ga.runLogoCommands()}Va=String.fromCharCode(a.keyCode),Wa=a.keyCode}}}function C(){return Wa}function D(){Va="",Wa=0}function E(){if(!docById("labelDiv").classList.contains("hasKeyboard")){if(platform.androidWebkit)var a=window.outerWidth,b=window.outerHeight;else var a=window.innerWidth,b=window.innerHeight;var c=Math.min(a,b);if(c<11*ob){var d=!0;Pa=a<10*ob?c/(11*ob):Math.max(c/(11*ob),.75)}else{var d=!1;Pa=a/1200>b/900?a/1200:b/900}Ca.scaleX=Pa,Ca.scaleY=Pa,Ca.canvas.width=a,Ca.canvas.height=b,Da.setScale(Pa),Fa.setScale(Pa),boundary.setScale(a,b,Pa),Ea.setScale(Pa),trashcan.resizeEvent(Pa),ra(d),zb.x=Ba.width/(2*Pa)-600,zb.y=Ba.height/(2*Pa)-450,Ab.x=Ba.width/(2*Pa)-600,Ab.y=Ba.height/(2*Pa)-450,yb=!0,ua(!0),d?(Ea.setMobile(!0),Ea.hide()):(Ea.setMobile(!1),Ea.show(),Ea.bringToTop());for(var e=0;e<Da.turtleList.length;e++)Da.turtleList[e].doClear(!1,!1);var f=document.getElementById("overlayCanvas");f.width=a,f.height=b}}function F(){for(var a in Fa.palettes.dict)Fa.palettes.dict[a].hideMenu(!0);N();var b=0,c=3*-ob;if(0===Fa.trashStacks.length)return void console.log("Trash is empty--nothing to do");var d=Fa.trashStacks.pop();Fa.findDragGroup(d);for(var e=0;e<Fa.dragGroup.length;e++){var f=Fa.dragGroup[e];Fa.blockList[f].trash=!1,Fa.moveBlockRelative(f,b,c),Fa.blockList[f].show()}if(Fa.raiseStackToTop(d),"start"===Fa.blockList[d].name||"drum"===Fa.blockList[d].name){var g=Fa.blockList[d].value;Da.turtleList[g].trash=!1,Da.turtleList[g].container.visible=!0}else if("action"===Fa.blockList[d].name){var h=Fa.blockList[Fa.blockList[d].connections[1]];if(null!=h){var i=h.value;Fa.blockList[d].trash=!0;var j=Fa.findUniqueActionName(i);if(Fa.blockList[d].trash=!1,j!==h){console.log("renaming action when restoring from trash. old name: "+i+" unique name: "+j),h.value=j;var k=h.value.toString();k.length>8&&(k=k.substr(0,7)+"..."),h.text.text=k,null!=h.label&&(h.label.value=j),h.container.updateCache();for(var e=0;e<Fa.dragGroup.length;e++){var l=Fa.blockList[Fa.dragGroup[e]];if(["nameddo","nameddoArg","namedcalc","namedcalcArg"].indexOf(l.name)!==-1&&l.privateData===i){console.log("reassigning nameddo to "+j),l.privateData=j,l.value=j;var k=l.value.toString();k.length>8&&(k=k.substr(0,7)+"..."),l.text.text=k,l.overrideName=k,l.regenerateArtwork(),l.container.updateCache()}}}var m=h.value;m!==_("action")&&console.log("FIXME: Check for unique action name here")}}Fa.refreshCanvas()}function G(){Ha.show(Pa)}function H(){Ia.init(Pa,rb.x-27,rb.y,ya)}function I(a,b){for(var c in Fa.palettes.dict)Fa.palettes.dict[c].hideMenu(!0);N();var d=0,e=3*ob;for(var f in Fa.blockList){if(null==Fa.blockList[f].connections[0]&&Fa.trashStacks.push(f),"start"===Fa.blockList[f].name||"drum"===Fa.blockList[f].name){console.log("start blk "+f+" value is "+Fa.blockList[f].value);var g=Fa.blockList[f].value;Fa.blockList[f].trash||null==g||(console.log("sending turtle "+g+" to trash"),Da.turtleList[g].trash=!0,Da.turtleList[g].container.visible=!1)}else"action"===Fa.blockList[f].name&&(Fa.blockList[f].trash||Fa.deleteActionBlock(Fa.blockList[f]));Fa.blockList[f].trash=!0,Fa.moveBlockRelative(f,d,e),Fa.blockList[f].hide()}a?Fa.loadNewBlocks(DATAOBJS):b||X(),yb=!0}function J(){Fa.visible?(Ga.hideBlocks(),Ea.hide()):(null!=Za&&(Ca.removeChild(Za),Za=null),Ga.showBlocks(),Ea.show(),Ea.bringToTop())}function K(){Fa.visible&&(console.log("calling toggleCollapsibles"),Fa.toggleCollapsibles())}function L(){ab.visible&&na()}function M(){ab.visible||oa()}function N(){yb=!0}function O(a){yb&&(yb=!1,Ca.update(a))}function P(){localStorage.setItem("isStatusHidden",docById("statusDiv").style.visibility),Ga.doStopTurtle(),tb.visible=!1,docById("helpElem").style.visibility="hidden",console.log("save locally"),X(),Ja.show()}function Q(){Ka.init(Pa,sb.x-27,sb.y-97,ya)}function R(){var a=prompt("Filename:","untitled.tb");null!=a&&("tb"!==fileExt(a)&&(a+=".tb"),download(a,"data:text/plain;charset=utf-8,"+encodeURIComponent(la())))}function S(){var a=prompt("Filename:","untitled.svg");if(null!=a){"svg"!==fileExt(a)&&(a+=".svg");var b=doSVG(Ga.canvas,Ga,Ga.turtles,Ga.canvas.width,Ga.canvas.height,1);download(a,"data:image/svg+xml;utf8,"+b,a,'"width='+Ga.canvas.width+", height="+Ga.canvas.height+'"')}}function T(){alert("Unavailable at the moment")}function U(){X(),Ja.show()}function V(){alert("Facebook Sharing : disabled")}function W(){console.log("Loading .tb file"),document.querySelector("#myOpenFile").focus(),document.querySelector("#myOpenFile").click(),window.scroll(0,0)}function X(){if(sugarizerCompatibility.isInsideSugarizer()?storage=sugarizerCompatibility.data:storage=localStorage,console.log("overwriting session data"),void 0===storage.currentProject)try{storage.currentProject="My Project",storage.allProjects=JSON.stringify(["My Project"])}catch(a){console.log(a)}try{var a=storage.currentProject;storage["SESSION"+a]=la()}catch(a){console.log(a)}var b=new Image,c=doSVG(Ba,Ga,Da,320,240,320/Ba.width);b.onload=function(){var c=new createjs.Bitmap(b),d=c.getBounds();c.cache(d.x,d.y,d.width,d.height);try{storage["SESSIONIMAGE"+a]=c.getCacheDataURL()}catch(a){console.log(a)}},b.src="data:image/svg+xml;base64,"+window.btoa(unescape(encodeURIComponent(c))),sugarizerCompatibility.isInsideSugarizer()&&sugarizerCompatibility.saveLocally()}function Y(a){console.log("Running Project from Event"),document.removeEventListener("finishedLoading",Y),setTimeout(function(){console.log("Run"),J(),d(a)},5e3)}function Z(a,b,c){b="undefined"!=typeof b&&b,document.body.style.cursor="wait",setTimeout(function(){"tb"!==fileExt(a)&&(a+=".tb");try{try{httpGet(null),console.log("running from server or the user can access to examples."),Oa=!0}catch(a){console.log("running from filesystem or the connection isnt secure"),Oa=!1}if(Oa)var b=httpGet(a),c=b.replace("\n","");for(var d in Fa.palettes.dict)Fa.palettes.dict[d].hideMenu(!0);var e=JSON.parse(c);Fa.loadNewBlocks(e),X()}catch(a){console.log(a),aa(ca)}document.body.style.cursor="default",yb=!0},200),b&&vb&&(document.addEventListener?document.addEventListener("finishedLoading",function(){Y(c)},!1):document.attachEvent("finishedLoading",function(){Y(c)})),vb=!1}function $(a){console.log("loadRawProject "+a),document.body.style.cursor="wait",c();for(var b in Fa.palettes.dict)Fa.palettes.dict[b].hideMenu(!0);var d=JSON.parse(a);Fa.loadNewBlocks(d),document.body.style.cursor="default"}function aa(a,b,c,d){var e=new Date;a(b,c,d);var f=new Date,g=f.getTime()-e.getTime(),h=Math.max(6e3-g);setTimeout(ba,h)}function ba(){docById("loading-image-container").style.display="none",docById("hideContents").style.display="block"}function ca(){console.log("LOAD START"),justLoadStart=function(){console.log("loading start and a matrix"),Fa.loadNewBlocks(DATAOBJS)},sugarizerCompatibility.isInsideSugarizer()?storage=sugarizerCompatibility.data:storage=localStorage,sessionData=null;var a=storage.currentProject;if(sessionData=storage["SESSION"+a],sessionData)try{if("undefined"===sessionData||"[]"===sessionData)console.log("empty session found: loading start"),justLoadStart();else{console.log("restoring session: "+sessionData);for(var b in Fa.palettes.dict)Fa.palettes.dict[b].hideMenu(!0);Fa.loadNewBlocks(JSON.parse(sessionData))}}catch(a){console.log(a)}else justLoadStart();yb=!0}function da(){Cb.parent.visible=!1,null!=Db&&(Db.removeAllChildren(),N()),Bb.parent.visible=!1;for(var a in Eb)Eb[a].visible=!1}function ea(a){if(null!=Bb){var b=Bb.parent;b.visible=!0,Bb.text=a,b.updateCache(),Ca.setChildIndex(b,Ca.getNumChildren()-1)}}function fa(a,b,c){if(na(),null!=Cb){if(void 0!==b&&null!=b&&!Fa.blockList[b].collapsed){var d=(Ba.width-1e3)/2,e=128,f=Fa.blockList[b].container.x+blocksContainer.x,g=Fa.blockList[b].container.y+blocksContainer.y;null==Db&&(Db=new createjs.Container,Ca.addChild(Db));var h=new createjs.Shape;Db.addChild(h),h.graphics.setStrokeStyle(4).beginStroke("#ff0031").moveTo(d,e).lineTo(f,g),Ca.setChildIndex(Db,Ca.getNumChildren()-1);var i=Math.atan2(f-d,e-g)/Math.PI*180,j=new createjs.Shape;Db.addChild(j),j.graphics.setStrokeStyle(4).beginStroke("#ff0031").moveTo(-10,18).lineTo(0,0).lineTo(10,18),j.x=f,j.y=g,j.rotation=i}switch(a){case NOMICERRORMSG:Eb.nomicrophone.visible=!0,Ca.setChildIndex(Eb.nomicrophone,Ca.getNumChildren()-1);break;case NOSTRINGERRORMSG:Eb.notastring.visible=!0,Ca.setChildIndex(Eb.notastring,Ca.getNumChildren()-1);break;case EMPTYHEAPERRORMSG:Eb.emptyheap.visible=!0,Ca.setChildIndex(Eb.emptyheap,Ca.getNumChildren()-1);break;case NOSQRTERRORMSG:Eb.negroot.visible=!0,Ca.setChildIndex(Eb.negroot,Ca.getNumChildren()-1);break;case NOACTIONERRORMSG:null==c&&(c="foo"),Eb.nostack.children[1].text=c,Eb.nostack.visible=!0,Eb.nostack.updateCache(),Ca.setChildIndex(Eb.nostack,Ca.getNumChildren()-1);break;case NOBOXERRORMSG:null==c&&(c="foo"),Eb.emptybox.children[1].text=c,Eb.emptybox.visible=!0,Eb.emptybox.updateCache(),Ca.setChildIndex(Eb.emptybox,Ca.getNumChildren()-1);break;case ZERODIVIDEERRORMSG:Eb.zerodivide.visible=!0,Ca.setChildIndex(Eb.zerodivide,Ca.getNumChildren()-1);break;case NANERRORMSG:Eb.notanumber.visible=!0,Ca.setChildIndex(Eb.notanumber,Ca.getNumChildren()-1);break;case NOINPUTERRORMSG:Eb.noinput.visible=!0,Ca.setChildIndex(Eb.noinput,Ca.getNumChildren()-1);break;default:var k=Cb.parent;k.visible=!0,Cb.text=a,Ca.setChildIndex(k,Ca.getNumChildren()-1),k.updateCache()}yb=!0}}function ga(){zb.visible=!1,zb.updateCache(),yb=!0}function ha(){zb.visible=!0,zb.updateCache(),yb=!0}function ia(){Ab.visible=!1,Ab.updateCache(),yb=!0}function ja(){Ab.visible=!0,Ab.updateCache(),yb=!0}function ka(){Fa.pasteStack()}function la(){for(var a=[],b=!1,c=0;c<Fa.blockList.length;c++){var d=Fa.blockList[c];d.trash||a.push(c)}for(var e=[],c=0;c<Fa.blockList.length;c++){var d=Fa.blockList[c];if(!d.trash){if(d.isValueBlock()||"loadFile"===d.name)var f={value:d.value};else if("start"===d.name||"drum"===d.name){var g=Da.turtleList[d.value];if(null==g)var f={collapsed:!1,xcor:0,ycor:0,heading:0,color:0,shade:50,pensize:5,grey:100};else var f={collapsed:d.collapsed,xcor:g.x,ycor:g.y,heading:g.orientation,color:g.color,shade:g.value,pensize:g.stroke,grey:g.chroma}}else if("action"===d.name)var f={collapsed:d.collapsed};else if("matrix"===d.name)var f={collapsed:d.collapsed};else if("pitchdrummatrix"===d.name)var f={collapsed:d.collapsed};else if("status"===d.name)var f={collapsed:d.collapsed};else if("namedbox"===d.name)var f={value:d.privateData};else if("nameddo"===d.name)var f={value:d.privateData};else if("nameddoArg"===d.name)var f={value:d.privateData};else if("namedcalc"===d.name)var f={value:d.privateData};else if("namedcalcArg"===d.name)var f={value:d.privateData};else if("namedarg"===d.name)var f={value:d.privateData};else if("matrixData"===d.name){var f={notes:window.savedMatricesNotes,count:window.savedMatricesCount};b=!0}else var f={};connections=[];for(var h=0;h<d.connections.length;h++){var i=a.indexOf(d.connections[h]);null==d.connections[h]||i===-1?connections.push(null):connections.push(i)}e.push([a.indexOf(c),[d.name,f],d.container.x,d.container.y,connections])}}return JSON.stringify(e)}function ma(){Ma.focus(),Ma.click()}function na(){ab.visible=!1}function oa(){ab.visible=!0}function pa(a){function b(){createjs.Tween.get(a).to({alpha:1,visible:!0},500)}createjs.Tween.get(a).to({alpha:0,visible:!1},1e3).call(b)}function qa(){if(null===Ya){var a=new Image;a.onload=function(){var b=55,c=Math.floor(ob/2),d=new createjs.Bitmap(a);ob!==b&&(d.scaleX=ob/b,d.scaleY=ob/b),d.regX=c/d.scaleX,d.regY=c/d.scaleY,Xa.addChild(d),Ya=d,yb=!0},a.src="header-icons/paste-button.svg"}else pa(Ya)}function ra(a){if(void 0!==Ra){Ca.removeChild(Ra);for(var h in pb)Ca.removeChild(pb[h])}Ra=new createjs.Shape,Ra.graphics.f(platformColor.header).r(0,0,screen.width/Pa,ob),platformColor.doHeaderShadow&&(Ra.shadow=new createjs.Shadow("#777",0,2,2)),Ca.addChild(Ra);var i,i=[["run",d,_("Run fast / long press to run slowly"),e,null,"slow-button",null],["step",f,_("Run step by step"),null,null,null,null],["stop-turtle",g,_("Stop"),null,null,null,null],["clear",c,_("Clean"),null,null,null,null],["hide-blocks",J,_("Show/hide blocks"),null,null,null,null],["collapse-blocks",K,_("Expand/collapse collapsable blocks"),null,null,null,null],["go-home",b,_("Home"),null,null,null,null],["help",ua,_("Help"),null,null,null,null]];sugarizerCompatibility.isInsideSugarizer()&&i.push(["sugarizer-stop",function(){sugarizerCompatibility.data.blocks=la(),sugarizerCompatibility.saveLocally(function(){sugarizerCompatibility.sugarizerStop()})},"Stop",null,null,null,null]),a&&i.unshift(["popdown-palette",ta]);for(var j=ob,k=Math.floor(j/2),l=k,m=j,n=0,h=0;h<i.length;h++)if(getMainToolbarButtonNames(i[h][0])){var o=ya(i[h][0]+"-button",i[h][2],k,l,j,0);if(za(o,k,l,i[h][1],i[h][3],i[h][4],i[h][5],i[h][6]),pb.push(o),"stop-turtle"===i[h][0])ab=o,bb=k,cb=l;else if("go-home"===i[h][0]){db=[],db.push(o),eb=k,fb=l;var p=ya("go-home-faded-button",_("Home"),k,l,j,0);za(p,k,l,i[h][1],null,null,null,null),db.push(p),pb.push(p),db[0].visible=!1,db[1].visible=!0,boundary.hide(),Fa.setHomeContainers(db,boundary)}k+=m,l+=n}else console.log("continue");sa(Pa)}function sa(a){if(void 0!==Ta){Ca.removeChild(Ta);for(var b in qb)Ca.removeChild(qb[b])}var c,c=[["planet",P,_("Load samples from server")],["open",W,_("Load project from files")],["save",Q,_("Save project")],["paste-disabled",ka,_("Paste")],["Cartesian",h,_("Cartesian")],["polar",i,_("Polar")],["utility",H,_("Settings")],["empty-trash",G,_("Delete all")],["restore-trash",F,_("Undo")]];document.querySelector("#myOpenFile").addEventListener("change",function(a){Ja.model.controller.hide()});var d=ob,e=Math.floor(Ba.width/a)-d/2,f=Math.floor(d/2),g=0,j=d;Ta=ya("menu-button","",e,f,d,Sa?90:void 0),za(Ta,e,f,va,null,null,null,null);for(var b=0;b<c.length;b++)if(getAuxToolbarButtonNames(c[b][0])){e+=g,f+=j;var k=ya(c[b][0]+"-button",c[b][2],e,f,d,0);za(k,e,f,c[b][1],null,null,null,null),qb.push(k),"utility"===c[b][0]?rb=k:"save"===c[b][0]&&(sb=k),k.visible=!1}if(Sa)for(var l in qb)qb[l].visible=!0}function ta(){console.log("doPopdownPalette");var a=new PopdownPalette(Ea);a.popdown()}function ua(a){if(ub=0,a){if(null==tb){tb=new createjs.Container,Ca.addChild(tb),tb.x=65,tb.y=65,tb.on("click",function(a){var b=tb.getBounds();if(a.stageY<tb.y+b.height/2)tb.visible=!1,docById("helpElem").style.visibility="hidden";else{ub+=1,ub>=HELPCONTENT.length&&(ub=0);var d=55*Pa;c.innerHTML='<img src ="'+HELPCONTENT[ub][2]+'" style="height:'+d+'px; width: auto"></img> <h2>'+HELPCONTENT[ub][0]+"</h2><p>"+HELPCONTENT[ub][1]+"</p>"}yb=!0});var b=new Image;b.onload=function(){console.log(Pa);var a=new createjs.Bitmap(b);tb.children.length>0&&(console.log("delete old help container"),tb.removeChild(tb.children[0])),tb.addChild(a);var c=tb.getBounds(),d=new createjs.Shape;d.graphics.beginFill("#FFF").drawRect(c.x,c.y,c.width,c.height),d.x=0,d.y=0,tb.hitArea=d,docById("helpElem").innerHTML='<img src ="'+HELPCONTENT[ub][2]+'"</img> <h2>'+HELPCONTENT[ub][0]+"</h2><p>"+HELPCONTENT[ub][1]+"</p>",doneTour||(docById("helpElem").style.visibility="visible"),yb=!0},b.src="images/help-container.svg"}var c=docById("helpElem");c.style.position="absolute",c.style.display="block",c.style.paddingLeft=20*Pa+"px",c.style.paddingRight=20*Pa+"px",c.style.paddingTop="0px",c.style.paddingBottom=20*Pa+"px",c.style.fontSize="20px",c.style.color="#000000",c.style.left=65*Pa+"px",c.style.top=105*Pa+"px";var d=Math.min(300,300),e=Math.min(300,300);if(c.style.width=d+"px",c.style.height=e+"px",Pa>1){tb.children[0]}}doneTour="true"===storage.doneTour,a&&doneTour?(docById("helpElem").style.visibility="hidden",tb.visible=!1):(sugarizerCompatibility.isInsideSugarizer()?sugarizerCompatibility.data.doneTour="true":storage.doneTour="true",docById("helpElem").innerHTML='<img src ="'+HELPCONTENT[ub][2]+'"</img> <h2>'+HELPCONTENT[ub][0]+"</h2><p>"+HELPCONTENT[ub][1]+"</p>",docById("helpElem").style.visibility="visible",tb.visible=!0,yb=!0,Ea.show(),Sa||doMenuAnimation(1))}function va(){wa(1)}function wa(){var a=last(Ta.children);if(null!=a){var b=a.rotation;createjs.Tween.get(a).to({rotation:b}).to({rotation:b+90},500)}else setTimeout(wa,50);setTimeout(function(){if(Sa){Sa=!1;for(var a in qb)qb[a].visible=!1}else{Sa=!0;for(var a in qb)qb[a].visible=!0}yb=!0},500)}function xa(){Qa=!Qa,Ta.visible=Qa,Ra.visible=Qa;for(var a in pb)pb[a].visible=Qa;for(var a in qb)qb[a].visible=Qa;yb=!0}function ya(a,b,c,d,e,f,g){var h=new createjs.Container;"paste-disabled-button"===a&&(Xa=h),void 0==g?Ca.addChild(h):g.addChild(h),h.x=c,h.y=d;var i=new createjs.Text(b,"14px Sans","#282828");h.y<55?(h.x<55?(i.textAlign="left",i.x=-14):(i.textAlign="center",i.x=0),i.y=30):(i.textAlign="right",i.x=-28,i.y=0),i.visible=!1,h.on("mouseover",function(a){for(var b=0;b<h.children.length;b++)if(void 0!=h.children[b].text){h.children[b].visible=!0;break}}),h.on("mouseout",function(a){for(var b=0;b<h.children.length;b++)if(void 0!=h.children[b].text){h.children[b].visible=!1;break}});var j=new Image;return j.onload=function(){var a=55,b=Math.floor(e/2),c=new createjs.Bitmap(j);e!==a&&(c.scaleX=e/a,c.scaleY=e/a),c.regX=b/c.scaleX,c.regY=b/c.scaleY,void 0!==f&&(c.rotation=f),h.addChild(c);var d=new createjs.Shape;d.graphics.beginFill("#FFF").drawEllipse(-b,-b,e,e),d.x=0,d.y=0,h.hitArea=d,c.cache(0,0,e,e),c.updateCache(),yb=!0},j.src="header-icons/"+a+".svg",h.addChild(i),h}function za(a,b,c,d,e,f,g,h){var i=!1;null===e&&(e=d),null===f&&(f=e);var j,k,l=!1,m=!1,n=a;a.on("mousedown",function(o){var p=!0;({x:a.x-Math.round(o.stageX/Pa),y:a.y-Math.round(o.stageY/Pa)});j=setTimeout(function(){l=!0,null!==g&&(a.visible=!1,a=ya(g,"",b,c,ob,0))},500),k=setTimeout(function(){m=!0,null!==h&&(a.visible=!1,a=ya(h,"",b,c,ob,0))},1e3);var q=showButtonHighlight(b,c,ob/2,o,Pa,Ca);a.on("pressup",function(o){hideButtonHighlight(q,Ca),a.x=b,a.y=c,null===g&&null===h||(a.visible=!1,a=n,a.visible=!0),null!=d&&p&&!i&&(i=!0,setTimeout(function(){i=!1},500),clearTimeout(j),clearTimeout(k),l?m?f():e():d()),p=!1}),l=!1,m=!1})}createDefaultStack(),createHelpContent(),window.scroll(0,0);try{meSpeak.loadConfig("lib/mespeak_config.json");var Aa=document.webL10n.getLanguage();sugarizerCompatibility.isInsideSugarizer()&&(Aa=sugarizerCompatibility.getLanguage()),["es","ca","de","el","eo","fi","fr","hu","it","kn","la","lv","nl","pl","pt","ro","sk","sv","tr","zh"].indexOf(Aa)!==-1?meSpeak.loadVoice("lib/voices/"+Aa+".json"):meSpeak.loadVoice("lib/voices/en/en.json")}catch(a){console.log(a)}var Ba=docById("myCanvas");new createjs.LoadQueue(!1);if(window.File&&window.FileReader&&window.FileList&&window.Blob);else{alert("The File APIs are not fully supported in this browser.")}var Ca,Da,Ea,Fa,Ga,Ha,Ia,Ja,Ka,La=docById("myOpenFile"),Ma=docById("myOpenPlugin"),Na=docById("myOpenAll"),Oa=!0,Pa=1,Qa=!0,Ra=null,Sa=!0,Ta=null,Ua=!1,Va="",Wa=0,Xa=null,Ya=null,Za=null;
for(var $a in PALETTECOLORS)PALETTEFILLCOLORS[$a]=getMunsellColor(PALETTECOLORS[$a][0],PALETTECOLORS[$a][1],PALETTECOLORS[$a][2]),PALETTESTROKECOLORS[$a]=getMunsellColor(PALETTECOLORS[$a][0],PALETTECOLORS[$a][1]-30,PALETTECOLORS[$a][2]),PALETTEHIGHLIGHTCOLORS[$a]=getMunsellColor(PALETTECOLORS[$a][0],PALETTECOLORS[$a][1]+10,PALETTECOLORS[$a][2]),HIGHLIGHTSTROKECOLORS[$a]=getMunsellColor(PALETTECOLORS[$a][0],PALETTECOLORS[$a][1]-50,PALETTECOLORS[$a][2]);pluginObjs={PALETTEPLUGINS:{},PALETTEFILLCOLORS:{},PALETTESTROKECOLORS:{},PALETTEHIGHLIGHTCOLORS:{},FLOWPLUGINS:{},ARGPLUGINS:{},BLOCKPLUGINS:{},ONLOAD:{},ONSTART:{},ONSTOP:{}};var _a={},ab=null,bb=0,cb=0,db=[],eb=0,fb=0;const gb=500,hb=-1,ib=[1,1.5,2,3,4];var jb=ib.indexOf(DEFAULTBLOCKSCALE);jb===-1&&(jb=1);var kb=!1,lb=0,mb=0,nb=1200===screen.width&&900===screen.height||900===screen.width&&1200===screen.height,ob=55;nb&&(ob=75);var pb=[],qb=[],rb=null,sb=null,tb=null,ub=0,vb=!0;pluginsImages={},console.log("initing i18n for music terms"),initDrumI18N(),initModeI18N(),initVoiceI18N(),window.onblur=function(){Ga.doStopTurtle()};var wb=!1,xb=!1,yb=!0,zb=null,Ab=null,Bb=null,Cb=null,Db=null,Eb={};const Fb=["emptybox","emptyheap","negroot","noinput","zerodivide","notanumber","nostack","notastring","nomicrophone"];q(),window.onresize=function(){E()},window.prepareExport=la,window.saveLocally=X}require(["domReady!","activity/sugarizer-compatibility"],function(a){sugarizerCompatibility.isInsideSugarizer()?(window.addEventListener("localized",function(){sugarizerCompatibility.loadData(function(){b(a)})}),document.webL10n.setLanguage(sugarizerCompatibility.getLanguage())):b(a)})});