/*! Sugarizer 2016-12-28 */
function Block(a,b,c){return null==a?void console.log("null protoblock sent to Block"):(this.protoblock=a,this.name=a.name,this.overrideName=c,this.blocks=b,this.x=0,this.y=0,this.collapsed=!1,this.trash=!1,this.loadComplete=!1,this.label=null,this.text=null,this.value=null,this.privateData=null,this.image=a.image,this.imageBitmap=null,this.container=null,this.bounds=null,this.bitmap=null,this.highlightBitmap=null,this.artwork=null,this.collapseArtwork=null,this.collapseContainer=null,this.collapseBitmap=null,this.expandBitmap=null,this.collapseBlockBitmap=null,this.highlightCollapseBlockBitmap=null,this.collapseText=null,this.size=1,this.docks=[],this.connections=[],this.clampCount=[1,1],this.argClampSlots=[1],this.postProcess=null,this.postProcessArg=null,this.copySize=function(){this.size=this.protoblock.size},this.getInfo=function(){return this.name+" block"},this.highlight=function(){this.collapsed&&["start","action"].indexOf(this.name)!=-1?this.highlightCollapseBlockBitmap&&(this.highlightCollapseBlockBitmap.visible=!0,this.collapseBlockBitmap.visible=!1,this.collapseText.visible=!0,this.bitmap.visible=!1,this.highlightBitmap.visible=!1):(this.bitmap.visible=!1,this.highlightBitmap.visible=!0,["start","action"].indexOf(this.name)!=-1&&this.highlightCollapseBlockBitmap&&(null!=this.collapseText&&(this.collapseText.visible=!1),null!=this.collapseBlockBitmap.visible&&(this.collapseBlockBitmap.visible=!1),null!=this.highlightCollapseBlockBitmap.visible&&(this.highlightCollapseBlockBitmap.visible=!1))),this.container.updateCache(),this.blocks.refreshCanvas()},this.unhighlight=function(){this.collapsed&&["start","action"].indexOf(this.name)!=-1?this.highlightCollapseBlockBitmap&&(this.highlightCollapseBlockBitmap.visible=!1,this.collapseBlockBitmap.visible=!0,this.collapseText.visible=!0,this.bitmap.visible=!1,this.highlightBitmap.visible=!1):(this.bitmap.visible=!0,this.highlightBitmap.visible=!1,["start","action"].indexOf(this.name)!=-1&&this.highlightCollapseBlockBitmap&&(this.highlightCollapseBlockBitmap.visible=!1,this.collapseBlockBitmap.visible=!1,this.collapseText.visible=!1)),this.container.updateCache(),this.blocks.refreshCanvas()},this.updateArgSlots=function(a){this.argClampSlots=a,this.newArtwork(),this.regenerateArtwork(!1)},this.updateSlots=function(a,b){this.clampCount[a]+=b,this.newArtwork(b),this.regenerateArtwork(!1)},this.resize=function(a){if(this.postProcess=function(b){if(null!=b.imageBitmap&&(positionMedia(b.imageBitmap,b,b.imageBitmap.image.width,b.imageBitmap.image.height,a),z=b.container.getNumChildren()-1,b.container.setChildIndex(b.imageBitmap,z)),"start"==b.name)for(turtle=0;turtle<b.blocks.turtles.turtleList.length;turtle++)if(b.blocks.turtles.turtleList[turtle].startBlock==b){b.blocks.turtles.turtleList[turtle].resizeDecoration(a,b.bitmap.image.width),ensureDecorationOnTop(b);break}b.container.updateCache(),calculateBlockHitArea(b)},this.protoblock.scale=a,this.newArtwork(0),this.regenerateArtwork(!0,[]),null!=this.text&&positionText(this,a),null!=this.collapseContainer){this.collapseContainer.uncache();var b=function(b){b.collapseBitmap.scaleX=b.collapseBitmap.scaleY=b.collapseBitmap.scale=a/2,b.expandBitmap.scaleX=b.expandBitmap.scaleY=b.expandBitmap.scale=a/2;var c=b.collapseContainer.getBounds();b.collapseContainer.cache(c.x,c.y,c.width,c.height),positionCollapseContainer(b,b.protoblock.scale),calculateCollapseHitArea(b)};this.generateCollapseArtwork(b);var c=10*a;this.collapseText.font=c+"px Sans",positionCollapseLabel(this,a)}},this.newArtwork=function(a){switch(this.name){case"start":case"action":var b=new ProtoBlock("collapse");b.scale=this.protoblock.scale,b.extraWidth=10,b.basicBlockCollapsed();var c=b.generator();this.collapseArtwork=c[0];var c=this.protoblock.generator(this.clampCount[0]);break;case"repeat":case"clamp":case"forever":case"if":case"while":case"until":var c=this.protoblock.generator(this.clampCount[0]);break;case"less":case"greater":case"equal":var c=this.protoblock.generator(this.clampCount[0]);break;case"ifthenelse":var c=this.protoblock.generator(this.clampCount[0],this.clampCount[1]);break;case"nameddoArg":case"namedcalcArg":case"doArg":case"calcArg":var c=this.protoblock.generator(this.argClampSlots);this.size=2;for(var d=0;d<this.argClampSlots.length;d++)this.size+=this.argClampSlots[d];this.docks=[],this.docks.push([c[1][0][0],c[1][0][1],this.protoblock.dockTypes[0]]);break;default:if(this.isArgBlock())var c=this.protoblock.generator(this.clampCount[0]);else if(this.isTwoArgBlock())var c=this.protoblock.generator(this.clampCount[0]);else var c=this.protoblock.generator();this.size+=a}switch(this.name){case"nameddoArg":for(var d=1;d<c[1].length-1;d++)this.docks.push([c[1][d][0],c[1][d][1],"anyin"]);this.docks.push([c[1][2][0],c[1][2][1],"in"]);break;case"namedcalcArg":for(var d=1;d<c[1].length;d++)this.docks.push([c[1][d][0],c[1][d][1],"anyin"]);break;case"doArg":this.docks.push([c[1][1][0],c[1][1][1],this.protoblock.dockTypes[1]]);for(var d=2;d<c[1].length-1;d++)this.docks.push([c[1][d][0],c[1][d][1],"anyin"]);this.docks.push([c[1][3][0],c[1][3][1],"in"]);break;case"calcArg":this.docks.push([c[1][1][0],c[1][1][1],this.protoblock.dockTypes[1]]);for(var d=2;d<c[1].length;d++)this.docks.push([c[1][d][0],c[1][d][1],"anyin"])}this.artwork=c[0];for(var d=0;d<this.docks.length;d++)this.docks[d][0]=c[1][d][0],this.docks[d][1]=c[1][d][1]},this.imageLoad=function(){var a=10*this.protoblock.scale;this.text=new createjs.Text("",a+"px Sans","#000000"),this.generateArtwork(!0,[])},this.addImage=function(){var a=new Image,b=this;a.onload=function(){var c=new createjs.Bitmap(a);c.name="media",b.container.addChild(c),positionMedia(c,b,a.width,a.height,b.protoblock.scale),b.imageBitmap=c,b.container.updateCache(),b.blocks.refreshCanvas()},a.src=this.image},this.regenerateArtwork=function(a){this.container.removeChild(this.bitmap),this.container.removeChild(this.highlightBitmap),a&&null!=this.collapseBitmap&&(this.collapseContainer.removeChild(this.collapseBitmap),this.collapseContainer.removeChild(this.expandBitmap),this.container.removeChild(this.collapseBlockBitmap),this.container.removeChild(this.highlightCollapseBlockBitmap)),this.generateArtwork(!1)},this.generateArtwork=function(a){function b(b,e,f){function g(b,d,e){e.highlightBitmap=d,e.container.addChild(e.highlightBitmap),e.highlightBitmap.x=0,e.highlightBitmap.y=0,e.highlightBitmap.name="bmp_highlight_"+c,e.highlightBitmap.cursor="pointer",e.highlightBitmap.visible=!1,a||e.container.uncache(),e.bounds=e.container.getBounds(),e.container.cache(e.bounds.x,e.bounds.y,e.bounds.width,e.bounds.height),e.blocks.refreshCanvas(),a?(loadEventHandlers(e),null!=e.image&&e.addImage(),e.finishImageLoad()):("start"==e.name&&ensureDecorationOnTop(e),e.blocks.loopCounter=0,e.blocks.adjustDocks(c),positionText(e,e.protoblock.scale),e.blocks.clampBlocksToCheck.length>0&&setTimeout(function(){e.blocks.adjustExpandableClampBlock()},250),["start","action"].indexOf(e.name)!=-1&&(e.bitmap.visible=!e.collapsed,e.highlightBitmap.visible=!1,e.container.updateCache(),e.blocks.refreshCanvas()),null!=e.postProcess&&(e.postProcess(e),e.postProcess=null))}if(f.bitmap=e,f.container.addChild(f.bitmap),f.bitmap.x=0,f.bitmap.y=0,f.bitmap.name="bmp_"+c,f.bitmap.cursor="pointer",f.blocks.refreshCanvas(),f.protoblock.disabled)var h=f.artwork.replace(/fill_color/g,DISABLEDFILLCOLOR).replace(/stroke_color/g,DISABLEDSTROKECOLOR).replace("block_label",d);else var h=f.artwork.replace(/fill_color/g,PALETTEHIGHLIGHTCOLORS[f.protoblock.palette.name]).replace(/stroke_color/g,HIGHLIGHTSTROKECOLORS[f.protoblock.palette.name]).replace("block_label",d);for(var i=1;i<f.protoblock.staticLabels.length;i++)h=h.replace("arg_label_"+i,f.protoblock.staticLabels[i]);makeBitmap(h,f.name,g,f)}var c=this.blocks.blockList.indexOf(this),d="";for(this.overrideName?d=this.overrideName:this.protoblock.staticLabels.length>0&&!this.protoblock.image&&(d=this.protoblock.staticLabels[0]);this.protoblock.staticLabels.length<this.protoblock.args+1;)this.protoblock.staticLabels.push("");if(a){var e=this.protoblock.generator();this.artwork=e[0];for(var f=0;f<e[1].length;f++)this.docks.push([e[1][f][0],e[1][f][1],this.protoblock.dockTypes[f]])}if(this.protoblock.disabled)var g=this.artwork.replace(/fill_color/g,DISABLEDFILLCOLOR).replace(/stroke_color/g,DISABLEDSTROKECOLOR).replace("block_label",d);else var g=this.artwork.replace(/fill_color/g,PALETTEFILLCOLORS[this.protoblock.palette.name]).replace(/stroke_color/g,PALETTESTROKECOLORS[this.protoblock.palette.name]).replace("block_label",d);for(var f=1;f<this.protoblock.staticLabels.length;f++)g=g.replace("arg_label_"+f,this.protoblock.staticLabels[f]);makeBitmap(g,this.name,b,this)},this.finishImageLoad=function(){this.blocks.blockList.indexOf(this);if("text"==this.name||"number"==this.name){null==this.value&&("text"==this.name?this.value="---":this.value=100);var a=this.value.toString();a.length>8&&(a=a.substr(0,7)+"..."),this.text.text=a,this.container.addChild(this.text),positionText(this,this.protoblock.scale)}else this.protoblock.parameter&&(this.container.addChild(this.text),positionText(this,this.protoblock.scale));if(["start","action"].indexOf(this.name)==-1)this.loadComplete=!0,null!=this.postProcess&&(this.postProcess(this.postProcessArg),this.postProcess=null),this.blocks.refreshCanvas(),this.blocks.cleanupAfterLoad();else{var b=new ProtoBlock("collapse");b.scale=this.protoblock.scale,b.extraWidth=10,b.basicBlockCollapsed();var c=b.generator();this.collapseArtwork=c[0];var d=function(a){loadCollapsibleEventHandlers(a),a.loadComplete=!0,null!=a.postProcess&&(a.postProcess(a.postProcessArg),a.postProcess=null)};this.generateCollapseArtwork(d)}},this.generateCollapseArtwork=function(a){function b(b,d,e){function f(b,d,e){if(e.highlightCollapseBlockBitmap=d,e.highlightCollapseBlockBitmap.name="highlight_collapse_"+c,e.container.addChild(e.highlightCollapseBlockBitmap),e.highlightCollapseBlockBitmap.visible=!1,null==e.collapseText){var f=10*e.protoblock.scale;"action"==e.name?e.collapseText=new createjs.Text(_("action"),f+"px Sans","#000000"):e.collapseText=new createjs.Text(_("start"),f+"px Sans","#000000"),e.collapseText.textAlign="left",e.collapseText.textBaseline="alphabetic",e.container.addChild(e.collapseText)}positionCollapseLabel(e,e.protoblock.scale),e.collapseText.visible=e.collapsed,ensureDecorationOnTop(e),e.container.updateCache(),e.blocks.refreshCanvas(),e.collapseContainer=new createjs.Container,e.collapseContainer.snapToPixelEnabled=!0;var g=new Image;g.onload=function(){e.collapseBitmap=new createjs.Bitmap(g),e.collapseBitmap.scaleX=e.collapseBitmap.scaleY=e.collapseBitmap.scale=e.protoblock.scale/2,e.collapseContainer.addChild(e.collapseBitmap),e.collapseBitmap.visible=!e.collapsed,finishCollapseButton(e)},g.src="images/collapse.svg",finishCollapseButton=function(b){var c=new Image;c.onload=function(){b.expandBitmap=new createjs.Bitmap(c),b.expandBitmap.scaleX=b.expandBitmap.scaleY=b.expandBitmap.scale=b.protoblock.scale/2,b.collapseContainer.addChild(b.expandBitmap),b.expandBitmap.visible=b.collapsed;var d=b.collapseContainer.getBounds();b.collapseContainer.cache(d.x,d.y,d.width,d.height),b.blocks.stage.addChild(b.collapseContainer),null!=a&&a(b),b.blocks.refreshCanvas(),b.blocks.cleanupAfterLoad()},c.src="images/expand.svg"}}e.collapseBlockBitmap=d,e.collapseBlockBitmap.name="collapse_"+c,e.container.addChild(e.collapseBlockBitmap),e.collapseBlockBitmap.visible=e.collapsed,e.blocks.refreshCanvas();var g=e.collapseArtwork;makeBitmap(g.replace(/fill_color/g,PALETTEHIGHLIGHTCOLORS[e.protoblock.palette.name]).replace(/stroke_color/g,HIGHLIGHTSTROKECOLORS[e.protoblock.palette.name]).replace("block_label",""),"",f,e)}var c=this.blocks.blockList.indexOf(this),d=this.collapseArtwork;makeBitmap(d.replace(/fill_color/g,PALETTEFILLCOLORS[this.protoblock.palette.name]).replace(/stroke_color/g,PALETTESTROKECOLORS[this.protoblock.palette.name]).replace("block_label",""),"",b,this)},this.hide=function(){this.container.visible=!1,null!=this.collapseContainer&&(this.collapseContainer.visible=!1,this.collapseText.visible=!1)},this.show=function(){this.trash||["action","start"].indexOf(this.name)==-1&&this.collapsed||(this.container.visible=!0,null!=this.collapseContainer&&(this.collapseContainer.visible=!0,this.collapseText.visible=!0))},this.isValueBlock=function(){return"value"==this.protoblock.style},this.isArgBlock=function(){return"value"==this.protoblock.style||"arg"==this.protoblock.style},this.isTwoArgBlock=function(){return"twoarg"==this.protoblock.style},this.isTwoArgBooleanBlock=function(){return["equal","greater","less"].indexOf(this.name)!=-1},this.isClampBlock=function(){return"clamp"==this.protoblock.style||this.isDoubleClampBlock()},this.isDoubleClampBlock=function(){return"doubleclamp"==this.protoblock.style},this.isNoRunBlock=function(){return"action"==this.name},this.isArgClamp=function(){return"argclamp"==this.protoblock.style||"argclamparg"==this.protoblock.style},this.isExpandableBlock=function(){return this.protoblock.expandable},this.getBlockId=function(){var a=blockBlocks.blockList.indexOf(this);return"_"+a.toString()},this.removeChildBitmap=function(a){for(var b=0;b<this.container.getNumChildren();b++)if(this.container.children[b].name==a){this.container.removeChild(this.container.children[b]);break}},this.loadThumbnail=function(a){var b=this.blocks.blockList.indexOf(this),c=this;if(null!=this.blocks.blockList[b].value||null!=a){var d=new Image;d.onload=function(){c.removeChildBitmap("media");var a=new createjs.Bitmap(d);a.name="media";var b=new createjs.Container;b.addChild(a);var e=600,f=450;d.width>d.height?d.width>e&&(a.scaleX=a.scaleY=a.scale=e/d.width):d.height>f&&(a.scaleX=a.scaleY=a.scale=f/d.height);var g=b.getBounds();b.cache(g.x,g.y,g.width,g.height),c.value=b.getCacheDataURL(),c.imageBitmap=a,positionMedia(a,c,a.image.width,a.image.height,c.protoblock.scale),c.container.addChild(a),c.container.updateCache(),c.blocks.refreshCanvas()},null==a?d.src=this.value:d.src=a}},this.doOpenMedia=function(a,b){var c=docById("myOpenAll");readerAction=function(d){window.scroll(0,0);var e=new FileReader;e.onloadend=function(){if(e.result){if("media"==a.name)return a.value=e.result,void a.loadThumbnail(null);a.value=[c.files[0].name,e.result],a.blocks.updateBlockText(b)}},"media"==a.name?e.readAsDataURL(c.files[0]):e.readAsText(c.files[0]),c.removeEventListener("change",readerAction)},c.addEventListener("change",readerAction,!1),c.focus(),c.click(),window.scroll(0,0)},void(this.collapseToggle=function(){function a(a){var b=a.collapsed;if(null==a.collapseBitmap)return void console.log("collapse bitmap not ready");if(a.collapsed=!b,a.collapseBitmap.visible=b,a.expandBitmap.visible=!b,a.collapseBlockBitmap.visible=!b,a.highlightCollapseBlockBitmap.visible=!1,a.collapseText.visible=!b,b?a.bitmap.visible=!0:(a.bitmap.visible=!1,a.container.updateCache()),a.highlightBitmap.visible=!1,"action"==a.name)if(null!=a.connections[1]){var c=a.blocks.blockList[a.connections[1]].value;c.length>8&&(c=c.substr(0,7)+"..."),a.collapseText.text=c}else a.collapseText.text="";var d=a.container.getNumChildren()-1;if(a.container.setChildIndex(a.collapseText,d),a.blocks.dragGroup.length>0)for(var e=1;e<a.blocks.dragGroup.length;e++){var f=a.blocks.dragGroup[e];a.blocks.blockList[f].collapsed=!b,a.blocks.blockList[f].container.visible=b}a.collapseContainer.updateCache(),a.container.updateCache(),a.blocks.refreshCanvas()}var b=this.blocks.blockList.indexOf(this);this.blocks.findDragGroup(b),a(this)}))}function $(){for(var a=new Array,b=0;b<arguments.length;b++){var c=arguments[b];if("string"==typeof c&&(c=docById(c)),1==arguments.length)return c;a.push(c)}return a}function positionText(a,b){a.text.textBaseline="alphabetic",a.text.textAlign="right";var c=10*b;if(a.text.font=c+"px Sans",a.text.x=TEXTX*b/2,a.text.y=TEXTY*b/2,"text"==a.name||"number"==a.name)a.text.textAlign="center",a.text.x=VALUETEXTX*b/2;else if(0==a.protoblock.args){var d=a.container.getBounds();a.text.x=d.width-25}else a.text.textAlign="left","booleanout"==a.docks[0][2]&&(a.text.y=a.docks[0][1]);z=a.container.getNumChildren()-1,a.container.setChildIndex(a.text,z),a.container.updateCache()}function positionMedia(a,b,c,d,e){c>d?a.scaleX=a.scaleY=a.scale=MEDIASAFEAREA[2]/c*e/2:a.scaleX=a.scaleY=a.scale=MEDIASAFEAREA[3]/d*e/2,a.x=(MEDIASAFEAREA[0]-10)*e/2,a.y=MEDIASAFEAREA[1]*e/2}function calculateCollapseHitArea(a){var b=a.collapseContainer.getBounds(),c=new createjs.Shape,d=b.width,e=b.height;c.graphics.beginFill("#FFF").drawEllipse(-d/2,-e/2,d,e),c.x=d/2,c.y=e/2,a.collapseContainer.hitArea=c}function positionCollapseLabel(a,b){a.collapseText.x=COLLAPSETEXTX*b/2,a.collapseText.y=COLLAPSETEXTY*b/2,z=a.container.getNumChildren()-1,a.container.setChildIndex(a.collapseText,z)}function positionCollapseContainer(a,b){a.collapseContainer.x=a.container.x+COLLAPSEBUTTONXOFF*b/2,a.collapseContainer.y=a.container.y+COLLAPSEBUTTONYOFF*b/2}function loadCollapsibleEventHandlers(a){function b(){e||(e=!0,setTimeout(function(){e=!1},500),hideDOMLabel(),d||a.collapseToggle())}var c=a.blocks.blockList.indexOf(a);calculateCollapseHitArea(a),a.collapseContainer.on("mouseover",function(b){a.blocks.highlight(c,!0),a.blocks.activeBlock=c,a.blocks.refreshCanvas()});var d=!1,e=!1,f=!1,g={x:0,y:0};a.collapseContainer.on("click",function(a){b()}),a.collapseContainer.on("mousedown",function(b){hideDOMLabel(),trashcan.show(),d=!1,f=!0;var c=new Date;blocks.time=c.getTime(),g={x:a.collapseContainer.x-Math.round(b.stageX/a.blocks.scale),y:a.collapseContainer.y-Math.round(b.stageY/a.blocks.scale)}}),a.collapseContainer.on("pressup",function(e){if(f)if(f=!1,d)collapseOut(blocks,a,c,d,e),d=!1;else{var g=new Date;if(g.getTime()-blocks.time>1e3){var g=new Date;blocks.time=g.getTime(),b()}}}),a.collapseContainer.on("mouseout",function(e){if(f)if(f=!1,d)collapseOut(blocks,a,c,d,e),d=!1;else{var g=new Date;if(g.getTime()-blocks.time<200){var g=new Date;blocks.time=g.getTime(),b()}}}),a.collapseContainer.on("pressmove",function(b){if(f){d=!0;var e=a.collapseContainer.x,h=a.collapseContainer.y;a.collapseContainer.x=Math.round(b.stageX/a.blocks.scale+g.x),a.collapseContainer.y=Math.round(b.stageY/a.blocks.scale+g.y);var i=a.collapseContainer.x-e,j=a.collapseContainer.y-h;if(a.container.x+=i,a.container.y+=j,a.x=a.container.x,a.y=a.container.y,trashcan.overTrashcan(b.stageX/a.blocks.scale,b.stageY/a.blocks.scale)?trashcan.highlight():trashcan.unhighlight(),a.blocks.findDragGroup(c),a.blocks.dragGroup.length>0)for(var k=0;k<a.blocks.dragGroup.length;k++){var l=a.blocks.dragGroup[k];0!=k&&a.blocks.moveBlockRelative(l,i,j)}a.blocks.refreshCanvas()}})}function collapseOut(a,b,c,d,e){trashcan.hide(),a.unhighlight(c),d&&(trashcan.overTrashcan(e.stageX/a.scale,e.stageY/a.scale)?sendStackToTrash(a,b):a.blockMoved(c)),a.activeBlock==b&&(a.unhighlight(null),a.activeBlock=null,a.refreshCanvas())}function calculateBlockHitArea(a){var b=new createjs.Shape,c=a.container.getBounds();a.isClampBlock()||a.isArgClamp()?b.graphics.beginFill("#FFF").drawRect(0,0,c.width,STANDARDBLOCKHEIGHT):b.graphics.beginFill("#FFF").drawRect(0,0,c.width,.75*c.height),a.container.hitArea=b}function loadEventHandlers(a){var b=a.blocks.blockList.indexOf(a),c=a.blocks;calculateBlockHitArea(a),a.container.on("mouseover",function(a){c.highlight(b,!0),c.refreshCanvas()});var d=!1,e=!1,f=!1,g=window.hasMouse;a.container.on("click",function(h){if(c.activeBlock=b,d=!0,!f&&(f=!0,setTimeout(function(){f=!1},500),hideDOMLabel(),!window.hasMouse&&g||window.hasMouse&&!e))if(c.selectingStack){var i=c.findTopBlock(b);c.selectedStack=i,c.selectingStack=!1}else if("media"==a.name)a.doOpenMedia(a,b);else if("loadFile"==a.name)a.doOpenMedia(a,b);else if("text"==a.name||"number"==a.name)a.trash||changeLabel(a);else if(!c.inLongPress){var i=c.findTopBlock(b);console.log("running from "+c.blockList[i].name),c.logo.runLogoCommands(i)}}),a.container.on("mousedown",function(f){if(null==a.connections[0]){var h=new Date;c.time=h.getTime(),c.timeOut=setTimeout(function(){c.triggerLongPress(a)},LONGPRESSTIME)}trashcan.show(),c.raiseStackToTop(b),null!=a.collapseContainer&&c.stage.setChildIndex(a.collapseContainer,c.stage.getNumChildren()-1),e=!1;var i={x:a.container.x-Math.round(f.stageX/c.scale),y:a.container.y-Math.round(f.stageY/c.scale)};a.container.on("mouseout",function(b){d||(c.inLongPress||mouseoutCallback(a,b,e,d,!0),e=!1)}),a.container.on("pressup",function(b){d||(c.inLongPress||mouseoutCallback(a,b,e,d,!0),e=!1)});var j={x:f.stageX,y:f.stageY};a.container.on("pressmove",function(d){d.nativeEvent.preventDefault(),null!=c.timeOut&&(clearTimeout(c.timeOut),c.timeOut=null),e||null==a.label||(a.label.style.display="none"),window.hasMouse?e=!0:setTimeout(function(){e=Math.abs(d.stageX-j.x)+Math.abs(d.stageY-j.y)>20&&!window.hasMouse,g=!e},200);var f=a.container.x,h=a.container.y;a.container.x=Math.round(d.stageX/c.scale)+i.x,a.container.y=Math.round(d.stageY/c.scale)+i.y,a.x=a.container.x,a.y=a.container.y;var k=Math.round(a.container.x-f),l=Math.round(a.container.y-h);if(trashcan.overTrashcan(d.stageX/c.scale,d.stageY/c.scale)?trashcan.highlight():trashcan.unhighlight(),a.isValueBlock()&&"media"!=a.name){var m=a.container.getNumChildren()-1;a.container.setChildIndex(a.text,m)}else null!=a.collapseContainer&&positionCollapseContainer(a,a.protoblock.scale);if(c.findDragGroup(b),c.dragGroup.length>0)for(var n=0;n<c.dragGroup.length;n++){var o=c.dragGroup[n];0!=n&&c.moveBlockRelative(o,k,l)}c.refreshCanvas()})}),a.container.on("mouseout",function(b){c.inLongPress||mouseoutCallback(a,b,e,d,!0),e=!1}),a.container.on("pressup",function(b){c.inLongPress||mouseoutCallback(a,b,e,d,!1),e=!1})}function mouseoutCallback(a,b,c,d,e){var f=a.blocks.blockList.indexOf(a);if(null!=a.blocks.timeOut&&(clearTimeout(a.blocks.timeOut),a.blocks.timeOut=null),trashcan.hide(),c)if(trashcan.overTrashcan(b.stageX/a.blocks.scale,b.stageY/a.blocks.scale))sendStackToTrash(blocks,a);else{var g=new Date;blocks.time=g.getTime(),a.blocks.blockMoved(f)}else if(["text","number","media","loadFile"].indexOf(a.name)!=-1&&!d){var g=new Date;if(g.getTime()-blocks.time<500&&!a.trash){var g=new Date;blocks.time=g.getTime(),"media"==a.name||"loadFile"==a.name?a.doOpenMedia(a,f):changeLabel(a)}}e&&(a.blocks.activeBlock!=f?hideDOMLabel():(a.blocks.unhighlight(null),a.blocks.refreshCanvas()),a.blocks.activeBlock=null)}function ensureDecorationOnTop(a){for(var b=0;b<a.container.getNumChildren();b++)if("decoration"==a.container.children[b].name){a.container.setChildIndex(a.container.children[b],a.container.getNumChildren()-1);break}}function makeBitmap(a,b,c,d){var e=new Image;e.onload=function(){bitmap=new createjs.Bitmap(e),c(b,bitmap,d)},e.src="data:image/svg+xml;base64,"+window.btoa(unescape(encodeURIComponent(a)))}function changeLabel(a){var b=a.blocks,c=a.container.x,d=a.container.y,e=b.canvas.offsetLeft+28,f=b.canvas.offsetTop+6,g=!1;if(!window.hasMouse&&b.stage.y+d>75){g=!0;var h=b.stage.y;b.stage.y=-d+75}if("text"==a.name)var i="text";else var i="number";var j=a.label?a.label.value:a.value,k=docById("labelDiv");k.innerHTML='<input id="'+i+'Label" style="position: absolute; -webkit-user-select: text;-moz-user-select: text;-ms-user-select: text;" class="'+i+'" type="'+i+'" value="'+j+'" />',k.classList.add("hasKeyboard"),a.label=docById(i+"Label");var l=!1,m=function(c){l&&(labelChanged(a),c.preventDefault(),k.classList.remove("hasKeyboard"),window.scroll(0,0),a.label.style.display="none",a.label.removeEventListener("keypress",n),g&&(b.stage.y=h,b.updateStage()))};a.label.addEventListener("blur",m);var n=function(a){[13,10,9].indexOf(a.keyCode)!==-1&&m(a)};a.label.addEventListener("keypress",n),a.label.addEventListener("change",function(){labelChanged(a)}),a.label.style.left=Math.round((c+b.stage.x)*b.scale+e)+"px",a.label.style.top=Math.round((d+b.stage.y)*b.scale+f)+"px",a.label.style.width=Math.round(100*b.scale)*a.protoblock.scale/2+"px",a.label.style.fontSize=Math.round(20*b.scale*a.protoblock.scale/2)+"px",a.label.style.display="",a.label.focus(),setTimeout(function(){a.label.style.display="",a.label.focus(),l=!0},100)}function labelChanged(a){if(null!=a){var b=a.value,c=a.label.value;if(b!=c){if("number"==a.name){if(a.value=Number(c),isNaN(a.value)){var d=a.blocks.blockList.indexOf(a);a.blocks.errorMsg(c+": Not a number",d),a.blocks.refreshCanvas(),a.value=b}}else a.value=c;var e=a.value.toString();e.length>8&&(e=e.substr(0,7)+"..."),a.text.text=e,a.label.style.display="none";var f=a.container.getNumChildren()-1;a.container.setChildIndex(a.text,f);try{a.container.updateCache()}catch(a){console.log(a)}a.blocks.refreshCanvas();var g=a.connections[0];if("text"==a.name&&null!=g){var h=a.blocks.blockList[g];switch(console.log("Label changed to: "+a.value),h.name){case"action":console.log("renameDos and..."),a.blocks.renameDos(b,c),b==_("action")?(console.log("newNameddoBlock."),a.blocks.newNameddoBlock(c,a.blocks.actionHasReturn(g),a.blocks.actionHasArgs(g))):(console.log("renameNameddos."),a.blocks.renameNameddos(b,c)),a.blocks.palettes.updatePalettes("actions");break;case"storein":"box"!=a.value&&(a.blocks.newStoreinBlock(a.value),a.blocks.newNamedboxBlock(a.value)),a.blocks.renameBoxes(b,c),a.blocks.renameNamedboxes(b,c),a.blocks.palettes.updatePalettes("blocks")}}}}}var LONGPRESSTIME=2e3;window.hasMouse=!1,document.addEventListener("mousemove",function(a){window.hasMouse=!0});