/*! Sugarizer 2016-12-28 */
function Turtle(a,b){this.name=a,this.turtles=b,this.running=!1,this.trash=!1,this.container=null,this.x=0,this.y=0,this.bitmap=null,this.skinChanged=!1,this.startBlock=null,this.decorationBitmap=null,this.queue=[],this.listeners={},this.drawingCanvas=null,this.imageContainer=null,this.svgOutput="",this.svgPath=!1,this.color=DEFAULTCOLOR,this.value=DEFAULTVALUE,this.chroma=DEFAULTCHROMA,this.stroke=DEFAULTSTROKE,this.canvasColor="#ff0031",this.orientation=0,this.fillState=!1,this.hollowState=!1,this.penState=!0,this.font=DEFAULTFONT,this.media=[],this.move=function(a,b,c,d,e){function f(a,b,c,d,e,f){for(var g=f,h=Math.PI/b,i=0;i<b;i++){var j=c+e*Math.cos(g),k=d+e*Math.sin(g);a.svgOutput+=j+","+k+" ",g+=h}}if(e?(a=this.turtles.turtleX2screenX(a),b=this.turtles.turtleY2screenY(b),nx=this.turtles.turtleX2screenX(c),ny=this.turtles.turtleY2screenY(d)):(nx=c,ny=d),this.penState&&this.hollowState){this.closeSVG(),this.svgPath=!0;var g=this.stroke;if(this.stroke=1,this.drawingCanvas.graphics.setStrokeStyle(this.stroke,"round","round"),g<3)var h=.5;else var h=(g-2)/2;var i=(this.orientation-90)*Math.PI/180,j=h*Math.sin(i),k=-h*Math.cos(i);this.drawingCanvas.graphics.moveTo(a+j,b+k);var l=(a+j)*this.turtles.scale,m=(b+k)*this.turtles.scale;this.svgOutput+='<path d="M '+l+","+m+" ",this.drawingCanvas.graphics.lineTo(nx+j,ny+k);var n=(nx+j)*this.turtles.scale,o=(ny+k)*this.turtles.scale;this.svgOutput+=n+","+o+" ";var i=(this.orientation+90)*Math.PI/180,j=h*Math.sin(i),k=-h*Math.cos(i),p=this.orientation/180*Math.PI,q=nx,r=ny,s=p-Math.PI,t=p;this.drawingCanvas.graphics.arc(q,r,h,s,t,!1);var n=(nx+j)*this.turtles.scale,o=(ny+k)*this.turtles.scale,u=h*this.turtles.scale;steps=Math.max(Math.floor(g,1)),f(this,steps,q*this.turtles.scale,r*this.turtles.scale,u,s),this.svgOutput+=n+","+o+" ",this.drawingCanvas.graphics.lineTo(a+j,b+k);var n=(a+j)*this.turtles.scale,o=(b+k)*this.turtles.scale;this.svgOutput+=n+","+o+" ";var i=(this.orientation-90)*Math.PI/180,j=h*Math.sin(i),k=-h*Math.cos(i),p=(this.orientation+180)/180*Math.PI,q=a,r=b,s=p-Math.PI,t=p;this.drawingCanvas.graphics.arc(q,r,h,s,t,!1);var n=(a+j)*this.turtles.scale,o=(b+k)*this.turtles.scale,u=h*this.turtles.scale;f(this,steps,q*this.turtles.scale,r*this.turtles.scale,u,s),this.svgOutput+=n+","+o+" ",this.closeSVG(),this.stroke=g,this.drawingCanvas.graphics.setStrokeStyle(this.stroke,"round","round"),this.drawingCanvas.graphics.moveTo(nx,ny)}else if(this.penState){if(this.drawingCanvas.graphics.lineTo(nx,ny),!this.svgPath){this.svgPath=!0;var l=a*this.turtles.scale,m=b*this.turtles.scale;this.svgOutput+='<path d="M '+l+","+m+" "}var n=nx*this.turtles.scale,o=ny*this.turtles.scale;this.svgOutput+=n+","+o+" "}else this.drawingCanvas.graphics.moveTo(nx,ny);this.container.x=nx,this.container.y=ny,e?(this.x=c,this.y=d):(this.x=this.turtles.screenX2turtleX(c),this.y=this.turtles.screenY2turtleY(d))},this.arc=function(a,b,c,d,e,f,g,h,i,j,k){function l(a,b,c,d,e,f,g){for(var h=f,i=(g-f)/b,j=0;j<b;j++){var k=c+e*Math.cos(h),l=d+e*Math.sin(h);a.svgOutput+=k+","+l+" ",h+=i}}if(k?(a=this.turtles.turtleX2screenX(a),b=this.turtles.turtleY2screenY(b),c=this.turtles.turtleX2screenX(c),d=this.turtles.turtleY2screenY(d),nx=this.turtles.turtleX2screenX(e),ny=this.turtles.turtleY2screenY(f)):(nx=e,ny=f),j?(sa=h,ea=i):(sa=h-Math.PI,ea=i-Math.PI),this.penState&&this.hollowState){this.closeSVG(),this.svgPath=!0;var m=this.stroke;if(this.stroke=1,this.drawingCanvas.graphics.setStrokeStyle(this.stroke,"round","round"),m<3)var n=.5;else var n=(m-2)/2;var o=(this.orientation+90)*Math.PI/180,p=n*Math.sin(o),q=-n*Math.cos(o);if(j){this.drawingCanvas.graphics.moveTo(c+p,d+q);var r=(c+p)*this.turtles.scale,s=(d+q)*this.turtles.scale}else{this.drawingCanvas.graphics.moveTo(c-p,d-q);var r=(c-p)*this.turtles.scale,s=(d-q)*this.turtles.scale}this.svgOutput+='<path d="M '+r+","+s+" ",this.drawingCanvas.graphics.arc(a,b,g+n,sa,ea,j),nsteps=Math.max(Math.floor(g*Math.abs(sa-ea)/2),2),steps=Math.max(Math.floor(m,1)),l(this,nsteps,a*this.turtles.scale,b*this.turtles.scale,(g+n)*this.turtles.scale,sa,ea);var o=(this.orientation+90)*Math.PI/180,p=n*Math.sin(o),q=-n*Math.cos(o),t=nx,u=ny,v=ea,w=ea+Math.PI;this.drawingCanvas.graphics.arc(t,u,n,v,w,j),l(this,steps,t*this.turtles.scale,u*this.turtles.scale,n*this.turtles.scale,v,w),this.drawingCanvas.graphics.arc(a,b,g-n,ea,sa,!j),l(this,nsteps,a*this.turtles.scale,b*this.turtles.scale,(g-n)*this.turtles.scale,ea,sa);var x=c,y=d,z=sa-Math.PI,A=sa;this.drawingCanvas.graphics.arc(x,y,n,z,A,j),l(this,steps,x*this.turtles.scale,y*this.turtles.scale,n*this.turtles.scale,z,A),this.closeSVG(),this.stroke=m,this.drawingCanvas.graphics.setStrokeStyle(this.stroke,"round","round"),this.drawingCanvas.graphics.moveTo(nx,ny)}else if(this.penState){if(this.drawingCanvas.graphics.arc(a,b,g,sa,ea,j),!this.svgPath){this.svgPath=!0;var r=c*this.turtles.scale,s=d*this.turtles.scale;this.svgOutput+='<path d="M '+r+","+s+" "}if(j)var B=0;else var B=1;var C=nx*this.turtles.scale,D=ny*this.turtles.scale,E=g*this.turtles.scale;this.svgOutput+="A "+E+","+E+" 0 0 "+B+" "+C+","+D+" "}else this.drawingCanvas.graphics.moveTo(nx,ny);this.container.x=nx,this.container.y=ny,k?(this.x=e,this.y=f):(this.x=this.screenX2turtles.turtleX(e),this.y=this.screenY2turtles.turtleY(f))},this.doClear=function(){this.x=0,this.y=0,this.orientation=0;var a=this.turtles.turtleList.indexOf(this)%10;for(this.color=10*a,this.value=DEFAULTVALUE,this.chroma=DEFAULTCHROMA,this.stroke=DEFAULTSTROKE,this.font=DEFAULTFONT,this.container.x=this.turtles.turtleX2screenX(this.x),this.container.y=this.turtles.turtleY2screenY(this.y),this.skinChanged&&(this.doTurtleShell(55,turtleBasePath+"turtle-"+a.toString()+".svg"),this.skinChanged=!1),this.bitmap.rotation=this.orientation,this.container.updateCache(),a=0;a<this.media.length;a++)this.imageContainer.removeChild(this.media[a]),this.turtles.stage.removeChild(this.media[a]),delete this.media[a];this.media=[],this.penState=!0,this.fillState=!1,this.hollowState=!1,this.canvasColor=getMunsellColor(this.color,this.value,this.chroma),this.drawingCanvas.graphics.clear(),this.drawingCanvas.graphics.beginStroke(this.canvasColor),this.drawingCanvas.graphics.setStrokeStyle(this.stroke,"round","round"),this.svgOutput="",this.svgPath=!1,this.turtles.refreshCanvas()},this.doForward=function(a){this.fillState||(this.drawingCanvas.graphics.beginStroke(this.canvasColor),this.drawingCanvas.graphics.setStrokeStyle(this.stroke,"round","round"),this.drawingCanvas.graphics.moveTo(this.container.x,this.container.y));var b=this.turtles.screenX2turtleX(this.container.x),c=this.turtles.screenY2turtleY(this.container.y),d=this.orientation*Math.PI/180,e=b+Number(a)*Math.sin(d),f=c+Number(a)*Math.cos(d);this.move(b,c,e,f,!0),this.turtles.refreshCanvas()},this.doSetXY=function(a,b){this.fillState||(this.drawingCanvas.graphics.beginStroke(this.canvasColor),this.drawingCanvas.graphics.setStrokeStyle(this.stroke,"round","round"),this.drawingCanvas.graphics.moveTo(this.container.x,this.container.y));var c=this.turtles.screenX2turtleX(this.container.x),d=this.turtles.screenY2turtleY(this.container.y),e=Number(a),f=Number(b);this.move(c,d,e,f,!0),this.turtles.refreshCanvas()},this.doArc=function(a,b){b<0&&(b=-b);var c=Number(a);if(c<0){var d=-1;c=-c}else var d=1;for(var e=c%90,f=Math.floor(c/90),g=0;g<f;g++)this.doArcPart(90*d,b);e>0&&this.doArcPart(e*d,b)},this.doArcPart=function(a,b){this.fillState||(this.drawingCanvas.graphics.beginStroke(this.canvasColor),this.drawingCanvas.graphics.setStrokeStyle(this.stroke,"round","round"),this.drawingCanvas.graphics.moveTo(this.container.x,this.container.y));var c=Number(a),d=c/180*Math.PI,e=this.orientation/180*Math.PI,f=Number(b);if(ox=this.turtles.screenX2turtleX(this.container.x),oy=this.turtles.screenY2turtleY(this.container.y),c<0){var g=!0;c=-c;var h=ox-Math.cos(e)*f,i=oy+Math.sin(e)*f,j=h+Math.cos(e+d)*f,k=i-Math.sin(e+d)*f}else var g=!1,h=ox+Math.cos(e)*f,i=oy-Math.sin(e)*f,j=h-Math.cos(e+d)*f,k=i+Math.sin(e+d)*f;this.arc(h,i,ox,oy,j,k,f,e,e+d,g,!0),g?this.doRight(-c):this.doRight(c),this.turtles.refreshCanvas()},this.doShowImage=function(a,b){if(null!=b){var c=new Image,d=this;c.onload=function(){var b=new createjs.Bitmap(c);d.imageContainer.addChild(b),d.media.push(b),b.scaleX=Number(a)/c.width,b.scaleY=b.scaleX,b.scale=b.scaleX,b.x=d.container.x,b.y=d.container.y,b.regX=c.width/2,b.regY=c.height/2,b.rotation=d.orientation,d.turtles.refreshCanvas()},c.src=b}},this.doShowURL=function(a,b){if(null!=b){var c=new Image;c.src=b;var d=this;c.onload=function(){var b=new createjs.Bitmap(c);d.imageContainer.addChild(b),d.media.push(b),b.scaleX=Number(a)/c.width,b.scaleY=b.scaleX,b.scale=b.scaleX,b.x=d.container.x,b.y=d.container.y,b.regX=c.width/2,b.regY=c.height/2,b.rotation=d.orientation,d.turtles.refreshCanvas()}}},this.doTurtleShell=function(a,b){if(null!=b){var c=new Image;c.src=b;var d=this;c.onload=function(){d.container.removeChild(d.bitmap),d.bitmap=new createjs.Bitmap(c),d.container.addChild(d.bitmap),d.bitmap.scaleX=Number(a)/c.width,d.bitmap.scaleY=d.bitmap.scaleX,d.bitmap.scale=d.bitmap.scaleX,d.bitmap.x=0,d.bitmap.y=0,d.bitmap.regX=c.width/2,d.bitmap.regY=c.height/2,d.bitmap.rotation=d.orientation,d.skinChanged=!0,d.container.uncache();var e=d.container.getBounds();d.container.cache(e.x,e.y,e.width,e.height);var f=new createjs.Shape;if(f.graphics.beginFill("#FFF").drawRect(0,0,e.width,e.height),f.x=-e.width/2,f.y=-e.height/2,d.container.hitArea=f,null!=d.startBlock){d.startBlock.container.removeChild(d.decorationBitmap),d.decorationBitmap=new createjs.Bitmap(b),d.startBlock.container.addChild(d.decorationBitmap),d.decorationBitmap.name="decoration";var e=d.startBlock.container.getBounds();d.decorationBitmap.x=e.width-50*d.startBlock.protoblock.scale/2,d.decorationBitmap.y=20*d.startBlock.protoblock.scale/2,d.decorationBitmap.scaleX=27.5/c.width*d.startBlock.protoblock.scale/2,d.decorationBitmap.scaleY=27.5/c.height*d.startBlock.protoblock.scale/2,d.decorationBitmap.scale=27.5/c.width*d.startBlock.protoblock.scale/2,d.startBlock.container.updateCache()}d.turtles.refreshCanvas()}}},this.resizeDecoration=function(a,b){this.decorationBitmap.x=b-30*a/2,this.decorationBitmap.y=35*a/2,this.decorationBitmap.scaleX=this.decorationBitmap.scaleY=this.decorationBitmap.scale=.5*a/2},this.doShowText=function(a,b){var c=a.toString()+"px "+this.font,d=new createjs.Text(b.toString(),c,this.canvasColor);d.textAlign="left",d.textBaseline="alphabetic",this.turtles.stage.addChild(d),this.media.push(d),d.x=this.container.x,d.y=this.container.y,d.rotation=this.orientation;var e=d.x*this.turtles.scale,f=d.y*this.turtles.scale,g=a*this.turtles.scale;this.svgOutput+='<text x="'+e+'" y = "'+f+'" fill="'+this.canvasColor+'" font-family = "'+this.font+'" font-size = "'+g+'">'+b+"</text>",this.turtles.refreshCanvas()},this.doRight=function(a){this.orientation+=Number(a),this.orientation%=360,this.bitmap.rotation=this.orientation,this.container.updateCache(),this.turtles.refreshCanvas()},this.doSetHeading=function(a){this.orientation=Number(a),this.orientation%=360,this.bitmap.rotation=this.orientation,this.turtles.refreshCanvas(),this.container.updateCache()},this.doSetFont=function(a){this.font=a,this.turtles.refreshCanvas(),this.container.updateCache()},this.doSetColor=function(a){this.closeSVG(),this.color=Number(a);var b=getcolor(this.color);this.canvasValue=b[0],this.canvasChroma=b[1],this.canvasColor=b[2],this.drawingCanvas.graphics.beginStroke(this.canvasColor)},this.doSetHue=function(a){this.closeSVG(),this.color=Number(a),this.canvasColor=getMunsellColor(this.color,this.value,this.chroma),this.drawingCanvas.graphics.beginStroke(this.canvasColor)},this.doSetValue=function(a){this.closeSVG(),this.value=Number(a),this.canvasColor=getMunsellColor(this.color,this.value,this.chroma),this.drawingCanvas.graphics.beginStroke(this.canvasColor)},this.doSetChroma=function(a){this.closeSVG(),this.chroma=Number(a),this.canvasColor=getMunsellColor(this.color,this.value,this.chroma),this.drawingCanvas.graphics.beginStroke(this.canvasColor)},this.doSetPensize=function(a){this.closeSVG(),this.stroke=a,this.drawingCanvas.graphics.setStrokeStyle(this.stroke,"round","round")},this.doPenUp=function(){this.closeSVG(),this.penState=!1},this.doPenDown=function(){this.penState=!0},this.doStartFill=function(){this.drawingCanvas.graphics.beginFill(this.canvasColor),this.fillState=!0},this.doEndFill=function(){this.drawingCanvas.graphics.endFill(),this.closeSVG(),this.fillState=!1},this.doStartHollowLine=function(){this.hollowState=!0},this.doEndHollowLine=function(){this.hollowState=!1},this.closeSVG=function(){if(this.svgPath){this.svgOutput+='" style="stroke-linecap:round;fill:',this.fillState?this.svgOutput+=this.canvasColor+";":this.svgOutput+="none;",this.svgOutput+="stroke:"+this.canvasColor+";";var a=this.stroke*this.turtles.scale;this.svgOutput+="stroke-width:"+a+'pt;" />',this.svgPath=!1}}}function Turtles(a,b,c){this.canvas=a,this.stage=b,this.refreshCanvas=c,this.scale=1,this.rotating=!1,this.setScale=function(a){this.scale=a},this.setBlocks=function(a){this.blocks=a},this.turtleList=[],this.add=function(a,b){function c(a,b,c,d){g.bitmap=c,g.bitmap.regX=27,g.bitmap.regY=27,g.bitmap.cursor="pointer",g.container.addChild(g.bitmap);var e=g.container.getBounds();if(g.container.cache(e.x,e.y,e.width,e.height),g.startBlock=d,null!=d){g.decorationBitmap=g.bitmap.clone(),d.container.addChild(g.decorationBitmap),g.decorationBitmap.name="decoration";var e=d.container.getBounds();g.decorationBitmap.x=e.width-30*d.protoblock.scale/2,g.decorationBitmap.y=35*d.protoblock.scale/2,g.decorationBitmap.scaleX=g.decorationBitmap.scaleY=g.decorationBitmap.scale=.5*d.protoblock.scale/2,d.container.updateCache()}a.refreshCanvas()}null!=a?console.log("adding a new turtle "+a.name):console.log("adding a new turtle startBlock is null");var d=!1;"object"==typeof b&&8==Object.keys(b).length&&(d=!0);var e=this.turtleList.length,f=e.toString(),g=new Turtle(f,this);d&&(g.x=b.xcor,g.y=b.ycor),this.turtleList.push(g),g.imageContainer=new createjs.Container,console.log("creating image container"),this.stage.addChild(g.imageContainer),g.drawingCanvas=new createjs.Shape,this.stage.addChild(g.drawingCanvas),g.drawingCanvas.tickEnabled=!1;new Image;e%=10,g.container=new createjs.Container,this.stage.addChild(g.container),g.container.x=this.turtleX2screenX(g.x),g.container.y=this.turtleY2screenY(g.y);var h=new createjs.Shape;h.graphics.beginFill("#FFF").drawEllipse(-27,-27,55,55),h.x=0,h.y=0,g.container.hitArea=h,sugarizerCompatibility.isInsideSugarizer()?makeTurtleBitmap(this,TURTLESVG.replace(/fill_color/g,sugarizerCompatibility.xoColor.fill).replace(/stroke_color/g,sugarizerCompatibility.xoColor.stroke),"turtle",c,a):makeTurtleBitmap(this,TURTLESVG.replace(/fill_color/g,FILLCOLORS[e]).replace(/stroke_color/g,STROKECOLORS[e]),"turtle",c,a),g.color=10*e,g.canvasColor=getMunsellColor(g.color,DEFAULTVALUE,DEFAULTCHROMA);var i=this;g.container.on("mousedown",function(a){if(!i.rotating){var b={x:g.container.x-a.stageX/i.scale,y:g.container.y-a.stageY/i.scale};g.container.on("pressmove",function(a){g.running||(g.container.x=a.stageX/i.scale+b.x,g.container.y=a.stageY/i.scale+b.y,g.x=i.screenX2turtleX(g.container.x),g.y=i.screenY2turtleY(g.container.y),i.refreshCanvas())})}}),g.container.on("click",function(a){i.stage.dispatchEvent("click"+g.name)}),g.container.on("mouseover",function(a){g.bitmap.scaleX=1.2,g.bitmap.scaleY=1.2,g.bitmap.scale=1.2,i.refreshCanvas()}),g.container.on("mouseout",function(a){g.bitmap.scaleX=1,g.bitmap.scaleY=1,g.bitmap.scale=1,i.refreshCanvas()}),document.getElementById("loader").className="",setTimeout(function(){d&&(g.doSetHeading(b.heading),g.doSetPensize(b.pensize),g.doSetChroma(b.grey),g.doSetValue(b.shade),g.doSetColor(b.color))},1e3),this.refreshCanvas()},this.screenX2turtleX=function(a){return a-this.canvas.width/(2*this.scale)},this.screenY2turtleY=function(a){return this.invertY(a)},this.turtleX2screenX=function(a){return this.canvas.width/(2*this.scale)+a},this.turtleY2screenY=function(a){return this.invertY(a)},this.invertY=function(a){return this.canvas.height/(2*this.scale)-a},this.markAsStopped=function(){for(turtle in this.turtleList)this.turtleList[turtle].running=!1},this.running=function(){for(turtle in this.turtleList)if(this.turtleList[turtle].running)return!0;return!1}}function Queue(a,b,c,d){this.blk=a,this.count=b,this.parentBlk=c,this.args=d}function makeTurtleBitmap(a,b,c,d,e){var f=new Image;f.onload=function(){complete=!0,bitmap=new createjs.Bitmap(f),d(a,c,bitmap,e)},f.src="data:image/svg+xml;base64,"+window.btoa(unescape(encodeURIComponent(b)))}var DEFAULTCOLOR=0,DEFAULTVALUE=50,DEFAULTCHROMA=100,DEFAULTSTROKE=5,DEFAULTFONT="sans-serif",turtlePath="images/turtle.svg",turtleBasePath="images/";