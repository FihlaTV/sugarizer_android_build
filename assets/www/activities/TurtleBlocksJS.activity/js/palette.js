/*! Sugarizer 2016-12-28 */
function maxPaletteHeight(a,b){var c=windowHeight()*canvasPixelRatio()/b-2*a;return c-c%STANDARDBLOCKHEIGHT+STANDARDBLOCKHEIGHT/2}function paletteBlockButtonPush(a,b){return console.log("paletteBlockButtonPush: "+a+" "+b),blk=paletteBlocks.makeBlock(a,b),blk}function Palettes(a,b,c,d,b,e){return this.canvas=a,this.refreshCanvas=b,this.stage=c,this.cellSize=d,this.halfCellSize=Math.floor(d/2),this.scrollDiff=0,this.refreshCanvas=b,this.originalSize=55,this.trashcan=e,sugarizerCompatibility.isInsideSugarizer()?storage=sugarizerCompatibility.data:storage=localStorage,this.dict={},this.buttons={},this.visible=!0,this.scale=1,this.x=0,this.y=this.cellSize,this.current="turtle",this.container=new createjs.Container,this.container.snapToPixelEnabled=!0,this.stage.addChild(this.container),this.setScale=function(a){this.scale=a,this.updateButtonMasks();for(var b in this.dict)this.dict[b].resizeEvent()},this.setMacroDictionary=function(a){this.macroDict=a},this.menuScrollEvent=function(a,b){var c=Object.keys(this.buttons),d=a*b;if(!(this.buttons[c[0]].y+d>this.cellSize&&a>0||this.buttons[last(c)].y+d<windowHeight()/this.scale-this.cellSize&&a<0)){this.scrollDiff+=d;for(var e in this.buttons)this.buttons[e].y+=d,this.buttons[e].visible=!0;this.updateButtonMasks(),this.refreshCanvas()}},this.updateButtonMasks=function(){for(var a in this.buttons){var b=new createjs.Shape;b.graphics.r(0,0,this.cellSize,windowHeight()/this.scale),b.x=0,b.y=this.cellSize/2,this.buttons[a].mask=b}},this.makePalettes=function(){function a(a,b,c,d){a.buttons[b].addChild(c),a.cellSize!=a.originalSize&&(c.scaleX=a.cellSize/a.originalSize,c.scaleY=a.cellSize/a.originalSize);var e=new createjs.Shape;e.graphics.beginFill("#FFF").drawEllipse(-a.halfCellSize,-a.halfCellSize,a.cellSize,a.cellSize),e.x=a.halfCellSize,e.y=a.halfCellSize,a.buttons[b].hitArea=e,a.buttons[b].visible=!1,a.dict[b].makeMenu(!1),a.dict[b].moveMenu(a.cellSize,a.cellSize),a.dict[b].updateMenu(!1),loadPaletteButtonHandler(a,b)}for(var b in this.dict)if(b in this.buttons)this.dict[b].updateMenu(!0);else{this.buttons[b]=new createjs.Container,this.buttons[b].snapToPixelEnabled=!0,this.stage.addChild(this.buttons[b]),this.buttons[b].x=this.x,this.buttons[b].y=this.y+this.scrollDiff,this.y+=this.cellSize;var c=this;makePaletteBitmap(c,PALETTEICONS[b],b,a,null)}},this.showPalette=function(a){for(var b in this.dict)this.dict[b]==this.dict[a]?(this.dict[a].showMenu(!0),this.dict[a].showMenuItems(!0)):this.dict[b].visible&&(this.dict[b].hideMenu(!0),this.dict[b].hideMenuItems(!1))},this.showMenus=function(){for(var a in this.buttons)this.buttons[a].visible=!0;for(var a in this.dict);this.refreshCanvas()},this.hideMenus=function(){for(var a in this.buttons)this.buttons[a].visible=!1;for(var a in this.dict)this.dict[a].hideMenu(!0);this.refreshCanvas()},this.getInfo=function(){for(var a in this.dict)console.log(this.dict[a].getInfo())},this.updatePalettes=function(a){if(this.makePalettes(),a){var b=this;setTimeout(function(){b.dict[a].showMenu(),b.dict[a].showMenuItems(),b.refreshCanvas()},250)}else this.refreshCanvas()},this.hide=function(){this.hideMenus(),this.visible=!1},this.show=function(){this.showMenus(),this.visible=!0},this.setBlocks=function(a){paletteBlocks=a},this.add=function(a){return this.dict[a]=new Palette(this,a),this},this.remove=function(a){if(!(a in this.buttons))return void console.log("Palette.remove: Cannot find palette "+a);this.buttons[a].removeAllChildren();for(var b=Object.keys(this.dict),c=b.indexOf(a)+1;c<b.length;c++)this.buttons[b[c]].y-=this.cellSize;delete this.buttons[a],delete this.dict[a],this.y-=this.cellSize,this.makePalettes()},this.bringToTop=function(){for(var a in this.dict){this.stage.removeChild(this.dict[a].menuContainer),this.stage.addChild(this.dict[a].menuContainer);for(var b in this.dict[a].protoContainers)this.stage.removeChild(this.dict[a].protoContainers[b]),this.stage.addChild(this.dict[a].protoContainers[b])}this.refreshCanvas()},this.findPalette=function(a,b){for(var c in this.dict){var d=this.dict[c].menuContainer.x,e=this.dict[c].menuContainer.y,f=Math.min(maxPaletteHeight(this.cellSize,this.scale),this.dict[c].y);if(this.dict[c].menuContainer.visible&&d<a&&a<d+MENUWIDTH&&e<b&&b<e+f)return this.dict[c]}return null},this}function loadPaletteButtonHandler(a,b){var c=!1,d=!1;a.buttons[b].on("mousedown",function(c){d=!0,lastY=c.stageY,a.buttons[b].on("pressmove",function(b){d&&(diff=b.stageY-lastY,a.menuScrollEvent(diff,10),lastY=b.stageY)}),a.buttons[b].on("pressup",function(a){d=!1},null,!0)});var e={};a.buttons[b].on("mouseover",function(c){var d=a.cellSize/2;e=showButtonHighlight(a.buttons[b].x+d,a.buttons[b].y+d,d,c,a.scale,a.stage)}),a.buttons[b].on("pressup",function(b){hideButtonHighlight(e,a.stage)}),a.buttons[b].on("mouseout",function(b){hideButtonHighlight(e,a.stage)}),a.buttons[b].on("click",function(d){c||(c=!0,setTimeout(function(){c=!1},500),a.showPalette(b),a.refreshCanvas())})}function PaletteModel(a,b,c){this.palette=a,this.palettes=b,this.name=c,this.blocks=[],this.calculateHeight=function(a,b){var c=this.palette.protoList[a].size;return["if","while","until","ifthenelse","waitFor"].indexOf(b)!=-1?c=1:(EXPANDBYONE.indexOf(b)!=-1||this.palette.protoList[a].image)&&(c+=1),STANDARDBLOCKHEIGHT*c*this.palette.protoList[a].scale/2},this.update=function(){this.blocks=[];for(var a in this.palette.protoList){var b=this.palette.protoList[a];if(!b.hidden){var c=b.name,d=c;switch(c){case"storein":d="store in "+b.defaults[0];var e=b.defaults[0];break;case"box":d=b.defaults[0];var e=b.defaults[0];break;case"namedbox":if(void 0==b.defaults[0]){d="namedbox";var e=_("box")}else{d=b.defaults[0];var e=b.defaults[0]}break;case"namedarg":if(void 0==b.defaults[0]){d="namedarg";var e="1"}else{d=b.defaults[0];var e=b.defaults[0]}break;case"nameddo":if(void 0==b.defaults[0]){d="nameddo";var e=_("action")}else{d=b.defaults[0];var e=b.defaults[0]}break;case"nameddoArg":if(void 0==b.defaults[0]){d="nameddoArg";var e=_("action")}else{d=b.defaults[0];var e=b.defaults[0]}break;case"namedcalc":if(void 0==b.defaults[0]){d="namedcalc";var e=_("action")}else{d=b.defaults[0];var e=b.defaults[0]}break;case"namedcalcArg":if(void 0==b.defaults[0]){d="namedcalcArg";var e=_("action")}else{d=b.defaults[0];var e=b.defaults[0]}}var f=paletteBlocks.protoBlockDict[c];if(null!=f){var g="";switch(f.name){case"text":g=_("text");break;case"number":g="100";break;case"less":case"greater":case"equal":g=f.staticLabels[0];break;case"namedarg":g="arg "+e;break;default:c!=d?g=b.defaults[0]:f.staticLabels.length>0?(g=f.staticLabels[0],""==g&&(g="loadFile"==c?_("open file"):c)):g=c}switch(["do","nameddo","namedbox","namedcalc","doArg","calcArg","nameddoArg","namedcalcArg"].indexOf(f.name)!=-1&&g.length>8&&(g=g.substr(0,7)+"..."),f.image&&(g=""),f.name){case"namedbox":case"namedarg":var h=new SVG;h.init(),h.setScale(f.scale),h.setExpand(60,0,0,0),h.setOutie(!0);var i=h.basicBox(),j=h.docks;break;case"nameddo":var h=new SVG;h.init(),h.setScale(f.scale),h.setExpand(30,0,0,0);var i=h.basicBlock(),j=h.docks;break;case"ifthenelse":g=f.staticLabels[0]+" "+f.staticLabels[2];case"if":case"until":case"while":case"waitFor":var h=new SVG;h.init(),h.setScale(f.scale),h.setTab(!0),h.setSlot(!0);var i=h.basicBlock(),j=h.docks;break;default:var k=f.generator(),i=k[0],j=k[1]}i=f.disabled?i.replace(/fill_color/g,DISABLEDFILLCOLOR).replace(/stroke_color/g,DISABLEDSTROKECOLOR).replace("block_label",g):i.replace(/fill_color/g,PALETTEFILLCOLORS[f.palette.name]).replace(/stroke_color/g,PALETTESTROKECOLORS[f.palette.name]).replace("block_label",g);for(var l=0;l<=f.args;l++)i=i.replace("arg_label_"+l,f.staticLabels[l]||"");this.blocks.push({blk:a,blkname:c,modname:d,height:this.calculateHeight(a,c),label:g,artwork:i,artwork64:"data:image/svg+xml;base64,"+window.btoa(unescape(encodeURIComponent(i))),docks:j,image:b.image,scale:b.scale,palettename:this.palette.name})}else console.log("Could not find block "+c)}}}}function PopdownPalette(a){this.palettes=a,this.models={};var b=this;for(var c in this.palettes.dict)this.models[c]=new PaletteModel(this.palettes.dict[c],this.palettes,c);this.update=function(){var a='<div class="back"><h2>'+_("back")+"</h2></div>";for(var c in this.models){a+='<div class="palette">';var d=PALETTEICONS[c].replace(/#f{3,6}/gi,PALETTEFILLCOLORS[c]);a+=format('<h2 data-name="{n}">                                 {i}<span>{n}</span>                                 <img class="hide-button" src="icons/hide.svg"                                      alt="{'+_("hide")+'}"                                      title="{'+_("hide")+'}" />                                 <img class="show-button" src="icons/show.svg"                                      alt="{'+_("show")+'}"                                      title="{'+_("show")+'}" />                                 <img class="popout-button" src="icons/popout.svg"                                      alt="{'+_("popout")+'}"                                      title="{'+_("popout")+'}" />                             </h2>',{i:d,n:_(c)}),a+="<ul>",this.models[c].update();for(var e in this.models[c].blocks)a+=format('<li title="{label}"                                     data-blk="{blk}"                                     data-palettename="{palettename}"                                     data-modname="{modname}">                                     <img src="{artwork64}" alt="{label}" />                                 </li>',this.models[c].blocks[e]);a+="</div>"}document.querySelector("#popdown-palette").innerHTML=a,document.querySelector("#popdown-palette .back").addEventListener("click",function(){b.popup()});var f=document.querySelectorAll("#popdown-palette > .palette");Array.prototype.forEach.call(f,function(a){a.querySelector("h2").addEventListener("click",function(){a.classList.contains("show")?a.classList.remove("show"):a.classList.add("show")}),a.querySelector(".popout-button").addEventListener("click",function(){b.popup(),b.palettes.showPalette(a.querySelector("h2").dataset.name)})});var f=document.querySelectorAll("#popdown-palette li");Array.prototype.forEach.call(f,function(a){a.addEventListener("click",function(c){b.popup();var d=b.palettes.dict[a.dataset.palettename];d.protoContainers[a.dataset.modname],makeBlockFromPalette(a.dataset.blk,a.dataset.modname,d,function(a){paletteBlocks.findDragGroup(a);for(var b in paletteBlocks.dragGroup)paletteBlocks.moveBlockRelative(paletteBlocks.dragGroup[b],Math.round(c.clientX/d.palettes.scale)-paletteBlocks.stage.x,Math.round(c.clientY/d.palettes.scale)-paletteBlocks.stage.y);blocks.blockMoved(a)})})})},this.popdown=function(){this.update(),document.querySelector("#popdown-palette").classList.add("show")},this.popup=function(){document.querySelector("#popdown-palette").classList.remove("show")}}function Palette(a,b){return this.palettes=a,this.name=b,this.model=new PaletteModel(this,a,b),this.visible=!1,this.menuContainer=null,this.protoList=[],this.protoContainers={},this.background=null,this.scrollDiff=0,this.y=0,this.size=0,this.columns=0,this.draggingProtoBlock=!1,this.mouseHandled=!1,this.upButton=null,this.downButton=null,this.FadedUpButton=null,this.FadedDownButton=null,this.count=0,this.makeMenu=function(a){function b(a,b,d,e){function f(a,b,d,e){function f(a,b,d,e){function f(a,b,d,e){function f(a,b,d,e){d.scaleX=d.scaleY=d.scale=.7,a.palettes.stage.addChild(d),d.x=a.menuContainer.x+c,d.y=a.getDownButtonY();var f=new createjs.Shape;f.graphics.beginFill("#FFF").drawRect(0,0,STANDARDBLOCKHEIGHT,STANDARDBLOCKHEIGHT),f.x=0,f.y=0,d.hitArea=f,d.visible=!1,a.downButton=d,a.downButton.on("click",function(b){a.scrollEvent(-STANDARDBLOCKHEIGHT,10)})}function g(a,b,d,e){d.scaleX=d.scaleY=d.scale=.7,a.palettes.stage.addChild(d),d.x=a.menuContainer.x+c,d.y=a.getDownButtonY();var f=new createjs.Shape;f.graphics.beginFill("#FFF").drawRect(0,0,STANDARDBLOCKHEIGHT,STANDARDBLOCKHEIGHT),f.x=0,f.y=0,d.hitArea=f,d.visible=!1,a.FadedDownButton=d}function h(a,b,d,e){d.scaleX=d.scaleY=d.scale=.7,a.palettes.stage.addChild(d),d.x=a.menuContainer.x+c,d.y=a.menuContainer.y+STANDARDBLOCKHEIGHT;var f=new createjs.Shape;f.graphics.beginFill("#FFF").drawRect(0,0,STANDARDBLOCKHEIGHT,STANDARDBLOCKHEIGHT),f.x=0,f.y=0,d.hitArea=f,d.visible=!1,a.FadedUpButton=d}d.scaleX=d.scaleY=d.scale=.7,a.palettes.stage.addChild(d),d.x=a.menuContainer.x+c,d.y=a.menuContainer.y+STANDARDBLOCKHEIGHT;var i=new createjs.Shape;i.graphics.beginFill("#FFF").drawRect(0,0,STANDARDBLOCKHEIGHT,STANDARDBLOCKHEIGHT),i.x=0,i.y=0,d.hitArea=i,d.visible=!1,a.upButton=d,a.upButton.on("click",function(b){a.scrollEvent(STANDARDBLOCKHEIGHT,10)}),makePaletteBitmap(a,DOWNICON,b,f,null),makePaletteBitmap(a,FADEDDOWNICON,b,g,null),makePaletteBitmap(a,FADEDUPICON,b,h,null)}d.scaleX=d.scaleY=d.scale=.7,a.menuContainer.addChild(d),d.x=c-STANDARDBLOCKHEIGHT,d.y=0;var g=new createjs.Shape;g.graphics.beginFill("#FFF").drawEllipse(-c/2,-STANDARDBLOCKHEIGHT/2,c,STANDARDBLOCKHEIGHT),g.x=c/2,g.y=STANDARDBLOCKHEIGHT/2,a.menuContainer.hitArea=g,a.menuContainer.visible=!1,a.mouseHandled||(loadPaletteMenuHandler(a),a.mouseHandled=!0),makePaletteBitmap(a,UPICON,b,f,null)}d.scaleX=d.scaleY=d.scale=.8,a.menuContainer.addChild(d),a.palettes.container.addChild(a.menuContainer),makePaletteBitmap(a,CLOSEICON,b,f,null)}a.menuContainer.addChild(d),makePaletteBitmap(a,PALETTEICONS[b],b,f,null)}if(null==this.menuContainer&&(this.menuContainer=new createjs.Container,this.menuContainer.snapToPixelEnabled=!0),a){var c=MENUWIDTH+160*this.columns;this.menuContainer.removeAllChildren(),makePaletteBitmap(this,PALETTEHEADER.replace("fill_color","#282828").replace("palette_label",_(this.name)).replace(/header_width/g,c),this.name,b,null)}},this.getDownButtonY=function(){var a=this.y,b=maxPaletteHeight(this.palettes.cellSize,this.palettes.scale);return this.y>b&&(a=b),this.menuContainer.y+a-3*STANDARDBLOCKHEIGHT},this.resizeEvent=function(){this.updateBackground(),this.updateBlockMasks(),null!==this.downButton&&(this.downButton.y=this.getDownButtonY(),this.FadedDownButton.y=this.getDownButtonY())},this.updateBlockMasks=function(){var a=Math.min(maxPaletteHeight(this.palettes.cellSize,this.palettes.scale),this.y);for(var b in this.protoContainers){var c=new createjs.Shape;c.graphics.r(0,0,MENUWIDTH,a),c.x=this.background.x,c.y=this.background.y,this.protoContainers[b].mask=c}},this.updateBackground=function(){if(null!==this.menuContainer){null!==this.background?this.background.removeAllChildren():(this.background=new createjs.Container,this.background.snapToPixelEnabled=!0,this.background.visible=!1,this.palettes.stage.addChild(this.background),setupBackgroundEvents(this));var a=Math.min(maxPaletteHeight(this.palettes.cellSize,this.palettes.scale),this.y),b=new createjs.Shape;b.graphics.f("#b3b3b3").r(0,0,MENUWIDTH,a).ef(),b.width=MENUWIDTH,b.height=a,this.background.addChild(b),this.background.x=this.menuContainer.x,this.background.y=this.menuContainer.y+STANDARDBLOCKHEIGHT}},this.updateMenu=function(a){function b(a,b,c,d){function e(a,b,c){var d=a.protoContainers[c].getBounds();a.protoContainers[c].cache(d.x,d.y,Math.ceil(d.width),Math.ceil(d.height));var e=new createjs.Shape;e.graphics.beginFill("#FFF").drawRect(0,0,Math.ceil(d.width),Math.ceil(.75*d.height)),a.protoContainers[c].hitArea=e,loadPaletteMenuItemHandler(a,b,c),a.palettes.refreshCanvas()}function f(a,b,c,d){if(a.protoContainers[b].addChild(c),c.x=PALETTELEFTMARGIN,c.y=0,c.scaleX=PROTOBLOCKSCALE,c.scaleY=PROTOBLOCKSCALE,c.scale=PROTOBLOCKSCALE,g.image){var f=new Image;f.onload=function(){var c=new createjs.Bitmap(f);f.width>f.height?c.scaleX=c.scaleY=c.scale=MEDIASAFEAREA[2]/f.width*(g.scale/2):c.scaleX=c.scaleY=c.scale=MEDIASAFEAREA[3]/f.height*(g.scale/2),a.protoContainers[b].addChild(c),c.x=MEDIASAFEAREA[0]*(g.scale/2),c.y=MEDIASAFEAREA[1]*(g.scale/2),e(a,d,b)},f.src=g.image}else e(a,d,b)}var g=d[0],h=d[1];makePaletteBitmap(a,g.artwork,g.modname,f,h)}null==this.menuContainer?this.makeMenu(!1):a&&this.hide(),this.y=0,this.model.update();for(var c in this.model.blocks){var d=this.model.blocks[c];this.protoContainers[d.modname]?this.y+=Math.ceil(d.height*PROTOBLOCKSCALE):(this.protoContainers[d.modname]=new createjs.Container,this.protoContainers[d.modname].snapToPixelEnabled=!0,this.protoContainers[d.modname].x=this.menuContainer.x,this.protoContainers[d.modname].y=this.menuContainer.y+this.y+this.scrollDiff+STANDARDBLOCKHEIGHT,this.palettes.stage.addChild(this.protoContainers[d.modname]),this.protoContainers[d.modname].visible=!1,this.size+=Math.ceil(d.height*PROTOBLOCKSCALE),this.y+=Math.ceil(d.height*PROTOBLOCKSCALE),this.updateBackground(),makePaletteBitmap(this,PALETTEFILLER.replace(/filler_height/g,d.height.toString()),d.modname,b,[d,c]))}this.makeMenu(!0)},this.moveMenu=function(a,b){null!==this.menuContainer&&(dx=a-this.menuContainer.x,dy=b-this.menuContainer.y,this.menuContainer.x=a,this.menuContainer.y=b,this.moveMenuItemsRelative(dx,dy))},this.moveMenuRelative=function(a,b){this.menuContainer.x+=a,this.menuContainer.y+=b,this.moveMenuItemsRelative(a,b)},this.hide=function(){this.hideMenu()},this.show=function(){this.showMenu();for(var a in this.protoContainers)this.protoContainers[a].visible=!0;this.updateBlockMasks(),null!==this.background&&(this.background.visible=!0)},this.hideMenu=function(){null!=this.menuContainer&&(this.menuContainer.visible=!1,this.hideMenuItems(!0)),this.moveMenu(this.palettes.cellSize,this.palettes.cellSize)},this.showMenu=function(){this.menuContainer.visible=!0},this.hideMenuItems=function(a){for(var b in this.protoContainers)this.protoContainers[b].visible=!1;null!==this.background&&(this.background.visible=!1),null!=this.FadedDownButton&&(this.upButton.visible=!1,this.downButton.visible=!1,this.FadedUpButton.visible=!1,this.FadedDownButton.visible=!1),this.visible=!1},this.showMenuItems=function(a){0==this.scrollDiff&&(this.count=0);for(var b in this.protoContainers)this.protoContainers[b].visible=!0;this.updateBlockMasks(),null!==this.background&&(this.background.visible=!0),this.scrollEvent(0,10),this.visible=!0},this.moveMenuItems=function(a,b){for(var c in this.protoContainers)this.protoContainers[c].x=a,this.protoContainers[c].y=b;null!==this.background&&(this.background.x=a,this.background.y=b)},this.moveMenuItemsRelative=function(a,b){for(var c in this.protoContainers)this.protoContainers[c].x+=a,this.protoContainers[c].y+=b;null!==this.background&&(this.background.x+=a,this.background.y+=b),null!==this.FadedDownButton&&(this.upButton.x+=a,this.upButton.y+=b,this.downButton.x+=a,this.downButton.y+=b,this.FadedUpButton.x+=a,this.FadedUpButton.y+=b,this.FadedDownButton.x+=a,this.FadedDownButton.y+=b)},this.scrollEvent=function(a,b){var c=a*b,d=Math.min(maxPaletteHeight(this.palettes.cellSize,this.palettes.scale),this.y);if(this.y<maxPaletteHeight(this.palettes.cellSize,this.palettes.scale))return this.upButton.visible=!1,this.downButton.visible=!1,this.FadedUpButton.visible=!1,void(this.FadedDownButton.visible=!1);if(this.scrollDiff+c>0&&a>0){var e=-this.scrollDiff;if(0==e)return this.downButton.visible=!0,this.upButton.visible=!1,this.FadedUpButton.visible=!0,void(this.FadedDownButton.visible=!1);this.scrollDiff+=e,this.FadedDownButton.visible=!1,this.downButton.visible=!0;for(var f in this.protoContainers)this.protoContainers[f].y+=e,this.protoContainers[f].visible=!0,0==this.scrollDiff&&(this.downButton.visible=!0,this.upButton.visible=!1,this.FadedUpButton.visible=!0,this.FadedDownButton.visible=!1)}else if(this.y+this.scrollDiff+c<d&&a<0){var e=-this.y+d-this.scrollDiff;if(0==e)return this.upButton.visible=!0,this.downButton.visible=!1,this.FadedDownButton.visible=!0,void(this.FadedUpButton.visible=!1);this.scrollDiff+=-this.y+d-this.scrollDiff,this.FadedUpButton.visible=!1,this.upButton.visible=!0;for(var f in this.protoContainers)this.protoContainers[f].y+=e,this.protoContainers[f].visible=!0;-this.y+d-this.scrollDiff==0&&(this.upButton.visible=!0,this.downButton.visible=!1,this.FadedDownButton.visible=!0,this.FadedUpButton.visible=!1)}else if(0==this.count)this.FadedUpButton.visible=!0,this.FadedDownButton.visible=!1,this.upButton.visible=!1,this.downButton.visible=!0;else{this.scrollDiff+=c,this.FadedUpButton.visible=!1,this.FadedDownButton.visible=!1,this.upButton.visible=!0,this.downButton.visible=!0;for(var f in this.protoContainers)this.protoContainers[f].y+=c,this.protoContainers[f].visible=!0}this.updateBlockMasks();var g=this.palettes.stage;g.setChildIndex(this.menuContainer,g.getNumChildren()-1),this.palettes.refreshCanvas(),this.count+=1},this.getInfo=function(){var a=this.name+" palette:";for(var b in this.protoList)a+=" "+this.protoList[b].name;return a},this.add=function(a){return this.protoList.indexOf(a)==-1&&this.protoList.push(a),this},this}function initPalettes(a,b,c,d,b,e,f){var g=new Palettes(a,b,c,d,b,e).add("turtle").add("pen").add("number").add("boolean").add("flow").add("blocks").add("actions").add("media").add("sensors").add("heap").add("extras");return g.makePalettes(),blocks=f,setTimeout(function(){g.show(),g.bringToTop()},2e3),g}function setupBackgroundEvents(a){var b=!1;a.background.on("mousedown",function(c){b=!0;var d=c.stageY;a.background.on("pressmove",function(c){if(b){var e=c.stageY-d;a.scrollEvent(e,10),d=c.stageY}}),a.background.on("pressup",function(a){b=!1},null,!0)})}function makeBlockFromPalette(a,b,c,d){switch(c.protoList[a].name){case"do":b="do "+c.protoList[a].defaults[0];var e=c.protoList[a].name,f=c.protoList[a].defaults[0];break;case"storein":b="store in "+c.protoList[a].defaults[0];var e=c.protoList[a].name,f=c.protoList[a].defaults[0];break;case"box":b=c.protoList[a].defaults[0];var e=c.protoList[a].name,f=c.protoList[a].defaults[0];break;case"namedbox":if(void 0==c.protoList[a].defaults[0]){b="namedbox";var f=_("box")}else{b=c.protoList[a].defaults[0];var f=c.protoList[a].defaults[0]}var e=c.protoList[a].name;break;case"namedarg":if(void 0==c.protoList[a].defaults[0]){b="namedarg";var f="1"}else{b=c.protoList[a].defaults[0];var f=c.protoList[a].defaults[0]}var e=c.protoList[a].name;break;case"nameddo":if(void 0==c.protoList[a].defaults[0]){b="nameddo";var f=_("action")}else{b=c.protoList[a].defaults[0];var f=c.protoList[a].defaults[0]}var e=c.protoList[a].name;break;case"nameddoArg":if(void 0==c.protoList[a].defaults[0]){b="nameddoArg";var f=_("action")}else{b=c.protoList[a].defaults[0];var f=c.protoList[a].defaults[0]}var e=c.protoList[a].name;break;case"namedcalc":if(void 0==c.protoList[a].defaults[0]){b="namedcalc";var f=_("action")}else{b=c.protoList[a].defaults[0];var f=c.protoList[a].defaults[0]}var e=c.protoList[a].name;break;case"namedcalcArg":if(void 0==c.protoList[a].defaults[0]){b="namedcalcArg";var f=_("action")}else{b=c.protoList[a].defaults[0];var f=c.protoList[a].defaults[0]}var e=c.protoList[a].name;break;default:var e=b,f="__NOARG__"}var g=paletteBlockButtonPush(e,f);d(g)}function loadPaletteMenuItemHandler(a,b,c){var d=!1,e=!1,f=a.protoContainers[c].x,g=a.protoContainers[c].y;a.protoContainers[c].on("mousedown",function(b){var d=a.palettes.stage;d.setChildIndex(a.protoContainers[c],d.getNumChildren()-1);var f=Math.min(maxPaletteHeight(a.palettes.cellSize,a.palettes.scale),a.palettes.y),h=b.stageY/a.palettes.scale,i=a.menuContainer.y+f+STANDARDBLOCKHEIGHT;h<i&&(a.protoContainers[c].mask=null),e=!1,g=a.protoContainers[c].y-a.scrollDiff;var j=b.stageX,k=b.stageY,l=b.stageY;if(!a.draggingProtoBlock){var m=window.hasMouse?MODEDRAG:MODEUNSURE;a.protoContainers[c].on("pressmove",function(b){if(m===MODEDRAG)return void(h<i&&(e=!0,a.draggingProtoBlock=!0,a.protoContainers[c].x=Math.round(b.stageX/a.palettes.scale)-PALETTELEFTMARGIN,a.protoContainers[c].y=Math.round(b.stageY/a.palettes.scale),a.palettes.refreshCanvas()));if(m===MODESCROLL){var d=b.stageY-l;return a.scrollEvent(d,10),void(l=b.stageY)}var f=Math.abs(b.stageX-j),g=Math.abs(b.stageY-k),d=Math.sqrt(f*f+g*g);m===MODEUNSURE&&d>DECIDEDISTANCE&&(m=g>f?MODESCROLL:MODEDRAG)})}}),a.protoContainers[c].on("pressup",function(h){d||(d=!0,setTimeout(function(){d=!1},1e3),makeBlockFromProtoblock(a,b,e,c,h,f,g))})}function makeBlockFromProtoblock(a,b,c,d,e,f,g){function h(b){paletteBlocks.findDragGroup(b);for(var c in paletteBlocks.dragGroup)paletteBlocks.moveBlockRelative(paletteBlocks.dragGroup[c],Math.round(e.stageX/a.palettes.scale)-paletteBlocks.stage.x,Math.round(e.stageY/a.palettes.scale)-paletteBlocks.stage.y);blocks.blockMoved(b),restoreProtoblock(a,d,f,g+a.scrollDiff)}if(c){if(c=!1,a.draggingProtoBlock=!1,"myblocks"==a.name){for(var i=d.replace("macro_",""),j=[],k=0;k<a.palettes.macroDict[i].length;k++){var l=a.palettes.macroDict[i][k][1],m=[];m="string"==typeof l?l:"string"==typeof l[1]?"number"==l[0]?[l[0],Number(l[1])]:[l[0],l[1]]:"number"==typeof l[1]?"number"==l[0]?[l[0],l[1]]:[l[0],l[1].toString()]:"number"==l[0]?[l[0],Number(l[1].value)]:[l[0],{value:l[1].value}];var n=[a.palettes.macroDict[i][k][0],m,a.palettes.macroDict[i][k][2],a.palettes.macroDict[i][k][3],a.palettes.macroDict[i][k][4]];j.push(n)}j[0][2]=a.protoContainers[d].x,j[0][3]=a.protoContainers[d].y,console.log("loading macro "+i),paletteBlocks.loadNewBlocks(j);var o=paletteBlocks.blockList.length-1,p=paletteBlocks.findTopBlock(o);setTimeout(function(){paletteBlocks.blockList[p].collapseToggle()},500)}else var n=makeBlockFromPalette(b,d,a,h);a.updateBlockMasks(),a.palettes.refreshCanvas()}}function restoreProtoblock(a,b,c,d){a.protoContainers[b].x=c,a.protoContainers[b].y=d}function loadPaletteMenuHandler(a){var b=!1,c=a.palettes.trashcan,d=MENUWIDTH+160*a.columns;a.menuContainer.on("click",function(c){if(Math.round(c.stageX/a.palettes.scale)>a.menuContainer.x+d-STANDARDBLOCKHEIGHT)return a.hide(),void a.palettes.refreshCanvas();if(!b){b=!0,setTimeout(function(){b=!1},500);for(p in a.palettes.dict)a.name!=p&&a.palettes.dict[p].visible&&a.palettes.dict[p].hideMenuItems(!1);a.visible?a.hideMenuItems(!1):a.showMenuItems(!1),a.palettes.refreshCanvas()}}),a.menuContainer.on("mousedown",function(b){c.show();var d={x:a.menuContainer.x-Math.round(b.stageX/a.palettes.scale),y:a.menuContainer.y-Math.round(b.stageY/a.palettes.scale)};a.menuContainer.on("pressup",function(b){c.overTrashcan(b.stageX/a.palettes.scale,b.stageY/a.palettes.scale)&&(a.hide(),a.palettes.refreshCanvas(),BUILTINPALETTES.indexOf(a.name)===-1?promptPaletteDelete(a):"myblocks"==a.name&&promptMacrosDelete(a)),c.hide()}),a.menuContainer.on("mouseout",function(b){c.overTrashcan(b.stageX/a.palettes.scale,b.stageY/a.palettes.scale)&&(a.hide(),a.palettes.refreshCanvas()),c.hide()}),a.menuContainer.on("pressmove",function(b){var e=a.menuContainer.x,f=a.menuContainer.y;a.menuContainer.x=Math.round(b.stageX/a.palettes.scale)+d.x,a.menuContainer.y=Math.round(b.stageY/a.palettes.scale)+d.y,a.palettes.refreshCanvas();var g=a.menuContainer.x-e,h=a.menuContainer.y-f;c.overTrashcan(b.stageX/a.palettes.scale,b.stageY/a.palettes.scale)?c.highlight():c.unhighlight(),a.hideMenuItems(!1),a.moveMenuItemsRelative(g,h)})}),a.menuContainer.on("mouseout",function(a){})}function promptPaletteDelete(a){var b='Do you want to remove all "%s" blocks from your project?'.replace("%s",a.name);if(confirm(b)){console.log("removing palette "+a.name),a.palettes.remove(a.name),delete pluginObjs.PALETTEHIGHLIGHTCOLORS[a.name],delete pluginObjs.PALETTESTROKECOLORS[a.name],delete pluginObjs.PALETTEFILLCOLORS[a.name],delete pluginObjs.PALETTEPLUGINS[a.name];for(var c=0;c<a.protoList.length;c++){var d=a.protoList[c].name;delete pluginObjs.FLOWPLUGINS[d],delete pluginObjs.ARGPLUGINS[d],delete pluginObjs.BLOCKPLUGINS[d],delete pluginObjs.ONLOAD[d],delete pluginObjs.ONSTART[d],delete pluginObjs.ONSTOP[d]}storage.plugins=preparePluginExports({}),sugarizerCompatibility.isInsideSugarizer()&&sugarizerCompatibility.saveLocally()}}function promptMacrosDelete(a){var b="Do you want to remove all the stacks from your custom palette?";if(confirm(b)){console.log("removing macros from "+a.name);for(var c=0;c<a.protoList.length;c++){var d=a.protoList[c].name;delete a.protoContainers[d],a.protoList.splice(c,1)}a.palettes.updatePalettes("myblocks"),storage.macros=prepareMacroExports(null,null,{}),sugarizerCompatibility.isInsideSugarizer()&&sugarizerCompatibility.saveLocally()}}function makePaletteBitmap(a,b,c,d,e){var f=new Image;f.onload=function(){bitmap=new createjs.Bitmap(f),d(a,c,bitmap,e)},f.src="data:image/svg+xml;base64,"+window.btoa(unescape(encodeURIComponent(b)))}function regeneratePalette(a){a.visible=!1,a.hideMenuItems(),a.protoContainers={},a.palettes.updatePalettes()}require(["activity/utils"]);var paletteBlocks=null,PROTOBLOCKSCALE=1,PALETTELEFTMARGIN=10,BUILTINPALETTES=["turtle","pen","number","boolean","flow","blocks","actions","media","sensors","myblocks","heap"],EXPANDBYONE=["repeat","forever","media","camera","video","action","start","and","or"],blocks=void 0,MODEUNSURE=0,MODEDRAG=1,MODESCROLL=2,DECIDEDISTANCE=20;