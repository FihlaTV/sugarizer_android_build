/*! Sugarizer 2016-12-28 */
function Blocks(a,c,d,e,f){return sugarizerCompatibility.isInsideSugarizer()?storage=sugarizerCompatibility.data:storage=localStorage,this.canvas=a,this.stage=c,this.refreshCanvas=d,this.trashcan=e,this.updateStage=f,this.protoBlockDict={},this.blockList=[],this.time=0,this.timeOut=null,this.selectingStack=!1,this.selectedStack=null,this.loopCounter=0,this.sizeCounter=0,this.searchCounter=0,this.palettes=null,this.highlightedBlock=null,this.activeBlock=null,this.visible=!0,this.dragGroup=[],this.stackList=[],this.expandablesList=[],this.loadCounter=0,this.adjustTheseDocks=[],this.blocksToCollapse=[],this.checkTwoArgBlocks=[],this.checkArgClampBlocks=[],this.clampBlocksToCheck=[],this.expandableBlocks=[],this.clampBlocks=[],this.doubleExpandable=[],this.argClampBlocks=[],this.argBlocks=[],this.valueBlocks=[],this.twoArgBlocks=[],this.noRunBlocks=[],this.blockScale=DEFAULTBLOCKSCALE,this.inLongPress=!1,this.setBlockScale=function(a){for(console.log("new block scale is "+a),this.blockScale=a,blk=0;blk<this.blockList.length;blk++)this.blockList[blk].resize(a);for(this.findStacks(),stack=0;stack<this.stackList.length;stack++)this.loopCounter=0,this.adjustDocks(this.stackList[stack]);for(palette in this.palettes.dict)for(blk=0;blk<this.palettes.dict[palette].protoList.length;blk++)this.palettes.dict[palette].protoList[blk].scale=a},this.setMsgText=function(a){this.msgText=a},this.setErrorMsg=function(a){this.errorMsg=a},this.setMacroDictionary=function(a){this.macroDict=a},this.setTurtles=function(a){this.turtles=a},this.setLogo=function(a){this.logo=a},this.setScale=function(a){this.scale=a},this.toggleCollapsibles=function(){for(var a in this.blockList){var b=this.blockList[a];["start","action"].indexOf(b.name)!=-1&&b.collapseToggle()}},this.makeCopyPasteButtons=function(a,b){var c=this;this.updatePasteButton=b,this.copyButton=a("copy-button",0,0,55),this.copyButton.visible=!1,this.dismissButton=a("cancel-button",0,0,55),this.dismissButton.visible=!1,this.saveStackButton=a("save-blocks-button",0,0,55),this.saveStackButton.visible=!1,this.copyButton.on("click",function(a){var b=c.findTopBlock(c.activeBlock);c.selectedStack=b,c.copyButton.visible=!1,c.saveStackButton.visible=!1,c.dismissButton.visible=!1,c.inLongPress=!1,c.updatePasteButton(),c.refreshCanvas()}),this.dismissButton.on("click",function(a){c.copyButton.visible=!1,c.saveStackButton.visible=!1,c.dismissButton.visible=!1,c.inLongPress=!1,c.refreshCanvas()}),this.saveStackButton.on("click",function(a){var b=c.findTopBlock(c.activeBlock);c.inLongPress=!1,c.selectedStack=b,c.copyButton.visible=!1,c.saveStackButton.visible=!1,c.dismissButton.visible=!1,c.saveStack(),c.refreshCanvas()})},this.findBlockTypes=function(){for(var a in this.protoBlockDict)this.protoBlockDict[a].expandable&&this.expandableBlocks.push(this.protoBlockDict[a].name),"clamp"==this.protoBlockDict[a].style&&this.clampBlocks.push(this.protoBlockDict[a].name),"argclamp"==this.protoBlockDict[a].style&&this.argClampBlocks.push(this.protoBlockDict[a].name),"argclamparg"==this.protoBlockDict[a].style&&(this.argClampBlocks.push(this.protoBlockDict[a].name),this.argBlocks.push(this.protoBlockDict[a].name)),"twoarg"==this.protoBlockDict[a].style&&this.twoArgBlocks.push(this.protoBlockDict[a].name),"arg"==this.protoBlockDict[a].style&&this.argBlocks.push(this.protoBlockDict[a].name),"value"==this.protoBlockDict[a].style&&(this.argBlocks.push(this.protoBlockDict[a].name),this.valueBlocks.push(this.protoBlockDict[a].name)),"doubleclamp"==this.protoBlockDict[a].style&&this.doubleExpandable.push(this.protoBlockDict[a].name)},this.adjustBlockPositions=function(){this.dragGroup.length<2||(this.loopCounter=0,this.adjustDocks(this.dragGroup[0]))},this.adjustExpandableClampBlock=function(){function a(a,b,c,d){if(0==d)var e=c.connections.length-2;else var e=c.connections.length-3;a.sizeCounter=0;var f=1;e>0&&null!=c.connections[e]&&(f=Math.max(a.getStackSize(c.connections[e]),1));var g=f-c.clampCount[d];0!=g&&(0==f&&1==c.clampCount[d]||c.updateSlots(d,g)),setTimeout(function(){a.clampBlocksToCheck.length>0&&a.adjustExpandableClampBlock()},250)}if(0!=this.clampBlocksToCheck.length){var b=this.clampBlocksToCheck.pop(),c=b[0],d=b[1],e=this.blockList[c];e.isArgBlock()||e.isTwoArgBlock()||a(this,c,e,d)}},this.getBlockSize=function(a){var b=this.blockList[a];return b.size},this.adjustArgClampBlock=function(a){if(0!=a.length){var b=a.pop(),c=this.blockList[b];["doArg","calcArg"].indexOf(c.name)!=-1?ci=2:ci=1;var d=c.argClampSlots,e=!1;for(i=0;i<d.length;i++){var f=c.connections[ci+i],g=1;null!=f&&(g=Math.max(this.getBlockSize(f),1)),d[i]!=g&&(d[i]=g,e=!0)}e&&c.updateArgSlots(d)}},this.adjustExpandableTwoArgBlock=function(a){if(0!=a.length){var b=a.pop(),c=this.blockList[b],d=c.connections[1],e=1;null!=d&&(e=Math.max(this.getBlockSize(d),1));var f=e-c.clampCount[0];0!=f&&0!=e&&c.updateSlots(0,f)}},this.addRemoveVspaceBlock=function(a){function b(a){var c=last(blockBlocks.blockList[a].connections);return c&&"vspace"==blockBlocks.blockList[c].name?1+b(c):0}var c=blockBlocks.blockList[a],d=c.connections[c.connections.length-2],e=1;if(null!=d)var e=Math.max(this.getBlockSize(d),1);var f=b(a);if(e<f+1)for(var g=Math.abs(e-f-1),h=0;h<g;h++){var i=c.connections.length-1,j=this.blockList[c.connections[i]],k=j.connections[1];c.connections[i]=k,null!=k&&(this.blockList[k].connections[0]=a),j.connections=[null,null],j.trash=!0,j.hide()}else if(e>f+1)for(var l,m,g=e-f-1,h=0;h<g;h++)l=last(c.connections),m=blockBlocks.blockList.length,blockBlocks.makeNewBlockWithConnections("vspace",m,[null,null],function(b){var d=b[1],e=b[0],f=blockBlocks.blockList[d],g=last(c.docks),h=g[0]-f.docks[0][0],i=g[1]-f.docks[0][1];f.x=c.container.x+h,f.y=c.container.y+i,f.container.x=c.container.x+h,f.container.y=c.container.y+i,f.connections[0]=a,f.connections[1]=e,c.connections[c.connections.length-1]=d,e&&(blockBlocks.blockList[e].connections[0]=d)},[l,m])},this.getStackSize=function(a){var b=0;if(this.sizeCounter+=1,this.sizeCounter>2*this.blockList.length)return console.log("Infinite loop encountered detecting size of expandable block? "+a),b;if(null==a)return b;var c=this.blockList[a];if(null==c&&console.log("Something very broken in getStackSize."),c.isClampBlock()){var d=c.connections.length-2,e=0;if(d>0){var f=c.connections[d];null!=f&&(e=this.getStackSize(f)),b=0==e?1:e}if(c.isDoubleClampBlock()){var d=c.connections.length-3,e=0;if(d>0){var f=c.connections[d];if(null!=f)var e=this.getStackSize(f);b+=0==e?1:e}}b+=c.size}else b=c.size;if(!c.isValueBlock()){var f=last(c.connections);null!=f&&(b+=this.getStackSize(f))}return b},this.adjustDocks=function(a,b){var c=this.blockList[a];if(null!=b&&(this.loopCounter=0),null==c)return void console.log("Saw a null block: "+a);if(null==c.connections)return void console.log("Saw a block with null connections: "+a);if(0==c.connections.length)return void console.log("Saw a block with [] connections: "+a);if(1!=c.docks.length){if(this.loopCounter+=1,this.loopCounter>2*this.blockList.length)return void console.log("Infinite loop encountered while adjusting docks: "+a+" "+this.blockList);if(c.isTwoArgBooleanBlock())var d=0;else var d=1;for(var e=d;e<c.connections.length;e++){var f=c.docks[e],g=c.connections[e];if(null!=g)if(null!=this.blockList[g]){for(var h=!1,i=0;i<this.blockList[g].connections.length;i++)if(this.blockList[g].connections[i]==a){h=!0;break}if(!h){console.log("Did not find match for "+c.name+" and "+this.blockList[g].name);break}var j=this.blockList[g].docks[i];if(e>0){var k=f[0]-j[0],l=f[1]-j[1];if(null==c.container){console.log("Does this ever happen any more?");var m=c.x+k,n=c.y+l}else var m=c.container.x+k,n=c.container.y+l;this.moveBlock(g,m,n)}else{var k=j[0]-f[0],l=j[1]-f[1],m=this.blockList[g].container.x+k,n=this.blockList[g].container.y+l;this.moveBlock(a,m,n)}e>0&&this.adjustDocks(g)}else console.log("This is not good: we encountered a null block: "+g)}}},this.blockMoved=function(a){if(this.clampBlocksToCheck=[],null==a)return void console.log("block moved called with null block.");for(var b=this.insideExpandableBlock(a),c=0;null!=b;){if(c+=1,c>2*this.blockList.length){console.log("Inifinite loop encountered checking for expandables?");break}this.clampBlocksToCheck.push([b,0]),b=this.insideExpandableBlock(b)}this.checkTwoArgBlocks=[];var d=[],e=this.blockList[a];if(null==e)return void console.log("null block found in blockMoved method: "+a);var f=e.connections[0];if(null!=f)var g=this.blockList[f];if(e.isArgBlock()&&null!=f&&(this.blockList[f].isTwoArgBlock()||this.blockList[f].isArgClamp()?g.connections[1]==a&&this.checkTwoArgBlocks.push(f):(this.blockList[f].isArgBlock()&&this.blockList[f].isExpandableBlock()||this.blockList[f].isArgClamp())&&g.connections[1]==a&&this.checkTwoArgBlocks.push(f)),null!=f){for(var h=1;h<g.connections.length;h++)if(g.connections[h]==a){g.connections[h]=null;break}e.connections[0]=null,this.raiseStackToTop(a)}for(var i=e.container.x+e.docks[0][0],j=e.container.y+e.docks[0][1],k=null,l=null,m=MINIMUMDOCKDISTANCE,n=e.docks[0][2],o=0;o<this.blockList.length;o++)if(o!=a)for(var h=1;h<this.blockList[o].connections.length&&h!=this.blockList[o].docks.length;h++)this.testConnectionType(n,this.blockList[o].docks[h][2])&&(x2=this.blockList[o].container.x+this.blockList[o].docks[h][0],y2=this.blockList[o].container.y+this.blockList[o].docks[h][1],dist=(x2-i)*(x2-i)+(y2-j)*(y2-j),dist<m&&(k=o,l=h,m=dist));if(null!=k){e.connections[0]=k;var p=this.blockList[k].connections[l];if(null==p){if(this.blockList[k].isArgClamp())if("doArg"!=this.blockList[k].name&&"calcArg"!=this.blockList[k].name||1!=l)if(["doArg","nameddoArg"].indexOf(this.blockList[k].name)!=-1&&l==this.blockList[k].connections.length-1);else{var q=this.getBlockSize(a),r=this.blockList[k].argClampSlots;if(["doArg","calcArg"].indexOf(this.blockList[k].name)!=-1)var s=l-2;else var s=l-1;r[s]!=q&&(r[s]=q,this.blockList[k].updateArgSlots(r))}else;}else if(this.blockList[k].isArgClamp())if("doArg"!=this.blockList[k].name&&"calcArg"!=this.blockList[k].name||1!=l)if(["doArg","nameddoArg"].indexOf(this.blockList[k].name)!=-1&&l==this.blockList[k].connections.length-1){var t=this.findBottomBlock(a);this.blockList[p].connections[0]=t,this.blockList[t].connections[this.blockList[t].connections.length-1]=p}else{var q=this.getBlockSize(a),r=this.blockList[k].argClampSlots,u=this.blockList[k].connections.indexOf(p);if(["doArg","calcArg"].indexOf(this.blockList[k].name)!=-1)var s=u-2;else var s=u-1;for(var v=null,w=null,v=s;v<r.length;v++)if(null==this.blockList[k].connections[u+v-s]){w=u+v-s;break}if(null==w){r.push(1),this.newLocalArgBlock(r.length),w=u+v-s,this.blockList[k].connections.push(null);for(var h=r.length-1;h>s+1;h--)r[h]=r[h-1];for(var h=this.blockList[k].connections.length-1;h>u+1;h--)this.blockList[k].connections[h]=this.blockList[k].connections[h-1]}l+=1,r[s+1]=q,this.blockList[k].updateArgSlots(r)}else{this.blockList[p].connections[0]=null,this.findDragGroup(p);for(var f=0;f<this.dragGroup.length;f++)this.moveBlockRelative(this.dragGroup[f],40,40)}else if(e.isArgBlock()){this.blockList[p].connections[0]=null,this.findDragGroup(p);for(var f=0;f<this.dragGroup.length;f++)this.moveBlockRelative(this.dragGroup[f],40,40)}else{var t=this.findBottomBlock(a);this.blockList[p].connections[0]=t,this.blockList[t].connections[this.blockList[t].connections.length-1]=p}this.blockList[k].connections[l]=a,this.loopCounter=0,this.adjustDocks(k)}if((e.isArgBlock()||"calcArg"==e.name||"namedcalcArg"==e.name)&&null!=k){this.blockList[k].isTwoArgBlock()?this.blockList[k].connections[1]==a&&this.checkTwoArgBlocks.indexOf(k)==-1&&this.checkTwoArgBlocks.push(k):this.blockList[k].isArgBlock()&&this.blockList[k].isExpandableBlock()&&this.blockList[k].connections[1]==a&&this.checkTwoArgBlocks.indexOf(k)==-1&&this.checkTwoArgBlocks.push(k);var x=this.blockList[k].connections.length;this.blockList[k].connections[x-2]==a&&(this.blockList[k].isArgClamp()||"in"!=this.blockList[k].docks[x-1][2]||d.push(k))}var y=this;setTimeout(function(){if(d.length>0)for(var b=0;b<d.length;b++)y.addRemoveVspaceBlock(d[b]);y.checkTwoArgBlocks.length>0&&y.adjustExpandableTwoArgBlock(y.checkTwoArgBlocks);for(var b=0;b<d.length;b++)y.adjustDocks(d[b]);for(var c=y.insideExpandableBlock(a),e=0;null!=c;){if(e+=1,e>2*y.blockList.length){console.log("Infinite loop checking for expandables?"),console.log(y.blockList);break}"ifthenelse"==y.blockList[c].name?(y.clampBlocksToCheck.push([c,0]),y.clampBlocksToCheck.push([c,1])):y.clampBlocksToCheck.push([c,0]),c=y.insideExpandableBlock(c)}y.adjustExpandableClampBlock(),y.refreshCanvas()},250)},this.testConnectionType=function(a,b){return"in"==a&&"out"==b||("out"==a&&"in"==b||("numberin"==a&&["numberout","anyout"].indexOf(b)!=-1||(["numberout","anyout"].indexOf(a)!=-1&&"numberin"==b||("textin"==a&&["textout","anyout"].indexOf(b)!=-1||(["textout","anyout"].indexOf(a)!=-1&&"textin"==b||("booleanout"==a&&"booleanin"==b||("booleanin"==a&&"booleanout"==b||("mediain"==a&&"mediaout"==b||("mediaout"==a&&"mediain"==b||("mediain"==a&&"textout"==b||("mediain"==b&&"textout"==a||("filein"==a&&"fileout"==b||("fileout"==a&&"filein"==b||("anyin"==a&&["textout","mediaout","numberout","anyout","fileout"].indexOf(b)!=-1||"anyin"==b&&["textout","mediaout","numberout","anyout","fileout"].indexOf(a)!=-1))))))))))))))},this.updateBlockPositions=function(){for(var a=0;a<this.blockList.length;a++)this.moveBlock(a,this.blockList[a].x,this.blockList[a].y)},this.bringToTop=function(){for(var a in this.blockList){var b=this.blockList[a];this.stage.removeChild(b.container),this.stage.addChild(b.container),null!=b.collapseContainer&&(this.stage.removeChild(b.collapseContainer),this.stage.addChild(b.collapseContainer))}this.refreshCanvas()},this.moveBlock=function(a,b,c){var d=this.blockList[a];null!=d.container?(d.container.x=b,d.container.y=c,d.x=b,d.y=c,null!=d.collapseContainer&&(d.collapseContainer.x=b+COLLAPSEBUTTONXOFF*(this.blockList[a].protoblock.scale/2),d.collapseContainer.y=c+COLLAPSEBUTTONYOFF*(this.blockList[a].protoblock.scale/2))):(console.log("no container yet"),d.x=b,d.y=c)},this.moveBlockRelative=function(a,b,c){var d=this.blockList[a];null!=d.container?(d.container.x+=b,d.container.y+=c,d.x=d.container.x,d.y=d.container.y,null!=d.collapseContainer&&(d.collapseContainer.x+=b,d.collapseContainer.y+=c)):(console.log("no container yet"),d.x+=b,d.y+=c)},this.updateBlockText=function(a){var b=this.blockList[a],c=8;if(null!=b.text){if("loadFile"==b.name){try{var d=b.value[0].toString()}catch(a){var d=_("open file")}c=10}else var d=b.value.toString();d.length>c&&(d=d.substr(0,c-1)+"..."),b.text.text=d,z=b.container.getNumChildren()-1,b.container.setChildIndex(b.text,z),b.loadComplete?b.container.updateCache():console.log("load not yet complete for "+a)}},this.findTopBlock=function(a){if(null==a)return null;var b=this.blockList[a];if(null==b.connections)return a;if(0==b.connections.length)return a;for(var c=0;null!=b.connections[0];){if(c+=1,c>2*this.blockList.length){console.log("infinite loop finding topBlock?"),console.log(b.name);break}a=b.connections[0],b=this.blockList[a]}return a},this.findBottomBlock=function(a){if(null==a)return null;var b=this.blockList[a];if(null==b.connections)return a;if(0==b.connections.length)return a;for(var c=0;null!=last(b.connections);){if(c+=1,c>2*this.blockList.length){console.log("infinite loop finding bottomBlock?");break}a=last(b.connections),b=this.blockList[a]}return a},this.findStacks=function(){for(this.stackList=[],i=0;i<this.blockList.length;i++)null==this.blockList[i].connections[0]&&this.stackList.push(i)},this.findClamps=function(){this.expandablesList=[],this.findStacks();for(var a=0;a<this.stackList.length;a++)this.searchCounter=0,this.searchForExpandables(this.stackList[a])},this.findTwoArgs=function(){this.expandablesList=[];for(var a=0;a<this.blockList.length;a++)this.blockList[a].isArgBlock()&&this.blockList[a].isExpandableBlock()?this.expandablesList.push(a):this.blockList[a].isTwoArgBlock()&&this.expandablesList.push(a)},this.searchForExpandables=function(a){for(;null!=a&&null!=this.blockList[a]&&!this.blockList[a].isValueBlock();){if(this.searchCounter+=1,this.searchCounter>2*this.blockList.length){console.log("infinite loop searching for Expandables? "+this.searchCounter),console.log(a+" "+this.blockList[a].name);break}if(this.blockList[a].isClampBlock()){this.expandablesList.push(a);var b=this.blockList[a].connections.length-2;this.searchForExpandables(this.blockList[a].connections[b])}a=last(this.blockList[a].connections)}},this.expandTwoArgs=function(){this.findTwoArgs(),this.adjustExpandableTwoArgBlock(this.expandablesList),this.refreshCanvas()},this.expandClamps=function(){for(this.findClamps(),this.clampBlocksToCheck=[],i=0;i<this.expandablesList.length;i++)"ifthenelse"==this.blockList[this.expandablesList[i]].name?(this.clampBlocksToCheck.push([this.expandablesList[i],0]),this.clampBlocksToCheck.push([this.expandablesList[i],1])):this.clampBlocksToCheck.push([this.expandablesList[i],0]);this.adjustExpandableClampBlock(),this.refreshCanvas()},this.changeDisabledStatus=function(a,b){for(var c in this.blockList){var d=this.blockList[c];d.name==a&&(d.protoblock.disabled=b,d.regenerateArtwork(!1))}},this.unhighlightAll=function(){for(var a in this.blockList)this.unhighlight(a)},this.unhighlight=function(a){if(this.visible){if(null!=a)var b=a;else var b=this.highlightedBlock;null!=b&&this.blockList[b].unhighlight(),(this.highlightedBlock=b)&&(this.highlightedBlock=null)}},this.highlight=function(a,b){this.visible&&null!=a&&(b&&this.unhighlight(null),this.blockList[a].highlight(),this.highlightedBlock=a)},this.hide=function(){for(var a in this.blockList)this.blockList[a].hide();this.visible=!1},this.show=function(){for(var a in this.blockList)this.blockList[a].show();this.visible=!0},this.makeNewBlockWithConnections=function(a,b,c,d,e,f){if("undefined"==typeof f&&(f=!1),myBlock=this.makeNewBlock(a,d,e),null==myBlock)return void console.log("could not make block "+a);for(var g=0;g<c.length&&g!=myBlock.docks.length;g++)null==c[g]?myBlock.connections.push(null):myBlock.connections.push(c[g]+b)},this.makeNewBlock=function(a,b,c){if(!a in this.protoBlockDict)return console.log("makeNewBlock: no prototype for "+a),null;if(null==this.protoBlockDict[a])return console.log("makeNewBlock: no prototype for "+a),null;if(["namedbox","nameddo","namedcalc","nameddoArg","namedcalcArg"].indexOf(a)!=-1?this.blockList.push(new Block(this.protoBlockDict[a],this,c[1])):"namedarg"==a?this.blockList.push(new Block(this.protoBlockDict[a],this,"arg "+c[1])):this.blockList.push(new Block(this.protoBlockDict[a],this)),null==last(this.blockList))return console.log("failed to make protoblock for "+a),null;var d=last(this.blockList);return d.copySize(),d.postProcess=b,d.postProcessArg=c,d.container=new createjs.Container,this.stage.addChild(d.container),d.container.snapToPixelEnabled=!0,d.container.x=d.x,d.container.y=d.y,d.imageLoad(),d},this.makeBlock=function(a,b){console.log("makeBlock "+a+" "+b);var c=null,d=null,e=this,f=this.blockList.length;"start"==a?(c=function(a){e.blockList[a].value=e.turtles.turtleList.length,e.turtles.add(e.blockList[a])},d=f):"text"==a?(c=function(a){var b=a[0],c=a[1];e.blockList[b].value=c,e.blockList[b].text.text=c,e.blockList[b].container.updateCache()},d=[f,_("text")]):"number"==a?(c=function(a){var b=a[0],c=Number(a[1]);e.blockList[b].value=c,e.blockList[b].text.text=c.toString(),e.blockList[b].container.updateCache()},d=[f,100]):"media"==a?(c=function(a){var b=a[0],c=a[1];e.blockList[b].value=c,null==c?e.blockList[b].image="images/load-media.svg":e.blockList[b].image=null},d=[f,null]):"camera"==a?(c=function(a){console.log("post process camera "+a[1]);var b=a[0],c=a[1];e.blockList[b].value=CAMERAVALUE,null==c?e.blockList[b].image="images/camera.svg":e.blockList[b].image=null},d=[f,null]):"video"==a?(c=function(a){var b=a[0],c=a[1];e.blockList[b].value=VIDEOVALUE,null==c?e.blockList[b].image="images/video.svg":e.blockList[b].image=null},d=[f,null]):"loadFile"==a?(c=function(a){e.updateBlockText(a[0])},d=[f,null]):["namedbox","nameddo","namedcalc","nameddoArg","namedcalcArg","namedarg"].indexOf(a)!=-1&&(c=function(a){e.blockList[f].value=null,e.blockList[f].privateData=a[1]},d=[f,b]);var g=!1;for(var h in e.protoBlockDict)if(e.protoBlockDict[h].name==a){if("__NOARG__"==b){console.log("creating "+a+" block with no args"),e.makeNewBlock(h,c,d),g=!0;break}if(e.protoBlockDict[h].defaults[0]==b){console.log("creating "+a+" block with default arg "+b),e.makeNewBlock(h,c,d),g=!0;break}if(["namedbox","nameddo","namedcalc","nameddoArg","namedcalcArg","namedarg"].indexOf(a)!=-1&&void 0==e.protoBlockDict[h].defaults[0]){e.makeNewBlock(h,c,d),g=!0;break}}g||console.log(a+" not found!!");for(var i=this.blockList.length-1,j=this.blockList[i],k=0;k<j.docks.length;k++)j.connections.push(null);for(var l=i+1,k=0;k<j.protoblock.defaults.length;k++){var m=j.protoblock.defaults[k];"action"==j.name&&(console.log("calling findUniqueActionName"),m=this.findUniqueActionName(_("action")),console.log("renaming action block to "+m),m!=_("action")&&(console.log("calling newNameddoBlock with value "+m),this.newNameddoBlock(m,!1,!1),this.palettes.updatePalettes()));var e=this,f=this.blockList.length;j.docks.length>k&&"anyin"==j.docks[k+1][2]?null==m?console.log("cannot set default value"):"string"==typeof m?(c=function(a){var b=a[0],c=a[1];e.blockList[b].value=c;var d=c.toString();d.length>8&&(d=d.substr(0,7)+"..."),e.blockList[b].text.text=d,e.blockList[b].container.updateCache()},this.makeNewBlock("text",c,[f,m])):(c=function(a){var b=a[0],c=Number(a[1]);e.blockList[b].value=c,e.blockList[b].text.text=c.toString()},this.makeNewBlock("number",c,[f,m])):"textin"==j.docks[k+1][2]?(c=function(a){var b=a[0],c=a[1];e.blockList[b].value=c;var d=c.toString();d.length>8&&(d=d.substr(0,7)+"..."),e.blockList[b].text.text=d},this.makeNewBlock("text",c,[f,m])):"mediain"==j.docks[k+1][2]?(c=function(a){var b=a[0],c=a[1];e.blockList[b].value=c},this.makeNewBlock("media",c,[f,m])):"filein"==j.docks[k+1][2]?(c=function(a){e.updateBlockText(a)},this.makeNewBlock("loadFile",c,f)):(c=function(a){var b=a[0],c=a[1];e.blockList[b].value=c,e.blockList[b].text.text=c.toString()},this.makeNewBlock("number",c,[f,m]));var n=this.blockList[l+k];n.connections=[i],n.value=m,j.connections[k+1]=l+k}return this.updateBlockPositions(),this.adjustDocks(i,!0),this.refreshCanvas(),i},this.findDragGroup=function(a){this.dragGroup=[],this.calculateDragGroup(a)},this.calculateDragGroup=function(a){if(null!=a){var b=this.blockList[a];if(null==b)return void console.log("null block encountered... this is bad. "+a);if(null==b.connections)return void(this.dragGroup=[a]);if(0==b.connections.length)return void(this.dragGroup=[a]);this.dragGroup.push(a);for(var c=1;c<b.connections.length;c++){var d=b.connections[c];null!=d&&this.calculateDragGroup(d)}}},this.findUniqueActionName=function(a){for(var b=[],c=0;c<this.blockList.length;c++)if("text"==this.blockList[c].name){var d=this.blockList[c].connections[0];null!=d&&"action"==this.blockList[d].name&&b.push(this.blockList[c].value)}if(1==b.length)return a;for(var e=1,f=a;b.indexOf(f)!=-1;)f=a+e.toString(),e+=1;return f},this.renameBoxes=function(a,b){if(a!=b)for(var c=0;c<this.blockList.length;c++)if("text"==this.blockList[c].name){var d=this.blockList[c].connections[0];if(null!=d&&"box"==this.blockList[d].name&&this.blockList[c].value==a){this.blockList[c].value=b,this.blockList[c].text.text=b;try{this.blockList[c].container.updateCache()}catch(a){console.log(a)}}}},this.renameNamedboxes=function(a,b){if(a!=b){for(var c=0;c<this.blockList.length;c++)if("namedbox"==this.blockList[c].name&&this.blockList[c].privateData==a){this.blockList[c].privateData=b,this.blockList[c].overrideName=b,this.blockList[c].regenerateArtwork();try{this.blockList[c].container.updateCache()}catch(a){console.log(a)}}for(var d=this.palettes.dict.blocks,e=!1,f=0;f<d.protoList.length;f++){var g=d.protoList[f];"namedbox"==g.name&&g.defaults[0]!=_("box")&&g.defaults[0]==a&&(console.log("renaming "+g.defaults[0]+" to "+b),g.defaults[0]=b,e=!0)}e&&regeneratePalette(d)}},this.renameDos=function(a,b){if(a!=b)for(var c=0;c<this.blockList.length;c++){var d=this.blockList[c],e=this.blockList[d.connections[0]];if(null!=e&&["do","calc","doArg","calcArg","action"].indexOf(e.name)!=-1){var f=d.value;if(f==a){d.value=b;var g=d.value;g.length>8&&(g=g.substr(0,7)+"..."),d.text.text=g,d.container.updateCache()}}}},this.renameNameddos=function(a,b){if(a!=b){for(var c=0;c<this.blockList.length;c++)if(["nameddo","namedcalc","nameddoArg","namedcalcArg"].indexOf(this.blockList[c].name)!=-1&&this.blockList[c].privateData==a){this.blockList[c].privateData=b;var d=b;d.length>8&&(d=d.substr(0,7)+"..."),this.blockList[c].overrideName=d,console.log("regenerating artwork for "+this.blockList[c].name+" block["+c+"]: "+a+" -> "+d),this.blockList[c].regenerateArtwork()}console.log("updating the palette in renameNameddos");for(var e=this.palettes.dict.actions,f=!1,g=0;g<e.protoList.length;g++){var h=e.protoList[g];["nameddo","namedcalc","nameddoArg","namedcalcArg"].indexOf(h.name)!=-1&&h.defaults[0]!=_("action")&&h.defaults[0]==a&&(console.log("renaming "+h.name+": "+h.defaults[0]+" to "+b),h.defaults[0]=b,f=!0)}f&&(console.log("regenerating actions palette"),regeneratePalette(e))}},this.newStoreinBlock=function(a){if(!("myStorein_"+a in this.protoBlockDict)){console.log("new storein block "+a);var b=new ProtoBlock("storein");this.protoBlockDict["myStorein_"+a]=b,b.palette=this.palettes.dict.blocks,b.defaults.push(a),b.defaults.push(100),b.staticLabels.push(_("store in"),_("name"),_("value")),b.adjustWidthToLabel(),b.twoArgBlock(),b.dockTypes[1]="anyin",b.dockTypes[2]="anyin","box"!=a&&b.palette.add(b)}},this.newNamedboxBlock=function(a){if(!("myBox_"+a in this.protoBlockDict)){var b=new ProtoBlock("namedbox");this.protoBlockDict["myBox_"+a]=b,b.palette=this.palettes.dict.blocks,b.defaults.push(a),b.staticLabels.push(a),b.parameterBlock(),"box"!=a&&b.palette.add(b)}},this.newLocalArgBlock=function(a){var b="arg_"+a;if(!(b in this.protoBlockDict)){var c=new ProtoBlock("namedarg");this.protoBlockDict[b]=c,c.palette=this.palettes.dict.actions,c.defaults.push(a),c.staticLabels.push("arg "+a),c.parameterBlock(),"arg 1"!=a&&(c.palette.add(c),regeneratePalette(this.palettes.dict.actions))}},this.removeNamedoEntries=function(a){console.log("DELETE: removing old palette entries for "+a),this.protoBlockDict["myDo_"+a]?(console.log("deleting myDo_"+a+" "+this.protoBlockDict["myDo_"+a].name),this.protoBlockDict["myDo_"+a].hide=!0,delete this.protoBlockDict["myDo_"+a]):this.protoBlockDict["myCalc_"+a]?(console.log("deleting myCalc_"+a+" "+this.protoBlockDict["myCalc_"+a].name),this.protoBlockDict["myCalc_"+a].hide=!0,delete this.protoBlockDict["myCalc_"+a]):this.protoBlockDict["myDoArg_"+a]?(console.log("deleting myDoArg_"+a+" "+this.protoBlockDict["myDoArg_"+a].name),this.protoBlockDict["myDoArg_"+a].hide=!0,delete this.protoBlockDict["myDoArg_"+a]):this.protoBlockDict["myCalcArg_"+a]&&(console.log("deleting myCalcArg_"+a+" "+this.protoBlockDict["myCalcArg_"+a].name),this.protoBlockDict["myCalcArg_"+a].hide=!0,delete this.protoBlockDict["myCalcArg_"+a])},this.newNameddoBlock=function(a,b,c){if(console.log("NEW DO: "+a+" "+b+" "+c),a!=_("action"))if(b&&c)this.newNamedcalcArgBlock(a);else if(!b&&c)this.newNameddoArgBlock(a);else if(b&&!c)this.newNamedcalcBlock(a);else if(void 0==this.protoBlockDict["myDo_"+a]){console.log("creating myDo_"+a);var d=new ProtoBlock("nameddo");this.protoBlockDict["myDo_"+a]=d,d.palette=this.palettes.dict.actions,d.defaults.push(a),d.staticLabels.push(a),d.zeroArgBlock(),d.palette.add(d)}else console.log("myDo_"+a+" already exists.")},this.newNamedcalcBlock=function(a){if(void 0==this.protoBlockDict["myCalc_"+a]){console.log("creating myCalc_"+a);var b=new ProtoBlock("namedcalc");this.protoBlockDict["myCalc_"+a]=b,b.palette=this.palettes.dict.actions,b.defaults.push(a),b.staticLabels.push(a),b.zeroArgBlock(),b.palette.add(b)}else console.log("myCalc_"+a+" already exists.")},this.newNameddoArgBlock=function(a){if(void 0==this.protoBlockDict["myDoArg_"+a]){console.log("creating myDoArg_"+a);var b=new ProtoBlock("nameddoArg");this.protoBlockDict["myDoArg_"+a]=b,b.palette=this.palettes.dict.actions,b.defaults.push(a),b.staticLabels.push(a),b.zeroArgBlock(),b.palette.add(b)}else console.log("myDoArg_"+a+" already exists.")},this.newNamedcalcArgBlock=function(a){if(void 0==this.protoBlockDict["myCalcArg_"+a]){console.log("creating myCalcArg_"+a);var b=new ProtoBlock("namedcalcArg");this.protoBlockDict["myCalcArg_"+a]=b,b.palette=this.palettes.dict.actions,b.defaults.push(a),b.staticLabels.push(a),b.zeroArgBlock(),b.palette.add(b)}else console.log("myCalcArg_"+a+" already exists.")},this.newActionBlock=function(a){if(!("myAction_"+a in this.protoBlockDict)){var b=new ProtoBlock("action");this.protoBlockDict["myAction_"+a]=b,b.palette=this.palettes.dict.actions,b.defaults.push(a),b.staticLabels.push(_("action")),b.expandable=!0,b.style="clamp",b.stackClampOneArgBlock(),"action"!=a&&b.palette.add(b)}},this.insideArgClamp=function(a){if(null==this.blockList[a])return console.log("null block in blockList? "+a),null;if(null==this.blockList[a].connections[0])return null;var b=this.blockList[a].connections[0];return this.blockList[b].isArgClamp()?b:null},this.insideExpandableBlock=function(a){if(null==this.blockList[a])return console.log("null block in blockList? "+a),null;if(null==this.blockList[a].connections[0])return null;var b=this.blockList[a].connections[0];return this.blockList[b].isExpandableBlock()?a==last(this.blockList[b].connections)?this.insideExpandableBlock(b):b:this.insideExpandableBlock(b)},this.triggerLongPress=function(a){null==this.timeOut,this.inLongPress=!0,this.copyButton.visible=!0,this.copyButton.x=a.container.x-27,this.copyButton.y=a.container.y-27,this.dismissButton.visible=!0,this.dismissButton.x=a.container.x+27,this.dismissButton.y=a.container.y-27,"action"==a.name&&(this.saveStackButton.visible=!0,this.saveStackButton.x=a.container.x+82,this.saveStackButton.y=a.container.y-27),this.refreshCanvas()},this.pasteStack=function(){if(null!=this.selectedStack){var a=this.copyBlocksToObj();this.loadNewBlocks(a)}},this.saveStack=function(){if(null!=this.selectedStack){var a=this.copyBlocksToObj(),b=a[0][4][1];if(null==b)console.log("action not named... skipping");else{if(console.log(a[b][1][1]),"string"==typeof a[b][1][1])var c=a[b][1][1];else if("number"==typeof a[b][1][1])var c=a[b][1][1].toString();else var c=a[b][1][1].value;storage.macros=prepareMacroExports(c,a,this.macroDict),sugarizerCompatibility.isInsideSugarizer()?sugarizerCompatibility.saveLocally(function(){this.addToMyPalette(c,a),this.palettes.updatePalettes()}):(this.addToMyPalette(c,a),this.palettes.updatePalettes())}}},this.copyBlocksToObj=function(){var a=[],b={};this.findDragGroup(this.selectedStack);for(var c=0;c<this.dragGroup.length;c++){if(myBlock=this.blockList[this.dragGroup[c]],0==c?(x=25,y=25):(x=0,y=0),myBlock.isValueBlock())switch(myBlock.name){case"media":blockItem=[c,[myBlock.name,null],x,y,[]];break;default:blockItem=[c,[myBlock.name,myBlock.value],x,y,[]]}else["namedbox","nameddo","namedcalc","nameddoArg","namedcalcArg","namedarg"].indexOf(myBlock.name)!=-1?blockItem=[c,[myBlock.name,{value:myBlock.privateData}],x,y,[]]:blockItem=[c,myBlock.name,x,y,[]];b[this.dragGroup[c]]=c,a.push(blockItem)}for(var c=0;c<this.dragGroup.length;c++){myBlock=this.blockList[this.dragGroup[c]];for(var d=0;d<myBlock.connections.length;d++)null==myBlock.connections[d]?a[c][4].push(null):a[c][4].push(b[myBlock.connections[d]])}return a},this.addToMyPalette=function(a,b){var c=new ProtoBlock("macro_"+a),d="macro_"+a;this.protoBlockDict[d]=c,"myblocks"in this.palettes.dict||this.palettes.add("myblocks"),c.palette=this.palettes.dict.myblocks,
c.zeroArgBlock(),c.staticLabels.push(_(a)),this.protoBlockDict[d].palette.add(this.protoBlockDict[d])},this.loadNewBlocks=function(b){for(var c=0;c<b.length;c++){var d=b[c];for(var e in d[4])if(d[4][e]==d[0])return console.log("Circular connection in block data: "+d),console.log("Punting loading of new blocks!"),void console.log(b)}for(var f=[],g=[],c=0;c<this.blockList.length;c++)"action"==this.blockList[c].name?null!=this.blockList[c].connections[1]&&f.push(this.blockList[this.blockList[c].connections[1]].value):"storein"==this.blockList[c].name&&null!=this.blockList[c].connections[1]&&g.push(this.blockList[this.blockList[c].connections[1]].value);this.checkTwoArgBlocks=[],this.checkArgClampBlocks=[];var h={},i={},j={},k={};this.blocksToCollapse=[];for(var c=0;c<b.length;c++){var d=b[c];if("string"==typeof d[1])var l=d[1];else var l=d[1][0];if(l in this.protoBlockDict){switch(["arg","twoarg"].indexOf(this.protoBlockDict[l].style)!=-1&&this.protoBlockDict[l].expandable&&this.checkTwoArgBlocks.push(this.blockList.length+c),l){case"text":var m=d[1][1];void 0==h[m]&&(h[m]=[]),h[m].push(c);break;case"action":case"hat":null!=d[4][1]&&(i[c]=d[4][1]);break;case"storein":null!=d[4][1]&&(j[c]=d[4][1]);break;case"nameddo":case"namedcalc":case"nameddoArg":case"namedcalcArg":k[c]=d[1][1].value;break;case"do":case"stack":null!=d[4][1]&&(k[c]=d[4][1])}switch(l){case"action":case"start":"object"==typeof d[1]&&d[1].length>1&&"object"==typeof d[1][1]&&"collapsed"in d[1][1]&&d[1][1].collapsed&&this.blocksToCollapse.push(this.blockList.length+c)}}}var o=!1;for(var c in j){var d=b[j[c]];if(g.indexOf(d[1][1])==-1){if("string"==typeof d[1][1])var l=d[1][1];else var l=d[1][1].value;this.newStoreinBlock(l),this.newNamedboxBlock(l),o=!0}}for(var c in i){var d=b[i[c]];if("string"==typeof d[1][1])var l=d[1][1];else var l=d[1][1].value;for(var p=l,q=1;f.indexOf(l)!=-1;)if(l=p+q.toString(),q+=1,q>this.blockList.length){console.log("Could not generate unique action name.");break}p!=l&&(console.log("action "+p+" is being renamed "+l),d[1][1]={value:l});for(var r in k){var s=b[r];if("string"==typeof s[1])var t=s[1];else var t=s[1][0];if(["nameddo","namedcalc","nameddoArg","namedcalcArg"].indexOf(t)!=-1)s[1][1].value==p&&(s[1][1]={value:l});else{var u=b[k[r]];"string"==typeof u[1][1]?u[1][1]==p&&(u[1][1]=l):u[1][1].value==p&&(u[1][1]={value:l})}}}o&&this.palettes.updatePalettes(),this.adjustTheseDocks=[],this.loadCounter=b.length;var v=this.blockList.length;console.log(this.loadCounter+" blocks to load");for(var c=0;c<this.loadCounter;c++){var w=v+c,d=b[c];"object"==typeof d[1]?1==d[1].length?blkInfo=[d[1][0],{value:null}]:["number","string"].indexOf(typeof d[1][1])!=-1?(blkInfo=[d[1][0],{value:d[1][1]}],["start","action","hat"].indexOf(d[1][0])!=-1&&(blkInfo[1].collapsed=!1)):blkInfo=d[1]:(blkInfo=[d[1],{value:null}],["start","action","hat"].indexOf(d[1])!=-1&&(blkInfo[1].collapsed=!1));var l=blkInfo[0],x=!1;if(["start","action"].indexOf(l)!=-1&&(x=blkInfo[1].collapsed),null==blkInfo[1])var y=null;else var y=blkInfo[1].value;l in NAMEDICT&&(l=NAMEDICT[l]);var z=this;switch(l){case"start":d[4][0]=null,d[4][2]=null,postProcess=function(a){var b=a[0],c=a[1];z.blockList[b].value=z.turtles.turtleList.length,z.turtles.add(z.blockList[b],c)},this.makeNewBlockWithConnections("start",v,d[4],postProcess,[w,blkInfo[1]],x);break;case"action":case"hat":d[4][0]=null,d[4][3]=null,this.makeNewBlockWithConnections("action",v,d[4],null,null,x);break;case"namedbox":postProcess=function(a){var b=a[0],c=a[1];z.blockList[b].privateData=c,z.blockList[b].value=null},this.makeNewBlockWithConnections("namedbox",v,d[4],postProcess,[w,y]);break;case"namedarg":postProcess=function(a){var b=a[0],c=a[1];z.blockList[b].privateData=c,z.blockList[b].value=null},this.makeNewBlockWithConnections("namedarg",v,d[4],postProcess,[w,y]);break;case"namedcalc":postProcess=function(a){var b=a[0],c=a[1];z.blockList[b].privateData=c,z.blockList[b].value=null},this.makeNewBlockWithConnections("namedcalc",v,d[4],postProcess,[w,y]);break;case"nameddo":postProcess=function(a){var b=a[0],c=a[1];z.blockList[b].privateData=c,z.blockList[b].value=null},this.makeNewBlockWithConnections("nameddo",v,d[4],postProcess,[w,y]);break;case"doArg":postProcess=function(a){var b=a[0],c=a[1].length-4;if(c>0){for(var d=z.blockList[b].argClampSlots,e=0;e<c;e++)d.push(1),z.newLocalArgBlock(d.length),z.blockList[b].connections.push(null);z.blockList[b].updateArgSlots(d);for(var e=0;e<a[1].length;e++)z.blockList[b].connections[e]=a[1][e]}z.checkArgClampBlocks.push(b)},this.makeNewBlockWithConnections("doArg",v,d[4],postProcess,[w,d[4]]);break;case"nameddoArg":postProcess=function(a){var b=a[0],c=a[1];z.blockList[b].privateData=c,z.blockList[b].value=null;var d=a[2].length-3;if(d>0){for(var e=z.blockList[b].argClampSlots,f=0;f<d;f++)e.push(1),z.newLocalArgBlock(e.length),z.blockList[b].connections.push(null);z.blockList[b].updateArgSlots(e);for(var f=0;f<a[2].length;f++)z.blockList[b].connections[f]=a[2][f]}z.checkArgClampBlocks.push(b)},this.makeNewBlockWithConnections("nameddoArg",v,d[4],postProcess,[w,y,d[4]]);break;case"calcArg":postProcess=function(a){var b=a[0],c=a[1].length-3;if(c>0){for(var d=z.blockList[b].argClampSlots,e=0;e<c;e++)d.push(1),z.newLocalArgBlock(d.length),z.blockList[b].connections.push(null);z.blockList[b].updateArgSlots(d);for(var e=0;e<a[1].length;e++)z.blockList[b].connections[e]=a[1][e]}z.checkArgClampBlocks.push(b)},this.makeNewBlockWithConnections("calcArg",v,d[4],postProcess,[w,d[4]]);break;case"namedcalcArg":postProcess=function(a){var b=a[0],c=a[1];z.blockList[b].privateData=c,z.blockList[b].value=null;var d=a[2].length-2;if(d>0){for(var e=z.blockList[b].argClampSlots,f=0;f<d;f++)e.push(1),z.newLocalArgBlock(e.length),z.blockList[b].connections.push(null);z.blockList[b].updateArgSlots(e);for(var f=0;f<a[2].length;f++)z.blockList[b].connections[f]=a[2][f]}z.checkArgClampBlocks.push(b)},this.makeNewBlockWithConnections("namedcalcArg",v,d[4],postProcess,[w,y,d[4]]);break;case"number":postProcess=function(a){var b=a[0],c=a[1];z.blockList[b].value=Number(c),z.updateBlockText(b)},this.makeNewBlockWithConnections(l,v,d[4],postProcess,[w,y]);break;case"text":postProcess=function(a){var b=a[0],c=a[1];z.blockList[b].value=c,z.updateBlockText(b)},this.makeNewBlockWithConnections(l,v,d[4],postProcess,[w,y]);break;case"media":postProcess=function(a){var b=a[0],c=a[1];z.blockList[b].value=c,null!=c&&z.blockList[b].loadThumbnail(null)},this.makeNewBlockWithConnections(l,v,d[4],postProcess,[w,y]);break;case"camera":postProcess=function(a){var b=a[0];a[1];z.blockList[b].value=CAMERAVALUE},this.makeNewBlockWithConnections(l,v,d[4],postProcess,[w,y]);break;case"video":postProcess=function(a){var b=a[0];a[1];z.blockList[b].value=VIDEOVALUE},this.makeNewBlockWithConnections(l,v,d[4],postProcess,[w,y]);break;case"red":case"black":postProcess=function(a){z.blockList[a].value=0,z.updateBlockText(a)},this.makeNewBlockWithConnections("number",v,d[4],postProcess,w);break;case"white":postProcess=function(a){z.blockList[a].value=100,z.updateBlockText(a)},this.makeNewBlockWithConnections("number",v,d[4],postProcess,w);break;case"orange":postProcess=function(a){z.blockList[a].value=10,z.updateBlockText(a)},this.makeNewBlockWithConnections("number",v,d[4],postProcess,w);break;case"yellow":postProcess=function(a){z.blockList[a].value=20,z.updateBlockText(a)},this.makeNewBlockWithConnections("number",v,d[4],postProcess,w);break;case"green":postProcess=function(a){z.blockList[a].value=40,z.updateBlockText(a)},this.makeNewBlockWithConnections("number",v,d[4],postProcess,w);break;case"blue":postProcess=function(a){z.blockList[a].value=70,z.updateBlockText(a)},this.makeNewBlockWithConnections("number",v,d[4],postProcess,w);break;case"leftpos":postProcess=function(b){z.blockList[b].value=-(a.width/2),z.updateBlockText(b)},this.makeNewBlockWithConnections("number",v,d[4],postProcess,w);break;case"rightpos":postProcess=function(b){z.blockList[b].value=a.width/2,z.updateBlockText(b)},this.makeNewBlockWithConnections("number",v,d[4],postProcess,w);break;case"toppos":postProcess=function(b){z.blockList[b].value=a.height/2,z.updateBlockText(b)},this.makeNewBlockWithConnections("number",v,d[4],postProcess,w);break;case"botpos":case"bottompos":postProcess=function(b){z.blockList[b].value=-(a.height/2),z.updateBlockText(b)},this.makeNewBlockWithConnections("number",v,d[4],postProcess,w);break;case"width":postProcess=function(b){z.blockList[b].value=a.width,z.updateBlockText(b)},this.makeNewBlockWithConnections("number",v,d[4],postProcess,w);break;case"height":postProcess=function(b){z.blockList[b].value=a.height,z.updateBlockText(b)},this.makeNewBlockWithConnections("number",v,d[4],postProcess,w);break;case"loadFile":postProcess=function(a){z.blockList[a[0]].value=a[1],z.updateBlockText(a[0])},this.makeNewBlockWithConnections(l,v,d[4],postProcess,[w,y]);break;default:if(!l in this.protoBlockDict||null==this.protoBlockDict[l])switch(n=d[4].length,console.log(n+": substituting nop block for "+l),n){case 1:l="nopValueBlock";break;case 2:l="nopZeroArgBlock";break;case 3:l="nopOneArgBlock";break;case 4:l="nopTwoArgBlock";break;case 5:default:l="nopThreeArgBlock"}this.makeNewBlockWithConnections(l,v,d[4],null)}w==this.blockList.length-1&&null==this.blockList[w].connections[0]&&(this.blockList[w].x=d[2],this.blockList[w].y=d[3],this.adjustTheseDocks.push(w))}},this.cleanupAfterLoad=function(){if(this.loadCounter-=1,!(this.loadCounter>0)){if(this.updateBlockPositions(),this.checkArgClampBlocks.length>0)for(c=0;c<this.checkArgClampBlocks.length;c++)for(b=0;b<this.checkArgClampBlocks.length;b++)this.adjustArgClampBlock([this.checkArgClampBlocks[b]]);if(this.checkTwoArgBlocks.length>0)for(c=0;c<this.checkTwoArgBlocks.length;c++)for(b=0;b<this.checkTwoArgBlocks.length;b++)this.adjustExpandableTwoArgBlock([this.checkTwoArgBlocks[b]]);for(var a=0;a<this.adjustTheseDocks.length;a++)this.loopCounter=0,this.adjustDocks(this.adjustTheseDocks[a]),blockBlocks.expandClamps();for(var c=0;c<this.blocksToCollapse.length;c++)console.log("collapse "+this.blockList[this.blocksToCollapse[c]].name),this.blockList[this.blocksToCollapse[c]].collapseToggle();this.blocksToCollapse=[];for(var a=0;a<this.blockList.length;a++)null!=this.blockList[a].collapseContainer&&(this.blockList[a].collapseContainer.x=this.blockList[a].container.x+COLLAPSEBUTTONXOFF*(this.blockList[a].protoblock.scale/2),this.blockList[a].collapseContainer.y=this.blockList[a].container.y+COLLAPSEBUTTONYOFF*(this.blockList[a].protoblock.scale/2));this.refreshCanvas(),this.checkPaletteEntries()}},this.checkPaletteEntries=function(){for(var a=!1,b=0;b<this.blockList.length;b++)if("action"==this.blockList[b].name){var c=this.blockList[b],d=c.connections[1];null!=d&&this.blockList[d].value!=_("action")&&(console.log("calling newNameddoBlock with name "+this.blockList[d].value),this.newNameddoBlock(this.blockList[d].value,this.actionHasReturn(b),this.actionHasArgs(b)),a=!0)}a&&this.palettes.updatePalettes()},this.actionHasReturn=function(a){if("action"!=this.blockList[a].name)return!1;this.findDragGroup(a);for(var b=0;b<this.dragGroup.length;b++)if("return"==this.blockList[this.dragGroup[b]].name)return!0;return!1},this.actionHasArgs=function(a){if("action"!=this.blockList[a].name)return!1;this.findDragGroup(a);for(var b=0;b<this.dragGroup.length;b++)if("arg"==this.blockList[this.dragGroup[b]].name||"namedarg"==this.blockList[this.dragGroup[b]].name)return!0;return!1},this.raiseStackToTop=function(a){var b=this.findTopBlock(a);this.findDragGroup(b);for(var c=this.stage.getNumChildren()-1,d=0;d<this.dragGroup.length;d++)this.stage.setChildIndex(this.blockList[this.dragGroup[d]].container,c),c-=1;this.refreshCanvas},blockBlocks=this,this}function sendStackToTrash(a,b){var c=a.blockList.indexOf(b),d=b.connections[0];if(null!=d){for(var e in a.blockList[d].connections)if(a.blockList[d].connections[e]==c){a.blockList[d].connections[e]=null;break}b.connections[0]=null}if("start"==b.name&&(turtle=b.value,null!=turtle?(console.log("putting turtle "+turtle+" in the trash"),a.turtles.turtleList[turtle].trash=!0,a.turtles.turtleList[turtle].container.visible=!1):console.log("null turtle")),"action"==b.name){var f=a.blockList[b.connections[1]];if(f){for(var g=f.value,h=0;h<a.blockList.length;h++){var b=a.blockList[h],i=a.blockList[b.connections[0]];if(null!=i&&["namedcalc","calc","nameddo","do","action"].indexOf(i.name)==-1){var j=b.value;j!=_("action")&&j==g&&(i.hide(),b.hide(),b.trash=!0,i.trash=!0)}}for(var k=a.palettes.dict.actions,l=!1,h=0;h<k.protoList.length;h++){var m=k.protoList[h];["nameddo","namedcalc","nameddoArg","namedcalcArg"].indexOf(m.name)!=-1&&m.privateData!=_("action")&&(k.protoList.splice(k.protoList.indexOf(m),1),a.protoBlockDict["myDo_"+g]?(console.log("deleting protoblocks for action "+g),a.protoBlockDict["myDo_"+g].hide=!0,delete a.protoBlockDict["myDo_"+g]):a.protoBlockDict["myCalc_"+g]?(console.log("deleting protoblocks for action "+g),a.protoBlockDict["myCalc_"+g].hide=!0,delete a.protoBlockDict["myCalc_"+g]):a.protoBlockDict["myDoArg_"+g]?(console.log("deleting protoblocks for action "+g),a.protoBlockDict["myDoArg_"+g].hide=!0,delete a.protoBlockDict["myDoArg_"+g]):a.protoBlockDict["myCalcArg_"+g]&&(console.log("deleting protoblocks for action "+g),a.protoBlockDict["myCalcArg_"+g].hide=!0,delete a.protoBlockDict["myCalcArg_"+g]),k.y=0,l=!0)}l&&regeneratePalette(k)}}a.findDragGroup(c);for(var d=0;d<a.dragGroup.length;d++){var n=a.dragGroup[d];console.log("putting "+a.blockList[n].name+" in the trash"),a.blockList[n].trash=!0,a.blockList[n].hide(),a.refreshCanvas()}}var blockBlocks=null,MINIMUMDOCKDISTANCE=400,CAMERAVALUE="##__CAMERA__##",VIDEOVALUE="##__VIDEO__##";