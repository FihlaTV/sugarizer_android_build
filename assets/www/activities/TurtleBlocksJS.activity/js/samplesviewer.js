/*! Sugarizer 2016-12-28 */
function PlanetModel(a){this.controller=a,this.localProjects=[],this.globalProjects=[],this.localChanged=!1,this.globalImagesCache={},this.updated=function(){},this.stop=!1;var b=this;sugarizerCompatibility.isInsideSugarizer()?(server="https://turtle.sugarlabs.org/server/",storage=sugarizerCompatibility.data):storage=localStorage,this.start=function(a){b.updated=a,b.stop=!1,this.redoLocalStorageData(),b.updated(),this.downloadWorldWideProjects()},this.downloadWorldWideProjects=function(){jQuery.ajax({url:server,headers:{"x-api-key":APIKEY}}).done(function(a){b.globalProjects=[],b.stop=!1;var c=[];a.forEach(function(a,b){a.indexOf(".b64")!==-1&&c.push(a)}),b.getImages(c)})},this.getImages=function(a){if(b.stop!==!0){var c=a.pop();if(void 0!==c){var d=c.replace(".b64","");void 0!==b.globalImagesCache[c]?(b.globalProjects.push({title:d,img:b.globalImagesCache[c]}),b.updated(),b.getImages(a)):jQuery.ajax({url:server+c,headers:{"x-api-key":"3tgTzMXbbw6xEKX7"},dataType:"text"}).done(function(e){validateImageData(e)||(e=EMPTYIMAGE),b.globalImagesCache[c]=e,b.globalProjects.push({title:d,img:e,url:c}),b.updated(),b.getImages(a)})}}},this.redoLocalStorageData=function(){this.localProjects=[];var a=JSON.parse(storage.allProjects);a.forEach(function(a,c){var d=storage["SESSIONIMAGE"+a];"undefined"===d&&(d=EMPTYIMAGE);var e={title:a,img:d,data:storage["SESSION"+a],current:a===storage.currentProject};e.current?b.localProjects.unshift(e):b.localProjects.push(e)}),this.localChanged=!0},this.uniqueName=function(a){var b=JSON.parse(storage.allProjects);if(b.indexOf(a)===-1)return a;for(var c=1;;){var d=a+" "+c;if(b.indexOf(d)===-1)return d;c++}},this.newProject=function(){var a=this.uniqueName("My Project");b.prepLoadingProject(a),this.controller.sendAllToTrash(!0,!0),b.stop=!0},this.renameProject=function(a,c,d){d&&(storage.currentProject=c);var e=JSON.parse(storage.allProjects);e[e.indexOf(a)]=c,storage.allProjects=JSON.stringify(e),storage["SESSIONIMAGE"+c]=storage["SESSIONIMAGE"+a],storage["SESSION"+c]=storage["SESSION"+a],storage["SESSIONIMAGE"+a]=void 0,storage["SESSION"+a]=void 0,b.redoLocalStorageData()},this.delete=function(a){var c=JSON.parse(storage.allProjects);c.splice(c.indexOf(a),1),storage.allProjects=JSON.stringify(c),storage["SESSIONIMAGE"+a]=void 0,storage["SESSION"+a]=void 0,b.redoLocalStorageData(),b.updated()},this.open=function(a,c){storage.currentProject=a,b.controller.sendAllToTrash(!1,!0),b.controller.loadRawProject(c),b.stop=!0},this.prepLoadingProject=function(a){storage.currentProject=a;var b=JSON.parse(storage.allProjects);b.push(a),storage.allProjects=JSON.stringify(b)},this.load=function(a){b.prepLoadingProject(a),b.controller.sendAllToTrash(!1,!1),jQuery.ajax({url:server+a+".tb",headers:{"x-api-key":"3tgTzMXbbw6xEKX7"},dataType:"text"}).done(function(a){b.controller.loadRawProject(a),b.stop=!0})},this.publish=function(a,c,d){a=a.replace(/['!"#$%&\\'()\*+,\-\.\/:;<=>?@\[\\\]\^`{|}~']/g,"").replace(/ /g,"_"),httpPost(a+".tb",c),httpPost(a+".b64",d),b.downloadWorldWideProjects()}}function PlanetView(a,b){this.model=a,this.controller=b;var c=this;document.querySelector(".planet .new").addEventListener("click",function(){c.model.newProject(),c.controller.hide()}),document.querySelector("#myOpenFile").addEventListener("change",function(a){c.controller.hide()}),document.querySelector(".planet .open").addEventListener("click",function(){document.querySelector("#myOpenFile").focus(),document.querySelector("#myOpenFile").click(),window.scroll(0,0)}),this.update=function(){var a=this;if(a.localChanged){html="",a.localProjects.forEach(function(a,b){html+=format(LOCAL_PROJECT_TEMPLATE,a)}),document.querySelector(".planet .content.l").innerHTML=html;var b=document.querySelectorAll(".planet .content.l li");Array.prototype.forEach.call(b,function(a,b){a.querySelector(".open").addEventListener("click",c.open(a)),a.querySelector(".publish").addEventListener("click",c.publish(a)),a.querySelector(".download").addEventListener("click",c.download(a)),a.querySelector(".delete").addEventListener("click",c.delete(a)),a.querySelector("input").addEventListener("change",c.input(a)),a.querySelector(".thumbnail").addEventListener("click",c.open(a))}),a.localChanged=!1}html="",a.globalProjects.forEach(function(a,b){html+=format(GLOBAL_PROJECT_TEMPLATE,a)}),document.querySelector(".planet .content.w").innerHTML=html;var b=document.querySelectorAll(".planet .content.w li");Array.prototype.forEach.call(b,function(a,b){a.addEventListener("click",c.load(a))})},this.load=function(a){return function(){document.querySelector("#loading-image-container").style.display="",c.model.load(a.attributes.title.value),c.controller.hide()}},this.publish=function(a){return function(){document.querySelector("#loading-image-container").style.display="",c.model.publish(a.attributes.title.value,a.attributes.data.value,a.querySelector("img").src),document.querySelector("#loading-image-container").style.display="none"}},this.download=function(a){return function(){download(a.attributes.title.value+".tb","data:text/plain;charset=utf-8,"+a.attributes.data.value)}},this.open=function(a){return function(){return"true"===a.attributes.current.value?void c.controller.hide():(c.model.open(a.attributes.title.value,a.attributes.data.value),void c.controller.hide())}},this.delete=function(a){return function(){var b=a.attributes.title.value;c.model.delete(b)}},this.input=function(a){return function(){var b=a.querySelector("input").value,d=a.attributes.title.value,e="true"===a.attributes.current.value;c.model.renameProject(d,b,e),a.attributes.title.value=b}}}function SamplesViewer(a,b,c,d,e,f){this.stage=b,this.sendAllToTrash=f,this.loadProject=d,this.loadRawProject=e;var g=this;document.querySelector("#planetTitle").innerHTML=_("Planet"),document.querySelector("#planetMyDevice").innerHTML=_("On my device"),document.querySelector("#planetWorldwide").innerHTML=_("Worldwide"),this.model=new PlanetModel(this),this.view=new PlanetView(this.model,this),this.setServer=function(a){this.server=a},this.hide=function(){document.querySelector(".planet").style.display="none",document.querySelector("body").classList.remove("samples-shown"),document.querySelector(".canvasHolder").classList.remove("hide"),document.querySelector("#theme-color").content=platformColor.header,g.stage.enableDOMEvents(!0),window.scroll(0,0)},this.show=function(){return document.querySelector(".planet").style.display="",document.querySelector("body").classList.add("samples-shown"),document.querySelector(".canvasHolder").classList.add("hide"),document.querySelector("#theme-color").content="#8bc34a",setTimeout(function(){g.stage.enableDOMEvents(!1)},250),window.scroll(0,0),this.model.start(this.view.update),!0}}function validateImageData(a){if(void 0===a)return!1;if(0!==a.indexOf("data:image"))return!1;var b=a.split(",");return 0!=b[1].length}APIKEY="3tgTzMXbbw6xEKX7",EMPTYIMAGE="data:image/svg+xml;base64,"+btoa('<svg               xmlns="http://www.w3.org/2000/svg" width="320" height="240"               viewBox="0 0 320 240"></svg>'),window.server="/server/",jQuery.ajax("/server/").error(function(){server="https://turtle.sugarlabs.org/server/"});var LOCAL_PROJECT_TEMPLATE='<li data=\'{data}\' title="{title}" current="{current}">     <img class="thumbnail" src="{img}" />     <div class="options">         <input type="text" value="{title}"/><br/>         <img class="open icon" title="{_("Open")}" alt="{_Open}" src="icons/edit.svg" />         <img class="delete icon" title="{_Delete}" alt="{_Delete}" src="icons/delete.svg" />         <img class="publish icon" title="{_Publish}" alt="{_Publish}" src="icons/publish.svg" />         <img class="download icon" title="{_Download}" alt="{_Download}" src="icons/download.svg" />     </div> </li>',GLOBAL_PROJECT_TEMPLATE='<li url="{url}" title="{title}">     <img class="thumbnail" src="{img}" />     <div class="options">         <span>{title}</span><br/>         <img class="download icon" title="{_Download}" alt="{_Download}" src="icons/download.svg" />     </div> </li>';