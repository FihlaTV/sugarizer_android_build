/*! Sugarizer 2019-09-21 */
define(["sugar-web/activity/activity","webL10n","sugar-web/graphics/palette","sugar-web/graphics/presencepalette","sugar-web/datastore","sugar-web/graphics/journalchooser"],function(a,b,c,d,e,f){var a=requirejs("sugar-web/activity/activity");requirejs(["domReady!"],function(b){function c(a){var b;do{b=a,a=a.replace(j,"")}while(a!==b);return a.replace(/</g,"&lt;")}function g(){p=a.getPresenceObject(function(a,b){if(a)return m.innerHTML=l10n_s.get("Error"),void(m.className="error");q=b.getUserInfo(),m.innerHTML=l10n_s.get("Connected"),m.className="open",k.readOnly=!1,window.top.sugar.environment.sharedId||b.createSharedActivity("org.sugarlabs.ChatPrototype",function(a){}),b.onConnectionClosed(function(a){console.log(l10n_s.get("ConnectionClosed")),m.innerHTML=l10n_s.get("DisconnectedFromWebSocket"),m.className="closed"}),b.onSharedActivityUserChanged(function(a){var b=a.user.name.replace("<","&lt;").replace(">","&gt;");l.innerHTML+='<li class="received" style = "color:blue">'+b+" "+(a.move>0?l10n_s.get("Join"):l10n_s.get("Leave"))+" "+l10n_s.get("Chat")+"</li>",o.style.visibility="visible"}),b.onDataReceived(function(a){if("text"==a.type||void 0===a.type){var b=a.content,c=a.user.name.replace("<","&lt;").replace(">","&gt;"),d=a.user.colorvalue,e='<span style = "color:'+d.stroke+'">'+c+"</span>";myElem=document.createElement("li"),myElem.class="received",myElem.style.background=d.fill,myElem.innerHTML=e+b,myElem.style.color=d.stroke,l.appendChild(myElem),n.scrollTop=n.scrollHeight}else if("image"==a.type){var f=a.content,c=a.user.name.replace("<","&lt;").replace(">","&gt;"),d=a.user.colorvalue,e='<span style = "color:'+d.stroke+'">'+c+"</span>";myElem=document.createElement("li"),myElem.class="received",myElem.style.background=d.fill,myElem.innerHTML=e+"<img src='"+f+"' style='max-height:150px;'>",myElem.style.color=d.stroke,l.appendChild(myElem),n.scrollTop=n.scrollHeight}})})}function h(a,b){var c={user:q,content:a,type:b};p.sendMessage(p.getSharedInfo().id,c)}a.setup();var i="(?:[^\"'>]|\"[^\"]*\"|'[^']*')*",j=new RegExp("<(?:!--(?:(?:-*[^->])*--+|-?)|script\\b"+i+">[\\s\\S]*?</script\\s*|style\\b"+i+">[\\s\\S]*?</style\\s*|/?[a-z]"+i+")>","gi"),k=(document.getElementById("message-form"),document.getElementById("message")),l=document.getElementById("messages"),m=document.getElementById("status"),n=document.getElementById("content"),o=document.getElementById("image-upload");document.getElementById("status").innerHTML=l10n_s.get("status"),k.placeholder=l10n_s.get("WriteYourMessage");var p,q=null,r=document.getElementById("network-button");d=new d.PresencePalette(r,void 0),d.addEventListener("shared",g),window.top.sugar.environment.sharedId&&(g(),d.setShared(!0)),k.onkeydown=function(a){if(13===a.keyCode){return h(c(k.value),"text"),k.placeholder=l10n_s.get("WriteYourMessage"),k.value="",k.setSelectionRange(0,0),!1}},o.addEventListener("click",function(a){f.show(function(a){if(a){new e.DatastoreObject(a.objectId).loadAsText(function(a,b,c){h(c,"image")})}},{mimetype:"image/png"},{mimetype:"image/jpeg"})});for(var s,t=document.getElementById("smiley-button"),u=[[128513,128515],[128517,128519],[128521,128528]],v=0;v<u.length;v++)for(var w=u[v],x=w[0];x<w[1];x++)s=document.createElement("option"),s.value=x,s.innerHTML="&#"+x+";",t.appendChild(s);for(var y,z=document.getElementById("sad-button"),A=[[128531,128533],[128545,128551],[128555,128558]],v=0;v<A.length;v++)for(var w=A[v],x=w[0];x<w[1];x++)y=document.createElement("option"),y.value=x,y.innerHTML="&#"+x+";",z.appendChild(y);for(var B,C=document.getElementById("others-button"),D=[[128568,128573],[128582,128588]],v=0;v<D.length;v++)for(var w=D[v],x=w[0];x<w[1];x++)B=document.createElement("option"),B.value=x,B.innerHTML="&#"+x+";",C.appendChild(B)})});