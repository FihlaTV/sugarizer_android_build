/*! Sugarizer 2017-08-25 */
define(["activity/data-model","activity/draw","webL10n","sugar-web/env","sugar-web/datastore","moment-with-locales.min"],function(a,b,c,d,e,f){"use strict";function g(){n(),k()}function h(a){B=a.showGrid,B?(B=!0,s.classList.add("active")):(B=!1,s.classList.remove("active")),C=a.showSouth,C?(C=!0,t.classList.add("active")):(C=!1,t.classList.remove("active"))}function i(){return{showGrid:B,showSouth:C}}function j(a){var b={name:"",language:"undefined"!=typeof chrome&&chrome.app&&chrome.app.runtime?chrome.i18n.getUILanguage():navigator.language};if(!d.isSugarizer())return void a(b);var c=e.localStorage.getValue("sugar_settings");a(c)}function k(){var a=document.querySelector("#main-toolbar").clientHeight;document.querySelector("#panel-container").style.height=window.innerHeight-a+"px";var b=document.querySelector("#panel-right").clientHeight,c=document.querySelector("#panel-right").clientWidth,d=.05;y=(1-d)*Math.min(c,b),z=.5*y,u.width=y,u.height=y,u.style.top=.5*(b-u.height)+"px",u.style.left=.5*(c-u.width)+"px"}function l(){clearTimeout(A),m(),b.setImageSize(y),b.moon(),C?(v.save(),v.rotate(Math.PI),v.drawImage(u,-y,-y),v.restore(),B&&b.grid(w("SNWE"))):B&&b.grid(w("NSEW")),A=setTimeout(l,5e3)}function m(){a.update_moon_calculations();var b={},c=["moonInfo","phase","julian","age","lunation","visibility","seleno","full","new","lunar","solar"];b[w(c[0])]=[r()],b[w(c[1])]=[w(a.moon_phase_name())],b[w(c[2])]=[a.julian_date.toFixed(2),w("astro")],b[w(c[3])]=[a.days_old,w("days")+",",a.hours_old,w("hours")+",",a.minutes_old,w("minutes")],b[w(c[4])]=[(100*a.phase_of_moon).toFixed(4)+"%",w("thru"),a.lunation],b[w(c[5])]=[(100*a.percent_of_full_moon).toFixed(4)+"%",w("estimated")],b[w(c[6])]=[a.selenographic_deg.toFixed(2)+"Â°",w(a.west_or_east),"("+w(a.rise_or_set)+")"],b[w(c[7])]=[r(a.next_full_moon_date),w("in"),a.days_until_full_moon.toFixed(),w("days")],b[w(c[8])]=[r(a.next_new_moon_date),w("in"),a.days_until_new_moon.toFixed(),w("days")],b[w(c[9])]=[r(a.next_lunar_eclipse_date),w("in"),a.days_until_lunar_eclipse.toFixed(),w("days")],b[w(c[10])]=[r(a.next_solar_eclipse_date),w("in"),a.days_until_solar_eclipse.toFixed(),w("days")];var d=[];for(var e in b){var f="<p>"+e+":<br>"+b[e].join(" ")+"</p>";d.push(f)}d=d.join(""),document.querySelector("#panel-left").innerHTML=d,document.getElementById("toggle-grid-button").title=w("ToggleGrid"),document.getElementById("toggle-hemisphere-button").title=w("ToggleHemisphere"),document.getElementById("save-image-button").title=w("SaveImage")}function n(){window.addEventListener("resize",function(){k(),l()}),s.addEventListener("click",o),t.addEventListener("click",p),document.querySelector("#save-image-button").addEventListener("click",q)}function o(){B=!B,B?s.classList.add("active"):s.classList.remove("active"),l()}function p(){C=!C,C?t.classList.add("active"):t.classList.remove("active"),l()}function q(){var a="image/jpeg",b=u.toDataURL(a,1),c={mimetype:a,title:"Image Moon",activity:"org.olpcfrance.MediaViewerActivity",timestamp:(new Date).getTime(),creation_time:(new Date).getTime(),file_size:0};e.create(c,function(){console.log("export done.")},b)}function r(a){a=a?new Date(1e3*a):new Date;var b=f(a);return b.format("LLLL").replace(b.format("LT"),b.format("LTS"))}var s=document.querySelector("#toggle-grid-button"),t=document.querySelector("#toggle-hemisphere-button"),u=document.querySelector("canvas"),v=u.getContext("2d"),w=c.get,x=!0;c.ready(function(){x&&(x=!1,e.localStorage.load(function(){j(function(a){c.language.code=a.language,f.locale(a.language);var b=setTimeout(function(){clearTimeout(b),l()},50)})}))});var y,z,A,B,C;return{setup:g,initPrefs:h,getPrefs:i,updateInfo:m}});