/*! Sugarizer 2018-07-01 */
define(["sugar-web/activity/activity","sugar-web/datastore","notepalette","zoompalette","sugar-web/graphics/presencepalette","humane","tutorial","sugar-web/env"],function(a,b,c,d,e,f,g,h){var i="#FFF29F",j=!1,k=!1,l=null,m={},n='<?xml version="1.0" ?><!DOCTYPE svg  PUBLIC \'-//W3C//DTD SVG 1.1//EN\'  \'http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd\' [<!ENTITY stroke_color "#010101"><!ENTITY fill_color "#FFFFFF">]><svg enable-background="new 0 0 55 55" height="55px" version="1.1" viewBox="0 0 55 55" width="55px" x="0px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" y="0px"><g display="block" id="stock-xo_1_"><path d="M33.233,35.1l10.102,10.1c0.752,0.75,1.217,1.783,1.217,2.932   c0,2.287-1.855,4.143-4.146,4.143c-1.145,0-2.178-0.463-2.932-1.211L27.372,40.961l-10.1,10.1c-0.75,0.75-1.787,1.211-2.934,1.211   c-2.284,0-4.143-1.854-4.143-4.141c0-1.146,0.465-2.184,1.212-2.934l10.104-10.102L11.409,24.995   c-0.747-0.748-1.212-1.785-1.212-2.93c0-2.289,1.854-4.146,4.146-4.146c1.143,0,2.18,0.465,2.93,1.214l10.099,10.102l10.102-10.103   c0.754-0.749,1.787-1.214,2.934-1.214c2.289,0,4.146,1.856,4.146,4.145c0,1.146-0.467,2.18-1.217,2.932L33.233,35.1z" fill="&fill_color;" stroke="&stroke_color;" stroke-width="3.5"/><circle cx="27.371" cy="10.849" fill="&fill_color;" r="8.122" stroke="&stroke_color;" stroke-width="3.5"/></g></svg>';require(["domReady!"],function(o){a.setup();var p=0,q=document.getElementById("nodetext-button"),r=document.getElementById("delete-button"),s=function(a){p=a,q.classList.remove("active"),r.classList.remove("active"),M(),0==a?q.classList.add("active"):1==a&&r.classList.add("active"),null!=z&&(I(),z=null)};q.addEventListener("click",function(){s(0)},!0),r.addEventListener("click",function(){s(1)},!0);var t=document.getElementById("color-button");colorPalette=new c.NotePalette(t),colorPalette.setColor("rgb(255, 242, 159)"),colorPalette.addEventListener("colorChange",function(a){F(z)&&($({redo:{action:"update",id:z.id(),color:a.detail.color},undo:{action:"update",id:z.id(),color:z.data("background-color")}}),z.style("background-color",a.detail.color),z.data("background-color",a.detail.color)),B.style.backgroundColor=a.detail.color,i=a.detail.color});var u=document.getElementById("zoom-button");zoomPalette=new d.zoomPalette(u),zoomPalette.addEventListener("pop",function(a){}),zoomPalette.addEventListener("zoom",function(a){var b=a.detail.zoom,c=cy.zoom(),d=.25;0==b?c!=cy.minZoom()&&c-d>cy.minZoom()&&cy.zoom(c-d):1==b?c!=cy.maxZoom()&&cy.zoom(c+d):2==b?cy.fit():3==b&&cy.center()});var v=document.getElementById("png-button");v.addEventListener("click",function(a){var c=cy.png(),d=c.split(";")[0].split(":")[1],e=d.split("/")[0],f={mimetype:d,title:e.charAt(0).toUpperCase()+e.slice(1)+" Shared Notes",activity:"org.olpcfrance.MediaViewerActivity",timestamp:(new Date).getTime(),creation_time:(new Date).getTime(),file_size:0};b.create(f,function(){console.log("export done.")},c)});var w=document.getElementById("network-button"),x=new e.PresencePalette(w,void 0),y=document.getElementById("stop-button");y.addEventListener("click",function(a){console.log("writing..."),T(function(a){null===a?console.log("write done."):console.log("write failed.")})});var z=null,A="<Your content>",B=document.getElementById("textvalue"),C=null;B.addEventListener("click",function(a){M()});var D=function(a,b,c,d){cy.add({group:"nodes",nodes:[{data:{id:a,content:b,color:"rgb(0, 0, 0)","background-color":d},position:{x:c.x,y:c.y}}]});var e=cy.getElementById(a);return e.style({content:b,"background-color":d}),e.addClass("standard-node"),e},E=function(a,b){if(null!=a){var c=a.data("content");void 0===b?b=a.style().content:a.data("content",b),a.style({content:b}),c!=b&&$({redo:{action:"update",id:a.id(),text:b},undo:{action:"update",id:a.id(),text:c}})}},F=function(a){return null!=a&&"dashed"==a.style()["border-style"]},G=function(a){null!=a&&a.style({"border-color":"black","border-style":"dashed","border-width":"4px"})},H=function(a){null!=a&&a.style({"border-color":"darkgray","border-style":"solid","border-width":"1px"})},I=function(){for(var a=cy.collection("node"),b=0;b<a.length;b++)H(a[b])},J=function(a){null!=a&&cy.remove(a)},K=function(a){var b=a.renderedPosition(),c=cy.zoom();B.value=a.data("content"),B.style.visibility="visible",B.style.backgroundColor=a.style().backgroundColor;var d=100*c-200*c;B.style.left=b.x+d+"px",B.style.top=55+b.y+d+"px",B.style.width=190*c+"px",B.style.height=190*c+"px",B.value==A?B.setSelectionRange(0,B.value.length):B.setSelectionRange(B.value.length,B.value.length),B.focus()},L=function(){textvalue.style.visibility="hidden"},M=function(){null!=z&&F(z)&&(E(z,B.value),L(),H(z))},N=function(){var a=document.getElementById("canvas"),b={x:a.clientWidth/2,y:a.clientHeight/2};return b},O=function(){for(var a=[],b="0123456789abcdef",c=0;c<36;c++)a[c]=b.substr(Math.floor(16*Math.random()),1);a[14]="4",a[19]=b.substr(3&a[19]|8,1),a[8]=a[13]=a[18]=a[23]="-";var d=a.join("");return d},P=function(a){if(void 0!==a.action)if("create"==a.action)D(a.id,a.text,a.position,a.color);else if("delete"==a.action){var b=cy.getElementById(a.id);if(null==b)return;cy.remove(b)}else if("update"==a.action){var b=cy.getElementById(a.id);if(null==b)return;void 0!==a.text&&(b.data("content",a.text),b.style({content:a.text})),void 0!==a.color&&(b.data("background-color",a.color),b.style({"background-color":a.color})),void 0!==a.position&&b.position({x:a.position.x,y:a.position.y})}},Q=function(a){if(null!=a){cy.remove("node"),z=null;for(var b=0;b<a.length;b++)P(a[b]);L(),Z()}},R=function(){var b=a.getDatastoreObject();b.loadAsText(function(a,b,c){Q(c)})},S=function(){for(var a=[],b=cy.elements("node"),c=0;c<b.length;c++){var d=b[c];a.push({action:"create",id:d.id(),text:d.data("content"),position:{x:d.position().x,y:d.position().y},color:d.data("background-color")})}return a},T=function(b){var c=a.getDatastoreObject(),d=S();c.setDataAsText(d),c.save(b)},U=[],V=0,W=30,X=document.getElementById("undo-button");X.addEventListener("click",function(){M(),_()},!0);var Y=document.getElementById("redo-button");Y.addEventListener("click",function(){M(),aa()},!0);var Z=function(){U=[],V=0},$=function(a,b){if(V<U.length-1){for(var c=[],d=0;d<V+1;d++)c.push(U[d]);U=c}var e=U.length-1,f=a;if(e<W)U.push(f);else{for(var d=0;d<e;d++)U[d]=U[d+1];U[U.length-1]=f}V=U.length-1,j&&!b&&ga({action:"updateBoard",data:a}),ba()},_=function(a){if(!(U.length<1||V<0)){var b=U[V--].undo;P(b),j&&!a&&ga({action:"undoBoard"}),ba()}},aa=function(a){if(!(V+1>=U.length)){var b=U[++V].redo;P(b),j&&!a&&ga({action:"redoBoard"}),ba()}},ba=function(){var a=U.length;X.disabled=U.length<1||V<0,Y.disabled=V+1>=a},ca=function(a){var b=n;return b=b.replace("#010101",a.stroke),b=b.replace("#FFFFFF",a.fill),"data:image/svg+xml;base64,"+btoa(b)},da=function(){var a=document.getElementById("presence-users"),b="<hr><ul style='list-style: none; padding:0;'>";for(var c in m)b+="<li><img style='height:30px;' src='"+ca(m[c].colorvalue)+"'>"+m[c].name+"</li>";b+="</ul>",a.innerHTML=b},ea=function(a){var b=document.getElementById("presence-users");a&&b&&l.listSharedActivityUsers(l.getSharedInfo().id,function(a){m={};for(var b=0;b<a.length;b++){var c=a[b];m[c.networkId]=c}da()})},fa=function(){l=a.getPresenceObject(function(a,b){return a?void console.log("error"):(j=!0,userSettings=b.getUserInfo(),console.log("connected"),window.top.sugar.environment.sharedId||(k=!0,b.createSharedActivity("org.olpcfrance.sharednotes",function(a){})),b.onConnectionClosed(function(a){console.log(a),console.log("Connection closed")}),b.onSharedActivityUserChanged(function(a){ia(a)}),void b.onDataReceived(ha))})},ga=function(a){try{l.sendMessage(l.getSharedInfo().id,{user:l.getUserInfo(),content:a})}catch(a){}},ha=function(a){if(l.getUserInfo().networkId!==a.user.networkId)switch(a.content.action){case"initialBoard":Q(a.content.data);break;case"updateBoard":P(a.content.data.redo),$(a.content.data,!0);break;case"undoBoard":_(!0);break;case"redoBoard":aa(!0)}},ia=function(a){var b=a.user.name.replace("<","&lt;").replace(">","&gt;"),c="<img style='height:30px;' src='"+ca(a.user.colorvalue)+"'>"+b;1===a.move?(f.log(c+" joined"),k&&ga({action:"initialBoard",data:S()})):a.move===-1&&f.log(c+" left"),l.listSharedActivities(function(a){for(var b=0;b<a.length;b++)a[b].id===l.getSharedInfo().id&&ea(a[b].users)})};x.addEventListener("shared",function(){x.popDown(),fa()}),window.top&&window.top.sugar&&window.top.sugar.environment&&window.top.sugar.environment.sharedId&&(fa(),x.setShared(!0));var ja=document.getElementById("help-button");g.setElement("activity",document.getElementById("activity-button")),g.setElement("title",document.getElementById("title")),g.setElement("network",w),g.setElement("help",ja),g.setElement("shared",document.getElementById("shared-button")),g.setElement("png",v),g.setElement("zoom",u),g.setElement("color",t),g.setElement("add",q),g.setElement("remove",r),g.setElement("undo",document.getElementById("undo-button")),g.setElement("redo",document.getElementById("redo-button")),g.setElement("stop",y),g.setElement("node",document.getElementById("canvas")),ja.addEventListener("click",function(a){g.start()}),h.getEnvironment(function(a,b){b.help&&setTimeout(function(){g.start(g.tourInit)},500)}),window.addEventListener("localized",function(){h.getEnvironment(function(a,b){var c="undefined"!=typeof chrome&&chrome.app&&chrome.app.runtime?chrome.i18n.getUILanguage():navigator.language,d=b.user?b.user.language:c;l10n_s.language.code!=d&&(l10n_s.language.code=d);var e=A;if(A=l10n_s.get("YourNewIdea"),q.title=l10n_s.get("nodetextTitle"),r.title=l10n_s.get("removeButtonTitle"),X.title=l10n_s.get("undoButtonTitle"),Y.title=l10n_s.get("redoButtonTitle"),u.title=l10n_s.get("zoomButtonTitle"),v.title=l10n_s.get("pngButtonTitle"),w.title=l10n_s.get("networkButtonTitle"),ja.title=l10n_s.get("helpButtonTitle"),cy){for(var f=cy.elements("node"),g=0;g<f.length;g++){var h=f[g];h.data("content")==e&&(h.data("content",A),h.style({content:A}))}B&&B.value==e&&(B.value=A,z&&K(z))}})},!1),cy=cytoscape({container:document.getElementById("cy"),ready:function(){cy=this;var a=D(O(),A,N(),i);$({redo:{action:"create",id:a.id(),text:a.data("content"),position:{x:a.position().x,y:a.position().y},color:i},undo:{action:"delete",id:a.id()}}),a.select(),G(a),K(a),z=a,R()},style:[{selector:".standard-node",css:{width:"200px",height:"200px","text-valign":"center","text-halign":"center","border-color":"darkgray","border-width":"1px","background-color":i,"text-wrap":"wrap","text-max-width":"200px","shadow-color":"black","shadow-offset-x":"4px","shadow-offset-y":"4px","shadow-opacity":"0.5",shape:"rectangle"}}]}),cy.on("tap","node",function(){return 1==p?($({redo:{action:"delete",id:this.id()},undo:{action:"create",id:this.id(),text:this.data("content"),position:{x:this.position().x,y:this.position().y},color:i}}),J(this),void(z==this&&(z=null))):(F(this)||(null!=z&&(E(z,B.value),H(z)),G(this),K(this)),void(z=this))}),cy.on("unselect","node",function(){M(),H(this)}),cy.on("tap",function(a){if(a.cyTarget===cy&&0==p){var b=D(O(),A,a.cyPosition,i);$({redo:{action:"create",id:b.id(),text:b.data("content"),position:{x:b.position().x,y:b.position().y},color:i},undo:{action:"delete",id:b.id()}}),b.select(),G(b),K(b),z=b}}),cy.on("drag","node",function(a){M(),null==C&&(C={x:this.position().x,y:this.position().y})}),cy.on("free","node",function(a){null==C||this.position().x==C.x&&this.position().y==C.y||$({redo:{action:"update",id:this.id(),position:{x:this.position().x,y:this.position().y}},undo:{action:"update",id:this.id(),position:{x:C.x,y:C.y}}}),C=null}),cy.on("zoom",function(){M()}),cy.on("pan",function(){M()})})});