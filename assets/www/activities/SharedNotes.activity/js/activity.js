/*! Sugarizer 2016-12-28 */
define(["sugar-web/activity/activity","webL10n","sugar-web/datastore","notepalette","zoompalette","sugar-web/graphics/presencepalette","humane"],function(a,b,c,d,e,f,g){var h="#FFF29F",i=!1,j=!1,k=null,l={},m='<?xml version="1.0" ?><!DOCTYPE svg  PUBLIC \'-//W3C//DTD SVG 1.1//EN\'  \'http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd\' [<!ENTITY stroke_color "#010101"><!ENTITY fill_color "#FFFFFF">]><svg enable-background="new 0 0 55 55" height="55px" version="1.1" viewBox="0 0 55 55" width="55px" x="0px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" y="0px"><g display="block" id="stock-xo_1_"><path d="M33.233,35.1l10.102,10.1c0.752,0.75,1.217,1.783,1.217,2.932   c0,2.287-1.855,4.143-4.146,4.143c-1.145,0-2.178-0.463-2.932-1.211L27.372,40.961l-10.1,10.1c-0.75,0.75-1.787,1.211-2.934,1.211   c-2.284,0-4.143-1.854-4.143-4.141c0-1.146,0.465-2.184,1.212-2.934l10.104-10.102L11.409,24.995   c-0.747-0.748-1.212-1.785-1.212-2.93c0-2.289,1.854-4.146,4.146-4.146c1.143,0,2.18,0.465,2.93,1.214l10.099,10.102l10.102-10.103   c0.754-0.749,1.787-1.214,2.934-1.214c2.289,0,4.146,1.856,4.146,4.145c0,1.146-0.467,2.18-1.217,2.932L33.233,35.1z" fill="&fill_color;" stroke="&stroke_color;" stroke-width="3.5"/><circle cx="27.371" cy="10.849" fill="&fill_color;" r="8.122" stroke="&stroke_color;" stroke-width="3.5"/></g></svg>';require(["domReady!"],function(n){a.setup();var o=0,p=document.getElementById("nodetext-button"),q=document.getElementById("delete-button"),r=function(a){o=a,p.classList.remove("active"),q.classList.remove("active"),J(),0==a?p.classList.add("active"):1==a&&q.classList.add("active"),null!=w&&(F(),w=null)};p.addEventListener("click",function(){r(0)},!0),q.addEventListener("click",function(){r(1)},!0);var s=document.getElementById("color-button");colorPalette=new d.NotePalette(s),colorPalette.setColor("rgb(255, 242, 159)"),colorPalette.addEventListener("colorChange",function(a){C(w)&&(X({redo:{action:"update",id:w.id(),color:a.detail.color},undo:{action:"update",id:w.id(),color:w.data("background-color")}}),w.style("background-color",a.detail.color),w.data("background-color",a.detail.color)),y.style.backgroundColor=a.detail.color,h=a.detail.color});var t=document.getElementById("zoom-button");zoomPalette=new e.zoomPalette(t),zoomPalette.addEventListener("pop",function(a){}),zoomPalette.addEventListener("zoom",function(a){var b=a.detail.zoom,c=cy.zoom(),d=.25;0==b?c!=cy.minZoom()&&c-d>cy.minZoom()&&cy.zoom(c-d):1==b?c!=cy.maxZoom()&&cy.zoom(c+d):2==b?cy.fit():3==b&&cy.center()});var u=document.getElementById("png-button");u.addEventListener("click",function(a){var b=cy.png(),d=b.split(";")[0].split(":")[1],e=d.split("/")[0],f={mimetype:d,title:e.charAt(0).toUpperCase()+e.slice(1)+" Shared Notes",activity:"org.olpcfrance.MediaViewerActivity",timestamp:(new Date).getTime(),creation_time:(new Date).getTime(),file_size:0};c.create(f,function(){console.log("export done.")},b)});var v=document.getElementById("stop-button");v.addEventListener("click",function(a){console.log("writing..."),Q(function(a){null===a?console.log("write done."):console.log("write failed.")})}),window.addEventListener("localized",function(){var a=navigator.language;a&&(a.indexOf("fr")!=-1?b.locale="fr":a.indexOf("es")!=-1&&(b.locale="es")),x=b.get("YourNewIdea"),p.title=b.get("nodetextTitle"),q.title=b.get("removeButtonTitle"),U.title=b.get("undoButtonTitle"),V.title=b.get("redoButtonTitle"),t.title=b.get("zoomButtonTitle"),u.title=b.get("pngButtonTitle"),ga.title=b.get("networkButtonTitle")},!1);var w=null,x="<Your content>",y=document.getElementById("textvalue"),z=null;y.addEventListener("click",function(a){J()});var A=function(a,b,c,d){cy.add({group:"nodes",nodes:[{data:{id:a,content:b,color:"rgb(0, 0, 0)","background-color":d},position:{x:c.x,y:c.y}}]});var e=cy.getElementById(a);return e.style({content:b,"background-color":d}),e.addClass("standard-node"),e},B=function(a,b){if(null!=a){var c=a.data("content");void 0===b?b=a.style().content:a.data("content",b),a.style({content:b}),c!=b&&X({redo:{action:"update",id:a.id(),text:b},undo:{action:"update",id:a.id(),text:c}})}},C=function(a){return null!=a&&"dashed"==a.style()["border-style"]},D=function(a){null!=a&&a.style({"border-color":"black","border-style":"dashed","border-width":"4px"})},E=function(a){null!=a&&a.style({"border-color":"darkgray","border-style":"solid","border-width":"1px"})},F=function(){for(var a=cy.collection("node"),b=0;b<a.length;b++)E(a[b])},G=function(a){null!=a&&cy.remove(a)},H=function(a){var b=a.renderedPosition(),c=cy.zoom();y.value=a.data("content"),y.style.visibility="visible",y.style.backgroundColor=a.style().backgroundColor;var d=100*c-200*c;y.style.left=b.x+d+"px",y.style.top=55+b.y+d+"px",y.style.width=190*c+"px",y.style.height=190*c+"px",y.value==x?y.setSelectionRange(0,y.value.length):y.setSelectionRange(y.value.length,y.value.length),y.focus()},I=function(){textvalue.style.visibility="hidden"},J=function(){null!=w&&C(w)&&(B(w,y.value),I(),E(w))},K=function(){var a=document.getElementById("canvas"),b={x:a.clientWidth/2,y:a.clientHeight/2};return b},L=function(){for(var a=[],b="0123456789abcdef",c=0;c<36;c++)a[c]=b.substr(Math.floor(16*Math.random()),1);a[14]="4",a[19]=b.substr(3&a[19]|8,1),a[8]=a[13]=a[18]=a[23]="-";var d=a.join("");return d},M=function(a){if(void 0!==a.action)if("create"==a.action)A(a.id,a.text,a.position,a.color);else if("delete"==a.action){var b=cy.getElementById(a.id);if(null==b)return;cy.remove(b)}else if("update"==a.action){var b=cy.getElementById(a.id);if(null==b)return;void 0!==a.text&&(b.data("content",a.text),b.style({content:a.text})),void 0!==a.color&&(b.data("background-color",a.color),b.style({"background-color":a.color})),void 0!==a.position&&b.position({x:a.position.x,y:a.position.y})}},N=function(a){if(null!=a){cy.remove("node"),w=null;for(var b=0;b<a.length;b++)M(a[b]);I(),W()}},O=function(){var b=a.getDatastoreObject();b.loadAsText(function(a,b,c){N(c)})},P=function(){for(var a=[],b=cy.elements("node"),c=0;c<b.length;c++){var d=b[c];a.push({action:"create",id:d.id(),text:d.data("content"),position:{x:d.position().x,y:d.position().y},color:d.data("background-color")})}return a},Q=function(b){var c=a.getDatastoreObject(),d=P();c.setDataAsText(d),c.save(b)},R=[],S=0,T=30,U=document.getElementById("undo-button");U.addEventListener("click",function(){J(),Y()},!0);var V=document.getElementById("redo-button");V.addEventListener("click",function(){J(),Z()},!0);var W=function(){R=[],S=0},X=function(a,b){if(S<R.length-1){for(var c=[],d=0;d<S+1;d++)c.push(R[d]);R=c}var e=R.length-1,f=a;if(e<T)R.push(f);else{for(var d=0;d<e;d++)R[d]=R[d+1];R[R.length-1]=f}S=R.length-1,i&&!b&&da({action:"updateBoard",data:a}),$()},Y=function(a){if(!(R.length<1||S<0)){var b=R[S--].undo;M(b),i&&!a&&da({action:"undoBoard"}),$()}},Z=function(a){if(!(S+1>=R.length)){var b=R[++S].redo;M(b),i&&!a&&da({action:"redoBoard"}),$()}},$=function(){var a=R.length;U.disabled=R.length<1||S<0,V.disabled=S+1>=a},_=function(a){var b=m;return b=b.replace("#010101",a.stroke),b=b.replace("#FFFFFF",a.fill),"data:image/svg+xml;base64,"+btoa(b)},aa=function(){var a=document.getElementById("presence-users"),b="<hr><ul style='list-style: none; padding:0;'>";for(var c in l)b+="<li><img style='height:30px;' src='"+_(l[c].color)+"'>"+l[c].name+"</li>";b+="</ul>",a.innerHTML=b},ba=function(a){var b=document.getElementById("presence-users");if(a&&b){l={};for(var c=0;c<a.length;c++)!function(){var b=a[c],d=window.location.href.substring(0,window.location.href.indexOf("/activities/SharedNotes.activity"))+"/api/users/"+b,e=new XMLHttpRequest;e.open("GET",d,!0),e.onreadystatechange=function(a){4==e.readyState&&200==e.status&&(l[b]=JSON.parse(e.responseText),aa())},e.send(null)}()}},ca=function(){k=a.getPresenceObject(function(a,b){return a?void console.log("error"):(i=!0,userSettings=b.getUserInfo(),console.log("connected"),window.top.sugar.environment.sharedId||(j=!0,b.createSharedActivity("org.olpcfrance.sharednotes",function(a){})),b.onConnectionClosed(function(a){console.log(a),console.log("Connection closed")}),b.onSharedActivityUserChanged(function(a){fa(a)}),void b.onDataReceived(ea))})},da=function(a){try{k.sendMessage(k.getSharedInfo().id,{user:k.getUserInfo(),content:a})}catch(a){}},ea=function(a){if(k.getUserInfo().networkId!==a.user.networkId)switch(a.content.action){case"initialBoard":N(a.content.data);break;case"updateBoard":M(a.content.data.redo),X(a.content.data,!0);break;case"undoBoard":Y(!0);break;case"redoBoard":Z(!0)}},fa=function(a){var b=a.user.name.replace("<","&lt;").replace(">","&gt;"),c="<img style='height:30px;' src='"+_(a.user.colorvalue)+"'>"+b;1===a.move?(g.log(c+" joined"),j&&da({action:"initialBoard",data:P()})):a.move===-1&&g.log(c+" left"),k.listSharedActivities(function(a){for(var b=0;b<a.length;b++)a[b].id===k.getSharedInfo().id&&ba(a[b].users)})},ga=document.getElementById("network-button"),ha=new f.PresencePalette(ga,void 0);ha.addEventListener("shared",function(){ha.popDown(),ca()}),window.top&&window.top.sugar&&window.top.sugar.environment&&window.top.sugar.environment.sharedId&&(ca(),ha.setShared(!0)),cy=cytoscape({container:document.getElementById("cy"),ready:function(){cy=this;var a=A(L(),x,K(),h);X({redo:{action:"create",id:a.id(),text:a.data("content"),position:{x:a.position().x,y:a.position().y},color:h},undo:{action:"delete",id:a.id()}}),a.select(),D(a),H(a),w=a,O()},style:[{selector:".standard-node",css:{width:"200px",height:"200px","text-valign":"center","text-halign":"center","border-color":"darkgray","border-width":"1px","background-color":h,"text-wrap":"wrap","text-max-width":"200px","shadow-color":"black","shadow-offset-x":"4px","shadow-offset-y":"4px","shadow-opacity":"0.5",shape:"rectangle"}}]}),cy.on("tap","node",function(){return 1==o?(X({redo:{action:"delete",id:this.id()},undo:{action:"create",id:this.id(),text:this.data("content"),position:{x:this.position().x,y:this.position().y},color:h}}),G(this),void(w==this&&(w=null))):(C(this)||(null!=w&&(B(w,y.value),E(w)),D(this),H(this)),void(w=this))}),cy.on("unselect","node",function(){J(),E(this)}),cy.on("tap",function(a){if(a.cyTarget===cy&&0==o){var b=A(L(),x,a.cyPosition,h);X({redo:{action:"create",id:b.id(),text:b.data("content"),position:{x:b.position().x,y:b.position().y},color:h},undo:{action:"delete",id:b.id()}}),b.select(),D(b),H(b),w=b}}),cy.on("drag","node",function(a){J(),null==z&&(z={x:this.position().x,y:this.position().y})}),cy.on("free","node",function(a){null==z||this.position().x==z.x&&this.position().y==z.y||X({redo:{action:"update",id:this.id(),position:{x:this.position().x,y:this.position().y}},undo:{action:"update",id:this.id(),position:{x:z.x,y:z.y}}}),z=null}),cy.on("zoom",function(){J()}),cy.on("pan",function(){J()})})});