/*! Sugarizer 2019-01-12 */
define(["activity/sample-ressources","activity/palettes/template-palette","activity/palettes/size-palette","activity/lz-string","sugar-web/graphics/journalchooser","sugar-web/datastore"],function(a,b,c,d,e,f){function g(a){for(var b,c,d=a.length;0!==d;)c=Math.floor(Math.random()*d),d-=1,b=a[d],a[d]=a[c],a[c]=b;return a}function h(a){S.presence.isConnected()&&(S.inEditMode=!1,H(),I(),S.game.multiplayer=!0,S.isHost=a,S.me=S.presence.userInfo,S.game.currentPlayer=S.me.networkId,S.ui.gamePlayers.style.display="block")}function i(a){if(S.game.cards=[],S.game.selectedCards=[],S.game.template){S.game.mode=S.game.template.mode;var b={name:S.game.template.name,cards:[]};b.cards=JSON.parse(JSON.stringify(g(S.game.template.cards)));var c=0;if(c=S.game.size%2==0?S.game.size*S.game.size:S.game.size*S.game.size-2,S.game.mode==K){for(var d=[],e=0;e<b.cards.length&&e<c/2;e++){var f=b.cards[e][0],h=b.cards[e][1];f.id=e,h.id=e,d.push(f),d.push(h)}S.game.cards=g(d)}if(S.game.mode==L){for(var i=[],j=[],e=0;e<c/2&&e<b.cards.length;e++){var f=b.cards[e][0],h=b.cards[e][1];f.id=e,h.id=e,i.push(f),j.push(h)}for(var k=g(i),e=0;e<k.length;e++)S.game.cards.push(k[e]);for(var l=g(j),e=0;e<l.length;e++)S.game.cards.push(l[e])}a||q()}}function j(){for(var a=document.getElementsByClassName("textCard"),b=0;b<a.length;b++){for(var c=a[b];c.scrollHeight>c.offsetHeight;)c.style.fontSize=parseInt(c.style.fontSize)-1+"px";for(;c.scrollWidth>c.offsetWidth;)c.style.fontSize=parseInt(c.style.fontSize)-1+"px"}}function k(b,c){if(b.image){0==b.image.indexOf(O)&&(b.image=a[b.image.slice(O.length)]);var d=document.createElement("div");return d.style.background="url('"+b.image+"')",d.style.backgroundRepeat="no-repeat",d.style.backgroundSize="contain",d.style.webkitBackgroundSize="contain",d.style.backgroundPosition="center center",d.style.height=c+"px",d.style.width=c+"px",d}if(b.text){0==b.text.indexOf(O)&&(b.text=a[b.text.slice(O.length)]);var d=document.createElement("div");return d.className="textCard",d.style.textAlign="center",d.style.display="block",d.innerHTML=b.text,d.style.lineHeight=c+"px",d.style.fontSize=c+"px",d.style.color="#000",d.style.width=c+"px",d.style.height=c+"px",d}}function l(){if(!S.context){var a=window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.oAudioContext||window.msAudioContext;if(a){a=new a,S.context=a;var b=a.createBuffer(1,1,22050),c=a.createBufferSource();S.source=c,c.buffer=b,c.connect(a.destination),c.start(0)}}}function m(a,b,c){var d=document.createElement("div");return d.cardPosition=a,d.webkitPerspective="500px",d.perspective="500px",d.style.border="3px solid #fff",d.style.borderRadius="6px",d.style.margin="5px",d.style.webkitTransition="transform 0.5s",d.style.transition="transform 0.5s",d.style.transitionDuration="0.5s",d.style.webkitTransitionDuration="0.5s",d.style.transformStyle="preserve-3d",d.style.webkitTransformStyle="preserve-3d",d.style.position="relative",d.style.float="left",d.style.height=b+"px",d.style.width=b+"px",c.solved?(d.style.webkitTransform="rotateY(180deg)",d.style.transform="rotateY(180deg)"):(d.style.webkitTransform="",d.style.transform=""),0!=S.game.selectedCards.length&&S.game.selectedCards[0].cardPosition==d.cardPosition&&(d.style.webkitTransform="",d.style.transform=""),d}function n(a,b,c){var d=document.createElement("div");return S.game.mode==K&&(d.style.background="#777"),S.game.mode==L&&(d.style.background=a<b?"#777 url(icons/number1.svg)":"#777 url(icons/number2.svg)"),d.zIndex=2,d.style.borderRadius="6px",d.style.webkitBackfaceVisibility="hidden",d.style.backfaceVisibility="hidden",d.style.backgroundPosition="center center",d.style.backgroundRepeat="no-repeat",d.style.height=c+"px",d.style.position="absolute",d.style.top="0px",d.style.left="0px",d.style.width=c+"px",d}function o(a,b,c){var d=document.createElement("div"),e=k(S.game.cards[a],b);return d.appendChild(e),d.style.height=b+"px",d.style.webkitBackfaceVisibility="hidden",d.style.backfaceVisibility="hidden",d.style.mozBackfaceVisibility="hidden",d.style.position="absolute",d.style.webkitTransform="rotateY(180deg)",d.style.transform="rotateY(180deg)",d.style.top="0px",d.style.left="0px",d.style.borderRadius="6px",d.style.width=b+"px",d.style.background="#fff",c.solved&&(d.style.backgroundColor=J),d}function p(b,c,d){var e=S.game.cards.length/2;l();var f=b;if(!f.card.solved&&2!=S.game.selectedCards.length){if(S.game.mode==L&&1==S.game.selectedCards.length){if(f.cardPosition<e&&S.game.selectedCards[0].cardPosition<e)return;if(f.cardPosition>=e&&S.game.selectedCards[0].cardPosition>=e)return}if(f.style.webkitTransform="rotateY(180deg)",f.style.transform="rotateY(180deg)",1!=S.game.selectedCards.length||S.game.selectedCards[0]!=f){if(S.game.selectedCards.push(f),f.card.sound){0==f.card.sound.indexOf(O)&&(f.card.sound=a[f.card.sound.slice(O.length)]);var g=f.card.sound.split("base64,")[1];g=U.decodeArrayBuffer(btoa(atob(g))),S.context&&S.context.decodeAudioData(g,function(a){var b=S.context.createBufferSource();if(S.source)if(/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream)try{S.source.noteOff(0)}catch(a){}else try{S.source.stop(0)}catch(a){}if(S.source=b,b.buffer=a,b.connect(S.context.destination),/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream)try{b.noteOn(0)}catch(a){}else try{b.start(0)}catch(a){}},function(a){console.log("err(decodeAudioData): "+a)})}if(1!=S.game.selectedCards.length){if(S.game.selectedCards[0].card.id==f.card.id){S.game.selectedCards[0].card.solved=!0,f.card.solved=!0;for(var h=0;h<S.game.players.length;h++)S.game.players[h].networkId==d.networkId&&(S.game.players[h].score=S.game.players[h].score+1);v();var i=S.game.selectedCards[0].resultDiv,j=f.resultDiv;return setTimeout(function(){i.style.backgroundColor=J,j.style.backgroundColor=J},1e3),S.game.selectedCards=[],void q()}S.game.currentPlayer="",setTimeout(function(){try{f.style.webkitTransform="",f.style.transform="",S.game.selectedCards[0].style.webkitTransform="",S.game.selectedCards[0].style.transform="",S.game.selectedCards=[],setTimeout(function(){if(c)for(var a=0;a<S.game.players.length;a++)if(S.game.players[a].online&&S.game.players[a].networkId!=S.me.networkId){S.game.currentPlayer=S.game.players[a].networkId,u({action:"updateCurrentPlayer",currentPlayer:S.game.currentPlayer}),v();break}},300)}catch(a){}},2e3)}}}}function q(){S.activity.getDatastoreObject().setDataAsText(JSON.stringify({game:S.game})),S.activity.getDatastoreObject().save(function(a,b){})}function r(){if(S.game.multiplayer){if(S.game.currentPlayer!=S.me.networkId)return;u({action:"cardClick",position:this.cardPosition}),0!=S.game.players.length&&1!=S.game.players.length||p(this,!0);for(var a=0;a<S.game.players.length;a++)S.game.players[a].networkId==S.me.networkId&&p(this,!0,S.game.players[a])}else p(this,!0)}function s(){S.editor.pairMode==M?S.ui.gameEditorInsertModeButton.style.backgroundImage="url(icons/pair-non-equals.svg)":S.ui.gameEditorInsertModeButton.style.backgroundImage="url(icons/pair-equals.svg)",S.game.template.mode==K?S.ui.gameEditorPlayModeButton.style.backgroundImage="url(icons/grouped_game1.svg)":S.ui.gameEditorPlayModeButton.style.backgroundImage="url(icons/grouped_game2.svg)",S.ui.gameSizeButton.style.background="url(icons/"+S.game.size+"x"+S.game.size+".svg)",S.ui.gameTemplatesButton.style.backgroundImage="url(icons/"+S.game.template.icon+")",S.ui.gameGrid.innerHTML="";var a=S.ui.gameGrid,b=document.body.clientWidth,c=document.body.clientHeight,d=S.game.cards.length/2,e=c;b<c&&(e=b),e-=228,e/=S.game.size;for(var f=0;f<S.game.cards.length;f++){var g=S.game.cards[f];if(f%S.game.size==0&&f>0){var h=document.createElement("div");h.style.clear="both",a.appendChild(h)}var i=m(f,e,g),k=n(f,d,e),h=o(f,e,g);i.card=g,i.resultDiv=h;var l="click";/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream&&(l="touchstart"),i.addEventListener(l,r,!1),i.appendChild(h),i.appendChild(k),a.appendChild(i)}a.style.width=parseInt(e+10)*parseInt(S.game.size+1)+"px",a.style.marginLeft="auto",a.style.marginRight="auto",j()}function t(a){if(a.user.networkId!=S.me.networkId&&(a.content=JSON.parse(d.decompressFromUTF16(a.content)),"updateCurrentPlayer"==a.content.action&&(S.game.currentPlayer=a.content.currentPlayer,v()),"updateGame"==a.content.action&&(S.game=a.content.game,S.ui.gameSizeButton.style.background="url(icons/"+S.game.size+"x"+S.game.size+".svg)",S.ui.gameTemplatesButton.style.backgroundImage="url(icons/"+S.game.template.icon+")",S.drawGame(),v(),q()),"cardClick"==a.content.action)){for(var b=S.ui.gameGrid.childNodes,c=[],e=0;e<b.length;e++)b[e].style.clear&&""!=b[e].style.clear||c.push(b[e]);for(var e=0;e<S.game.players.length;e++)S.game.players[e].networkId==a.user.networkId&&p(c[a.content.position],!1,S.game.players[e])}}function u(a){if(S.game.multiplayer){var b=window.top.sugar.environment.sharedId;b||(b=S.presence.getSharedInfo().id),S.presence.sendMessage(b,{user:S.presence.getUserInfo(),content:d.compressToUTF16(JSON.stringify(a))})}}function v(){if(0!=S.game.players.length){var a=document.createElement("div"),b=!1;S.game.currentPlayer==S.me.networkId&&(b=!0);var c=document.createElement("div");c.style.float="left",c.style.marginTop="10px",c.style.width="30px",c.style.marginRight="3px",c.style.borderRight="1px solid #fff",c.style.height="30px",c.style.backgroundImage=b?"url(icons/play.svg)":"url(icons/sandclock.svg)",c.style.backgroundPosition="center center",c.style.backgroundRepeat="no-repeat",a.appendChild(c);for(var d=0;d<S.game.players.length;d++){var e=S.game.players[d],f=document.createElement("div");f.style.paddingTop="15px";for(var g=x(e.colorvalue),h="",i=0;i<e.score;i++)h+='<img style="height:13px;" src="icons/pair-add.svg">';f.innerHTML='<img style="height:23px; vertical-align:middle; " src="'+g+'"><span style="color:#fff;">'+e.name+"</span> "+h,f.style.float="left",0!=d&&(f.style.marginLeft="10px"),a.appendChild(f)}S.ui.gamePlayers.innerHTML="",S.ui.gamePlayers.appendChild(a)}}function w(a){for(var b=0;b<S.game.players.length;b++)S.game.players[b].online=!1;if(!S.hasLoadedMultiplayer&&a.length>=3)return void document.getElementById("stop-button").click();if(S.hasLoadedMultiplayer=!0,1==a.length)return S.isHost=!0,S.game.currentPlayer=S.me.networkId,S.game.selectedCards=[],s(),void v();for(var b=0;b<a.length;b++){for(var c=!1,d=0;d<S.game.players.length;d++)if(S.game.players[d].networkId==a[b].networkId){S.game.players[d].online=!0,c=!0;break}if(!c){var e=a[b];e.score=0,e.online=!0,S.game.players.push(e)}}S.isHost&&u({action:"updateGame",game:S.game}),v()}function x(a){var b=T;return b=b.replace("#010101",a.stroke),b=b.replace("#FFFFFF",a.fill),"data:image/svg+xml;base64,"+btoa(b)}function y(a){S.ui.gameGrid=document.getElementById("game-grid"),S.ui.gamePlayers=document.getElementById("game-players"),S.ui.gameEditor=document.getElementById("game-editor"),S.ui.gameTemplatesButton=document.getElementById("game-templates-button"),new b.TemplatePalette(S.ui.gameTemplatesButton,void 0,S.templates).addEventListener("template",function(a){for(var b=0;b<S.game.players.length;b++)S.game.players[b].score=0;S.game.template=a.detail.value,S.ui.gameTemplatesButton.style.backgroundImage="url(icons/"+a.detail.value.icon+")",S.computeCards(),S.drawGame(),u({action:"updateGame",game:S.game})}),S.ui.gameSizeButton=document.getElementById("game-size-button"),new c.SizePalette(S.ui.gameSizeButton).addEventListener("size",function(a){for(var b=0;b<S.game.players.length;b++)S.game.players[b].score=0;S.game.size=a.detail.value,S.ui.gameSizeButton.style.background="url(icons/"+a.detail.value+"x"+a.detail.value+".svg)",S.computeCards(),S.drawGame(),u({action:"updateGame",game:S.game})}),S.ui.gameResetButton=document.getElementById("game-reset-button"),S.ui.gameResetButton.addEventListener("click",function(){for(var a=0;a<S.game.players.length;a++)S.game.players[a].score=0;S.game.selectedCards=[],S.game.cards=[],v(),S.computeCards(),S.drawGame(),u({action:"updateGame",game:S.game})}),S.ui.gameEditorButton=document.getElementById("game-editor-button"),S.ui.gameEditorInsertModeButton=document.getElementById("game-editor-insert-mode-button"),S.ui.gameEditorPlayModeButton=document.getElementById("game-editor-play-mode-button"),S.ui.gameEditorPlayModeButton.addEventListener("click",function(){S.game.template.mode==K?(S.game.template.mode=L,S.ui.gameEditorPlayModeButton.style.backgroundImage="url(icons/grouped_game2.svg)"):(S.game.template.mode=K,S.ui.gameEditorPlayModeButton.style.backgroundImage="url(icons/grouped_game1.svg)"),q(),G()}),S.ui.gameEditorClearButton=document.getElementById("game-editor-clear-button"),S.ui.gameEditorInsertModeButton.addEventListener("click",function(){S.editor.pairMode==M?(S.editor.pairMode=N,S.ui.gameEditorInsertModeButton.style.backgroundImage="url(icons/pair-non-equals.svg)"):(S.editor.pairMode=M,S.ui.gameEditorInsertModeButton.style.backgroundImage="url(icons/pair-equals.svg)"),q(),G()}),S.ui.gameEditorClearButton.addEventListener("click",function(){S.game.template.cards=[],q(),G()}),S.ui.gameEditorButton.addEventListener("click",function(){S.inEditMode?H():z()}),S.ui.gameEditorInsertModeButton.disabled=!0,S.ui.gameEditorInsertModeButton.style.opacity=.3,S.ui.gameEditorPlayModeButton.disabled=!0,S.ui.gameEditorPlayModeButton.style.opacity=.3,S.ui.gameEditorClearButton.disabled=!0,S.ui.gameEditorClearButton.style.opacity=.3,a&&a()}function z(){S.inEditMode=!0,S.ui.gameGrid.innerHTML="",S.ui.gameGrid.style.display="none",S.ui.gameEditor.style.display="block",S.game.selectedCards=[],S.editor.selectedPair=-1,S.ui.gameTemplatesButton.disabled=!0,S.ui.gameTemplatesButton.style.opacity=.3,S.ui.gameSizeButton.disabled=!0,S.ui.gameSizeButton.style.opacity=.3,S.ui.gameResetButton.disabled=!0,S.ui.gameResetButton.style.opacity=.3,S.ui.gameEditorInsertModeButton.disabled=!1,S.ui.gameEditorInsertModeButton.style.opacity=1,S.ui.gameEditorPlayModeButton.disabled=!1,S.ui.gameEditorPlayModeButton.style.opacity=1,S.ui.gameEditorClearButton.disabled=!1,S.ui.gameEditorClearButton.style.opacity=1,S.ui.gameEditorButton.style.backgroundImage="url(icons/play.svg)",G()}function A(a){var b=document.body.clientWidth;b>document.body.clientHeight&&(b=document.body.clientHeight);var c=document.createElement("div");c.style.width=parseInt(b/3.5)+"px",c.style.marginLeft="25px",c.style.float="left",c.style.marginTop="7px";var d=document.createElement("div");d.style.width=parseInt(b/3.5)-10+"px",d.style.height=parseInt(b/3.5)-10+"px",d.style.background="rgb(119, 119, 119)",d.style.border="4px solid #000",d.style.textAlign="center",d.style.borderRadius="9px",d.style.color="#fff",d.style.fontSize=parseInt(b/3.5)-10+"px",d.style.lineHeight=parseInt(b/3.5)-10+"px",d.className="textCard",d.style.backgroundRepeat="no-repeat",d.style.backgroundSize="100%",d.style.backgroundPosition="center",a&&a.text?d.innerHTML=a.text:a&&a.image&&(d.style.backgroundImage="url('"+a.image+"')");var e=document.createElement("img");e.style.marginLeft="5px",e.style.marginTop="5px",e.style.textAlign="center",e.setAttribute("src","icons/import_picture.svg"),e.style.width="30px",e.className="insertImage";var f=document.createElement("input");return f.setAttribute("type","text"),f.style.marginRight="auto",f.style.marginLeft="auto",f.style.width=parseInt(b/3.5)-50+"px",f.style.marginTop="5px",f.card=a,a&&a.text&&(f.value=a.text),f.linkedDiv=d,f.onkeyup=function(){this.linkedDiv.innerHTML=this.value,this.linkedDiv.style.fontSize=this.linkedDiv.style.width,this.card.text=this.value,j()},c.appendChild(d),c.appendChild(f),c.appendChild(e),c}function B(){var a=document.createElement("div"),b=document.body.clientWidth;b>document.body.clientHeight&&(b=document.body.clientHeight),a.style.float="right",a.style.height=parseInt(b/3.5)+"px",a.style.marginRight="20px",a.style.marginTop="7px";var c=document.createElement("div"),d=document.createElement("div"),e=document.createElement("div"),f=parseInt(b/3.5/5)+"px";return c.style.padding="5px",c.style.userSelect="none",c.style.webkitUserSelect="none",c.style.mozUserSelect="none",c.innerHTML="<img style='height:"+f+"; width:"+f+";' src='icons/pair-add.svg'><br/>"+S.strings.add,c.onmouseover=function(){this.style.background="#888"},c.onmouseout=function(){this.style.background="transparent"},c.addEventListener("click",function(){var a=[];S.editor.pairMode==M&&(a[0]=S.editor.card1,a[1]=S.editor.card1),S.editor.pairMode==N&&(a[0]=S.editor.card1,a[1]=S.editor.card2),(a[0].text||a[0].image||a[0].sound)&&(a[1].text||a[1].image||a[1].sound)&&(a=JSON.parse(JSON.stringify(a)),S.editor.card1={},S.editor.card2={},S.game.template.cards.push(a),S.editor.selectedPair=-1,q(),G())}),d.style.padding="5px",d.style.userSelect="none",d.style.webkitUserSelect="none",d.style.mozUserSelect="none",d.innerHTML="<img style='height:"+f+"; width:"+f+";' src='icons/pair-update.svg'><br/>"+S.strings.update,d.onmouseover=function(){this.style.background="#888"},d.onmouseout=function(){this.style.background="transparent"},d.addEventListener("click",function(){var a=[];S.editor.pairMode==M&&(a[0]=S.editor.card1,a[1]=S.editor.card1),S.editor.pairMode==N&&(a[0]=S.editor.card1,a[1]=S.editor.card2),(a[0].text||a[0].image||a[0].sound)&&(a[1].text||a[1].image||a[1].sound)&&(a=JSON.parse(JSON.stringify(a)),S.editor.selectedPair>-1&&(S.game.template.cards[S.editor.selectedPair]=a),q(),G())}),e.style.padding="5px",e.style.userSelect="none",e.style.webkitUserSelect="none",e.style.mozUserSelect="none",e.innerHTML="<img style='height:"+f+"; width:"+f+";' src='icons/remove.svg'><br/>"+S.strings.remove,e.onmouseover=function(){this.style.background="#888"},e.onmouseout=function(){this.style.background="transparent"},e.addEventListener("click",function(){S.editor.selectedPair>-1&&S.game.template.cards.splice(S.editor.selectedPair,1),S.editor.selectedPair=-1,S.editor.card1={},S.editor.card2={},q(),G()}),a.appendChild(c),a.appendChild(d),a.appendChild(e),a}function C(b,c,d){c-=10;var e=document.createElement("div");e.style.display="inline-block",e.style.height=c+"px",e.style.marginLeft="5px",d==S.editor.selectedPair&&(e.style.border="3px solid #00f");var f=document.createElement("div");f.style.backgroundRepeat="no-repeat",f.style.backgroundSize="cover",f.style.backgroundPosition="center center",f.innerHTML="&nbsp;",f.style.backgroundColor="#666",f.className="textCard",b[0].text?(0==b[0].text.indexOf(O)&&(b[0].text=a[b[0].image.slice(O.length)]),f.innerHTML=b[0].text):b[0].image&&(0==b[0].image.indexOf(O)&&(b[0].image=a[b[0].image.slice(O.length)]),f.style.backgroundImage="url('"+b[0].image+"')"),f.style.width=parseInt(c/2)+"px",f.style.height=parseInt(c/2)+"px",f.style.lineHeight=f.style.width+"",f.style.borderRadius="6px",f.style.textAlign="center",f.style.fontSize=parseInt(c/8)+"px",f.style.border="1px solid #000",f.style.color="#fff",f.style.marginBottom="5px";var g=document.createElement("div");return g.style.backgroundRepeat="no-repeat",g.style.backgroundPosition="center center",g.style.backgroundSize="cover",g.innerHTML="&nbsp;",g.style.backgroundColor="#666",g.className="textCard",b[1].text?(0==b[1].text.indexOf(O)&&(b[1].text=a[b[1].image.slice(O.length)]),g.innerHTML=b[1].text):b[1].image&&(0==b[1].image.indexOf(O)&&(b[1].image=a[b[1].image.slice(O.length)]),g.style.backgroundImage="url('"+b[1].image+"')"),g.style.width=parseInt(c/2)+"px",g.style.height=parseInt(c/2)+"px",g.style.textAlign="center",g.style.lineHeight=g.style.width+"",g.style.borderRadius="6px",g.style.fontSize=parseInt(c/8)+"px",g.style.border="1px solid #000",g.style.color="#fff",e.appendChild(f),e.appendChild(g),e}function D(){document.getElementsByClassName("insertImage")[0].onclick=function(){e.show(function(a){if(a){new f.DatastoreObject(a.objectId).loadAsText(function(b,c,d){var e=document.createElement("img");"org.olpcfrance.PaintActivity"==a.metadata.activity?e.src=LZString.decompressFromUTF16(JSON.parse(d).src):e.src=d,e.onload=function(){document.getElementsByClassName("textCard")[0].style.backgroundImage="url("+e.src+")",S.editor.pairMode==M?(S.editor.card1.image=e.src,S.editor.card1.text="",S.editor.card2.image=e.src,S.editor.card2.text=""):(S.editor.card1.image=e.src,S.editor.card1.text="");var a=[];S.editor.pairMode==M&&(a[0]=S.editor.card1,a[1]=S.editor.card1),S.editor.pairMode==N&&(a[0]=S.editor.card1,a[1]=S.editor.card2),(a[0].text||a[0].image||a[0].sound)&&(a[1].text||a[1].image||a[1].sound)&&(a=JSON.parse(JSON.stringify(a)),S.editor.selectedPair>-1&&(S.game.template.cards[S.editor.selectedPair]=a),q(),G())}})}},{mimetype:"image/png"},{mimetype:"image/jpeg"},{activity:"org.olpcfrance.PaintActivity"})},document.getElementsByClassName("insertImage")[1]&&(document.getElementsByClassName("insertImage")[1].onclick=function(){e.show(function(a){if(a){new f.DatastoreObject(a.objectId).loadAsText(function(a,b,c){var d=document.createElement("img");d.src=c,d.onload=function(){document.getElementsByClassName("textCard")[1].style.backgroundImage="url("+d.src+")",S.editor.pairMode==M?(S.editor.card1.image=d.src,S.editor.card1.text="",S.editor.card2.image=d.src,S.editor.card2.text=""):(S.editor.card2.image=d.src,S.editor.card2.text="");var a=[];S.editor.pairMode==M&&(a[0]=S.editor.card1,a[1]=S.editor.card1),S.editor.pairMode==N&&(a[0]=S.editor.card1,a[1]=S.editor.card2),(a[0].text||a[0].image||a[0].sound)&&(a[1].text||a[1].image||a[1].sound)&&(a=JSON.parse(JSON.stringify(a)),S.editor.selectedPair>-1&&(S.game.template.cards[S.editor.selectedPair]=a),q(),G())}})}},{mimetype:"image/png"},{mimetype:"image/jpeg"})})}function E(){var a=document.createElement("div"),b=document.body.clientWidth;b>document.body.clientHeight&&(b=document.body.clientHeight),a.style.position="fixed",a.style.bottom=0,a.style.width=document.body.clientWidth+"px",a.style.height=parseInt(b/3)+"px",a.style.padding="10px",a.style.paddingBottom="20px",a.style.marginTop="7px",a.style.background="#eee",a.style.overflowX="auto",a.style.whiteSpace="nowrap",a.style.overflowY="hidden";for(var c=0;c<S.game.template.cards.length;c++){var d=S.game.template.cards[c],e=C(d,parseInt(b/3),c);e.cards=d,e.index=c,e.addEventListener("click",function(){S.editor.selectedPair=this.index,S.editor.pairMode=N,S.editor.card1=this.cards[0],S.editor.card2=this.cards[1],G()}),a.appendChild(e)}var f=document.createElement("div");return f.style.height=parseInt(b/6)+"px",f.style.width="30px",f.style.display="inline-block",a.appendChild(f),a}function F(){var a=document.createElement("div");return a.style.clear="both",a}function G(){S.ui.gameEditor.innerHTML="",S.editor.pairMode==M&&S.ui.gameEditor.appendChild(A(S.editor.card1)),S.editor.pairMode==N&&(S.ui.gameEditor.appendChild(A(S.editor.card1)),S.ui.gameEditor.appendChild(A(S.editor.card2))),D(),S.ui.gameEditor.appendChild(B()),S.ui.gameEditor.appendChild(F()),S.ui.gameEditor.appendChild(E()),j()}function H(){S.editor.card1={},S.editor.card2={},S.inEditMode=!1,S.ui.gameEditor.innerHTML="",S.ui.gameEditor.style.display="none",S.ui.gameGrid.style.display="block",S.ui.gameTemplatesButton.disabled=!1,S.ui.gameTemplatesButton.style.opacity=1,S.ui.gameSizeButton.disabled=!1,S.ui.gameSizeButton.style.opacity=1,S.ui.gameResetButton.disabled=!1,S.ui.gameResetButton.style.opacity=1,S.ui.gameEditorInsertModeButton.disabled=!0,S.ui.gameEditorInsertModeButton.style.opacity=.3,S.ui.gameEditorPlayModeButton.disabled=!0,S.ui.gameEditorPlayModeButton.style.opacity=.3,S.ui.gameEditorClearButton.disabled=!0,S.ui.gameEditorClearButton.style.opacity=.3,S.ui.gameEditorButton.style.backgroundImage="url(icons/cog.svg)",S.drawGame()}function I(){S.ui.gameEditorButton.disabled=!0,S.ui.gameEditorButton.style.opacity=.3,S.ui.gameEditorButton.style.backgroundImage="url(icons/cog.svg)",S.ui.gameEditorInsertModeButton.disabled=!0,S.ui.gameEditorInsertModeButton.style.opacity=.3,S.ui.gameEditorPlayModeButton.disabled=!0,S.ui.gameEditorPlayModeButton.style.opacity=.3,S.ui.gameEditorClearButton.disabled=!0,S.ui.gameEditorClearButton.style.opacity=.3}var J="#84f060",K="classic",L="splitted",M="equal",N="non_equal",O="#inline#",P={name:"Addition",icon:"addition.svg",cards:[[{text:"3+4"},{text:"7"}],[{text:"5+5"},{text:"10"}],[{text:"5+6"},{text:"11"}],[{text:"4+4"},{text:"8"}],[{text:"4+5"},{text:"9"}],[{text:"3+3"},{text:"6"}],[{text:"2+2"},{text:"4"}],[{text:"1+1"},{text:"2"}],[{text:"1+2"},{text:"3"}],[{text:"9+9"},{text:"18"}],[{text:"10+9"},{text:"19"}],[{text:"8+8"},{text:"16"}],[{text:"8+9"},{text:"17"}],[{text:"7+7"},{text:"14"}],[{text:"7+8"},{text:"15"}],[{text:"6+6"},{text:"12"}]],mode:L},Q={name:"Letters",icon:"letters.svg",cards:[[{text:"A"},{text:"a"}],[{text:"B"},{text:"b"}],[{text:"C"},{text:"c"}],[{text:"D"},{text:"d"}],[{text:"E"},{text:"e"}],[{text:"F"},{text:"f"}],[{text:"G"},{text:"g"}],[{text:"H"},{text:"h"}],[{text:"I"},{text:"i"}],[{text:"J"},{text:"j"}],[{text:"K"},{text:"k"}],[{text:"L"},{text:"l"}],[{text:"M"},{text:"m"}],[{text:"N"},{text:"n"}],[{text:"O"},{text:"o"}],[{text:"P"},{text:"p"}],[{text:"Q"},{text:"q"}],[{text:"R"},{text:"r"}],[{text:"S"},{text:"s"}],[{text:"T"},{text:"t"}],[{text:"U"},{text:"u"}],[{text:"V"},{text:"v"}],[{text:"W"},{text:"w"}],[{text:"X"},{text:"x"}],[{text:"Y"},{text:"y"}],[{text:"Z"},{text:"z"}]],mode:L},R={name:"Sounds",icon:"sounds.svg",cards:[[{image:O+"drumkit1_b",sound:O+"beat1_a"},{image:O+"drumkit1_b",sound:O+"beat1_a"}],[{image:O+"drumkit2_b",sound:O+"beat1_b"},{image:O+"drumkit2_b",sound:O+"beat1_b"}],[{image:O+"drumkit3_b",sound:O+"beat1_c"},{image:O+"drumkit3_b",sound:O+"beat1_c"}],[{image:O+"drumkit4_b",sound:O+"beat8"},{image:O+"drumkit4_b",sound:O+"beat8"}],[{image:O+"drumkit5_b",sound:O+"beat10"},{image:O+"drumkit5_b",sound:O+"beat10"}],[{image:O+"drumkit6_b",sound:O+"beat3"},{image:O+"drumkit6_b",sound:O+"beat3"}],[{image:O+"drumkit7_b",sound:O+"beat4"},{image:O+"drumkit7_b",sound:O+"beat4"}],[{image:O+"drumkit8_b",sound:O+"beat14"},{image:O+"drumkit8_b",sound:O+"beat14"}],[{image:O+"drumkit9_b",sound:O+"beat6_2"},{image:O+"drumkit9_b",sound:O+"beat6_2"}],[{image:O+"drumkit10_b",sound:O+"beat2"},{image:O+"drumkit10_b",sound:O+"beat2"}],[{image:O+"drumkit11_b",sound:O+"beat16"},{image:O+"drumkit11_b",sound:O+"beat16"}],[{image:O+"drumkit12_b",sound:O+"beat17"},{image:O+"drumkit12_b",sound:O+"beat17"}],[{image:O+"guitar1_2",sound:O+"bending_a"},{image:O+"guitar1_2",sound:O+"bending_a"}],[{image:O+"guitar2_2",sound:O+"bending_b"},{image:O+"guitar2_2",sound:O+"bending_b"}],[{image:O+"guitar3_2",sound:O+"flashcomp2a"},{image:O+"guitar3_2",sound:O+"flashcomp2a"}],[{image:O+"guitar4_2",sound:O+"flashcomp2b"},{image:O+"guitar4_2",sound:O+"flashcomp2b"}],[{image:O+"guitar5_2",sound:O+"gedaempft"},{image:O+"guitar5_2",sound:O+"gedaempft"}],[{image:O+"guitar6_2",sound:O+"ungedaempft"},{image:O+"guitar6_2",sound:O+"ungedaempft"}],[{image:O+"guitar7_2",sound:O+"jimi4"},{image:O+"guitar7_2",sound:O+"jimi4"}],[{image:O+"guitar8_2",sound:O+"git_hit1"},{image:O+"guitar8_2",sound:O+"git_hit1"}],[{image:O+"guitar9_2",sound:O+"git_hit4"},{image:O+"guitar9_2",sound:O+"git_hit4"}],[{image:O+"guitar10_2",sound:O+"jimi1"},{image:O+"guitar10_2",sound:O+"jimi1"}],[{image:O+"guitar11_2",sound:O+"flasholet4"},{image:O+"guitar11_2",sound:O+"flasholet4"}],[{image:O+"guitar12_2",sound:O+"guitcello"},{image:O+"guitar12_2",sound:O+"guitcello"}]],mode:K},S={strings:{add:"Add",update:"Update",remove:"Remove"},ui:{},templates:[P,Q,R],isHost:!1,editor:{pairMode:M,card1:{},card2:{},selectedPair:-1},game:{template:Q,multiplayer:!1,selectedCards:[],mode:void 0,cards:[],currentPlayer:"",players:[],size:4},computeCards:i,inEditMode:!1,shareActivity:h,initUI:y,drawGame:s,onUsersListChanged:w,onDataReceived:t},T='<?xml version="1.0" ?><!DOCTYPE svg  PUBLIC \'-//W3C//DTD SVG 1.1//EN\'  \'http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd\' [<!ENTITY stroke_color "#010101"><!ENTITY fill_color "#FFFFFF">]><svg enable-background="new 0 0 55 55" height="55px" version="1.1" viewBox="0 0 55 55" width="55px" x="0px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" y="0px"><g display="block" id="stock-xo_1_"><path d="M33.233,35.1l10.102,10.1c0.752,0.75,1.217,1.783,1.217,2.932   c0,2.287-1.855,4.143-4.146,4.143c-1.145,0-2.178-0.463-2.932-1.211L27.372,40.961l-10.1,10.1c-0.75,0.75-1.787,1.211-2.934,1.211   c-2.284,0-4.143-1.854-4.143-4.141c0-1.146,0.465-2.184,1.212-2.934l10.104-10.102L11.409,24.995   c-0.747-0.748-1.212-1.785-1.212-2.93c0-2.289,1.854-4.146,4.146-4.146c1.143,0,2.18,0.465,2.93,1.214l10.099,10.102l10.102-10.103   c0.754-0.749,1.787-1.214,2.934-1.214c2.289,0,4.146,1.856,4.146,4.145c0,1.146-0.467,2.18-1.217,2.932L33.233,35.1z" fill="&fill_color;" stroke="&stroke_color;" stroke-width="3.5"/><circle cx="27.371" cy="10.849" fill="&fill_color;" r="8.122" stroke="&stroke_color;" stroke-width="3.5"/></g></svg>',U={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",_arrayBufferToBase64:function(a){for(var b="",c=new Uint8Array(a),d=c.byteLength,e=0;e<d;e++)b+=String.fromCharCode(c[e]);return window.btoa(b)},decodeArrayBuffer:function(a){var b=a.length/4*3,c=new ArrayBuffer(b);return this.decode(a,c),c},removePaddingChars:function(a){return 64==this._keyStr.indexOf(a.charAt(a.length-1))?a.substring(0,a.length-1):a},decode:function(a,b){a=this.removePaddingChars(a),a=this.removePaddingChars(a);var c,d,e,f,g,h,i,j,k=parseInt(a.length/4*3,10),l=0,m=0;for(c=b?new Uint8Array(b):new Uint8Array(k),a=a.replace(/[^A-Za-z0-9\+\/\=]/g,""),l=0;l<k;l+=3)g=this._keyStr.indexOf(a.charAt(m++)),h=this._keyStr.indexOf(a.charAt(m++)),i=this._keyStr.indexOf(a.charAt(m++)),j=this._keyStr.indexOf(a.charAt(m++)),d=g<<2|h>>4,e=(15&h)<<4|i>>2,f=(3&i)<<6|j,c[l]=d,64!=i&&(c[l+1]=e),64!=j&&(c[l+2]=f);return c}};return S});