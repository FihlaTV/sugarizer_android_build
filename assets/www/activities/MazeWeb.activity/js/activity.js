/*! Sugarizer 2018-07-01 */
define(["sugar-web/activity/activity","tween","rAF","activity/maze","activity/directions"],function(a,b,c,d,e){require(["domReady!"],function(c){a.setup();var f,g,h,i,j,k,l,m,n,o=/(iPad|iPhone|iPod)/g.test(navigator.userAgent)?".mp3":".ogg",p="#101010",q="#ffffff",r="hsl(0, 0%, 80%)",s="hsl(0, 90%, 50%)",t=[],u={arrows:[38,39,40,37],wasd:[87,68,83,65],ijkl:[73,76,75,74],mouse:[-1,-1,-1,-1]},v=["arrows","wasd","ijkl","mouse"],w={},x={},y={},z=60,A=!1,B=document.getElementById("maze"),C=document.createElement("canvas"),D=function(){var a=document.getElementById("main-toolbar");f=window.innerWidth,g=window.innerHeight-a.offsetHeight-3,i=Math.floor(f/d.width),j=Math.floor(g/d.height),B.width=f,B.height=g,C.width=2*i,C.height=j*v.length},E=function(){D(),F(),N()};window.addEventListener("resize",E);var F=function(){for(control in u)control in w&&G(control)},G=function(a){var b=v.indexOf(a);return ctx=C.getContext("2d"),K(ctx,0,b,w[a].normal),K(ctx,1,b,w[a].blocked),{normal:{image:C,x:0,y:b},blocked:{image:C,x:1,y:b}}},H=function(a,b,c,d){a.fillStyle=d,a.fillRect(i*b,j*c,i,j)},I=function(a,b,c,d){var e;e=1==d?p:q,H(a,b,c,e)},J=function(a,b,c,d,e){var f=i*(b+.5),g=j*(c+.5),h=e*Math.min(i,j)/2;a.beginPath(),a.arc(f,g,h,0,2*Math.PI,!1),a.fillStyle=d,a.fill()},K=function(a,b,c,d){J(a,b,c,d,.9);var e=i*(b+.3),f=j*(c+.45),g=.28*Math.min(i,j)/2;a.beginPath(),a.arc(e,f,g,0,2*Math.PI,!1);var h=i*(b+.7),k=j*(c+.45);a.arc(h,k,g,0,2*Math.PI,!1),a.fillStyle="#ffffff",a.fill(),a.beginPath(),a.arc(e,f,g/2,0,2*Math.PI,!1),a.arc(h,k,g/2,0,2*Math.PI,!1),a.fillStyle="#000000",a.fill(),a.beginPath(),a.moveTo(i*(b+.25),j*(c+.65)),a.quadraticCurveTo(i*(b+.5),j*(c+.75),i*(b+.75),j*(c+.65)),a.quadraticCurveTo(i*(b+.5),j*(c+.75),i*(b+.75),j*(c+.65)),a.quadraticCurveTo(i*(b+.5),j*(c+1),i*(b+.25),j*(c+.65)),a.quadraticCurveTo(i*(b+.5),j*(c+1),i*(b+.25),j*(c+.65)),a.fillStyle="#ffffff",a.fill()},L=function(a,b,c,d){a.drawImage(d.image,i*d.x,j*d.y,i,j,i*b,j*c,i,j)},M=function(a,b,c){void 0===c&&(c=B.getContext("2d")),I(c,a,b,d.walls[a][b]),void 0!==d.visited[a][b]&&J(c,a,b,d.visited[a][b],.5),A&&1==d.forks[a][b]&&J(c,a,b,"#faa",.5),a==d.startPoint.x&&b==d.startPoint.y&&J(c,d.startPoint.x,d.startPoint.y,r,.9),a==d.goalPoint.x&&b==d.goalPoint.y&&H(c,d.goalPoint.x,d.goalPoint.y,h);for(control in y){var e=y[control];a==e.x&&b==e.y&&L(c,a,b,e.sprite)}},N=function(a){void 0===a&&(a=B.getContext("2d"));for(var b=0;b<d.width;b++)for(var c=0;c<d.height;c++)I(a,b,c,d.walls[b][c]),void 0!==d.visited[b][c]&&J(a,b,c,d.visited[b][c],.5),A&&1==d.forks[b][c]&&J(a,b,c,"#faa",.5);J(a,d.startPoint.x,d.startPoint.y,r,.9),K(a,d.startPoint.x,d.startPoint.y,s),H(a,d.goalPoint.x,d.goalPoint.y,h);for(control in y){var e=y[control];L(a,b,c,e.sprite)}},O=function(a){void 0===a&&(a=B.getContext("2d"));var b=i*(k.x+.5),c=j*(k.y+.5),d=m;a.beginPath(),a.arc(b,c,d,0,2*Math.PI,!1),a.fillStyle=k.color,a.fill()},P=function(a){void 0===a&&(a=B.getContext("2d")),a.fillStyle=h;var b,c,e=i*n,f=j*n;b=1==d.goalPoint.x?i:(d.goalPoint.x+1)*i-e,c=1==d.goalPoint.y?j:(d.goalPoint.y+1)*j-f,a.fillRect(b,c,e,f),J(a,d.startPoint.x,d.startPoint.y,r,.9*n)},Q=function(){l="starting",tween=new b.Tween({t:0}),tween.to({t:1},900),tween.easing(b.Easing.Quadratic.InOut),tween.onUpdate(function(){n=this.t}),tween.onComplete(function(){n=void 0,l="playing",N()}),tween.start()},R=function(){d.generate(window.innerWidth/window.innerHeight,z),D(),F(),y={},k=void 0,Q()};R();var S=function(a){k=a,l="transition";var c=new Audio("sounds/win"+o);c.play();for(control in y)y[control].stop();var d=Math.sqrt(Math.pow(window.innerWidth,2)+Math.pow(window.innerHeight,2));tween=new b.Tween({radius:0}),tween.to({radius:d},1200),tween.easing(b.Easing.Circular.Out),tween.onUpdate(function(){m=this.radius}),tween.onComplete(function(){T()}),tween.start()},T=function(){z*=1.2,R()},U=function(a){if(this.control=a,this.x=d.startPoint.x,this.y=d.startPoint.y,!(a in w)){var b=Math.floor(360*Math.random());w[a]={normal:"hsl("+b+", 90%, 50%)",blocked:"hsl("+b+", 90%, 80%)",visited:"hsl("+b+", 30%, 80%)"},x[a]=G(a)}this.color=w[a].normal,this.sprite=x[a].normal,this.visitedColor=w[a].visited,this.path=void 0,this.animation=void 0,this.blockTween=void 0,t.push({x:this.x,y:this.y})};U.prototype.isMoving=function(){return void 0!==this.animation},U.prototype.canGo=function(a){var b=d.directions[this.x][this.y],c=e[a];return 1==b[c]},U.prototype.findPath=function(a){var b=function(a,c,f,g){if(!g&&(d.isDeadEnd(a,c)||d.isFork(a,c)))return[];var h=function(a,b,c){var f,g=a,h=b;"north"==c&&(h-=1),"east"==c&&(g+=1),"south"==c&&(h+=1),"west"==c&&(g-=1);var i=d.directions[g][h],j=i.slice(0);return j[e[e.getOpposite(c)]]=0,f=e.orders[j.indexOf(1)],{x:g,y:h,direction:f}},i=h(a,c,f),j=b(i.x,i.y,i.direction,!1);return j.unshift(f),j};return b(this.x,this.y,a,!0)},U.prototype.stop=function(){clearInterval(this.animation),this.animation=void 0},U.prototype.showBlocked=function(){function a(){c.color=w[c.control].normal,c.sprite=x[c.control].normal,t.push({x:c.x,y:c.y})}var c=this;void 0!==this.blockTween&&(this.blockTween.stop(),a()),this.blockTween=new b.Tween({}).to({},300),this.color=w[this.control].blocked,this.sprite=x[this.control].blocked,t.push({x:this.x,y:this.y}),this.blockTween.onComplete(function(){a()}),this.blockTween.start();var d=new Audio("sounds/tick"+o);d.play()},U.prototype.move=function(a){if(!this.isMoving()){if(!this.canGo(a))return void this.showBlocked();var b=this,c=function(){var a=b.path.shift();void 0==a&&b.stop(),d.visited[b.x][b.y]=b.visitedColor,t.push({x:b.x,y:b.y}),"north"==a&&(b.y-=1),"east"==a&&(b.x+=1),"south"==a&&(b.y+=1),"west"==a&&(b.x-=1),t.push({x:b.x,y:b.y}),b.x==d.goalPoint.x&&b.y==d.goalPoint.y&&S(b)};this.path=this.findPath(a),this.animation=setInterval(c,40)}};var V=function(a){if("transition"!=l){var b="mouse";b in y||(y[b]=new U(b));var c=y[b],d=i*(c.x+.5),e=j*(c.y+.5),f=a.clientX,g=a.clientY,h=document.getElementById("maze");f-=h.offsetLeft,g-=h.offsetTop;var k=180*Math.atan2(g-e,f-d)/Math.PI;45<k&&k<135?c.move("south"):-45>k&&k>-135?c.move("north"):-45<k&&k<45?c.move("east"):c.move("west")}};B.addEventListener?B.addEventListener("mousedown",V):B.attachEvent("onclick",V);var W=function(a){if("transition"!=l){var b,c;for(control in u)u[control].indexOf(a.keyCode)!=-1&&(b=control,c=e.orders[u[control].indexOf(a.keyCode)]);if(void 0!==b){b in y||(y[b]=new U(b));var d=y[b];d.move(c)}}};document.addEventListener("keydown",W);var X=function(a){var b=Math.floor(120*(1+Math.cos(a/3e3))),c=Math.floor(50+10*(1+Math.cos(a/300)));h="hsl("+b+", 90%, "+c+"%)",t.push({x:d.goalPoint.x,y:d.goalPoint.y})},Y=function(a){switch(b.update(a),l){case"transition":O();break;case"starting":X(a),P();break;case"playing":X(a),t.forEach(function(a){M(a.x,a.y)}),t=[]}requestAnimationFrame(Y),/Android/i.test(navigator.userAgent)&&"http"!=document.location.protocol.substr(0,4)&&(B.style.display="none",B.offsetHeight,B.style.display="block")};Y()})});