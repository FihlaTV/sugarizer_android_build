/*! Sugarizer 2016-12-28 */
define(["sugar-web/activity/activity","tween","rAF","activity/maze","activity/directions"],function(a,b,c,d,e){require(["domReady!"],function(c){a.setup();var f,g,h,i,j,k,l,m,n,o=/(iPad|iPhone|iPod)/g.test(navigator.userAgent)?".mp3":".ogg",p="#101010",q="#ffffff",r="hsl(0, 0%, 80%)",s=[],t={arrows:[38,39,40,37],wasd:[87,68,83,65],ijkl:[73,76,75,74],mouse:[-1,-1,-1,-1]},u=["arrows","wasd","ijkl","mouse"],v={},w={},x={},y=60,z=!1,A=document.getElementById("maze"),B=document.createElement("canvas"),C=function(){var a=document.getElementById("main-toolbar");f=window.innerWidth,g=window.innerHeight-a.offsetHeight-3,i=Math.floor(f/d.width),j=Math.floor(g/d.height),A.width=f,A.height=g,B.width=2*i,B.height=j*u.length},D=function(){C(),E(),M()};window.addEventListener("resize",D);var E=function(){for(control in t)control in v&&F(control)},F=function(a){var b=u.indexOf(a);return ctx=B.getContext("2d"),J(ctx,0,b,v[a].normal),J(ctx,1,b,v[a].blocked),{normal:{image:B,x:0,y:b},blocked:{image:B,x:1,y:b}}},G=function(a,b,c,d){a.fillStyle=d,a.fillRect(i*b,j*c,i,j)},H=function(a,b,c,d){var e;e=1==d?p:q,G(a,b,c,e)},I=function(a,b,c,d,e){var f=i*(b+.5),g=j*(c+.5),h=e*Math.min(i,j)/2;a.beginPath(),a.arc(f,g,h,0,2*Math.PI,!1),a.fillStyle=d,a.fill()},J=function(a,b,c,d){I(a,b,c,d,.9);var e=i*(b+.3),f=j*(c+.45),g=.28*Math.min(i,j)/2;a.beginPath(),a.arc(e,f,g,0,2*Math.PI,!1);var h=i*(b+.7),k=j*(c+.45);a.arc(h,k,g,0,2*Math.PI,!1),a.fillStyle="#ffffff",a.fill(),a.beginPath(),a.arc(e,f,g/2,0,2*Math.PI,!1),a.arc(h,k,g/2,0,2*Math.PI,!1),a.fillStyle="#000000",a.fill(),a.beginPath(),a.moveTo(i*(b+.25),j*(c+.65)),a.quadraticCurveTo(i*(b+.5),j*(c+.75),i*(b+.75),j*(c+.65)),a.quadraticCurveTo(i*(b+.5),j*(c+.75),i*(b+.75),j*(c+.65)),a.quadraticCurveTo(i*(b+.5),j*(c+1),i*(b+.25),j*(c+.65)),a.quadraticCurveTo(i*(b+.5),j*(c+1),i*(b+.25),j*(c+.65)),a.fillStyle="#ffffff",a.fill()},K=function(a,b,c,d){a.drawImage(d.image,i*d.x,j*d.y,i,j,i*b,j*c,i,j)},L=function(a,b,c){void 0===c&&(c=A.getContext("2d")),H(c,a,b,d.walls[a][b]),void 0!==d.visited[a][b]&&I(c,a,b,d.visited[a][b],.5),z&&1==d.forks[a][b]&&I(c,a,b,"#faa",.5),a==d.startPoint.x&&b==d.startPoint.y&&I(c,d.startPoint.x,d.startPoint.y,r,.9),a==d.goalPoint.x&&b==d.goalPoint.y&&G(c,d.goalPoint.x,d.goalPoint.y,h);for(control in x){var e=x[control];a==e.x&&b==e.y&&K(c,a,b,e.sprite)}},M=function(a){void 0===a&&(a=A.getContext("2d"));for(var b=0;b<d.width;b++)for(var c=0;c<d.height;c++)H(a,b,c,d.walls[b][c]),void 0!==d.visited[b][c]&&I(a,b,c,d.visited[b][c],.5),z&&1==d.forks[b][c]&&I(a,b,c,"#faa",.5);I(a,d.startPoint.x,d.startPoint.y,r,.9),G(a,d.goalPoint.x,d.goalPoint.y,h);for(control in x){var e=x[control];K(a,b,c,e.sprite)}},N=function(a){void 0===a&&(a=A.getContext("2d"));var b=i*(k.x+.5),c=j*(k.y+.5),d=m;a.beginPath(),a.arc(b,c,d,0,2*Math.PI,!1),a.fillStyle=k.color,a.fill()},O=function(a){void 0===a&&(a=A.getContext("2d")),a.fillStyle=h;var b,c,e=i*n,f=j*n;b=1==d.goalPoint.x?i:(d.goalPoint.x+1)*i-e,c=1==d.goalPoint.y?j:(d.goalPoint.y+1)*j-f,a.fillRect(b,c,e,f),I(a,d.startPoint.x,d.startPoint.y,r,.9*n)},P=function(){l="starting",tween=new b.Tween({t:0}),tween.to({t:1},900),tween.easing(b.Easing.Quadratic.InOut),tween.onUpdate(function(){n=this.t}),tween.onComplete(function(){n=void 0,l="playing",M()}),tween.start()},Q=function(){d.generate(window.innerWidth/window.innerHeight,y),C(),E(),x={},k=void 0,P()};Q();var R=function(a){k=a,l="transition";var c=new Audio("sounds/win"+o);c.play();for(control in x)x[control].stop();var d=Math.sqrt(Math.pow(window.innerWidth,2)+Math.pow(window.innerHeight,2));tween=new b.Tween({radius:0}),tween.to({radius:d},1200),tween.easing(b.Easing.Circular.Out),tween.onUpdate(function(){m=this.radius}),tween.onComplete(function(){S()}),tween.start()},S=function(){y*=1.2,Q()},T=function(a){if(this.control=a,this.x=d.startPoint.x,this.y=d.startPoint.y,!(a in v)){var b=Math.floor(360*Math.random());v[a]={normal:"hsl("+b+", 90%, 50%)",blocked:"hsl("+b+", 90%, 80%)",visited:"hsl("+b+", 30%, 80%)"},w[a]=F(a)}this.color=v[a].normal,this.sprite=w[a].normal,this.visitedColor=v[a].visited,this.path=void 0,this.animation=void 0,this.blockTween=void 0,s.push({x:this.x,y:this.y})};T.prototype.isMoving=function(){return void 0!==this.animation},T.prototype.canGo=function(a){var b=d.directions[this.x][this.y],c=e[a];return 1==b[c]},T.prototype.findPath=function(a){var b=function(a,c,f,g){if(!g&&(d.isDeadEnd(a,c)||d.isFork(a,c)))return[];var h=function(a,b,c){var f,g=a,h=b;"north"==c&&(h-=1),"east"==c&&(g+=1),"south"==c&&(h+=1),"west"==c&&(g-=1);var i=d.directions[g][h],j=i.slice(0);return j[e[e.getOpposite(c)]]=0,f=e.orders[j.indexOf(1)],{x:g,y:h,direction:f}},i=h(a,c,f),j=b(i.x,i.y,i.direction,!1);return j.unshift(f),j};return b(this.x,this.y,a,!0)},T.prototype.stop=function(){clearInterval(this.animation),this.animation=void 0},T.prototype.showBlocked=function(){function a(){c.color=v[c.control].normal,c.sprite=w[c.control].normal,s.push({x:c.x,y:c.y})}var c=this;void 0!==this.blockTween&&(this.blockTween.stop(),a()),this.blockTween=new b.Tween({}).to({},300),this.color=v[this.control].blocked,this.sprite=w[this.control].blocked,s.push({x:this.x,y:this.y}),this.blockTween.onComplete(function(){a()}),this.blockTween.start();var d=new Audio("sounds/tick"+o);d.play()},T.prototype.move=function(a){if(!this.isMoving()){if(!this.canGo(a))return void this.showBlocked();var b=this,c=function(){var a=b.path.shift();void 0==a&&b.stop(),d.visited[b.x][b.y]=b.visitedColor,s.push({x:b.x,y:b.y}),"north"==a&&(b.y-=1),"east"==a&&(b.x+=1),"south"==a&&(b.y+=1),"west"==a&&(b.x-=1),s.push({x:b.x,y:b.y}),b.x==d.goalPoint.x&&b.y==d.goalPoint.y&&R(b)};this.path=this.findPath(a),this.animation=setInterval(c,40)}};var U=function(a){if("transition"!=l){var b="mouse";b in x||(x[b]=new T(b));var c=x[b],d=i*(c.x+.5),e=j*(c.y+.5),f=a.clientX,g=a.clientY,h=document.getElementById("maze");f-=h.offsetLeft,g-=h.offsetTop;var k=180*Math.atan2(g-e,f-d)/Math.PI;45<k&&k<135?c.move("south"):-45>k&&k>-135?c.move("north"):-45<k&&k<45?c.move("east"):c.move("west")}};A.addEventListener?A.addEventListener("mousedown",U):A.attachEvent("onclick",U);var V=function(a){if("transition"!=l){var b,c;for(control in t)t[control].indexOf(a.keyCode)!=-1&&(b=control,c=e.orders[t[control].indexOf(a.keyCode)]);if(void 0!==b){b in x||(x[b]=new T(b));var d=x[b];d.move(c)}}};document.addEventListener("keydown",V);var W=function(a){var b=Math.floor(120*(1+Math.cos(a/3e3))),c=Math.floor(50+10*(1+Math.cos(a/300)));h="hsl("+b+", 90%, "+c+"%)",s.push({x:d.goalPoint.x,y:d.goalPoint.y})},X=function(a){switch(b.update(a),l){case"transition":N();break;case"starting":W(a),O();break;case"playing":W(a),s.forEach(function(a){L(a.x,a.y)}),s=[]}requestAnimationFrame(X),/Android/i.test(navigator.userAgent)&&"http"!=document.location.protocol.substr(0,4)&&(A.style.display="none",A.offsetHeight,A.style.display="block")};X()})});