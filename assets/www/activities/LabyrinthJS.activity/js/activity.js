/*! Sugarizer 2019-01-12 */
define(["sugar-web/activity/activity","webL10n","sugar-web/datastore","sugar-web/graphics/colorpalette","zoompalette","fontpalette","tutorial","sugar-web/env"],function(a,b,c,d,e,f,g,h){requirejs(["domReady!"],function(i){a.setup();var j=0,k=document.getElementById("nodetext-button"),l=document.getElementById("link-button"),m=document.getElementById("delete-button"),n=function(a){j=a,k.classList.remove("active"),l.classList.remove("active"),m.classList.remove("active"),0==a?k.classList.add("active"):1==a?l.classList.add("active"):2==a&&m.classList.add("active"),C(),null!=H&&(O(),H=null)};k.addEventListener("click",function(){n(0)},!0),l.addEventListener("click",function(){n(1),H=null},!0),m.addEventListener("click",function(){n(2)},!0);var o=document.getElementById("zoom-button");zoomPalette=new e.zoomPalette(o),zoomPalette.addEventListener("pop",function(a){C()}),zoomPalette.addEventListener("zoom",function(a){var b=a.detail.zoom,c=cy.zoom(),d=.25;0==b?c!=cy.minZoom()&&c-d>cy.minZoom()&&cy.zoom(c-d):1==b?c!=cy.maxZoom()&&cy.zoom(c+d):2==b?cy.fit():3==b&&cy.center()});var p=document.getElementById("png-button");p.addEventListener("click",function(a){var b=cy.png(),d=b.split(";")[0].split(":")[1],e=d.split("/")[0],f={mimetype:d,title:e.charAt(0).toUpperCase()+e.slice(1)+" LabyrinthJS",activity:"org.olpcfrance.MediaViewerActivity",timestamp:(new Date).getTime(),creation_time:(new Date).getTime(),file_size:0};c.create(f,function(){console.log("export done.")},b)});var q=document.getElementById("sub-toolbar"),r=document.getElementById("textvalue"),s=document.getElementById("bold-button"),t=document.getElementById("italics-button"),u=document.getElementById("foreground-button");foregroundPalette=new d.ColorPalette(u),foregroundPalette.setColor("rgb(0, 0, 0)");var v=!1,w=document.getElementById("background-button");backgroundPalette=new d.ColorPalette(w),backgroundPalette.setColor("rgb(255, 255, 255)");var x=!1,y=document.getElementById("fontminus-button"),z=document.getElementById("fontplus-button"),A=document.getElementById("font-button");fontPalette=new f.TextPalette(A),document.getElementById("help-button").addEventListener("click",function(a){if(g.setElement("activity",document.getElementById("activity-button")),g.setElement("stop",document.getElementById("stop-button")),g.setElement("undo",document.getElementById("undo-button")),g.setElement("redo",document.getElementById("redo-button")),g.setElement("node",k),g.setElement("link",l),g.setElement("remove",m),g.setElement("png",p),g.setElement("zoom",o),g.setElement("textvalue",r),g.setElement("bold",s),g.setElement("italic",t),g.setElement("foreground",u),g.setElement("background",w),g.setElement("font",A),g.setElement("fontminus",y),g.setElement("fontplus",z),g.setElement("board",document.getElementById("canvas")),cy){var b=H;if(!b){var c=cy.elements("node");c.length>0&&(b=c[0],H=b,M(b))}b&&B(b)}g.start()}),foregroundPalette.addEventListener("colorChange",function(a){v||(H.style("color",a.detail.color),H.data("color",a.detail.color),da()),v=!1}),backgroundPalette.addEventListener("colorChange",function(a){x||(H.style("background-color",a.detail.color),H.data("background-color",a.detail.color),da()),x=!1}),fontPalette.addEventListener("fontChange",function(a){var b=a.detail.family;H.data("font-family",b),H.removeClass("arial-text comic-text verdana-text"),K(H),"Arial"==b?H.addClass("arial-text"):"Comic Sans MS"==b?H.addClass("comic-text"):"Verdana"==b&&H.addClass("verdana-text"),da()}),r.addEventListener("input",function(){K(H,r.value),da()}),s.addEventListener("click",function(){H.toggleClass("bold-text"),H.hasClass("bold-text")?s.classList.add("active"):s.classList.remove("active"),K(H),da()}),t.addEventListener("click",function(){H.toggleClass("italic-text"),H.hasClass("italic-text")?t.classList.add("active"):t.classList.remove("active"),K(H),da()}),y.addEventListener("click",function(){H.data("font-size",Math.max(6,H.data("font-size")-2)),K(H),da()}),z.addEventListener("click",function(){H.data("font-size",Math.min(100,H.data("font-size")+2)),K(H),da()});var B=function(a){zoomPalette.popDown(),q.style.visibility="visible",r.value=a.style().content,a.hasClass("bold-text")?s.classList.add("active"):s.classList.remove("active"),a.hasClass("italic-text")?t.classList.add("active"):t.classList.remove("active"),v=!0,foregroundPalette.setColor(a.style().color),x=!0,backgroundPalette.setColor(a.style()["background-color"]),fontPalette.setFont(a.data("font-family"))},C=function(){q.style.visibility="hidden",backgroundPalette.popDown(),foregroundPalette.popDown(),fontPalette.popDown()};document.getElementById("stop-button").addEventListener("click",function(a){console.log("writing..."),V(function(a){null===a?console.log("write done."):console.log("write failed.")})}),window.addEventListener("localized",function(){h.getEnvironment(function(a,c){var d="undefined"!=typeof chrome&&chrome.app&&chrome.app.runtime?chrome.i18n.getUILanguage():navigator.language,e=c.user?c.user.language:d;l10n_s.language.code!=e&&(l10n_s.language.code=e);var f=I;if(I=l10n_s.get("YourNewIdea"),k.title=b.get("nodetextTitle"),l.title=b.get("linkButtonTitle"),m.title=b.get("removeButtonTitle"),aa.title=b.get("undoButtonTitle"),ba.title=b.get("redoButtonTitle"),o.title=b.get("zoomButtonTitle"),u.title=b.get("foregroundButtonTitle"),w.title=b.get("backgroundButtonTitle"),r.placeholder=b.get("typeText"),s.title=b.get("boldButtonTitle"),t.title=b.get("italicButtonTitle"),y.title=b.get("fontMinusButtonTitle"),z.title=b.get("fontPlusButtonTitle"),A.title=b.get("fontButtonTitle"),p.title=b.get("pngButtonTitle"),cy)for(var g=cy.elements("node"),h=0;h<g.length;h++){var i=g[h];i.data("content")==f&&(i.data("content",I),i.style({content:I}))}})},!1),cy=cytoscape({container:document.getElementById("cy"),ready:function(){var a=J(I,T());a.select(),M(a),H=a,B(a),da(),U()},style:[{selector:".standard-node",css:{"text-valign":"center","text-halign":"center","border-color":"darkgray","border-width":"1px",shape:"roundrectangle"}},{selector:".bold-text",css:{"font-weight":"bold"}},{selector:".italic-text",css:{"font-style":"italic"}},{selector:".arial-text",css:{"font-family":"Arial"}},{selector:".comic-text",css:{"font-family":"Comic Sans MS"}},{selector:".verdana-text",css:{"font-family":"Verdana"}}]}),cy.on("tap","node",function(){return 2==j?(P(this),da(),void(H==this&&(H=null))):1==j?(null!=H&&H!=this&&(Q(H,this),da()),void(H=this)):(L(this)?(N(this),C()):(M(this),B(this),r.value==I?r.setSelectionRange(0,r.value.length):r.setSelectionRange(r.value.length,r.value.length)),void(H=this))}),cy.on("unselect","node",function(){N(this)}),cy.on("select","edge",function(){if(2==j)return R(this),void da();C()}),cy.on("tap",function(a){if(a.cyTarget===cy&&0==j){var b=J(I,a.cyPosition);null!=H&&(Q(H,b),N(H)),da(),b.select(),M(b),H=b,B(b)}}),cy.on("free","node",function(a){da()});var D=0,E=0,F="Arial",G=16,H=null,I="<Your new idea>",J=function(a,b){var c=S(a,F,G,!1,!1);cy.add({group:"nodes",nodes:[{data:{id:"n"+ ++D,"font-family":F,"font-size":G,"font-weight":"normal",content:a,color:"rgb(0, 0, 0)","background-color":"rgb(255, 255, 255)"},position:{x:b.x,y:b.y}}]});var d=cy.getElementById("n"+D);return d.style({content:a,width:c.width,height:c.height,color:"rgb(0, 0, 0)","font-family":"Arial","font-size":G+"px","background-color":"rgb(255, 255, 255)"}),d.addClass("standard-node"),d},K=function(a,b){void 0===b?b=a.style().content:a.data("content",b);var c=a.data("font-size"),d=a.data("font-family"),e=S(b,d,c,a.hasClass("bold-text"),a.hasClass("italic-text"));a.style({content:b,"font-size":c+"px","font-family":d,width:e.width,height:e.height})},L=function(a){return"dashed"==a.style()["border-style"]},M=function(a){a.style({"border-color":"black","border-style":"dashed","border-width":"4px"})},N=function(a){a.style({"border-color":"darkgray","border-style":"solid","border-width":"1px"})},O=function(){for(var a=cy.collection("node"),b=0;b<a.length;b++)N(a[b])},P=function(a){cy.remove(a)},Q=function(a,b){cy.add({group:"nodes",edges:[{data:{id:"e"+ ++E,source:a.id(),target:b.id()}}]})},R=function(a){cy.remove(a)},S=function(a,b,c,d,e){var f=document.getElementById("fontsizecomputer");return f.innerHTML=a.replace("<","&lt;").replace(">","&gt;"),f.style.fontFamily=b,f.style.fontSize=c+"px",f.style.fontWeight=d?"bold":"normal",f.style.fontStyle=e?"italic":"normal",{width:f.clientWidth+c+"px",height:f.clientHeight+c+"px"}},T=function(){var a=document.getElementById("canvas");return{x:a.clientWidth/2,y:a.clientHeight/2}},U=function(){a.getDatastoreObject().loadAsText(function(a,b,c){null!=c&&(Y(JSON.parse(c)),ca(),da())})},V=function(b){var c=a.getDatastoreObject(),d=X();c.setDataAsText(JSON.stringify(d)),c.save(b)},W=function(a){var b,c=a;if(a&&"object"==typeof a){c="[object Array]"===Object.prototype.toString.call(a)?[]:{};for(b in a)c[b]=W(a[b])}return c},X=function(){return W(cy.json())},Y=function(a){cy.remove("node"),cy.remove("edge"),C(),H=null,cy.add({group:"nodes",nodes:a.elements.nodes});for(var b=cy.collection("node"),c=0,d=0;d<b.length;d++){var e=b[d];K(e,e.data("content")),e.style("color",e.data("color")),e.style("background-color",e.data("background-color"));var f=e.data("id").substr(1);f>c&&(c=f)}if(D=c+1,c=0,a.elements.edges){cy.add({group:"edges",edges:a.elements.edges});for(var g=cy.collection("edge"),d=0;d<g.length;d++){var f=g[d].data("id").substr(1);f>c&&(c=f)}}E=c+1},Z=[],$=0,_=30,aa=document.getElementById("undo-button");aa.addEventListener("click",function(){ea()},!0);var ba=document.getElementById("redo-button");ba.addEventListener("click",function(){fa()},!0);var ca=function(){Z=[],$=0},da=function(){if($<Z.length-1){for(var a=[],b=0;b<$+1;b++)a.push(Z[b]);Z=a}var c=Z.length-1,d=X();if(c<_)Z.push(d);else{for(var b=0;b<c-1;b++)Z[b]=Z[b+1];Z[c-1]=d}$=Z.length-1,ga()},ea=function(){Z.length<1||Z.length>=1&&0==$||(Y(Z[--$]),ga())},fa=function(){$+1>=Z.length||(Y(Z[++$]),ga())},ga=function(){var a=Z.length;aa.disabled=Z.length<1||Z.length>=1&&0==$,ba.disabled=$+1>=a}})});