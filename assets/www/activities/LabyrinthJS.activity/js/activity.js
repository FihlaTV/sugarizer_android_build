/*! Sugarizer 2017-08-25 */
define(["sugar-web/activity/activity","webL10n","sugar-web/datastore","sugar-web/graphics/colorpalette","zoompalette","fontpalette","tutorial","sugar-web/env"],function(a,b,c,d,e,f,g,h){require(["domReady!"],function(i){function j(a){var b={name:"",language:"undefined"!=typeof chrome&&chrome.app&&chrome.app.runtime?chrome.i18n.getUILanguage():navigator.language};return h.isSugarizer()?(loadedSettings=c.localStorage.getValue("sugar_settings"),void a(loadedSettings)):void a(b)}a.setup();var k=0,l=document.getElementById("nodetext-button"),m=document.getElementById("link-button"),n=document.getElementById("delete-button"),o=function(a){k=a,l.classList.remove("active"),m.classList.remove("active"),n.classList.remove("active"),0==a?l.classList.add("active"):1==a?m.classList.add("active"):2==a&&n.classList.add("active"),E(),null!=K&&(R(),K=null)};l.addEventListener("click",function(){o(0)},!0),m.addEventListener("click",function(){o(1),K=null},!0),n.addEventListener("click",function(){o(2)},!0);var p=document.getElementById("zoom-button");zoomPalette=new e.zoomPalette(p),zoomPalette.addEventListener("pop",function(a){E()}),zoomPalette.addEventListener("zoom",function(a){var b=a.detail.zoom,c=cy.zoom(),d=.25;0==b?c!=cy.minZoom()&&c-d>cy.minZoom()&&cy.zoom(c-d):1==b?c!=cy.maxZoom()&&cy.zoom(c+d):2==b?cy.fit():3==b&&cy.center()});var q=document.getElementById("png-button");q.addEventListener("click",function(a){var b=cy.png(),d=b.split(";")[0].split(":")[1],e=d.split("/")[0],f={mimetype:d,title:e.charAt(0).toUpperCase()+e.slice(1)+" LabyrinthJS",activity:"org.olpcfrance.MediaViewerActivity",timestamp:(new Date).getTime(),creation_time:(new Date).getTime(),file_size:0};c.create(f,function(){console.log("export done.")},b)});var r=document.getElementById("sub-toolbar"),s=document.getElementById("textvalue"),t=document.getElementById("bold-button"),u=document.getElementById("italics-button"),v=document.getElementById("foreground-button");foregroundPalette=new d.ColorPalette(v),foregroundPalette.setColor("rgb(0, 0, 0)");var w=!1,x=document.getElementById("background-button");backgroundPalette=new d.ColorPalette(x),backgroundPalette.setColor("rgb(255, 255, 255)");var y=!1,z=document.getElementById("fontminus-button"),A=document.getElementById("fontplus-button"),B=document.getElementById("font-button");fontPalette=new f.TextPalette(B);var C=document.getElementById("help-button");C.addEventListener("click",function(a){if(g.setElement("activity",document.getElementById("activity-button")),g.setElement("stop",document.getElementById("stop-button")),g.setElement("undo",document.getElementById("undo-button")),g.setElement("redo",document.getElementById("redo-button")),g.setElement("node",l),g.setElement("link",m),g.setElement("remove",n),g.setElement("png",q),g.setElement("zoom",p),g.setElement("textvalue",s),g.setElement("bold",t),g.setElement("italic",u),g.setElement("foreground",v),g.setElement("background",x),g.setElement("font",B),g.setElement("fontminus",z),g.setElement("fontplus",A),g.setElement("board",document.getElementById("canvas")),cy){var b=K;if(!b){var c=cy.elements("node");c.length>0&&(b=c[0],K=b,P(b))}b&&D(b)}g.start()}),foregroundPalette.addEventListener("colorChange",function(a){w||(K.style("color",a.detail.color),K.data("color",a.detail.color),ga()),w=!1}),backgroundPalette.addEventListener("colorChange",function(a){y||(K.style("background-color",a.detail.color),K.data("background-color",a.detail.color),ga()),y=!1}),fontPalette.addEventListener("fontChange",function(a){var b=a.detail.family;K.data("font-family",b),K.removeClass("arial-text comic-text verdana-text"),N(K),"Arial"==b?K.addClass("arial-text"):"Comic Sans MS"==b?K.addClass("comic-text"):"Verdana"==b&&K.addClass("verdana-text"),ga()}),s.addEventListener("input",function(){N(K,s.value),ga()}),t.addEventListener("click",function(){K.toggleClass("bold-text"),K.hasClass("bold-text")?t.classList.add("active"):t.classList.remove("active"),N(K),ga()}),u.addEventListener("click",function(){K.toggleClass("italic-text"),K.hasClass("italic-text")?u.classList.add("active"):u.classList.remove("active"),N(K),ga()}),z.addEventListener("click",function(){K.data("font-size",Math.max(6,K.data("font-size")-2)),N(K),ga()}),A.addEventListener("click",function(){K.data("font-size",Math.min(100,K.data("font-size")+2)),N(K),ga()});var D=function(a){zoomPalette.popDown(),r.style.visibility="visible",s.value=a.style().content,a.hasClass("bold-text")?t.classList.add("active"):t.classList.remove("active"),a.hasClass("italic-text")?u.classList.add("active"):u.classList.remove("active"),w=!0,foregroundPalette.setColor(a.style().color),y=!0,backgroundPalette.setColor(a.style()["background-color"]),fontPalette.setFont(a.data("font-family"))},E=function(){r.style.visibility="hidden",backgroundPalette.popDown(),foregroundPalette.popDown(),fontPalette.popDown()},F=document.getElementById("stop-button");F.addEventListener("click",function(a){console.log("writing..."),Y(function(a){null===a?console.log("write done."):console.log("write failed.")})}),window.addEventListener("localized",function(){c.localStorage.load(function(){j(function(a){l10n_s.language.code!=a.language&&(l10n_s.language.code=a.language);var c=L;if(L=l10n_s.get("YourNewIdea"),l.title=b.get("nodetextTitle"),m.title=b.get("linkButtonTitle"),n.title=b.get("removeButtonTitle"),da.title=b.get("undoButtonTitle"),ea.title=b.get("redoButtonTitle"),p.title=b.get("zoomButtonTitle"),v.title=b.get("foregroundButtonTitle"),x.title=b.get("backgroundButtonTitle"),s.placeholder=b.get("typeText"),t.title=b.get("boldButtonTitle"),u.title=b.get("italicButtonTitle"),z.title=b.get("fontMinusButtonTitle"),A.title=b.get("fontPlusButtonTitle"),B.title=b.get("fontButtonTitle"),q.title=b.get("pngButtonTitle"),cy)for(var d=cy.elements("node"),e=0;e<d.length;e++){var f=d[e];f.data("content")==c&&(f.data("content",L),f.style({content:L}))}})})},!1),cy=cytoscape({container:document.getElementById("cy"),ready:function(){var a=M(L,W());a.select(),P(a),K=a,D(a),ga(),X()},style:[{selector:".standard-node",css:{"text-valign":"center","text-halign":"center","border-color":"darkgray","border-width":"1px",shape:"roundrectangle"}},{selector:".bold-text",css:{"font-weight":"bold"}},{selector:".italic-text",css:{"font-style":"italic"}},{selector:".arial-text",css:{"font-family":"Arial"}},{selector:".comic-text",css:{"font-family":"Comic Sans MS"}},{selector:".verdana-text",css:{"font-family":"Verdana"}}]}),cy.on("tap","node",function(){return 2==k?(S(this),ga(),void(K==this&&(K=null))):1==k?(null!=K&&K!=this&&(T(K,this),ga()),void(K=this)):(O(this)?(Q(this),E()):(P(this),D(this),s.value==L?s.setSelectionRange(0,s.value.length):s.setSelectionRange(s.value.length,s.value.length)),void(K=this))}),cy.on("unselect","node",function(){Q(this)}),cy.on("select","edge",function(){return 2==k?(U(this),void ga()):void E()}),cy.on("tap",function(a){if(a.cyTarget===cy&&0==k){var b=M(L,a.cyPosition);null!=K&&(T(K,b),Q(K)),ga(),b.select(),P(b),K=b,D(b)}}),cy.on("free","node",function(a){ga()});var G=0,H=0,I="Arial",J=16,K=null,L="<Your new idea>",M=function(a,b){var c=V(a,I,J,!1,!1);cy.add({group:"nodes",nodes:[{data:{id:"n"+ ++G,"font-family":I,"font-size":J,"font-weight":"normal",content:a,color:"rgb(0, 0, 0)","background-color":"rgb(255, 255, 255)"},position:{x:b.x,y:b.y}}]});var d=cy.getElementById("n"+G);return d.style({content:a,width:c.width,height:c.height,color:"rgb(0, 0, 0)","font-family":"Arial","font-size":J+"px","background-color":"rgb(255, 255, 255)"}),d.addClass("standard-node"),d},N=function(a,b){void 0===b?b=a.style().content:a.data("content",b);var c=a.data("font-size"),d=a.data("font-family"),e=V(b,d,c,a.hasClass("bold-text"),a.hasClass("italic-text"));a.style({content:b,"font-size":c+"px","font-family":d,width:e.width,height:e.height})},O=function(a){return"dashed"==a.style()["border-style"]},P=function(a){a.style({"border-color":"black","border-style":"dashed","border-width":"4px"})},Q=function(a){a.style({"border-color":"darkgray","border-style":"solid","border-width":"1px"})},R=function(){for(var a=cy.collection("node"),b=0;b<a.length;b++)Q(a[b])},S=function(a){cy.remove(a)},T=function(a,b){cy.add({group:"nodes",edges:[{data:{id:"e"+ ++H,source:a.id(),target:b.id()}}]})},U=function(a){cy.remove(a)},V=function(a,b,c,d,e){var f=document.getElementById("fontsizecomputer");return f.innerHTML=a.replace("<","&lt;").replace(">","&gt;"),f.style.fontFamily=b,f.style.fontSize=c+"px",d?f.style.fontWeight="bold":f.style.fontWeight="normal",e?f.style.fontStyle="italic":f.style.fontStyle="normal",{width:f.clientWidth+c+"px",height:f.clientHeight+c+"px"}},W=function(){var a=document.getElementById("canvas"),b={x:a.clientWidth/2,y:a.clientHeight/2};return b},X=function(){var b=a.getDatastoreObject();b.loadAsText(function(a,b,c){null!=c&&(_(JSON.parse(c)),fa(),ga())})},Y=function(b){var c=a.getDatastoreObject(),d=$();c.setDataAsText(JSON.stringify(d)),c.save(b)},Z=function(a){var b,c=a;if(a&&"object"==typeof a){c="[object Array]"===Object.prototype.toString.call(a)?[]:{};for(b in a)c[b]=Z(a[b])}return c},$=function(){return Z(cy.json())},_=function(a){cy.remove("node"),cy.remove("edge"),E(),K=null,cy.add({group:"nodes",nodes:a.elements.nodes});for(var b=cy.collection("node"),c=0,d=0;d<b.length;d++){var e=b[d];N(e,e.data("content")),e.style("color",e.data("color")),e.style("background-color",e.data("background-color"));var f=e.data("id").substr(1);f>c&&(c=f)}if(G=c+1,c=0,a.elements.edges){cy.add({group:"edges",edges:a.elements.edges});for(var g=cy.collection("edge"),d=0;d<g.length;d++){var f=g[d].data("id").substr(1);f>c&&(c=f)}}H=c+1},aa=[],ba=0,ca=30,da=document.getElementById("undo-button");da.addEventListener("click",function(){ha()},!0);var ea=document.getElementById("redo-button");ea.addEventListener("click",function(){ia()},!0);var fa=function(){aa=[],ba=0},ga=function(){if(ba<aa.length-1){for(var a=[],b=0;b<ba+1;b++)a.push(aa[b]);aa=a}var c=aa.length-1,d=$();if(c<ca)aa.push(d);else{for(var b=0;b<c-1;b++)aa[b]=aa[b+1];aa[c-1]=d}ba=aa.length-1,ja()},ha=function(){aa.length<1||aa.length>=1&&0==ba||(_(aa[--ba]),ja())},ia=function(){ba+1>=aa.length||(_(aa[++ba]),ja())},ja=function(){var a=aa.length;da.disabled=aa.length<1||aa.length>=1&&0==ba,ea.disabled=ba+1>=a}})});