/*! Sugarizer 2018-07-01 */
define(["sugar-web/activity/activity","webL10n","sugar-web/datastore","sugar-web/graphics/colorpalette","zoompalette","fontpalette","tutorial","sugar-web/env"],function(a,b,c,d,e,f,g,h){require(["domReady!"],function(i){a.setup();var j=0,k=document.getElementById("nodetext-button"),l=document.getElementById("link-button"),m=document.getElementById("delete-button"),n=function(a){j=a,k.classList.remove("active"),l.classList.remove("active"),m.classList.remove("active"),0==a?k.classList.add("active"):1==a?l.classList.add("active"):2==a&&m.classList.add("active"),D(),null!=J&&(Q(),J=null)};k.addEventListener("click",function(){n(0)},!0),l.addEventListener("click",function(){n(1),J=null},!0),m.addEventListener("click",function(){n(2)},!0);var o=document.getElementById("zoom-button");zoomPalette=new e.zoomPalette(o),zoomPalette.addEventListener("pop",function(a){D()}),zoomPalette.addEventListener("zoom",function(a){var b=a.detail.zoom,c=cy.zoom(),d=.25;0==b?c!=cy.minZoom()&&c-d>cy.minZoom()&&cy.zoom(c-d):1==b?c!=cy.maxZoom()&&cy.zoom(c+d):2==b?cy.fit():3==b&&cy.center()});var p=document.getElementById("png-button");p.addEventListener("click",function(a){var b=cy.png(),d=b.split(";")[0].split(":")[1],e=d.split("/")[0],f={mimetype:d,title:e.charAt(0).toUpperCase()+e.slice(1)+" LabyrinthJS",activity:"org.olpcfrance.MediaViewerActivity",timestamp:(new Date).getTime(),creation_time:(new Date).getTime(),file_size:0};c.create(f,function(){console.log("export done.")},b)});var q=document.getElementById("sub-toolbar"),r=document.getElementById("textvalue"),s=document.getElementById("bold-button"),t=document.getElementById("italics-button"),u=document.getElementById("foreground-button");foregroundPalette=new d.ColorPalette(u),foregroundPalette.setColor("rgb(0, 0, 0)");var v=!1,w=document.getElementById("background-button");backgroundPalette=new d.ColorPalette(w),backgroundPalette.setColor("rgb(255, 255, 255)");var x=!1,y=document.getElementById("fontminus-button"),z=document.getElementById("fontplus-button"),A=document.getElementById("font-button");fontPalette=new f.TextPalette(A);var B=document.getElementById("help-button");B.addEventListener("click",function(a){if(g.setElement("activity",document.getElementById("activity-button")),g.setElement("stop",document.getElementById("stop-button")),g.setElement("undo",document.getElementById("undo-button")),g.setElement("redo",document.getElementById("redo-button")),g.setElement("node",k),g.setElement("link",l),g.setElement("remove",m),g.setElement("png",p),g.setElement("zoom",o),g.setElement("textvalue",r),g.setElement("bold",s),g.setElement("italic",t),g.setElement("foreground",u),g.setElement("background",w),g.setElement("font",A),g.setElement("fontminus",y),g.setElement("fontplus",z),g.setElement("board",document.getElementById("canvas")),cy){var b=J;if(!b){var c=cy.elements("node");c.length>0&&(b=c[0],J=b,O(b))}b&&C(b)}g.start()}),foregroundPalette.addEventListener("colorChange",function(a){v||(J.style("color",a.detail.color),J.data("color",a.detail.color),fa()),v=!1}),backgroundPalette.addEventListener("colorChange",function(a){x||(J.style("background-color",a.detail.color),J.data("background-color",a.detail.color),fa()),x=!1}),fontPalette.addEventListener("fontChange",function(a){var b=a.detail.family;J.data("font-family",b),J.removeClass("arial-text comic-text verdana-text"),M(J),"Arial"==b?J.addClass("arial-text"):"Comic Sans MS"==b?J.addClass("comic-text"):"Verdana"==b&&J.addClass("verdana-text"),fa()}),r.addEventListener("input",function(){M(J,r.value),fa()}),s.addEventListener("click",function(){J.toggleClass("bold-text"),J.hasClass("bold-text")?s.classList.add("active"):s.classList.remove("active"),M(J),fa()}),t.addEventListener("click",function(){J.toggleClass("italic-text"),J.hasClass("italic-text")?t.classList.add("active"):t.classList.remove("active"),M(J),fa()}),y.addEventListener("click",function(){J.data("font-size",Math.max(6,J.data("font-size")-2)),M(J),fa()}),z.addEventListener("click",function(){J.data("font-size",Math.min(100,J.data("font-size")+2)),M(J),fa()});var C=function(a){zoomPalette.popDown(),q.style.visibility="visible",r.value=a.style().content,a.hasClass("bold-text")?s.classList.add("active"):s.classList.remove("active"),a.hasClass("italic-text")?t.classList.add("active"):t.classList.remove("active"),v=!0,foregroundPalette.setColor(a.style().color),x=!0,backgroundPalette.setColor(a.style()["background-color"]),fontPalette.setFont(a.data("font-family"))},D=function(){q.style.visibility="hidden",backgroundPalette.popDown(),foregroundPalette.popDown(),fontPalette.popDown()},E=document.getElementById("stop-button");E.addEventListener("click",function(a){console.log("writing..."),X(function(a){null===a?console.log("write done."):console.log("write failed.")})}),window.addEventListener("localized",function(){h.getEnvironment(function(a,c){var d="undefined"!=typeof chrome&&chrome.app&&chrome.app.runtime?chrome.i18n.getUILanguage():navigator.language,e=c.user?c.user.language:d;l10n_s.language.code!=e&&(l10n_s.language.code=e);var f=K;if(K=l10n_s.get("YourNewIdea"),k.title=b.get("nodetextTitle"),l.title=b.get("linkButtonTitle"),m.title=b.get("removeButtonTitle"),ca.title=b.get("undoButtonTitle"),da.title=b.get("redoButtonTitle"),o.title=b.get("zoomButtonTitle"),u.title=b.get("foregroundButtonTitle"),w.title=b.get("backgroundButtonTitle"),r.placeholder=b.get("typeText"),s.title=b.get("boldButtonTitle"),t.title=b.get("italicButtonTitle"),y.title=b.get("fontMinusButtonTitle"),z.title=b.get("fontPlusButtonTitle"),A.title=b.get("fontButtonTitle"),p.title=b.get("pngButtonTitle"),cy)for(var g=cy.elements("node"),h=0;h<g.length;h++){var i=g[h];i.data("content")==f&&(i.data("content",K),i.style({content:K}))}})},!1),cy=cytoscape({container:document.getElementById("cy"),ready:function(){var a=L(K,V());a.select(),O(a),J=a,C(a),fa(),W()},style:[{selector:".standard-node",css:{"text-valign":"center","text-halign":"center","border-color":"darkgray","border-width":"1px",shape:"roundrectangle"}},{selector:".bold-text",css:{"font-weight":"bold"}},{selector:".italic-text",css:{"font-style":"italic"}},{selector:".arial-text",css:{"font-family":"Arial"}},{selector:".comic-text",css:{"font-family":"Comic Sans MS"}},{selector:".verdana-text",css:{"font-family":"Verdana"}}]}),cy.on("tap","node",function(){return 2==j?(R(this),fa(),void(J==this&&(J=null))):1==j?(null!=J&&J!=this&&(S(J,this),fa()),void(J=this)):(N(this)?(P(this),D()):(O(this),C(this),r.value==K?r.setSelectionRange(0,r.value.length):r.setSelectionRange(r.value.length,r.value.length)),void(J=this))}),cy.on("unselect","node",function(){P(this)}),cy.on("select","edge",function(){return 2==j?(T(this),void fa()):void D()}),cy.on("tap",function(a){if(a.cyTarget===cy&&0==j){var b=L(K,a.cyPosition);null!=J&&(S(J,b),P(J)),fa(),b.select(),O(b),J=b,C(b)}}),cy.on("free","node",function(a){fa()});var F=0,G=0,H="Arial",I=16,J=null,K="<Your new idea>",L=function(a,b){var c=U(a,H,I,!1,!1);cy.add({group:"nodes",nodes:[{data:{id:"n"+ ++F,"font-family":H,"font-size":I,"font-weight":"normal",content:a,color:"rgb(0, 0, 0)","background-color":"rgb(255, 255, 255)"},position:{x:b.x,y:b.y}}]});var d=cy.getElementById("n"+F);return d.style({content:a,width:c.width,height:c.height,color:"rgb(0, 0, 0)","font-family":"Arial","font-size":I+"px","background-color":"rgb(255, 255, 255)"}),d.addClass("standard-node"),d},M=function(a,b){void 0===b?b=a.style().content:a.data("content",b);var c=a.data("font-size"),d=a.data("font-family"),e=U(b,d,c,a.hasClass("bold-text"),a.hasClass("italic-text"));a.style({content:b,"font-size":c+"px","font-family":d,width:e.width,height:e.height})},N=function(a){return"dashed"==a.style()["border-style"]},O=function(a){a.style({"border-color":"black","border-style":"dashed","border-width":"4px"})},P=function(a){a.style({"border-color":"darkgray","border-style":"solid","border-width":"1px"})},Q=function(){for(var a=cy.collection("node"),b=0;b<a.length;b++)P(a[b])},R=function(a){cy.remove(a)},S=function(a,b){cy.add({group:"nodes",edges:[{data:{id:"e"+ ++G,source:a.id(),target:b.id()}}]})},T=function(a){cy.remove(a)},U=function(a,b,c,d,e){var f=document.getElementById("fontsizecomputer");return f.innerHTML=a.replace("<","&lt;").replace(">","&gt;"),f.style.fontFamily=b,f.style.fontSize=c+"px",d?f.style.fontWeight="bold":f.style.fontWeight="normal",e?f.style.fontStyle="italic":f.style.fontStyle="normal",{width:f.clientWidth+c+"px",height:f.clientHeight+c+"px"}},V=function(){var a=document.getElementById("canvas"),b={x:a.clientWidth/2,y:a.clientHeight/2};return b},W=function(){var b=a.getDatastoreObject();b.loadAsText(function(a,b,c){null!=c&&($(JSON.parse(c)),ea(),fa())})},X=function(b){var c=a.getDatastoreObject(),d=Z();c.setDataAsText(JSON.stringify(d)),c.save(b)},Y=function(a){var b,c=a;if(a&&"object"==typeof a){c="[object Array]"===Object.prototype.toString.call(a)?[]:{};for(b in a)c[b]=Y(a[b])}return c},Z=function(){return Y(cy.json())},$=function(a){cy.remove("node"),cy.remove("edge"),D(),J=null,cy.add({group:"nodes",nodes:a.elements.nodes});for(var b=cy.collection("node"),c=0,d=0;d<b.length;d++){var e=b[d];M(e,e.data("content")),e.style("color",e.data("color")),e.style("background-color",e.data("background-color"));var f=e.data("id").substr(1);f>c&&(c=f)}if(F=c+1,c=0,a.elements.edges){cy.add({group:"edges",edges:a.elements.edges});for(var g=cy.collection("edge"),d=0;d<g.length;d++){var f=g[d].data("id").substr(1);f>c&&(c=f)}}G=c+1},_=[],aa=0,ba=30,ca=document.getElementById("undo-button");ca.addEventListener("click",function(){ga()},!0);var da=document.getElementById("redo-button");da.addEventListener("click",function(){ha()},!0);var ea=function(){_=[],aa=0},fa=function(){if(aa<_.length-1){for(var a=[],b=0;b<aa+1;b++)a.push(_[b]);_=a}var c=_.length-1,d=Z();if(c<ba)_.push(d);else{for(var b=0;b<c-1;b++)_[b]=_[b+1];_[c-1]=d}aa=_.length-1,ia()},ga=function(){_.length<1||_.length>=1&&0==aa||($(_[--aa]),ia())},ha=function(){aa+1>=_.length||($(_[++aa]),ia())},ia=function(){var a=_.length;ca.disabled=_.length<1||_.length>=1&&0==aa,da.disabled=aa+1>=a}})});