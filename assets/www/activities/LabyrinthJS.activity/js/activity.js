/*! Sugarizer 2016-12-28 */
define(["sugar-web/activity/activity","webL10n","sugar-web/datastore","sugar-web/graphics/colorpalette","zoompalette","fontpalette"],function(a,b,c,d,e,f){require(["domReady!"],function(g){a.setup();var h=0,i=document.getElementById("nodetext-button"),j=document.getElementById("link-button"),k=document.getElementById("delete-button"),l=function(a){h=a,i.classList.remove("active"),j.classList.remove("active"),k.classList.remove("active"),0==a?i.classList.add("active"):1==a?j.classList.add("active"):2==a&&k.classList.add("active"),A(),null!=G&&(N(),G=null)};i.addEventListener("click",function(){l(0)},!0),j.addEventListener("click",function(){l(1),G=null},!0),k.addEventListener("click",function(){l(2)},!0);var m=document.getElementById("zoom-button");zoomPalette=new e.zoomPalette(m),zoomPalette.addEventListener("pop",function(a){A()}),zoomPalette.addEventListener("zoom",function(a){var b=a.detail.zoom,c=cy.zoom(),d=.25;0==b?c!=cy.minZoom()&&c-d>cy.minZoom()&&cy.zoom(c-d):1==b?c!=cy.maxZoom()&&cy.zoom(c+d):2==b?cy.fit():3==b&&cy.center()});var n=document.getElementById("png-button");n.addEventListener("click",function(a){var b=cy.png(),d=b.split(";")[0].split(":")[1],e=d.split("/")[0],f={mimetype:d,title:e.charAt(0).toUpperCase()+e.slice(1)+" LabyrinthJS",activity:"org.olpcfrance.MediaViewerActivity",timestamp:(new Date).getTime(),creation_time:(new Date).getTime(),file_size:0};c.create(f,function(){console.log("export done.")},b)});var o=document.getElementById("sub-toolbar"),p=document.getElementById("textvalue"),q=document.getElementById("bold-button"),r=document.getElementById("italics-button"),s=document.getElementById("foreground-button");foregroundPalette=new d.ColorPalette(s),foregroundPalette.setColor("rgb(0, 0, 0)");var t=!1,u=document.getElementById("background-button");backgroundPalette=new d.ColorPalette(u),backgroundPalette.setColor("rgb(255, 255, 255)");var v=!1,w=document.getElementById("fontminus-button"),x=document.getElementById("fontplus-button"),y=document.getElementById("font-button");fontPalette=new f.TextPalette(y),foregroundPalette.addEventListener("colorChange",function(a){t||(G.style("color",a.detail.color),G.data("color",a.detail.color),ca()),t=!1}),backgroundPalette.addEventListener("colorChange",function(a){v||(G.style("background-color",a.detail.color),G.data("background-color",a.detail.color),ca()),v=!1}),fontPalette.addEventListener("fontChange",function(a){var b=a.detail.family;G.data("font-family",b),G.removeClass("arial-text comic-text verdana-text"),J(G),"Arial"==b?G.addClass("arial-text"):"Comic Sans MS"==b?G.addClass("comic-text"):"Verdana"==b&&G.addClass("verdana-text"),ca()}),p.addEventListener("input",function(){J(G,p.value),ca()}),q.addEventListener("click",function(){G.toggleClass("bold-text"),G.hasClass("bold-text")?q.classList.add("active"):q.classList.remove("active"),J(G),ca()}),r.addEventListener("click",function(){G.toggleClass("italic-text"),G.hasClass("italic-text")?r.classList.add("active"):r.classList.remove("active"),J(G),ca()}),w.addEventListener("click",function(){G.data("font-size",Math.max(6,G.data("font-size")-2)),J(G),ca()}),x.addEventListener("click",function(){G.data("font-size",Math.min(100,G.data("font-size")+2)),J(G),ca()});var z=function(a){zoomPalette.popDown(),o.style.visibility="visible",p.value=a.style().content,a.hasClass("bold-text")?q.classList.add("active"):q.classList.remove("active"),a.hasClass("italic-text")?r.classList.add("active"):r.classList.remove("active"),t=!0,foregroundPalette.setColor(a.style().color),v=!0,backgroundPalette.setColor(a.style()["background-color"]),fontPalette.setFont(a.data("font-family"))},A=function(){o.style.visibility="hidden",backgroundPalette.popDown(),foregroundPalette.popDown(),fontPalette.popDown()},B=document.getElementById("stop-button");B.addEventListener("click",function(a){console.log("writing..."),U(function(a){null===a?console.log("write done."):console.log("write failed.")})}),window.addEventListener("localized",function(){var a=navigator.language;a&&(a.indexOf("fr")!=-1?b.locale="fr":a.indexOf("es")!=-1&&(b.locale="es")),H=b.get("YourNewIdea"),i.title=b.get("nodetextTitle"),j.title=b.get("linkButtonTitle"),k.title=b.get("removeButtonTitle"),_.title=b.get("undoButtonTitle"),aa.title=b.get("redoButtonTitle"),m.title=b.get("zoomButtonTitle"),s.title=b.get("foregroundButtonTitle"),u.title=b.get("backgroundButtonTitle"),p.placeholder=b.get("typeText"),q.title=b.get("boldButtonTitle"),r.title=b.get("italicButtonTitle"),w.title=b.get("fontMinusButtonTitle"),x.title=b.get("fontPlusButtonTitle"),y.title=b.get("fontButtonTitle"),n.title=b.get("pngButtonTitle")},!1),cy=cytoscape({container:document.getElementById("cy"),ready:function(){var a=I(H,S());a.select(),L(a),G=a,z(a),ca(),T()},style:[{selector:".standard-node",css:{"text-valign":"center","text-halign":"center","border-color":"darkgray","border-width":"1px",shape:"roundrectangle"}},{selector:".bold-text",css:{"font-weight":"bold"}},{selector:".italic-text",css:{"font-style":"italic"}},{selector:".arial-text",css:{"font-family":"Arial"}},{selector:".comic-text",css:{"font-family":"Comic Sans MS"}},{selector:".verdana-text",css:{"font-family":"Verdana"}}]}),cy.on("tap","node",function(){return 2==h?(O(this),ca(),void(G==this&&(G=null))):1==h?(null!=G&&G!=this&&(P(G,this),ca()),void(G=this)):(K(this)?(M(this),A()):(L(this),z(this),p.value==H?p.setSelectionRange(0,p.value.length):p.setSelectionRange(p.value.length,p.value.length)),void(G=this))}),cy.on("unselect","node",function(){M(this)}),cy.on("select","edge",function(){return 2==h?(Q(this),void ca()):void A()}),cy.on("tap",function(a){if(a.cyTarget===cy&&0==h){var b=I(H,a.cyPosition);null!=G&&(P(G,b),M(G)),ca(),b.select(),L(b),G=b,z(b)}}),cy.on("free","node",function(a){ca()});var C=0,D=0,E="Arial",F=16,G=null,H="<Your new idea>",I=function(a,b){var c=R(a,E,F,!1,!1);cy.add({group:"nodes",nodes:[{data:{id:"n"+ ++C,"font-family":E,"font-size":F,"font-weight":"normal",content:a,color:"rgb(0, 0, 0)","background-color":"rgb(255, 255, 255)"},position:{x:b.x,y:b.y}}]});var d=cy.getElementById("n"+C);return d.style({content:a,width:c.width,height:c.height,color:"rgb(0, 0, 0)","font-family":"Arial","font-size":F+"px","background-color":"rgb(255, 255, 255)"}),d.addClass("standard-node"),d},J=function(a,b){void 0===b?b=a.style().content:a.data("content",b);var c=a.data("font-size"),d=a.data("font-family"),e=R(b,d,c,a.hasClass("bold-text"),a.hasClass("italic-text"));a.style({content:b,"font-size":c+"px","font-family":d,width:e.width,height:e.height})},K=function(a){return"dashed"==a.style()["border-style"]},L=function(a){a.style({"border-color":"black","border-style":"dashed","border-width":"4px"})},M=function(a){a.style({"border-color":"darkgray","border-style":"solid","border-width":"1px"})},N=function(){for(var a=cy.collection("node"),b=0;b<a.length;b++)M(a[b])},O=function(a){cy.remove(a)},P=function(a,b){cy.add({group:"nodes",edges:[{data:{id:"e"+ ++D,source:a.id(),target:b.id()}}]})},Q=function(a){cy.remove(a)},R=function(a,b,c,d,e){var f=document.getElementById("fontsizecomputer");return f.innerHTML=a.replace("<","&lt;").replace(">","&gt;"),f.style.fontFamily=b,f.style.fontSize=c+"px",d?f.style.fontWeight="bold":f.style.fontWeight="normal",e?f.style.fontStyle="italic":f.style.fontStyle="normal",{width:f.clientWidth+c+"px",height:f.clientHeight+c+"px"}},S=function(){var a=document.getElementById("canvas"),b={x:a.clientWidth/2,y:a.clientHeight/2};return b},T=function(){var b=a.getDatastoreObject();b.loadAsText(function(a,b,c){null!=c&&(X(JSON.parse(c)),ba(),ca())})},U=function(b){var c=a.getDatastoreObject(),d=W();c.setDataAsText(JSON.stringify(d)),c.save(b)},V=function(a){var b,c=a;if(a&&"object"==typeof a){c="[object Array]"===Object.prototype.toString.call(a)?[]:{};for(b in a)c[b]=V(a[b])}return c},W=function(){return V(cy.json())},X=function(a){cy.remove("node"),cy.remove("edge"),A(),G=null,cy.add({group:"nodes",nodes:a.elements.nodes});for(var b=cy.collection("node"),c=0,d=0;d<b.length;d++){var e=b[d];J(e,e.data("content")),e.style("color",e.data("color")),e.style("background-color",e.data("background-color"));var f=e.data("id").substr(1);f>c&&(c=f)}if(C=c+1,c=0,a.elements.edges){cy.add({group:"edges",edges:a.elements.edges});for(var g=cy.collection("edge"),d=0;d<g.length;d++){var f=g[d].data("id").substr(1);f>c&&(c=f)}}D=c+1},Y=[],Z=0,$=30,_=document.getElementById("undo-button");_.addEventListener("click",function(){da()},!0);var aa=document.getElementById("redo-button");aa.addEventListener("click",function(){ea()},!0);var ba=function(){Y=[],Z=0},ca=function(){if(Z<Y.length-1){for(var a=[],b=0;b<Z+1;b++)a.push(Y[b]);Y=a}var c=Y.length-1,d=W();if(c<$)Y.push(d);else{for(var b=0;b<c-1;b++)Y[b]=Y[b+1];Y[c-1]=d}Z=Y.length-1,fa()},da=function(){Y.length<1||Y.length>=1&&0==Z||(X(Y[--Z]),fa())},ea=function(){Z+1>=Y.length||(X(Y[++Z]),fa())},fa=function(){var a=Y.length;_.disabled=Y.length<1||Y.length>=1&&0==Z,aa.disabled=Z+1>=a}})});